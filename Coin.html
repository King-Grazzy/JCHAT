<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JCHAT - Coins</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    :root { --pink:#ff7ac6; --blue:#6aa7ff; --bg:#0b1220; --panel:#0f172a; --panel-2:#111827; --text:#e5e7eb; --muted:#94a3b8; --border:#1f2937; --border-light:#374151; --shadow:0 10px 30px rgba(0,0,0,.35); --grad: linear-gradient(135deg, var(--pink), var(--blue)); }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:#0b1220;color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;min-height:100%}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(135deg, rgba(10,10,20,.85), rgba(10,10,20,.75));border-bottom:1px solid var(--border);box-shadow:0 4px 15px rgba(0,0,0,.25)}
    .header-inner{max-width:1000px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:-.02em}
    .brand .title{background-image:var(--grad);-webkit-background-clip:text;background-clip:text;color:transparent;font-family:Poppins,Inter,sans-serif;font-size:18px}
    .balances{display:flex;align-items:center;gap:10px}
    .pill{display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,.06);border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px}
    .pill i{background-image:var(--grad);-webkit-background-clip:text;background-clip:text;color:transparent}
    main{max-width:1000px;margin:16px auto;padding:0 16px;display:grid;gap:16px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
    .panel-hd{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .panel-title{font-weight:800;font-family:Poppins,Inter,sans-serif;background-image:var(--grad);-webkit-background-clip:text;background-clip:text;color:transparent}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;padding:16px}
    .card{background:var(--panel-2);border:1px solid var(--border);border-radius:14px;padding:16px;display:grid;gap:10px}
    .card h4{margin:0;font-family:Poppins,Inter,sans-serif}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--panel);color:var(--text);font-weight:600;cursor:pointer;transition:all .2s ease;text-decoration:none}
    .btn:hover{transform:translateY(-1px);border-color:var(--blue);box-shadow:0 6px 18px rgba(0,0,0,.25)}
    .btn.primary{background-image:var(--grad);color:#0b1220;border:0}
    .hint{color:var(--muted);font-size:12px}
    .price{font-size:28px;font-weight:800;font-family:Poppins,Inter,sans-serif}
    .coins{font-weight:700}
    .toast{position:fixed;top:16px;right:16px;background:var(--panel);border:1px solid var(--border);padding:12px 14px;border-radius:10px;box-shadow:var(--shadow);transform:translateX(400px);transition:transform .3s ease;z-index:60}
    .toast.show{transform:translateX(0)}
    .toast.success{border-left:4px solid #10b981}
    .toast.error{border-left:4px solid #ef4444}
    .toast.info{border-left:4px solid var(--blue)}
    /* Receipt upload UI */
    .file-input-wrapper{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:var(--panel-2);cursor:pointer}
    .file-input-wrapper i{color:var(--muted)}
    .file-name{color:var(--muted);font-size:12px}
    .receipt-preview{width:100%;max-height:220px;object-fit:contain;border:1px solid var(--border-light);border-radius:10px;display:none;margin-top:6px}
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="brand"><img src="assets/security.png" alt="JCHAT" style="height:24px;width:auto" onerror="this.style.display='none'"><span class="title">JCHAT Coins</span></div>
      <div class="balances">
        <div class="pill" title="Your JCoins"><i class="fas fa-coins"></i><span id="hdrJc">0</span></div>
        <div class="pill" title="Your Gas"><i class="fas fa-bolt"></i><span id="hdrGas">0</span></div>
      </div>
    </div>
  </header>

  <main>
    <section class="panel">
      <div class="panel-hd"><div class="panel-title">Coin Actions</div></div>
      <div class="grid">
        <div class="card">
          <h4>Buy JCoins</h4>
          <div class="hint">Purchase JCoins securely. Orders are reviewed by admins.</div>
          <a class="btn primary" href="#shop"><i class="fas fa-shopping-cart"></i><span>Open JCoin Shop</span></a>
        </div>
        <div class="card">
          <h4>Wallet</h4>
          <div class="hint">View balances, transactions, and manage your wallet.</div>
          <a class="btn" href="/Wallet.html"><i class="fas fa-wallet"></i><span>Go to Wallet</span></a>
        </div>
        <div class="card">
          <h4>Subscriptions</h4>
          <div class="hint">Upgrade experience with premium subscriptions.</div>
          <a class="btn" href="/premium_subscriptions.html"><i class="fas fa-gem"></i><span>View Plans</span></a>
        </div>
        <div class="card">
          <h4>Learn about JCoins</h4>
          <div class="hint">How JCoins work across JCHAT and ways to earn.</div>
          <a class="btn" href="/solution_center.html"><i class="fas fa-circle-info"></i><span>Open Help Center</span></a>
        </div>
      </div>
    </section>

    <section class="panel" id="shop">
      <div class="panel-hd">
        <div>
          <div class="panel-title">JCoin Shop</div>
          <div class="hint">$<span id="usdRateLabel">0.0000001</span>/J • Bonus from ₦5,000+</div>
        </div>
        <div class="pill" title="System rate"><i class="fas fa-scale-balanced"></i><span id="ratePill">—</span></div>
      </div>
      <div class="grid" id="shopGrid"></div>
    </section>

    <!-- Purchase Modal -->
    <div id="purchaseModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:80;align-items:center;justify-content:center;padding:16px;">
      <div class="panel" style="max-width:520px;width:100%;">
        <div class="panel-hd" style="display:flex;align-items:center;justify-content:space-between;">
          <div class="panel-title">Complete Purchase</div>
          <button id="closePurchaseModal" class="btn" style="padding:6px 10px;"><i class="fas fa-times"></i><span>Close</span></button>
        </div>
        <div class="card" style="margin:12px;">
          <div class="hint" id="purchaseInfo">Buying —</div>
          <div class="row" style="margin-top:8px;">
            <label>Upload Payment Receipt</label>
            <label class="file-input-wrapper" for="receiptInput" style="margin-top:4px;">
              <i class="fas fa-upload"></i>
              <span class="file-name" id="receiptName">No file chosen</span>
            </label>
            <input id="receiptInput" type="file" accept="image/*,application/pdf" style="display:none" />
            <img id="receiptPreview" class="receipt-preview" alt="Receipt Preview" />
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
            <button class="btn primary" id="submitPurchase"><i class="fas fa-paper-plane"></i><span>Submit Receipt</span></button>
          </div>
        </div>
      </div>
    </div>

    <div class="toast" id="coinToast">Info</div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
      apiKey: "AIzaSyDz-8N0totzvMCvonF9pKj9RsoH3J8xL0w",
      authDomain: "jchat-1.firebaseapp.com",
      databaseURL: "https://jchat-1-default-rtdb.firebaseio.com",
      projectId: "jchat-1",
      storageBucket: "jchat-1.firebasestorage.app",
      messagingSenderId: "328479683167",
      appId: "1:328479683167:web:276c0b7e8ea44dd2d6a1ea",
      measurementId: "G-S6Z9GG0R9P"
    };
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const hdrJc = document.getElementById('hdrJc');
    const hdrGas = document.getElementById('hdrGas');
    const rateLabel = document.getElementById('rateLabel');
    const usdRateLabel = document.getElementById('usdRateLabel');
    const ratePill = document.getElementById('ratePill');
    const shopGrid = document.getElementById('shopGrid');
    const toast = document.getElementById('coinToast');
    // Receipt UI
    const purchaseModal = document.getElementById('purchaseModal');
    const closePurchaseModal = document.getElementById('closePurchaseModal');
    const purchaseInfo = document.getElementById('purchaseInfo');
    const receiptInput = document.getElementById('receiptInput');
    const receiptName = document.getElementById('receiptName');
    const receiptPreview = document.getElementById('receiptPreview');
    const submitPurchase = document.getElementById('submitPurchase');

    let currentProfile = null;
    let jcoinRate = 7.5;
    const USD_PER_J = 0.0000001;
    const BASE_J_PER_NAIRA = 3.75; // ₦200 ⇒ 750 JCoins

    // Cloudinary
    const cloudinaryConfig = { cloudName: 'dxld01rcp', uploadPreset: 'Storage_preset' };
    async function uploadMediaToCloudinary(file){
      try{
        const fd = new FormData(); fd.append('file', file); fd.append('upload_preset', cloudinaryConfig.uploadPreset);
        const type = (file?.type||'').startsWith('image/') ? 'image' : ((file?.type||'').includes('pdf') ? 'raw' : 'image');
        const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/${type}/upload`, { method:'POST', body: fd });
        if (!res.ok){ const e = await res.json(); throw new Error(e?.error?.message||'Upload failed'); }
        const data = await res.json(); return data.secure_url || null;
      }catch(e){ console.error('upload', e); return null; }
    }
    const BONUS_THRESHOLD_NAIRA = 5000;
    const BONUS_PERCENT = 0.10;

    async function ensureAuth(){
      if (auth.currentUser) return;
      try { if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken); } catch {}
      if (!auth.currentUser) { try { await signInAnonymously(auth); } catch {} }
    }

    async function loadProfile(user){
      try {
        const profRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profiles', 'user_profile');
        const snap = await getDoc(profRef);
        if (!snap.exists()) {
          await setDoc(profRef, { jCoins: 0, gas: 0, username: user.email || 'User', createdAt: serverTimestamp(), updatedAt: serverTimestamp() }, { merge: true });
          hdrJc.textContent = '0'; hdrGas.textContent = '0'; currentProfile = { jCoins:0, gas:0, username: user.email || 'User' };
          return;
        }
        const p = snap.data(); currentProfile = p;
        hdrJc.textContent = Number(p.jCoins||0).toLocaleString();
        hdrGas.textContent = Number(p.gas||0).toLocaleString();
      } catch {}
    }

    function showToast(message, type='info'){
      toast.textContent = message;
      toast.className = `toast ${type}`;
      requestAnimationFrame(()=> toast.classList.add('show'));
      setTimeout(()=> toast.classList.remove('show'), 2800);
    }

    async function fetchSystemSettings(){
      try {
        const ref = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'system_settings');
        const snap = await getDoc(ref);
        if (snap.exists()) {
          const s = snap.data();
          if (typeof s.jcoinNairaRate === 'number' && s.jcoinNairaRate > 0) jcoinRate = s.jcoinNairaRate;
        }
      } catch {}
      if (usdRateLabel) usdRateLabel.textContent = USD_PER_J.toFixed(7);
      if (ratePill) ratePill.textContent = '—';
    }

    function calculateJCoins(naira){
      const base = Math.floor(naira * BASE_J_PER_NAIRA);
      const bonus = naira >= BONUS_THRESHOLD_NAIRA ? Math.floor(base * BONUS_PERCENT) : 0;
      return { base, bonus, total: base + bonus };
    }

    function renderShop(){
      if (!shopGrid) return;
      const packages = [200, 500, 1000, 2000, 5000, 10000, 20000];
      shopGrid.innerHTML = '';
      packages.forEach(price => {
        const { base, bonus, total } = calculateJCoins(price);
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="price">₦${price.toLocaleString()}</div>
          <div class="hint">${price>=BONUS_THRESHOLD_NAIRA ? `Includes ${(BONUS_PERCENT*100).toFixed(0)}% bonus` : 'No bonus'}</div>
          <div class="coins">${total.toLocaleString()} JCoins</div>
          <button class="btn primary" data-price="${price}"><i class="fas fa-shopping-cart"></i><span>Purchase</span></button>
        `;
        card.querySelector('button').addEventListener('click', ()=> requestPurchase(price, total));
        shopGrid.appendChild(card);
      });
    }

    let selectedNaira = 0, selectedJ = 0;
    async function requestPurchase(nairaAmount, jcoins){
      const u = auth.currentUser;
      if (!u) { showToast('Please log in', 'error'); return; }
      selectedNaira = nairaAmount; selectedJ = jcoins;
      if (purchaseInfo) purchaseInfo.textContent = `Buying ₦${nairaAmount.toLocaleString()} → ${jcoins.toLocaleString()} JCoins`;
      if (receiptInput) receiptInput.value = '';
      if (receiptName) receiptName.textContent = 'No file chosen';
      if (receiptPreview){ receiptPreview.style.display='none'; receiptPreview.src=''; }
      if (purchaseModal) purchaseModal.style.display = 'flex';
    }

    function onReceiptChange(){
      const f = receiptInput?.files?.[0];
      if (receiptName) receiptName.textContent = f ? (f.name||'receipt') : 'No file chosen';
      if (receiptPreview){ if (f && f.type.startsWith('image/')) { receiptPreview.src = URL.createObjectURL(f); receiptPreview.style.display='block'; } else { receiptPreview.style.display='none'; receiptPreview.src=''; } }
    }

    async function submitReceipt(){
      try{
        const u = auth.currentUser;
        if (!u){ showToast('Please log in', 'error'); return; }
        if (!selectedNaira || !selectedJ){ showToast('Select a package', 'error'); return; }
        const f = receiptInput?.files?.[0]; if (!f){ showToast('Attach receipt', 'error'); return; }
        const url = await uploadMediaToCloudinary(f); if (!url){ showToast('Upload failed', 'error'); return; }
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'jcoin_buy_requests'), {
          userId: u.uid,
          username: (currentProfile?.username)|| u.email || 'User',
          requestedNairaPrice: selectedNaira,
          requestedJCoins: selectedJ,
          receiptImageUrl: url,
          status: 'pending',
          timestamp: serverTimestamp()
        });
        showToast('Receipt submitted. Awaiting approval.', 'success');
        if (purchaseModal) purchaseModal.style.display = 'none';
      }catch(e){ console.error(e); showToast('Failed to submit', 'error'); }
    }

    onAuthStateChanged(auth, async (u)=>{
      if (!u) { await ensureAuth(); await fetchSystemSettings(); renderShop(); return; }
      await loadProfile(u);
      await fetchSystemSettings();
      renderShop();
    });
    receiptInput?.addEventListener('change', onReceiptChange);
    submitPurchase?.addEventListener('click', submitReceipt);
    closePurchaseModal?.addEventListener('click', ()=>{ if (purchaseModal) purchaseModal.style.display='none'; });

    (async ()=>{ await ensureAuth(); await fetchSystemSettings(); renderShop(); })();
  </script>
</body>
</html>
