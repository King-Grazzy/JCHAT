<!DOCTYPE html>
<html lang="en">
<head>
    <script src="auth/access-guard.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JCHAT - Profile</title>
    
    <!-- Security Meta Tags -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="JCHAT - User Profile with levels, achievements, and customization">
    <meta name="keywords" content="profile, user, levels, achievements, customization, JCHAT">
    <meta name="author" content="JCHAT Team">

    <!-- Google Fonts: Poppins for headings, Inter for body text -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Preconnect to Firebase and Cloudinary domains for faster loading -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://firebaseio.com" crossorigin>
    <link rel="preconnect" href="https://res.cloudinary.com" crossorigin>
    <link rel="preconnect" href="https://api.cloudinary.com" crossorigin>
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="dns-prefetch" href="//fonts.gstatic.com">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Audio support for success notifications -->

    <style>
        /* Universal box-sizing for consistent layout */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        /* Global CSS Variables for easy theme switching */
        :root {
            --pink: #ff2e92;
            --blue: #00d5ff;
            --glass-black: rgba(10, 10, 10, .75);
            --glass-blue: rgba(0, 213, 255, .15);
            --radius: 20px;
            --transition: .3s ease;

            /* These variables will be overridden by theme classes */
            --white: #fff;
            --text-light: rgba(255, 255, 255, .7);
            --background-main: rgba(10, 10, 10, .75);
            --background-gradient-1: #00d5ff;
            --background-gradient-2: #ff2e92;
            --card-background: linear-gradient(145deg, rgba(255, 255, 255, .03), rgba(255, 255, 255, .01));
            --header-background: linear-gradient(135deg, rgba(10, 10, 10, .85), rgba(10, 10, 10, .75));
            --border-light: rgba(255, 255, 255, .05);
            --input-background: rgba(255, 255, 255, 0.05);
            --button-background: linear-gradient(90deg, var(--blue), var(--pink));
            --button-shadow: 0 4px 15px var(--blue), 0 4px 15px var(--pink);

            /* New variables for consistent theming */
            --background-color-primary: #1a1a2e;
            --background-color-secondary: #0f0f1f;
            --header-background-color: #2a2a4a;
            --footer-background-color: #2a2a4a;
            --content-background-color: #20203a;
            --card-background-color: #2a2a4a;
            --text-color-primary: #e0e0e0;
            --text-color-secondary: #b0b0d0;
            --notification-badge-color: #ff2e92;
            --status-online: #4CAF50;
            --status-offline: #6c757d;
            --status-away: #FFC107;
            --delete-button-color: #dc3545;
            --warning-color: #ffc107;
            --accent-color: #00d5ff; /* A bright cyan */
            --accent-color-dark: #00aaff;
            --border-color: #3a3a5a;
        }

        /* --- Theme Definitions (Light and Dark Mode) --- */
        /* Light Mode */
        body.theme-light-mode {
            --background-main: #f0f2f5; /* Light gray background */
            --background-gradient-1: #e0e2e5; /* Subtle lighter gradient */
            --background-gradient-2: #d0d2d5; /* Subtle darker gradient */
            --white: #333; /* Dark text for readability */
            --text-light: #666; /* Lighter dark text */
            --card-background: rgba(255, 255, 255, 0.95); /* Near white cards */
            --header-background: rgba(255, 255, 255, 0.98); /* Near white header */
            --border-light: rgba(0, 0, 0, 0.1); /* Light borders */
            --input-background: rgba(0, 0, 0, 0.05); /* Light input background */
            --button-background: linear-gradient(90deg, #6dd5ed, #2193b0); /* Blue gradient */
            --button-shadow: 0 4px 15px rgba(109, 213, 237, 0.4), 0 4px 15px rgba(33, 147, 176, 0.4);

            /* New variables override for light mode */
            --background-color-primary: #f0f2f5;
            --background-color-secondary: #e0e2e5;
            --header-background-color: #ffffff;
            --footer-background-color: #ffffff;
            --content-background-color: #f7f9fb;
            --card-background-color: #ffffff;
            --text-color-primary: #333333;
            --text-color-secondary: #666666;
            --text-color-light: #999999;
            --accent-color: #007bff;
            --accent-color-dark: #0056b3;
            --border-color: #e0e0e0;
            --input-background-color: #f0f0f0;
            --button-background: #e9ecef;
            --button-hover-background: #dee2e6;
            --active-item-background: rgba(0, 123, 255, 0.1);
            --notification-badge-color: #dc3545;
            --status-online: #28a745;
            --status-offline: #6c757d;
            --status-away: #ffc107;
            --delete-button-color: #dc3545;
            --warning-color: #ffc107;
        }

        /* Dark Mode */
        body.theme-dark-mode {
            --background-main: #1a1a2e; /* Deep purple-dark blue */
            --background-gradient-1: #16213e; /* Slightly lighter deep blue */
            --background-gradient-2: #0f3460; /* Darker blue */
            --white: #e0e0e0; /* Off-white text */
            --text-light: #a0a0a0; /* Grayish text */
            --card-background: rgba(25, 25, 40, 0.7); /* Darker, less transparent cards */
            --header-background: linear-gradient(135deg, rgba(10, 10, 20, .85), rgba(10, 10, 20, .75)); /* Original dark header */
            --border-light: rgba(255, 255, 255, 0.08); /* Subtle white borders */
            --input-background: rgba(255, 255, 255, 0.08);
            --button-background: linear-gradient(90deg, #e94560, #ba2f49); /* Reddish gradient */
            --button-shadow: 0 4px 15px rgba(233, 69, 96, 0.4), 0 4px 15px rgba(186, 47, 73, 0.4);

            /* New variables override for dark mode */
            --background-color-primary: #121212;
            --background-color-secondary: #1e1e1e;
            --header-background-color: #2c2c2c;
            --footer-background-color: #2c2c2c;
            --content-background-color: #242424;
            --card-background-color: #2c2c2c;
            --text-color-primary: #ffffff;
            --text-color-secondary: #bbbbbb;
            --accent-color: #bb86fc;
            --accent-color-dark: #9a67ea;
            --border-color: #444444;
            --input-background-color: #383838;
            --button-background: #383838;
            --button-hover-background: #505050;
            --active-item-background: rgba(187, 134, 252, 0.2);
            --notification-badge-color: #cf6679;
            --delete-button-color: #f44336;
            --warning-color: #ffeb3b;
        }

        /* Glass Mode specific variables (from original Profile.html snippet, adapted) */
        body.theme-glass-mode {
            --background-main: rgba(10, 10, 10, 0.75);
            background-image: url('https://source.unsplash.com/random/1920x1080?abstract,blur') !important;
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
            backdrop-filter: blur(10px);
            --card-background: rgba(25, 25, 40, 0.7);
            --white: #e0e0e0; /* text-color */
            --text-light: rgba(255, 255, 255, 0.7);
            --input-background: rgba(255, 255, 255, 0.05);
            --border-light: rgba(255, 255, 255, 0.1); /* glass-border-color */
            --button-background: linear-gradient(90deg, var(--pink), var(--blue));
            --button-shadow: 0 4px 15px var(--blue), 0 4px 15px var(--pink);
            box-shadow: inset 0 0 100px rgba(0, 0, 0, 0.5); /* Inner shadow for glass effect */

            /* New variables override for glass mode */
            --background-color-primary: rgba(10, 10, 10, 0.75);
            --background-color-secondary: rgba(10, 10, 10, 0.6);
            --header-background-color: rgba(10, 10, 10, 0.85);
            --footer-background-color: rgba(10, 10, 10, 0.85);
            --content-background-color: rgba(10, 10, 10, 0.75);
            --card-background-color: rgba(25, 25, 40, 0.7);
            --text-color-primary: #e0e0e0;
            --text-color-secondary: #b0b0d0;
            --accent-color: #00d5ff;
            --accent-color-dark: #00aaff;
            --border-color: rgba(255, 255, 255, 0.1);
            --input-background-color: rgba(255, 255, 255, 0.05);
            --button-background: rgba(0, 213, 255, 0.15); /* Glassy button */
            --button-hover-background: rgba(0, 213, 255, 0.25);
            --active-item-background: rgba(0, 213, 255, 0.1);
        }

        /* NEW: Sunset Theme (from original Profile.html snippet, adapted) */
        body.theme-sunset-mode {
            background: linear-gradient(to top, #ff7e5f, #feb47b) !important;
            --background-main: linear-gradient(to top, #ff7e5f, #feb47b);
            --card-background: rgba(255, 255, 255, 0.15); /* Slightly transparent white for contrast */
            --white: #fff; /* White text for readability */
            --text-light: rgba(255, 255, 255, 0.8);
            --input-background: rgba(255, 255, 255, 0.1);
            --border-light: rgba(255, 255, 255, 0.3);
            --button-background: linear-gradient(90deg, #fd746c, #ff9068); /* Sunset gradient */
            --button-shadow: 0 4px 15px rgba(253, 116, 108, 0.4), 0 4px 15px rgba(255, 144, 104, 0.4);

            /* New variables override for sunset mode */
            --background-color-primary: #ff7e5f;
            --background-color-secondary: #feb47b;
            --header-background-color: rgba(255, 126, 95, 0.9);
            --footer-background-color: rgba(255, 126, 95, 0.9);
            --content-background-color: rgba(255, 126, 95, 0.85);
            --card-background-color: rgba(255, 255, 255, 0.15);
            --text-color-primary: #fff;
            --text-color-secondary: rgba(255, 255, 255, 0.8);
            --accent-color: #ffd700;
            --accent-color-dark: #ccaa00;
            --border-color: rgba(255, 255, 255, 0.3);
            --input-background-color: rgba(255, 255, 255, 0.2);
            --button-background: rgba(255, 255, 255, 0.2);
            --button-hover-background: rgba(255, 255, 255, 0.3);
            --active-item-background: rgba(255, 215, 0, 0.1);
        }

        /* EMERGENCY FIX: Remove all scroll restrictions */
        * {
            touch-action: auto !important;
            -webkit-overflow-scrolling: touch !important;
        }

        /* Pink and Blue Glowing Loader */
        .jchat-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(10, 10, 10, 0.95), rgba(20, 20, 30, 0.95));
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 1;
            visibility: visible;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        .jchat-loader.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loader-container {
            text-align: center;
            position: relative;
        }

        .loader-spinner {
            width: 80px;
            height: 80px;
            border: 4px solid transparent;
            border-radius: 50%;
            position: relative;
            margin: 0 auto 20px;
            animation: spin 2s linear infinite;
        }

        .loader-spinner::before {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border: 4px solid transparent;
            border-top: 4px solid var(--pink);
            border-right: 4px solid var(--blue);
            border-radius: 50%;
            animation: spin 1.5s linear infinite reverse;
            filter: drop-shadow(0 0 20px var(--pink)) drop-shadow(0 0 20px var(--blue));
        }

        .loader-spinner::after {
            content: '';
            position: absolute;
            top: 8px;
            left: 8px;
            right: 8px;
            bottom: 8px;
            border: 3px solid transparent;
            border-bottom: 3px solid var(--pink);
            border-left: 3px solid var(--blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            filter: drop-shadow(0 0 15px var(--pink)) drop-shadow(0 0 15px var(--blue));
        }

        .loader-text {
            color: var(--white);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
            background: linear-gradient(90deg, var(--pink), var(--blue), var(--pink));
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shimmer 2s ease-in-out infinite;
        }

        .loader-subtext {
            color: var(--text-light);
            font-size: 14px;
            opacity: 0.7;
            animation: pulse 2s ease-in-out infinite;
        }

        .loader-dots {
            display: inline-flex;
            gap: 4px;
            margin-left: 5px;
        }

        .loader-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--pink), var(--blue));
            animation: bounce 1.4s ease-in-out infinite;
            filter: drop-shadow(0 0 8px var(--pink)) drop-shadow(0 0 8px var(--blue));
        }

        .loader-dot:nth-child(1) { animation-delay: -0.32s; }
        .loader-dot:nth-child(2) { animation-delay: -0.16s; }
        .loader-dot:nth-child(3) { animation-delay: 0s; }

        /* Smart loader progress visuals */
        .loader-meter {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: conic-gradient(from -90deg, var(--pink) 0deg, var(--blue) var(--progress, 0deg), rgba(255,255,255,0.08) var(--progress, 0deg) 360deg);
            filter: drop-shadow(0 0 20px rgba(255,46,146,0.3)) drop-shadow(0 0 20px rgba(0,213,255,0.3));
            transition: background 0.2s ease;
            pointer-events: none;
        }
        .loader-progress {
            margin: -6px 0 8px;
            color: var(--text-light);
            font-size: 13px;
            letter-spacing: 0.5px;
        }
        .loader-spinner { display: none !important; }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes shimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes bounce {
            0%, 80%, 100% { 
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% { 
                transform: scale(1.2);
                opacity: 1;
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        /* Loader particle effects */
        .loader-particles {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200px;
            height: 200px;
            margin: -100px 0 0 -100px;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--pink);
            box-shadow: 0 0 10px var(--pink);
            animation: orbit 4s linear infinite;
        }

        .particle:nth-child(1) {
            background: var(--blue);
            box-shadow: 0 0 10px var(--blue);
            animation-delay: 0s;
            animation-duration: 3s;
        }

        .particle:nth-child(2) {
            animation-delay: -1s;
            animation-duration: 4s;
        }

        .particle:nth-child(3) {
            background: var(--blue);
            box-shadow: 0 0 10px var(--blue);
            animation-delay: -2s;
            animation-duration: 3.5s;
        }

        .particle:nth-child(4) {
            animation-delay: -3s;
            animation-duration: 4.5s;
        }

        @keyframes orbit {
            0% {
                transform: rotate(0deg) translateX(100px) rotate(0deg);
                opacity: 1;
            }
            50% {
                opacity: 0.3;
            }
            100% {
                transform: rotate(360deg) translateX(100px) rotate(-360deg);
                opacity: 1;
            }
        }
        
        html, body {
            scroll-behavior: auto !important;
            overflow: auto !important;
        }

        body {
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 0px; /* Adjusted: Removed nav bar and toggle button */
            background-color: var(--background-main);
            background-image: radial-gradient(circle at top left, var(--background-gradient-1), transparent 100px),
                              radial-gradient(circle at bottom right, var(--background-gradient-2), transparent 150px);
            color: var(--white);
            transition: background-color 0.5s ease, color 0.5s ease; /* Smooth theme transition */
        }

        /* Header Styling (from Home.html) */
        header {
            background: var(--header-background);
            border-bottom: 1px solid var(--border-light);
            padding: 10px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 55px;
            z-index: 10;
            display: flex;
            justify-content: center;
        }





        header .header-content-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 1200px;
            padding: 0 30px;
        }

        .logo {
            font-family: 'Poppins', sans-serif;
            font-size: 1.8rem;
            font-weight: 800;
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            letter-spacing: -0.03em;
            text-decoration: none;
        }

        /* Header Navigation (from Home.html) */
        header nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            gap: 25px;
        }

        header nav ul li a {
            color: var(--white);
            text-decoration: none;
            font-weight: 600;
            font-size: 1.1rem;
            padding: 5px 0;
            position: relative;
            transition: color var(--transition);
        }

        header nav ul li a::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            width: 0;
            height: 3px;
            background: var(--blue);
            border-radius: 2px;
            transition: width var(--transition);
        }

        header nav ul li a:hover {
            color: var(--blue);
        }

        header nav ul li a:hover::after {
            width: 100%;
        }

        /* Cool Notification Icon Styling (from Home.html) */
        .notification-icon-wrapper {
            position: relative;
            margin-right: 15px;
        }

        .notification-icon-wrapper a {
            text-decoration: none;
            color: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .notification-icon-wrapper a::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .notification-icon-wrapper a:hover::before {
            left: 100%;
        }

        .notification-icon-wrapper a:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 213, 255, 0.3);
            border-color: var(--blue);
        }

        .notification-icon-wrapper i {
            font-size: 1.3rem;
            background: linear-gradient(45deg, var(--blue), var(--pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent;
            transition: all 0.3s ease;
            z-index: 1;
            position: relative;
        }

        .notification-icon-wrapper a:hover i {
            transform: rotate(15deg) scale(1.1);
            background: linear-gradient(45deg, var(--pink), var(--blue));
            background-clip: text;
            -webkit-background-clip: text;
        }

        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(45deg, #ff4757, #ff3742);
            color: var(--white);
            border-radius: 50%;
            padding: 4px 8px;
            font-size: 0.7rem;
            font-weight: 800;
            min-width: 22px;
            height: 22px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(255, 71, 87, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--background-main);
            animation: pulse-notification 2s infinite;
            z-index: 2;
        }

        @keyframes pulse-notification {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .notification-badge:empty {
            display: none;
        }

        /* Additional cool effects for notification icon */
        .notification-icon-wrapper a:active {
            transform: scale(0.95);
        }

        /* Glow effect when there are notifications */
        .notification-icon-wrapper.has-notifications a {
            box-shadow: 0 0 20px rgba(255, 71, 87, 0.3);
        }

        .notification-icon-wrapper.has-notifications a:hover {
            box-shadow: 0 0 30px rgba(255, 71, 87, 0.5);
        }

        /* Shaking animation for notification bell when there are unread notifications */
        .notification-icon-wrapper.has-notifications i {
            animation: bell-shake 2s ease-in-out infinite, subtle-shake 3s ease-in-out infinite 1s;
            transform-origin: top;
        }

        @keyframes bell-shake {
            0%, 100% { transform: rotate(0deg); }
            5%, 15%, 25%, 35% { transform: rotate(8deg); }
            10%, 20%, 30% { transform: rotate(-8deg); }
            40%, 100% { transform: rotate(0deg); }
        }

        @keyframes subtle-shake {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(2deg); }
        }

        /* Pause shaking on hover */
        .notification-icon-wrapper.has-notifications a:hover i {
            animation-play-state: paused;
        }

        /* Admin Icon Styling */
        #adminIconLink {
            display: none; /* Hidden by default */
            margin-right: 15px; /* Space it out from other icons */
            /* Apply gradient to icons */
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Fallback */
            font-size: 1.5rem;
            transition: transform 0.2s ease;
        }

        #adminIconLink:hover {
            transform: scale(1.1);
        }

        /* User Profile Header Styling (from Home.html) */
        .user-profile-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-spacer {
            width: 40px;
            height: 40px;
        }













        /* Form help text and status */
        .form-help-text {
            display: block;
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-top: 4px;
            opacity: 0.8;
        }

        .form-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .form-status.success {
            background: rgba(76, 175, 80, 0.1);
            color: #4caf50;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .form-status.error {
            background: rgba(244, 67, 54, 0.1);
            color: #f44336;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }





        /* Profile Forms Moved Notice */
        .profile-forms-moved-notice {
            text-align: center;
            padding: 40px 20px;
            background: var(--card-bg);
            border-radius: var(--radius);
            border: 1px solid var(--border-light);
        }

        .profile-forms-moved-notice p {
            color: var(--text-secondary);
            margin: 10px 0;
        }

        .profile-forms-moved-notice i {
            color: var(--pink);
            margin: 0 5px;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Notification Icon Styling (from Home.html) */
        .notification-icon-wrapper {
            position: relative;
            margin-right: 15px; /* Space between notification and profile */
        }

        .notification-icon-wrapper a {
            text-decoration: none; /* Remove underline from link */
            color: inherit; /* Inherit color from parent */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .notification-icon-wrapper i {
            font-size: 1.5rem; /* Adjust size as needed */
            /* Apply gradient to icons */
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Fallback for browsers that don't support background-clip: text on icons */
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .notification-icon-wrapper i:hover {
            transform: scale(1.1);
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--notification-badge-color); /* Use pink for notifications */
            color: var(--white);
            border-radius: 50%;
            padding: 3px 7px;
            font-size: 0.7rem;
            font-weight: 700;
            min-width: 20px;
            text-align: center;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            /* Hide if no notifications */
            display: none;
        }

        .user-profile-header #profileLink {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: var(--white);
            transition: opacity 0.3s ease, background-color 0.3s ease;
            padding: 5px 10px;
            border-radius: var(--radius);
        }

        .user-profile-header #profileLink:hover {
            opacity: 0.8;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .user-profile-header img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--accent-color); /* Used accent-color for consistency */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: opacity 0.3s ease;
        }

        .user-profile-header i {
            font-size: 30px;
            /* Apply gradient to icons */
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Fallback */
        }

        .user-profile-header span {
            font-weight: 600;
            font-size: 1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
            /* Apply gradient to names */
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Fallback */
        }

        /* NEW: Admin Icon Styling */
        #adminIconLink {
            display: none; /* Hidden by default */
            margin-right: 15px; /* Space it out from other icons */
            /* Apply gradient to icons */
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Fallback */
            font-size: 1.5rem;
            transition: transform 0.2s ease;
        }

        #adminIconLink:hover {
            transform: scale(1.1);
        }

        /* Logout Button Styling (from Home.html) */
        #logoutButton {
            background: linear-gradient(90deg, var(--pink), var(--blue));
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.3s ease;
            opacity: 0.8;
            margin-left: 10px;
        }

        #logoutButton:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px var(--pink), 0 44px 15px var(--blue);
            opacity: 1;
        }

        #logoutButton i {
            color: var(--white);
            font-size: 0.9rem;
        }

        /* Main Content Area (from Home.html) */
        main {
            flex-grow: 1;
            padding: 40px 0;
            padding-top: 55px; /* Adjust for fixed header */
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* Align content to top */
            text-align: center;
        }

        .content-wrapper {
            width: 100%;
            max-width: 800px; /* Adjust as needed */
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
            overflow: visible; /* Allow content to overflow for proper display */
        }
        /* Enhanced scrollbar styling for better touch interaction */
        ::-webkit-scrollbar {
            width: 12px; /* Wider for better touch interaction */
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, var(--blue), var(--pink));
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            min-height: 40px; /* Minimum height for better touch interaction */
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(to bottom, var(--pink), var(--blue));
        }

        /* Touch gesture improvements - simplified for better scrolling */
        .content-wrapper,
        .profile-section,
        .unlocked-rewards-section,
        .recent-activity-section,
        .customization-section,
        .wallet-guide-section {
            /* Removed touch-action and overscroll restrictions for better natural scrolling */
        }

        /* Enhanced Profile Section (adapted from original Profile.html and settings-section) */
        .profile-section {
            background: var(--card-background);
            border: 1px solid var(--glass-blue); /* Consistent border */
            backdrop-filter: blur(10px) saturate(180%);
            border-radius: var(--radius);
            box-shadow: 0 8px 25px rgba(0, 0, 0, .3);
            padding: 2rem;
            width: 90%;
            max-width: 600px; /* Max width for consistency */
            margin: 20px auto;
            display: flex;
            flex-direction: column;
            align-items: center; /* Center content */
            gap: 1.5rem;
            text-align: center;
            position: relative;
            transition: all 0.3s ease;
            overflow: visible; /* Allow content to overflow for proper display */
        }

        .profile-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--blue), var(--pink));
            border-radius: var(--radius) var(--radius) 0 0;
        }

        .profile-section:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, .4);
        }

        .profile-header-area { /* New wrapper for top part of profile */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            width: 100%;
        }

        /* NEW: Profile Completion Progress Bar Styles */
        .profile-completion-section {
            width: 100%;
            max-width: 400px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-light);
            border-radius: 15px;
            padding: 20px;
            margin: 10px 0;
            backdrop-filter: blur(10px);
        }

        .completion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .completion-label {
            font-size: 0.9rem;
            color: var(--text-light);
            font-weight: 500;
        }

        .completion-percentage {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--blue);
            background: linear-gradient(90deg, var(--blue), var(--pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .completion-progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .completion-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--blue), var(--pink));
            border-radius: 4px;
            transition: width 0.8s ease;
            width: 0%;
        }

        .completion-tip {
            font-size: 0.8rem;
            color: var(--text-light);
            text-align: center;
            margin: 0;
            opacity: 0.8;
        }



        /* NEW: Enhanced Mobile Experience Styles */
        @media (max-width: 768px) {
            .profile-completion-section {
                max-width: 100%;
                margin: 15px 0;
                padding: 15px;
            }



            .profile-header-area {
                gap: 12px;
            }

            .profile-pic-wrapper {
                width: 100px;
                height: 100px;
            }

            .profile-name {
                font-size: 1.5rem;
            }

            .profile-bio {
                font-size: 0.9rem;
                text-align: center;
                padding: 0 15px;
            }

            .profile-stats {
                gap: 15px;
                flex-wrap: wrap;
                justify-content: center;
            }

            .stat-item {
                min-width: 80px;
            }

            .profile-actions {
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }

            .profile-action-button {
                width: 100%;
                max-width: 300px;
                justify-content: center;
            }

            /* Touch-friendly form elements */
            .profile-details-section input,
            .profile-details-section textarea,
            .profile-details-section select {
                padding: 12px 15px;
                font-size: 16px; /* Prevents zoom on iOS */
                min-height: 44px; /* Touch-friendly height */
            }

            .profile-details-section label {
                font-size: 0.95rem;
                margin-bottom: 8px;
            }

            /* Mobile-optimized toggle switches */
            .toggle-switch {
                transform: scale(1); /* Full size on mobile */
                min-height: 44px;
            }

            .toggle-switch input {
                min-height: 44px;
            }

            /* Mobile touch improvements - simplified for better scrolling */
            .profile-section {
                /* Removed touch-action restrictions for better natural scrolling */
            }

            /* Mobile-friendly modals */
            .modal-content {
                margin: 20px;
                max-height: calc(100vh - 40px);
                overflow-y: auto;
            }

            /* Mobile-optimized friends button */
            .friends-button {
                min-height: 90px; /* Larger touch target */
                padding: 18px 12px;
            }

            .button-icon {
                top: 12px;
                right: 12px;
                font-size: 16px; /* Larger icon for mobile */
            }

            /* Mobile-optimized friends section */
            .friends-snippet-section {
                padding: 15px;
                margin: 15px 0;
            }

            .friends-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                gap: 12px;
            }

            .friend-pic-wrapper {
                width: 50px;
                height: 50px;
            }

            /* Mobile navigation improvements */

        }







        /* Touch gesture support - simplified for better scrolling */
        .profile-section {
            /* Removed user-select restrictions for better touch interaction */
        }

        /* NEW: Theme Presets Styles */
        .theme-presets-section {
            margin: 20px 0;
        }

        .theme-presets-section label {
            display: block;
            margin-bottom: 15px;
            font-weight: 600;
            color: var(--text-light);
        }

        .theme-preset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .theme-preset {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-preset:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--blue);
            transform: translateY(-2px);
        }

        .theme-preset.selected {
            border-color: var(--pink);
            background: rgba(255, 46, 146, 0.1);
        }

        .preset-preview {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid var(--border-light);
            transition: all 0.3s ease;
        }

        .professional-preview {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .creative-preview {
            background: linear-gradient(135deg, #f093fb, #f5576c);
        }

        .minimal-preview {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
        }

        .vibrant-preview {
            background: linear-gradient(135deg, #43e97b, #38f9d7);
        }

        .theme-preset span {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-light);
            text-align: center;
        }

        /* NEW: Profile Notifications Styles */
        .profile-notifications-section {
            width: 100%;
            max-width: 400px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-light);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            backdrop-filter: blur(10px);
        }

        .notifications-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-light);
        }

        .notifications-header i {
            color: var(--blue);
            font-size: 1.1rem;
        }

        .notifications-header span {
            flex: 1;
            font-weight: 600;
            color: var(--text-light);
        }

        .clear-notifications-btn {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: all 0.2s ease;
        }

        .clear-notifications-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--white);
        }

        .notifications-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .notification-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            margin-bottom: 8px;
            border-left: 3px solid var(--blue);
            transition: all 0.2s ease;
        }

        .notification-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .notification-item.info {
            border-left-color: var(--blue);
        }

        .notification-item.warning {
            border-left-color: var(--warning-color);
        }

        .notification-item.success {
            border-left-color: var(--status-online);
        }

        .notification-item.error {
            border-left-color: var(--delete-button-color);
        }

        .notification-icon {
            font-size: 1rem;
            margin-top: 2px;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            color: var(--white);
            margin-bottom: 4px;
            font-size: 0.9rem;
        }

        .notification-message {
            color: var(--text-light);
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .notification-time {
            color: var(--text-light);
            font-size: 0.75rem;
            opacity: 0.7;
        }

        .profile-pic-wrapper {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid var(--blue);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            position: relative;
            flex-shrink: 0;
        }

        .profile-pic {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .profile-pic-placeholder {
            font-size: 100px;
            /* Apply gradient to icons */
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Fallback */
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .edit-profile-pic-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
            /* Ensure it's not clickable when not owner */
            pointer-events: none;
        }

        .profile-pic-wrapper:hover .edit-profile-pic-overlay {
            opacity: 1;
        }
        /* Make overlay clickable only for owner */
        .profile-pic-wrapper.owner .edit-profile-pic-overlay {
            pointer-events: auto;
        }



        .profile-name {
            font-family: 'Poppins', sans-serif;
            font-size: 2.2rem;
            font-weight: 800;
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            margin: 0;
            text-align: center;
            transition: all 0.3s ease;
        }

        .profile-name:hover {
            background-image: linear-gradient(90deg, var(--pink), var(--blue));
            transform: scale(1.02);
        }

        .profile-bio, .profile-location, .profile-email, .profile-info-item {
            font-size: 1rem;
            color: var(--text-light);
            margin: 0;
            line-height: 1.5;
        }
        .profile-location i, .profile-email i, .profile-info-item i {
            /* Apply gradient to icons */
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Fallback */
            margin-right: 5px;
        }

        /* NEW: User ID Display Styles - Pink and Blue Theme */
        .user-id-container {
            display: flex !important;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            padding: 12px;
            background: linear-gradient(135deg, rgba(255, 46, 146, 0.1), rgba(0, 213, 255, 0.1));
            border: 1px solid;
            border-image: linear-gradient(45deg, var(--pink), var(--blue)) 1;
            border-radius: 12px;
            margin: 8px 0;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .user-id-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 46, 146, 0.05), rgba(0, 213, 255, 0.05));
            border-radius: 12px;
            z-index: -1;
        }
        
        .user-id-container:hover {
            background: linear-gradient(135deg, rgba(255, 46, 146, 0.15), rgba(0, 213, 255, 0.15));
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 46, 146, 0.2), 0 8px 25px rgba(0, 213, 255, 0.2);
        }
        
        .user-id-label {
            font-weight: 600;
            background: linear-gradient(45deg, var(--pink), var(--blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0 4px;
            font-size: 0.95rem;
        }
        
        .user-id-text {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: var(--white);
            background: linear-gradient(135deg, rgba(255, 46, 146, 0.2), rgba(0, 213, 255, 0.2));
            padding: 6px 10px;
            border-radius: 8px;
            letter-spacing: 0.5px;
            border: 1px solid;
            border-image: linear-gradient(45deg, var(--pink), var(--blue)) 1;
            flex: 1;
            min-width: 0;
            word-break: break-all;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .copy-user-id-btn {
            background: linear-gradient(45deg, var(--pink), var(--blue));
            color: white;
            border: none;
            border-radius: 8px;
            padding: 6px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 8px rgba(255, 46, 146, 0.3), 0 2px 8px rgba(0, 213, 255, 0.3);
            font-weight: 600;
        }
        
        .copy-user-id-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 46, 146, 0.4), 0 4px 15px rgba(0, 213, 255, 0.4);
            background: linear-gradient(45deg, var(--blue), var(--pink));
        }
        
        .copy-user-id-btn:active {
            transform: translateY(0);
        }
        
        .copy-user-id-btn.copied {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            animation: pulse 0.6s ease-in-out;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Pink and Blue Glow Effects for User ID */
        .user-id-container {
            position: relative;
            overflow: hidden;
        }
        .user-id-container::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(
                from 0deg,
                transparent,
                rgba(255, 46, 146, 0.1),
                transparent,
                rgba(0, 213, 255, 0.1),
                transparent
            );
            animation: rotate 8s linear infinite;
            z-index: -2;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Enhanced hover effects */
        .user-id-text:hover {
            background: linear-gradient(135deg, rgba(255, 46, 146, 0.3), rgba(0, 213, 255, 0.3));
            transform: scale(1.02);
            transition: all 0.3s ease;
        }

        /* Pink and Blue focus effects */
        .user-id-container:focus-within {
            box-shadow: 0 0 20px rgba(255, 46, 146, 0.3), 0 0 20px rgba(0, 213, 255, 0.3);
        }

        /* Clean Profile Section Styling - Pink and Blue Theme */
        .clean-profile {
            background: linear-gradient(135deg, rgba(255, 46, 146, 0.05), rgba(0, 213, 255, 0.05));
            border: 1px solid;
            border-image: linear-gradient(45deg, var(--pink), var(--blue)) 1;
            border-radius: 16px;
            padding: 24px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }

        .clean-profile::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 46, 146, 0.02), rgba(0, 213, 255, 0.02));
            border-radius: 16px;
            z-index: -1;
        }

        .clean-profile .section-title {
            background: linear-gradient(45deg, var(--pink), var(--blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 24px;
            font-family: 'Poppins', sans-serif;
        }

        .clean-profile .input-group {
            margin-bottom: 20px;
        }

        .clean-profile .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color-primary);
            font-size: 0.95rem;
        }

        .clean-profile .input-group input,
        .clean-profile .input-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid;
            border-image: linear-gradient(45deg, var(--pink), var(--blue)) 1;
            border-radius: 8px;
            background: linear-gradient(135deg, rgba(255, 46, 146, 0.1), rgba(0, 213, 255, 0.1));
            color: var(--text-color-primary);
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .clean-profile .input-group input:focus,
        .clean-profile .input-group textarea:focus {
            outline: none;
            box-shadow: 0 0 20px rgba(255, 46, 146, 0.3), 0 0 20px rgba(0, 213, 255, 0.3);
            transform: translateY(-2px);
        }

        .clean-profile .input-group input::placeholder,
        .clean-profile .input-group textarea::placeholder {
            color: var(--text-color-secondary);
            opacity: 0.7;
        }

        .clean-profile .save-button {
            background: linear-gradient(45deg, var(--pink), var(--blue));
            color: white;
            border: none;
            border-radius: 12px;
            padding: 14px 28px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(255, 46, 146, 0.3), 0 4px 15px rgba(0, 213, 255, 0.3);
        }

        .clean-profile .save-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 46, 146, 0.4), 0 8px 25px rgba(0, 213, 255, 0.4);
            background: linear-gradient(45deg, var(--blue), var(--pink));
        }

        .clean-profile .save-button:active {
            transform: translateY(-1px);
        }

        /* Enhanced hover effects for clean profile */
        .clean-profile:hover {
            box-shadow: 0 8px 30px rgba(255, 46, 146, 0.15), 0 8px 30px rgba(0, 213, 255, 0.15);
        }

        /* Beautiful Help & Support Section - Pink and Blue Theme */
        .help-support-section {
            background: linear-gradient(135deg, rgba(255, 46, 146, 0.08), rgba(0, 213, 255, 0.08));
            border: 1px solid;
            border-image: linear-gradient(45deg, var(--pink), var(--blue)) 1;
            border-radius: 20px;
            padding: 32px;
            margin: 30px 0;
            position: relative;
            overflow: hidden;
        }

        .help-support-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 46, 146, 0.03), rgba(0, 213, 255, 0.03));
            border-radius: 20px;
            z-index: -1;
        }

        .help-section-title {
            background: linear-gradient(45deg, var(--pink), var(--blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2rem;
            font-weight: 800;
            text-align: center;
            margin-bottom: 32px;
            font-family: 'Poppins', sans-serif;
            text-shadow: 0 0 30px rgba(255, 46, 146, 0.3);
        }

        .help-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .help-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 1px solid;
            border-image: linear-gradient(45deg, var(--pink), var(--blue)) 1;
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .help-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 46, 146, 0.05), rgba(0, 213, 255, 0.05));
            border-radius: 16px;
            z-index: -1;
        }

        .help-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(255, 46, 146, 0.2), 0 20px 40px rgba(0, 213, 255, 0.2);
        }

        .help-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            position: relative;
            background: linear-gradient(135deg, rgba(255, 46, 146, 0.2), rgba(0, 213, 255, 0.2));
        }

        .help-icon::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--pink), var(--blue));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .help-card:hover .help-icon::before {
            opacity: 0.1;
        }

        .contact-card .help-icon {
            color: var(--pink);
        }

        .whatsapp-card .help-icon {
            color: #25D366;
        }

        .phone-card .help-icon {
            color: var(--blue);
        }



        .help-card h4 {
            color: var(--text-color-primary);
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 12px;
            font-family: 'Poppins', sans-serif;
        }

        .help-card p {
            color: var(--text-color-secondary);
            font-size: 0.95rem;
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .help-link {
            display: inline-block;
            background: linear-gradient(45deg, var(--pink), var(--blue));
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 46, 146, 0.3);
        }

        .help-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 46, 146, 0.4);
            background: linear-gradient(45deg, var(--blue), var(--pink));
        }



        .help-info {
            text-align: center;
            margin-top: 24px;
        }

        .help-tip {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            background: linear-gradient(135deg, rgba(255, 46, 146, 0.1), rgba(0, 213, 255, 0.1));
            border: 1px solid;
            border-image: linear-gradient(45deg, var(--pink), var(--blue)) 1;
            border-radius: 25px;
            padding: 16px 24px;
            color: var(--text-color-primary);
            font-size: 0.95rem;
            font-weight: 500;
        }

        .help-tip i {
            color: var(--pink);
            font-size: 1.2rem;
        }

        /* Responsive design for help section */
        @media (max-width: 768px) {
            .help-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .help-support-section {
                padding: 24px;
                margin: 20px 0;
            }
            
            .help-section-title {
                font-size: 1.6rem;
            }
        }

        /* NEW: Premium Features Section - Pink and Blue Theme */
        .premium-features-section {
            margin-top: 40px;
            padding: 30px;
            background: linear-gradient(135deg, rgba(255, 46, 146, 0.05), rgba(0, 213, 255, 0.05));
            border: 1px solid;
            border-image: linear-gradient(45deg, var(--pink), var(--blue)) 1;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .premium-section-title {
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 30px;
            background: linear-gradient(135deg, var(--pink), var(--blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .premium-section-title i {
            font-size: 1.8rem;
            background: linear-gradient(135deg, var(--pink), var(--blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .premium-features-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
            max-width: 600px;
            margin: 0 auto;
        }

        .premium-feature-card {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid;
            border-image: linear-gradient(45deg, var(--pink), var(--blue)) 1;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            backdrop-filter: blur(10px);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }

        .premium-feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 46, 146, 0.1), rgba(0, 213, 255, 0.1), transparent);
            transition: left 0.6s ease;
        }

        .premium-feature-card:hover::before {
            left: 100%;
        }

        .premium-feature-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(255, 46, 146, 0.2), 0 20px 40px rgba(0, 213, 255, 0.2);
        }

        .feature-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, var(--pink), var(--blue));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            box-shadow: 0 8px 25px rgba(255, 46, 146, 0.4), 0 8px 25px rgba(0, 213, 255, 0.4);
        }

        .premium-feature-card h4 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--white);
            margin-bottom: 15px;
            font-family: 'Poppins', sans-serif;
        }

        .premium-feature-card p {
            color: var(--text-light);
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 25px;
        }

        .feature-price {
            margin-bottom: 25px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(255, 46, 146, 0.1), rgba(0, 213, 255, 0.1));
            border-radius: 15px;
            border: 1px solid;
            border-image: linear-gradient(45deg, var(--pink), var(--blue)) 1;
        }

        .price-amount {
            display: block;
            font-size: 2rem;
            font-weight: 800;
            color: var(--white);
            margin-bottom: 5px;
            background: linear-gradient(135deg, var(--pink), var(--blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .price-description {
            color: var(--text-light);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .feature-benefits {
            margin-bottom: 30px;
            text-align: left;
        }

        .benefit-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            padding: 8px 0;
        }

        .benefit-item i {
            color: var(--pink);
            font-size: 1rem;
            background: linear-gradient(135deg, var(--pink), var(--blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .benefit-item span {
            color: var(--text-light);
            font-size: 0.95rem;
            font-weight: 500;
        }

        .feature-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .premium-contact-btn, .premium-whatsapp-btn {
            padding: 12px 24px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 2px solid transparent;
        }

        .premium-contact-btn {
            background: linear-gradient(135deg, var(--pink), var(--blue));
            color: white;
            box-shadow: 0 4px 15px rgba(255, 46, 146, 0.4);
        }

        .premium-contact-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 46, 146, 0.6);
        }

        .premium-whatsapp-btn {
            background: transparent;
            color: var(--white);
            border-color: var(--pink);
        }

        .premium-whatsapp-btn:hover {
            background: linear-gradient(135deg, var(--pink), var(--blue));
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 46, 146, 0.4);
        }

        /* Mobile responsive for premium features */
        @media (max-width: 768px) {
            .premium-features-section {
                padding: 20px;
                margin-top: 30px;
            }

            .premium-section-title {
                font-size: 1.6rem;
            }

            .premium-feature-card {
                padding: 25px;
            }

            .feature-icon {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
            }

            .feature-actions {
                flex-direction: column;
                align-items: center;
            }

            .premium-contact-btn, .premium-whatsapp-btn {
                width: 100%;
                max-width: 250px;
                justify-content: center;
            }
        }

        /* Floating Scroll Toggle Button - Pink and Blue Theme */
        .scroll-toggle-btn {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, var(--pink), var(--blue));
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(255, 46, 146, 0.3), 0 4px 15px rgba(0, 213, 255, 0.3);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 9999;
            overflow: hidden;
            font-size: 1.1rem;
            color: white;
            font-weight: 600;
            opacity: 0.7;
        }

        .scroll-toggle-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--blue), var(--pink));
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .scroll-toggle-btn:hover {
            transform: translateY(-3px) scale(1.1);
            box-shadow: 0 8px 25px rgba(255, 46, 146, 0.5), 0 8px 25px rgba(0, 213, 255, 0.5);
            opacity: 1;
        }

        .scroll-toggle-btn:hover::before {
            opacity: 1;
        }

        .scroll-toggle-btn:active {
            transform: translateY(-2px) scale(1.05);
        }

        .scroll-toggle-btn i {
            position: relative;
            z-index: 2;
            transition: all 0.3s ease;
        }

        .scroll-toggle-btn:hover i {
            transform: scale(1.2);
        }

        /* Scroll to Top state */
        .scroll-toggle-btn.scroll-to-top {
            background: linear-gradient(135deg, var(--blue), var(--pink));
        }

        .scroll-toggle-btn.scroll-to-top::before {
            background: linear-gradient(135deg, var(--pink), var(--blue));
        }



        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            .scroll-toggle-btn {
                bottom: 20px;
                right: 20px;
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            .scroll-toggle-btn {
                bottom: 15px;
                right: 15px;
                width: 35px;
                height: 35px;
                font-size: 0.9rem;
            }
        }

        /* Floating Contact Icon - Bottom Left */
        .contact-icon {
            position: fixed;
            bottom: 25px;
            left: 25px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--pink), var(--blue));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 46, 146, 0.3), 0 4px 15px rgba(0, 213, 255, 0.3);
        }

        .contact-icon:hover {
            transform: translateY(-3px) scale(1.1);
            box-shadow: 0 8px 25px rgba(255, 46, 146, 0.5), 0 8px 25px rgba(0, 213, 255, 0.5);
        }

        .contact-icon i {
            font-size: 1.4rem;
            color: white;
            transition: transform 0.3s ease;
        }

        .contact-icon:hover i {
            transform: scale(1.2) rotate(10deg);
        }

        /* Contact Modal */
        .contact-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        .contact-modal.active {
            display: flex;
        }

        .contact-modal-content {
            background: var(--card-bg);
            border-radius: 20px;
            max-width: 90vw;
            max-height: 90vh;
            width: 600px;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 46, 146, 0.2);
            animation: slideUp 0.3s ease;
        }

        .contact-modal-header {
            padding: 25px 30px 15px;
            border-bottom: 1px solid rgba(255, 46, 146, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, rgba(255, 46, 146, 0.1), rgba(0, 213, 255, 0.1));
            border-radius: 20px 20px 0 0;
        }

        .contact-modal-header h3 {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(45deg, var(--pink), var(--blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .close-contact-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: var(--text-light);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s ease;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-contact-btn:hover {
            background: rgba(255, 46, 146, 0.1);
            color: var(--pink);
            transform: scale(1.1);
        }

        .contact-modal-body {
            padding: 25px 30px 30px;
        }
        /* Mobile responsive for contact modal */
        @media (max-width: 768px) {
            .contact-icon {
                bottom: 20px;
                left: 20px;
                width: 50px;
                height: 50px;
            }

            .contact-icon i {
                font-size: 1.2rem;
            }

            .contact-modal-content {
                width: 95vw;
                max-height: 95vh;
                border-radius: 15px;
            }

            .contact-modal-header {
                padding: 20px 20px 15px;
                border-radius: 15px 15px 0 0;
            }

            .contact-modal-header h3 {
                font-size: 1.3rem;
            }

            .contact-modal-body {
                padding: 20px;
            }

            .help-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }

        @media (max-width: 480px) {
            .contact-icon {
                bottom: 15px;
                left: 15px;
                width: 45px;
                height: 45px;
            }

            .contact-icon i {
                font-size: 1rem;
            }

            .contact-modal-header h3 {
                font-size: 1.1rem;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { 
                opacity: 0; 
                transform: translateY(50px) scale(0.9); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 20px;
            width: 100%;
            margin-top: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid var(--border-light);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .profile-stats:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .stat-item {
            text-align: center;
            color: var(--white);
            padding: 15px 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80px;
        }

        .stat-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            background: linear-gradient(45deg, var(--blue), var(--pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent;
            transition: all 0.3s ease;
        }

        .stat-item:hover .stat-value {
            background: linear-gradient(45deg, var(--pink), var(--blue));
            background-clip: text;
            -webkit-background-clip: text;
            transform: scale(1.1);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-light); /* Lighter text for labels */
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* NEW: Friends Button Styles */
        .friends-button {
            cursor: pointer;
            position: relative;
            user-select: none;
            background: linear-gradient(135deg, rgba(0, 213, 255, 0.1), rgba(255, 46, 146, 0.1));
            border: 2px solid rgba(0, 213, 255, 0.3);
            transition: all 0.3s ease;
        }

        .friends-button:hover {
            background: linear-gradient(135deg, rgba(0, 213, 255, 0.2), rgba(255, 46, 146, 0.2));
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 213, 255, 0.3);
            border-color: rgba(0, 213, 255, 0.6);
        }

        .friends-button:active {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0, 213, 255, 0.4);
        }

        .friends-button.active {
            background: linear-gradient(135deg, rgba(0, 213, 255, 0.25), rgba(255, 46, 146, 0.25));
            border-color: var(--accent-color, #00d5ff);
            box-shadow: 0 0 25px rgba(0, 213, 255, 0.4);
        }

        .button-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 14px;
            color: var(--accent-color, #00d5ff);
            transition: all 0.3s ease;
            opacity: 0.8;
        }

        .friends-button:hover .button-icon {
            opacity: 1;
            color: var(--accent-color, #00d5ff);
            transform: scale(1.1);
        }

        .friends-button.active .button-icon {
            color: var(--accent-color, #00d5ff);
            opacity: 1;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
            }
        }

        /* NEW: Level Display and Progress Bar Styles */
        .level-link-wrapper {
            text-decoration: none; /* Remove underline from the link */
            color: inherit; /* Inherit text color */
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%; /* Ensure it takes full width for centering */
            padding: 5px 0; /* Add some padding */
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .level-link-wrapper:hover {
            transform: translateY(-2px);
        }

        .level-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            width: 100%; /* Ensure it takes full width */
        }

        .profile-level-info { /* Adjusted to target the new div */
            display: flex;
            flex-direction: column; /* Stack icon and name */
            align-items: center;
            gap: 8px;
            margin-top: 10px; /* Space from bio/location */
        }

        .profile-level-name {
            font-family: 'Poppins', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            /* Apply gradient to level name */
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0; /* Remove default margin */
        }

        .profile-level-icon {
            font-size: 2.5rem; /* Larger icon for the main level display */
            /* Apply gradient to level icon */
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .progress-bar-container {
            width: 80%; /* Adjust width as needed */
            height: 12px;
            background-color: rgba(255, 255, 255, 0.1); /* Lighter background for the bar */
            border-radius: 6px;
            overflow: hidden;
            margin-top: 8px; /* Space between level name and bar */
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            width: 0%; /* Fill grows with gas progress */
            background-image: linear-gradient(90deg, var(--pink), var(--blue));
            background-size: 200% 100%;
            background-position: right; /* Start with no visible gradient */
            border-radius: 6px;
            transition: background-position 0.5s ease-out, width 0.3s ease-in-out;
            position: relative;
        }

        /* Progress percentage display */
        .progress-percentage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.7rem;
            font-weight: 700;
            color: #000;
            text-shadow: 0 0 2px rgba(255, 255, 255, 0.8);
            z-index: 2;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        /* Progress bar glow effect */
        .progress-bar-container::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                rgba(255, 71, 87, 0.3) 0%,    /* Red glow */
                rgba(255, 107, 53, 0.3) 25%,  /* Orange-Red glow */
                rgba(255, 167, 38, 0.3) 50%,  /* Orange glow */
                rgba(255, 215, 0, 0.3) 75%,   /* Yellow glow */
                rgba(76, 175, 80, 0.3) 100%   /* Green glow */
            );
            border-radius: 6px;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .progress-bar-container:hover::after {
            opacity: 1;
        }

        /* Hide the "XP Level" label as requested */
        .level-link-wrapper .stat-label {
            display: none;
        }

        /* JCoin Exchange Rate Display */
        .jcoin-exchange-rate {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 5px;
            text-align: center;
            display: flex; /* Make it a flex container to align icon and text */
            align-items: center;
            justify-content: center;
            gap: 5px; /* Space between icon and text */
        }

        /* Padlock icon styling */
        .padlock-icon {
            font-size: 0.9rem; /* Smaller for inline text */
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--pink), var(--blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }




        .profile-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .profile-action-button {
            background: var(--button-background);
            color: var(--white);
            border: none;
            border-radius: 15px;
            padding: 0.8rem 1.5rem;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: var(--button-shadow);
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .profile-action-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .profile-action-button:hover::before {
            left: 100%;
        }

        .profile-action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--blue), 0 6px 20px var(--pink);
        }

        .profile-action-button.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--white);
            border: 1px solid var(--border-light);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }

        .profile-action-button.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }
        .profile-action-button.danger {
            background-color: var(--delete-button-color); /* Red for danger actions */
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
        }

        .profile-action-button.danger:hover {
            background-color: #c82333;
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.6);
        }

        /* Specific button styles for dynamic states */
        .profile-action-button.sent { background: #6c757d; cursor: default; box-shadow: none; }
        .profile-action-button.sent:hover { transform: none; box-shadow: none; }
        .profile-action-button.friends { background: #28a745; cursor: default; box-shadow: none; }
        .profile-action-button.friends:hover { transform: none; box-shadow: none; }
        .profile-action-button.accept { background: linear-gradient(90deg, #28a745, #218838); }
        .profile-action-button.accept:hover { background: linear-gradient(90deg, #218838, #28a745); }
        .profile-action-button.unfriend { background: #dc3545; }
        .profile-action-button.unfriend:hover { background: #c82333; }

        /* Icons within action buttons */
        .profile-action-button i {
            /* Apply gradient to icons */
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .profile-action-button.secondary i,
        .profile-action-button.danger i {
            -webkit-text-fill-color: var(--white); /* Ensure icons are white for secondary/danger */
        }

        /* Inline Profile Details (from original Profile.html snippet) */
        .profile-details-section { /* Renamed from .profile-details to avoid conflict */
            width: 100%;
            text-align: left;
            margin-top: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .profile-details-section label {
            display: block;
            text-align: left;
            margin-bottom: 5px;
            color: var(--text-light); /* Consistent text color */
            font-weight: 600;
            font-size: 0.95rem;
        }

        .profile-details-section input[type="text"],
        .profile-details-section input[type="url"], /* Added for website */
        .profile-details-section textarea,
        .profile-details-section select { /* NEW: for customization options */
            width: 100%;
            padding: 0.8rem 1rem;
            margin-bottom: 15px; /* Keep original margin for spacing between fields */
            border: 1px solid var(--border-light); /* Consistent border */
            border-radius: 15px; /* Consistent radius */
            background: var(--input-background); /* Consistent background */
            color: var(--white); /* Consistent text color */
            font-size: 1rem; /* Consistent font size */
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            outline: none;
        }

        .profile-details-section input[type="text"]:focus,
        .profile-details-section input[type="url"]:focus,
        .profile-details-section textarea:focus,
        .profile-details-section select:focus {
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(0, 213, 255, 0.2);
        }

        .profile-details-section textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* NEW: Toggle switch for privacy settings */
        .privacy-toggle-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed rgba(255,255,255,0.1);
            margin-bottom: 10px;
        }
        .privacy-toggle-group:last-child {
            border-bottom: none;
        }
        .privacy-toggle-group label {
            margin-bottom: 0;
        }
        /* Toggle button styles (reused from Admin.html) */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-switch .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--input-background);
            transition: .4s;
            border-radius: 34px;
            border: 1px solid var(--border-light);
        }

        .toggle-switch .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: var(--text-light);
            transition: .4s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .slider {
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            border-color: var(--blue);
        }

        .toggle-switch input:checked + .slider:before {
            transform: translateX(26px);
            background-color: var(--white);
        }

        /* Privacy Settings Section Styles */
        .privacy-settings-section {
            background: linear-gradient(135deg, rgba(255, 46, 146, 0.05), rgba(0, 213, 255, 0.05));
            border: 1px solid;
            border-image: linear-gradient(45deg, var(--pink), var(--blue)) 1;
            border-radius: 16px;
            padding: 24px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }

        .privacy-settings-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 46, 146, 0.02), rgba(0, 213, 255, 0.02));
            border-radius: 16px;
            z-index: -1;
        }

        .privacy-section-title {
            background: linear-gradient(45deg, var(--pink), var(--blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.4rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 8px;
            font-family: 'Poppins', sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .privacy-section-title i {
            background: linear-gradient(45deg, var(--pink), var(--blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .privacy-section-subtitle {
            text-align: center;
            color: var(--text-light);
            font-size: 0.95rem;
            margin-bottom: 24px;
            opacity: 0.8;
        }

        .privacy-category {
            margin-bottom: 24px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .privacy-category-title {
            color: var(--white);
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 16px;
            font-family: 'Poppins', sans-serif;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .privacy-category-title i {
            color: var(--blue);
            font-size: 1rem;
        }

        .privacy-toggle-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
            margin-bottom: 8px;
        }

        .privacy-toggle-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .privacy-toggle-group label:first-child {
            margin-bottom: 0;
            color: var(--text-light);
            font-weight: 500;
            font-size: 0.95rem;
        }

        .privacy-actions {
            margin-top: 24px;
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .save-privacy-btn {
            background: linear-gradient(45deg, var(--pink), var(--blue));
            color: white;
            border: none;
            border-radius: 12px;
            padding: 14px 28px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 0 auto;
            box-shadow: 0 4px 15px rgba(255, 46, 146, 0.3), 0 4px 15px rgba(0, 213, 255, 0.3);
        }

        .save-privacy-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 46, 146, 0.4), 0 8px 25px rgba(0, 213, 255, 0.4);
            background: linear-gradient(45deg, var(--blue), var(--pink));
        }

        .save-privacy-btn:active {
            transform: translateY(-1px);
        }

        .action-btn.privacy-btn {
            background: linear-gradient(45deg, var(--pink), var(--blue));
            color: white;
            border: none;
        }

        .action-btn.privacy-btn:hover {
            background: linear-gradient(45deg, var(--blue), var(--pink));
            transform: translateY(-2px);
        }

        /* Mobile responsive for privacy settings */
        @media (max-width: 768px) {
            .privacy-settings-section {
                padding: 20px;
                margin: 15px 0;
            }

            .privacy-section-title {
                font-size: 1.2rem;
            }

            .privacy-category {
                padding: 12px;
            }

            .privacy-toggle-group {
                padding: 10px 0;
            }

            .save-privacy-btn {
                width: 100%;
                max-width: 300px;
            }
        }

        /* NEW: Unlocked Rewards Section */
        .unlocked-rewards-section, .recent-activity-section, .customization-section {
            background: var(--card-background);
            border: 1px solid var(--glass-blue);
            backdrop-filter: blur(10px) saturate(180%);
            border-radius: var(--radius);
            box-shadow: 0 8px 25px rgba(0, 0, 0, .3);
            padding: 1.5rem;
            width: 100%;
            margin-top: 20px;
            text-align: left;
        }
        .unlocked-rewards-section h3, .friends-snippet-section h3, .recent-activity-section h3, .customization-section h3 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--white);
            margin-top: 0;
            margin-bottom: 1rem;
            text-align: center;
        }
        .rewards-grid, .friends-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            justify-content: center;
        }
        .reward-item, .friend-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-light);
            cursor: default;
        }
        .reward-icon {
            font-size: 2.5rem;
            margin-bottom: 5px;
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .friend-pic-wrapper {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid var(--accent-color);
            margin-bottom: 5px;
        }
        .friend-pic {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .friend-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            font-weight: 600;
            color: var(--white);
        }
        /* NEW: Enhanced Friend Item Styles */
        .friend-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid var(--border-light);
            transition: all 0.3s ease;
            position: relative;
        }

        .friend-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .friend-profile-link {
            text-decoration: none;
            color: inherit;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        .friend-profile-link:hover {
            text-decoration: none;
            color: inherit;
        }

        .friend-actions {
            margin-top: 10px;
            width: 100%;
        }

        .chat-with-friend-btn {
            background: linear-gradient(90deg, var(--blue), var(--pink));
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .chat-with-friend-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 213, 255, 0.4);
        }

        .default-avatar {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(45deg, var(--blue), var(--pink));
            color: white;
            font-size: 2rem;
        }



        /* Modal Overlay (exactly like Chat.html) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--card-background);
            padding: 30px;
            border-radius: var(--radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            gap: 15px;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        .close-friends-btn {
            position: absolute;
            top: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-light);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .close-friends-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: var(--white);
            transform: scale(1.1);
        }

        /* Select Friend Modal Specific Styles (exactly like Chat.html) */
        #selectFriendModal .modal-content {
            background: #000000;
            border: 2px solid #333333;
            background-clip: padding-box;
            backdrop-filter: blur(20px);
            position: relative;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5), 0 0 10px rgba(50, 50, 50, 0.3);
        }

        #selectFriendModal .search-input {
            width: 100%;
            padding: 12px 15px;
            border-radius: 10px;
            border: 2px solid #333333;
            background: #111111;
            color: var(--white);
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        }

        #selectFriendModal .search-input:focus {
            border: 2px solid #555555;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5), 0 0 5px rgba(100, 100, 100, 0.2);
            background: #000000;
        }

        #selectFriendModal .search-input::placeholder {
            color: var(--text-light);
        }

        #selectFriendModal .friend-list-modal {
            flex-grow: 1;
            overflow-y: auto;
            max-height: calc(80vh - 200px);
            padding-right: 5px;
            margin: 15px 0;
        }

        #selectFriendModal .friend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            border-radius: 12px;
            background-color: #000000 !important;
            background: #000000 !important;
            border: 1px solid #333333;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        #selectFriendModal .friend-item:hover {
            background-color: #111111 !important;
            background: #111111 !important;
            transform: translateY(-2px);
            border-color: #555555;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        #selectFriendModal .friend-item img,
        #selectFriendModal .friend-item .default-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #333333;
        }

        #selectFriendModal .friend-item .default-avatar {
            background: linear-gradient(45deg, var(--blue), var(--pink));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        #selectFriendModal .friend-item span {
            flex-grow: 1;
            color: var(--white);
            font-weight: 500;
            text-align: left;
        }

        /* Status Indicator Styles (exactly like Chat.html) */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #888888;
            position: absolute;
            bottom: 2px;
            right: 2px;
            border: 2px solid #000000;
        }

        .status-dot.online {
            background: #4CAF50;
            box-shadow: 0 0 6px rgba(76, 175, 80, 0.6);
            animation: pulse-online 2s infinite;
        }

        .status-dot.recently {
            background: #FFC107;
        }

        .status-dot.offline {
            background: #888888;
        }

        @keyframes pulse-online {
            0% { box-shadow: 0 0 6px rgba(76, 175, 80, 0.6); }
            50% { box-shadow: 0 0 12px rgba(76, 175, 80, 0.8); }
            100% { box-shadow: 0 0 6px rgba(76, 175, 80, 0.6); }
        }

        /* Friend Status Updates */
        .friend-status {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: auto;
        }

        .friend-status.online {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
        }

        .friend-status.typing {
            background: rgba(0, 213, 255, 0.2);
            color: #00d5ff;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .cancel-btn {
            background: #333333;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .cancel-btn:hover {
            background: #555555;
            transform: translateY(-1px);
        }

        #selectFriendModal .loading-friends-modal,
        #selectFriendModal .no-friends-modal {
            text-align: center;
            padding: 20px;
            color: var(--text-light);
        }

        #selectFriendModal .loading-friends-modal i {
            font-size: 2rem;
            color: var(--accent-color);
            margin-bottom: 10px;
            display: block;
        }

        #selectFriendModal .loading-friends-modal p {
            margin: 0;
            font-size: 1rem;
        }

        .friends-snippet-section.show {
            display: block !important;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Recent Activity Section */
        .activity-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .activity-item {
            background-color: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            padding: 12px 15px;
            margin-bottom: 10px;
            font-size: 0.95rem;
            color: var(--text-color-secondary);
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid var(--border-light);
        }
        .activity-item i {
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        .activity-timestamp {
            font-size: 0.8em;
            color: var(--text-light);
            margin-left: auto;
        }
        .no-activity-message, .no-friends-message, .no-rewards-message {
            text-align: center;
            color: var(--text-light);
            margin-top: 10px;
            font-size: 1rem;
        }

        /* Customization Section */
        .customization-option {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        .customization-option label {
            margin-bottom: 0;
        }

        /* Account Settings Sub-section (from original Profile.html snippet) */
        .sub-section {
            margin-top: 30px;
            padding-top: 22px; /* Increased padding-top to give more space from previous section */
            border-top: 1px solid var(--border-light); /* Consistent border */
            text-align: left;
        }

        .sub-section h2 {
            font-family: 'Poppins', sans-serif;
            font-weight: 700; /* Consistent with h3 in settings */
            font-size: 1.5rem; /* Consistent with h3 in settings */
            color: var(--white);
            margin-bottom: 1rem; /* Consistent margin */
            text-align: center;
        }

        .sub-section .input-group {
            margin-bottom: 1rem; /* Consistent margin */
        }

        .sub-section .input-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-light); /* Consistent text color */
            font-weight: 600;
            font-size: 0.95rem;
        }

        .sub-section .input-group input[type="password"],
        .sub-section .input-group input[type="email"] { /* Added email input style */
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid var(--border-light);
            border-radius: 15px;
            background: var(--input-background);
            color: var(--white);
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .sub-section .input-group input[type="password"]:focus,
        .sub-section .input-group input[type="email"]:focus {
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(0, 213, 255, 0.2);
        }

        .sub-section button {
            background: var(--button-background); /* Consistent button style */
            color: var(--white);
            border: none;
            border-radius: 15px;
            padding: 0.7rem 1.2rem;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: var(--button-shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%; /* Make buttons full width */
            margin-top: 1rem; /* Space from inputs */
        }
        .sub-section button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--blue), 0 6px 20px var(--pink);
        }

        .sub-section p {
            color: var(--text-light); /* Consistent text color */
            font-size: 0.9rem; /* Consistent font size */
            margin-top: 20px;
            text-align: center; /* Center text */
        }

        .sub-section p a {
            color: var(--blue); /* Use var(--blue) for links */
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        .sub-section p a:hover {
            color: var(--pink); /* Consistent hover color */
        }

            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, 
                rgba(255, 255, 255, 0.15) 0%, 
                transparent 60%);
            animation: successPulse 2s ease-in-out infinite;
            pointer-events: none;
        }

        /* Success message animations */
        @keyframes successGradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes successShine {
            0% { left: -100%; }
            50% { left: 100%; }
            100% { left: 100%; }
        }

        @keyframes successFloat {
            0% { 
                transform: translateY(30px) scale(0.8);
                opacity: 0;
            }
            50% { 
                transform: translateY(-5px) scale(1.05);
            }
            100% { 
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        @keyframes successPulse {
            0%, 100% { 
                transform: scale(1);
                opacity: 0.1;
            }
            50% { 
                transform: scale(1.1);
                opacity: 0.2;
            }
        }





        /* Celebration success animations */
        @keyframes celebrationBounce {
            0% { transform: translateY(30px) scale(0.8); }
            50% { transform: translateY(-10px) scale(1.1); }
            75% { transform: translateY(-5px) scale(1.05); }
            100% { transform: translateY(0) scale(1); }
        }

        @keyframes achievementGlow {
            0% { 
                transform: translateY(30px) scale(0.8);
                box-shadow: 0 0 0 rgba(156, 39, 176, 0);
            }
            50% { 
                transform: translateY(-5px) scale(1.05);
                box-shadow: 0 0 30px rgba(156, 39, 176, 0.6);
            }
            100% { 
                transform: translateY(0) scale(1);
                box-shadow: 0 0 20px rgba(156, 39, 176, 0.4);
            }
        }

        @keyframes updatePulse {
            0% { transform: translateY(30px) scale(0.8); }
            50% { transform: translateY(-5px) scale(1.05); }
            100% { transform: translateY(0) scale(1); }
        }

        /* Professional Celebration Sparkles - Perfectly Contained */
        .celebration-sparkles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }

        .celebration-sparkles::before,
        .celebration-sparkles::after {
            content: '✨';
            position: absolute;
            font-size: 1.2rem;
            animation: sparkleFloat 2s ease-in-out infinite;
            z-index: 1;
        }

        .celebration-sparkles::before {
            top: 15%;
            left: 15%;
            animation-delay: 0s;
        }

        .celebration-sparkles::after {
            top: 65%;
            right: 15%;
            animation-delay: 1s;
        }

        @keyframes sparkleFloat {
            0%, 100% { 
                transform: translateY(0) rotate(0deg) scale(1);
                opacity: 0.8;
            }
            50% { 
                transform: translateY(-10px) rotate(180deg) scale(1.2);
                opacity: 1;
            }
        }

        /* Professional Achievement Glow - Perfectly Contained */
        .achievement-glow {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, 
                rgba(156, 39, 176, 0.25) 0%, 
                rgba(233, 30, 99, 0.15) 40%, 
                transparent 70%);
            animation: achievementGlowPulse 2s ease-in-out infinite;
            pointer-events: none;
            z-index: 1;
        }

        @keyframes achievementGlowPulse {
            0%, 100% { 
                transform: scale(1);
                opacity: 0.3;
            }
            50% { 
                transform: scale(1.1);
                opacity: 0.6;
            }
        }












        /* 🚀 SMART SUCCESS MESSAGE PANEL - Edge Slide System */
        .smart-success-panel {
            position: fixed;
            top: 50%;
            right: -400px; /* Start hidden off-screen */
            transform: translateY(-50%);
            width: 380px;
            background: linear-gradient(135deg, 
                rgba(76, 175, 80, 0.98), 
                rgba(139, 195, 74, 0.98), 
                rgba(76, 175, 80, 0.98));
            border-radius: 20px 0 0 20px;
            box-shadow: 
                -10px 0 30px rgba(76, 175, 80, 0.3),
                -5px 0 15px rgba(139, 195, 74, 0.2),
                inset 1px 0 0 rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(76, 175, 80, 0.3);
            border-right: none;
            backdrop-filter: blur(20px);
            z-index: 99999;
            transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            overflow: hidden;
        }

        .smart-success-panel.show {
            right: 0;
            transform: translateY(-50%) scale(1);
        }

        .smart-success-panel.hide {
            right: -400px;
            transform: translateY(-50%) scale(0.95);
        }

        .smart-success-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, 
                rgba(255, 255, 255, 0.9), 
                rgba(255, 255, 255, 0.6),
                rgba(255, 255, 255, 0.3));
            animation: smartSuccessProgress 4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        .smart-success-content {
            padding: 24px 28px 20px 28px;
            color: var(--white);
            text-align: left;
        }

        .smart-success-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .smart-success-icon {
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            animation: smartSuccessIconPop 0.8s ease-out 0.3s both;
        }

        .smart-success-close {
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.15);
            border: none;
            border-radius: 50%;
            color: var(--white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .smart-success-close:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.1);
        }

        .smart-success-close:active {
            transform: scale(0.95);
        }

        .smart-success-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 8px;
            animation: smartSuccessTextSlide 0.6s ease-out 0.5s both;
        }

        .smart-success-message {
            font-size: 1rem;
            line-height: 1.5;
            opacity: 0.95;
            animation: smartSuccessTextSlide 0.6s ease-out 0.7s both;
        }

        .smart-success-footer {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: smartSuccessTextSlide 0.6s ease-out 0.9s both;
        }

        .smart-success-timestamp {
            font-size: 0.85rem;
            opacity: 0.8;
        }

        .smart-success-sound-indicator {
            width: 16px;
            height: 16px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            animation: smartSuccessPulse 2s ease-in-out infinite;
        }

        /* Smart Success Animations */
        @keyframes smartSuccessProgress {
            0% { 
                width: 0%; 
                opacity: 1;
            }
            100% { 
                width: 100%; 
                opacity: 0;
            }
        }
        @keyframes smartSuccessIconPop {
            0% {
                transform: scale(0) rotate(-180deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.2) rotate(0deg);
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        @keyframes smartSuccessTextSlide {
            0% {
                transform: translateX(30px);
                opacity: 0;
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes smartSuccessPulse {
            0%, 100% { 
                transform: scale(1);
                opacity: 0.8;
            }
            50% { 
                transform: scale(1.2);
                opacity: 1;
            }
        }

        /* Mobile Responsive Smart Success Panel */
        @media (max-width: 768px) {
            .smart-success-panel {
                width: 320px;
                right: -320px;
            }
            
            .smart-success-panel.show {
                right: 0;
            }
            
            .smart-success-panel.hide {
                right: -320px;
            }
            
            .smart-success-content {
                padding: 20px 24px 16px 24px;
            }
            
            .smart-success-icon {
                width: 40px;
                height: 40px;
                font-size: 1.3rem;
            }
            
            .smart-success-title {
                font-size: 1.2rem;
            }
        }

        @media (max-width: 480px) {
            .smart-success-panel {
                width: 280px;
                right: -280px;
            }
            
            .smart-success-panel.show {
                right: 0;
            }
            
            .smart-success-panel.hide {
                right: -280px;
            }
            
            .smart-success-content {
                padding: 18px 20px 14px 20px;
            }
            
            .smart-success-icon {
                width: 36px;
                height: 36px;
                font-size: 1.2rem;
            }
            
            .smart-success-title {
                font-size: 1.1rem;
            }
            
            .smart-success-message {
                font-size: 0.95rem;
            }
        }







        @keyframes pulse-bg {
            0% { background-color: var(--accent-color); }
            50% { background-color: rgba(0, 213, 255, 0.7); }
            100% { background-color: var(--accent-color); }
        }


        .button-text { display: block; }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Enhanced Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes loading-shimmer {
            0% { background-position: -200px 0; }
            100% { background-position: calc(200px + 100%) 0; }
        }

        .fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }

        .hover-lift {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .hover-lift:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        /* Loading Skeleton Animation */
        .loading-skeleton {
            background: linear-gradient(90deg, 
                rgba(255, 255, 255, 0.1) 25%, 
                rgba(255, 255, 255, 0.2) 50%, 
                rgba(255, 255, 255, 0.1) 75%);
            background-size: 200px 100%;
            animation: loading-shimmer 1.5s infinite;
            border-radius: 4px;
        }

        .skeleton-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
        }

        .skeleton-text {
            height: 20px;
            margin: 8px 0;
        }
        .skeleton-text.short {
            width: 60%;
        }
        .skeleton-text.medium {
            width: 80%;
        }

        /* Custom Confirmation Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: var(--card-background);
            padding: 30px;
            border-radius: var(--radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
            max-width: 400px;
            width: 90%;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .modal-overlay.active .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .modal-content h3 {
            color: var(--white);
            margin-top: 0;
            margin-bottom: 20px;
            font-family: 'Poppins', sans-serif;
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
        }
        .modal-buttons button {
            padding: 10px 25px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .modal-buttons button.confirm-btn {
            background: linear-gradient(90deg, var(--pink), var(--blue));
            color: var(--white);
            box-shadow: 0 4px 10px rgba(0, 213, 255, 0.3);
        }
        .modal-buttons button.confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 213, 255, 0.4);
        }
        .modal-buttons button.cancel-btn {
            background: var(--input-background);
            color: var(--text-light);
            border: 1px solid var(--border-light);
        }
        .modal-buttons button.cancel-btn:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.1);
        }

        /* NEW: JCoin Request Modal Styles */
        #jcoinRequestModal.modal-overlay { /* Specificity for this modal */
            background-color: rgba(0, 0, 0, 0.6);
        }

        #jcoinRequestModal .modal-content {
            max-width: 500px;
            text-align: left;
        }
        #jcoinRequestModal .modal-content h3 {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        #jcoinRequestModal .modal-content h3 i {
            /* Apply gradient to modal header icon */
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-right: 10px;
        }
        #jcoinRequestModal .modal-content .input-group {
            margin-bottom: 1rem;
        }
        #jcoinRequestModal .modal-content .input-group input[type="number"],
        #jcoinRequestModal .modal-content .input-group input[type="file"] {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid var(--border-light);
            border-radius: 15px;
            background: var(--input-background);
            color: var(--white);
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        #jcoinRequestModal .modal-content .input-group input[type="number"]:focus,
        #jcoinRequestModal .modal-content .input-group input[type="file"]:focus {
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(0, 213, 255, 0.2);
        }
        #jcoinRequestModal .modal-content .file-input-label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-light);
            font-weight: 600;
            font-size: 0.95rem;
            text-align: left;
        }
        #jcoinRequestModal .modal-content .file-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--input-background);
            border: 1px solid var(--border-light);
            border-radius: 15px;
            padding: 0.8rem 1rem;
            cursor: pointer;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        #jcoinRequestModal .modal-content .file-input-wrapper:hover {
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(0, 213, 255, 0.2);
        }
        #jcoinRequestModal .modal-content .file-input-wrapper i {
            /* Apply gradient to file input icon */
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        #jcoinRequestModal .modal-content .file-name {
            flex-grow: 1;
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .gradient-text { /* Reused from Home.html for consistency */
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        #jcoinRequestModal .modal-content .receipt-preview {
            max-width: 100px;
            max-height: 100px;
            border-radius: 8px;
            object-fit: cover;
            margin-top: 10px;
            border: 1px solid var(--border-light);
            display: none;
        }
        .modal-button {
            background: var(--button-background);
            color: var(--white);
            border: none;
            border-radius: 15px;
            padding: 0.7rem 1.2rem;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: var(--button-shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1; /* Make buttons take equal width */
        }
        .modal-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--blue), 0 66px 20px var(--pink);
        }
        .modal-button.cancel-button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-light);
            box-shadow: none;
        }
        .modal-button.cancel-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 1.5rem;
        }

        /* NEW: Report User Modal Styles */
        #reportUserModal.modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
        }
        #reportUserModal .modal-content {
            max-width: 500px;
            text-align: left;
        }
        #reportUserModal .modal-content h3 {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        #reportUserModal .modal-content h3 i {
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-right: 10px;
        }
        #reportUserModal .modal-content label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-light);
            font-weight: 600;
            font-size: 0.95rem;
        }
        #reportUserModal .modal-content textarea,
        #reportUserModal .modal-content select {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid var(--border-light);
            border-radius: 15px;
            background: var(--input-background);
            color: var(--white);
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        #reportUserModal .modal-content textarea:focus,
        #reportUserModal .modal-content select:focus {
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(0, 213, 255, 0.2);
        }
        #reportUserModal .modal-content .button-group {
            justify-content: center; /* Center buttons in modal */
        }


        /* Enhanced Responsive Design */
        @media (max-width: 768px) {
            .profile-section {
                width: 95%;
                padding: 1.5rem;
                margin: 15px auto;
            }

            .profile-pic-wrapper {
                width: 100px;
                height: 100px;
            }

            .profile-name {
                font-size: 1.8rem;
            }

            .profile-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
                padding: 15px;
            }

            .stat-item {
                padding: 12px 8px;
                min-height: 70px;
            }

            .profile-action-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .profile-action-button {
                width: 100%;
                padding: 1rem 1.5rem;
            }

            /* Enhanced mobile header */
            .header-content {
                padding: 0 15px;
            }

            .notification-icon-wrapper {
                margin-right: 10px;
            }

            .notification-icon-wrapper a {
                width: 35px;
                height: 35px;
            }

            .notification-icon-wrapper i {
                font-size: 1.1rem;
            }

            .user-profile-header span {
                font-size: 0.9rem;
                max-width: 120px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            /* Mobile-optimized friend items */
            .friend-item {
                padding: 12px;
            }

            .chat-with-friend-btn {
                padding: 10px 14px;
                font-size: 0.8rem;
            }

            .friends-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                gap: 12px;
            }

        }

        @media (max-width: 480px) {
            .profile-section {
                width: 98%;
                padding: 1rem;
                margin: 10px auto;
            }

            .profile-pic-wrapper {
                width: 80px;
                height: 80px;
            }

            .profile-name {
                font-size: 1.5rem;
            }

            .profile-stats {
                grid-template-columns: repeat(2, 1fr);
                padding: 12px;
                gap: 10px;
            }

            .stat-item {
                padding: 10px 6px;
                min-height: 60px;
            }

            .stat-value {
                font-size: 1.2rem;
            }

            .stat-label {
                font-size: 0.75rem;
            }

            .profile-action-button {
                padding: 0.8rem 1rem;
                font-size: 0.8rem;
            }

            /* Mobile header adjustments */
            .header-content {
                padding: 0 10px;
            }

            .notification-icon-wrapper a {
                width: 32px;
                height: 32px;
            }

            .notification-icon-wrapper i {
                font-size: 1rem;
            }

            .user-profile-header span {
                font-size: 0.8rem;
                max-width: 100px;
            }
        }

        /* Enhanced mobile responsiveness for scrolling */
        @media (max-width: 768px) {
            .content-wrapper {
                padding: 15px;
            }
            
            .profile-section,
            .unlocked-rewards-section,
            .recent-activity-section,
            .customization-section,
            .wallet-guide-section {
                width: 95%;
                padding: 1.5rem;
                margin: 15px auto;
            }

            /* Mobile-specific touch improvements */
            ::-webkit-scrollbar {
                width: 14px; /* Even wider on mobile for better touch */
            }




        }

        /* Additional touch improvements for very small screens */
        @media (max-width: 480px) {
            .content-wrapper {
                /* Removed forced scroll snapping for better natural scrolling */
            }
            
            .profile-section,
            .unlocked-rewards-section,
            .recent-activity-section,
            .customization-section,
            .wallet-guide-section {
                /* Removed forced scroll snapping for better natural scrolling */
            }


        }

        /* NEW: User Information Section Styles */
        .user-info-section {
            background: var(--card-background);
            border: 1px solid var(--glass-blue);
            backdrop-filter: blur(10px) saturate(180%);
            border-radius: var(--radius);
            box-shadow: 0 8px 25px rgba(0, 0, 0, .3);
            padding: 2rem;
            width: 90%;
            max-width: 600px;
            margin: 20px auto;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            position: relative;
            transition: all 0.3s ease;
            overflow: visible;
        }

        .user-info-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--blue), var(--pink));
            border-radius: var(--radius) var(--radius) 0 0;
        }

        .user-info-section:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, .4);
        }

        .user-info-header {
            text-align: center;
            margin-bottom: 1rem;
        }

        .user-info-title {
            font-family: 'Poppins', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            margin: 0 0 0.5rem 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .user-info-subtitle {
            color: var(--text-light);
            font-size: 0.95rem;
            margin: 0;
        }

        /* Profile Display Section */
        .profile-display-section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .profile-display-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .profile-display-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 1rem;
            transition: all 0.3s ease;
        }

        .profile-display-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }

        .profile-display-item.full-width {
            grid-column: 1 / -1;
        }

        .display-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .display-label i {
            color: var(--blue);
            font-size: 1rem;
        }

        .display-value {
            color: var(--white);
            font-size: 1rem;
            line-height: 1.4;
            word-wrap: break-word;
        }

        /* Profile Edit Form */
        .profile-edit-form {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-light);
            border-radius: 15px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .edit-form-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--white);
            margin: 0 0 1rem 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .edit-form-title i {
            color: var(--pink);
        }

        .edit-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            font-weight: 600;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group textarea {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 0.8rem;
            color: var(--white);
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--blue);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 3px rgba(0, 213, 255, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .edit-form-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1.5rem;
        }

        .save-btn,
        .cancel-btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .save-btn {
            background: linear-gradient(135deg, var(--blue), var(--pink));
            color: var(--white);
            box-shadow: 0 4px 15px rgba(0, 213, 255, 0.3);
        }

        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 213, 255, 0.4);
        }

        .cancel-btn {
            background: rgba(255, 255, 255, 0.1);
            color: var(--white);
            border: 1px solid var(--border-light);
        }

        .cancel-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        /* User Info Actions */
        .user-info-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }

        .action-btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .edit-btn {
            background: linear-gradient(135deg, var(--pink), var(--blue));
            color: var(--white);
            box-shadow: 0 4px 15px rgba(255, 46, 146, 0.3);
        }

        .edit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 46, 146, 0.4);
        }

        .view-btn {
            background: rgba(255, 255, 255, 0.1);
            color: var(--white);
            border: 1px solid var(--border-light);
        }

        .view-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        /* User Info Toggle Button Specific Styles */
        .user-info-toggle {
            background: linear-gradient(135deg, var(--blue), var(--pink));
            position: relative;
            overflow: hidden;
        }

        .user-info-toggle::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .user-info-toggle:hover::before {
            left: 100%;
        }

        .user-info-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--blue), 0 6px 20px var(--pink);
        }

        /* Mobile Responsiveness for User Info Section */
        @media (max-width: 768px) {
            .user-info-section {
                width: 95%;
                padding: 1.5rem;
                margin: 15px auto;
            }

            .profile-display-grid {
                grid-template-columns: 1fr;
            }

            .edit-form-grid {
                grid-template-columns: 1fr;
            }

            .edit-form-actions,
            .user-info-actions {
                flex-direction: column;
            }

            .action-btn,
            .save-btn,
            .cancel-btn {
                width: 100%;
                justify-content: center;
            }

            /* Enhanced mobile scrolling */
            .content-wrapper {
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
            }
        }

        @media (max-width: 480px) {
            .user-info-section {
                width: 98%;
                padding: 1rem;
                margin: 10px auto;
            }

            .user-info-title {
                font-size: 1.5rem;
            }

            .profile-display-item {
                padding: 0.8rem;
            }
        }

        /* Responsive Adjustments (from Home.html / privacy_settings.html) */
        @media (max-width: 600px) {
            header .header-content-wrapper {
                padding: 0 20px;
            }
            .logo {
                font-size: 1.6rem;
            }
            header nav ul {
                display: none;
            }
            header nav ul li a {
                font-size: 1.1rem;
            }
            .user-profile-header #profileLink {
                padding: 5px;
            }
            .user-profile-header span {
                max-width: 90px;
            }
            .user-profile-header img {
                width: 30px;
                height: 30px;
            }
            .user-profile-header i {
                font-size: 25px;
            }
            #logoutButton {
                width: 25px;
                height: 25px;
                font-size: 0.8rem;
                margin-left: 8px;
            }
            #logoutButton i {
                font-size: 0.8rem;
            }
            .profile-section {
                padding: 1.5rem;
            }
            .profile-name {
                font-size: 1.8rem;
            }
            .profile-bio, .profile-location, .profile-email, .profile-info-item {
                font-size: 0.9rem;
            }
            .profile-level-icon {
                font-size: 2rem;
            }
            .profile-level-name {
                font-size: 1.2rem;
            }
            .profile-stats {
                gap: 10px;
            }
            .stat-value {
                font-size: 1.2rem;
            }
            .stat-label {
                font-size: 0.75rem;
            }
            .profile-action-button {
                padding: 0.7rem 1.2rem;
                font-size: 0.8rem;
            }

            .profile-details-section label {
                font-size: 0.85rem;
            }
            .profile-details-section input[type="text"],
            .profile-details-section input[type="url"],
            .profile-details-section textarea,
            .profile-details-section select { /* NEW */
                padding: 0.7rem 0.9rem;
                font-size: 0.9rem;
            }
            .privacy-toggle-group label {
                font-size: 0.9rem;
            }
            .toggle-switch {
                transform: scale(0.8); /* Scale down for mobile */
                transform-origin: right center;
            }
            .unlocked-rewards-section h3, .friends-snippet-section h3, .recent-activity-section h3, .customization-section h3 {
                font-size: 1.2rem;
            }
            .rewards-grid, .friends-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                gap: 10px;
            }

            /* Mobile-optimized modal */
            .modal-content {
                padding: 20px;
                max-width: 95%;
                max-height: 90vh;
            }

            #selectFriendModal .friend-item {
                padding: 10px 12px;
            }

            #selectFriendModal .search-input {
                padding: 10px 12px;
                font-size: 16px; /* Prevents zoom on iOS */
            }
            .reward-item, .friend-item {
                font-size: 0.8rem;
            }
            .reward-icon {
                font-size: 2rem;
            }
            .friend-pic-wrapper {
                width: 50px;
                height: 50px;
            }
            .activity-item {
                font-size: 0.85rem;
                padding: 10px;
            }
            .activity-item i {
                font-size: 1rem;
            }
            .customization-option label {
                font-size: 0.85rem;
            }
            .sub-section h2 {
                font-size: 1.3rem;
            }
            .sub-section .input-group label {
                font-size: 0.85rem;
            }
            .sub-section .input-group input[type="password"],
            .sub-section .input-group input[type="email"] {
                padding: 0.7rem 0.9rem;
                font-size: 0.9rem;
            }
            .sub-section button {
                padding: 0.6rem 1rem;
                font-size: 0.8rem;
            }
            .sub-section p {
                font-size: 0.8rem;
            }
            body {
                padding-bottom: 0px; /* Adjusted for no nav/toggle */
            }
        }


    </style>
</head>
<body class="theme-dark-mode">
    <!-- JCHAT Pink & Blue Glowing Loader -->
    <div id="jchatLoader" class="jchat-loader">
        <div class="loader-container">
            <div class="loader-meter" aria-hidden="true"></div>
            <div class="loader-spinner"></div>
            <div class="loader-progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                <span class="loader-progress-text">0%</span>
            </div>
            <div class="loader-particles">
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
            </div>
            <div class="loader-text">JCHAT</div>
            <div class="loader-subtext">
                Loading your profile
                <span class="loader-dots">
                    <span class="loader-dot"></span>
                    <span class="loader-dot"></span>
                    <span class="loader-dot"></span>
                </span>
            </div>
        </div>
    </div>

    <!-- Smart Success Message Panel -->
    <div class="smart-success-panel" id="smartSuccessPanel">
        <div class="smart-success-content">
            <div class="smart-success-header">
                <div class="smart-success-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <button class="smart-success-close" aria-label="Close success message">×</button>
            </div>
            <div class="smart-success-title" id="smartSuccessTitle">Success!</div>
            <div class="smart-success-message" id="smartSuccessMessage">Operation completed successfully.</div>
            <div class="smart-success-footer">
                <div class="smart-success-timestamp" id="smartSuccessTimestamp"></div>
                <div class="smart-success-sound-indicator">🔊</div>
            </div>
        </div>
    </div>

    <header>
        <div class="header-content-wrapper">
            <a href="/Home.html" class="logo">JCHAT</a>
            <nav>
                <ul>
                    <!-- Removed Home and Profile links from header navigation -->
                </ul>
            </nav>
            <div class="user-profile-header">
                <!-- NEW: Admin Icon Link (hidden by default) -->
                <a href="/gas_management.html" id="adminIconLink" aria-label="Admin Dashboard">
                    <i class="fas fa-user-cog"></i>
                </a>
                <!-- Notification Icon with Badge -->
                <div class="notification-icon-wrapper">
                    <a href="/notifications.html" aria-label="Notifications">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notificationCount" style="display: none;">0</span>
                    </a>
                </div>




                    



















            </div>
        </div>
    </header>

    <main>
        <div class="content-wrapper">
                            <div class="profile-section">
                <div id="profileCoverWrapper" style="width:100%;height:180px;border-radius:14px;overflow:hidden;position:relative;margin-bottom:12px;background:rgba(255,255,255,0.05);border:1px solid var(--border-light);">
                    <img id="profileCoverImg" alt="Cover" style="width:100%;height:100%;object-fit:cover;display:none;">
                    <input type="file" id="profileCoverUploadInput" accept="image/*" style="display:none;">
                    <label for="profileCoverUploadInput" id="editCoverOverlay" style="position:absolute;right:10px;bottom:10px;background:rgba(0,0,0,0.5);padding:6px 10px;border-radius:8px;cursor:pointer;display:none;"><i class="fas fa-camera"></i> Edit Cover</label>
                </div>

                <div class="profile-header-area">
                    <div class="profile-pic-wrapper" id="profilePicWrapper">
                        <img id="profilePagePic" src="" alt="Profile Picture" class="profile-pic" style="display: none;">
                        <i id="profilePageAvatarIcon" class="fas fa-user-circle profile-pic-placeholder"></i>
                        <input type="file" id="profilePicUploadInput" accept="image/*" style="display: none;">
                        <label for="profilePicUploadInput" class="edit-profile-pic-overlay" id="editProfilePicOverlay">
                            <i class="fas fa-camera"></i> Edit
                        </label>
                         <!-- NEW: Loading spinner for profile pic -->
                    </div>
                    <h2 id="profileUsername" class="profile-name">Username</h2>
                    <p id="profileBio" class="profile-bio">No bio provided yet.</p>
                    
                    <!-- NEW: Profile Completion Progress Bar -->
                    <div class="profile-completion-section">
                        <div class="completion-header">
                            <span class="completion-label">Profile Completion</span>
                            <span id="completionPercentage" class="completion-percentage">0%</span>
                        </div>
                        <div class="completion-progress-bar">
                            <div id="completionProgressFill" class="completion-progress-fill"></div>
                        </div>
                        <p class="completion-tip" id="completionTip">Complete your profile to unlock more features!</p>
                    </div>

                    <!-- NEW: Smart Profile Notifications -->
                    <div class="profile-notifications-section" id="profileNotificationsSection" style="display: none;">
                        <div class="notifications-header">
                            <i class="fas fa-bell"></i>
                            <span>Profile Notifications</span>
                            <button class="clear-notifications-btn" id="clearNotificationsBtn">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="notifications-list" id="notificationsList">
                            <!-- Notifications will be populated here -->
                        </div>
                    </div>
                    
                    <!-- NEW: User ID Display -->
                    <p id="profileUserId" class="profile-info-item user-id-container" style="display: none;">
                        <i class="fas fa-id-card"></i> 
                        <span class="user-id-label">User ID:</span>
                        <span id="userIdText" class="user-id-text"></span>
                        <button id="copyUserIdBtn" class="copy-user-id-btn" title="Copy User ID">
                            <i class="fas fa-copy"></i>
                        </button>
                    </p>
                    
                    <p id="profileLocation" class="profile-info-item" style="display: none;"><i class="fas fa-map-marker-alt"></i> <span id="locationText"></span></p>
                    <p id="profileEmail" class="profile-info-item" style="display: none;"><i class="fas fa-envelope"></i> <span id="emailText"></span></p>
                    
                    <!-- New Profile Information Fields -->
                    <p id="profileFullName" class="profile-info-item" style="display: none;"><i class="fas fa-user"></i> <span id="fullNameText"></span></p>
                    <p id="profileDateOfBirth" class="profile-info-item" style="display: none;"><i class="fas fa-birthday-cake"></i> <span id="dateOfBirthText"></span></p>
                    <p id="profileGender" class="profile-info-item" style="display: none;"><i class="fas fa-venus-mars"></i> <span id="genderText"></span></p>
                    <p id="profilePhone" class="profile-info-item" style="display: none;"><i class="fas fa-phone"></i> <span id="phoneText"></span></p>
                    <p id="profileCountry" class="profile-info-item" style="display: none;"><i class="fas fa-flag"></i> <span id="countryText"></span></p>
                    <p id="profileCity" class="profile-info-item" style="display: none;"><i class="fas fa-city"></i> <span id="cityText"></span></p>
                    <p id="profileLanguage" class="profile-info-item" style="display: none;"><i class="fas fa-language"></i> <span id="languageText"></span></p>
                    <p id="profileTimezone" class="profile-info-item" style="display: none;"><i class="fas fa-clock"></i> <span id="timezoneText"></span></p>
                    
                    <p id="profileSchool" class="profile-info-item" style="display: none;"><i class="fas fa-graduation-cap"></i> <span id="schoolText"></span></p>
                    <p id="profileWork" class="profile-info-item" style="display: none;"><i class="fas fa-briefcase"></i> <span id="workText"></span></p>
                    <p id="profileWebsite" class="profile-info-item" style="display: none;"><i class="fas fa-globe"></i> <a id="websiteLink" href="#" target="_blank" rel="noopener noreferrer" class="gradient-text"></a></p>
                    <p id="profileSocialLinks" class="profile-info-item" style="display: none;"><i class="fas fa-share-alt"></i> <span id="socialLinksText"></span></p>

                    <!-- NEW: Level Info Display -->
                    <div class="profile-level-info">
                        <i id="xpLevelIcon" class="fas fa-question-circle profile-level-icon"></i>
                        <span id="xpLevelName" class="profile-level-name">Loading Level...</span>
                    </div>
                                    <div class="progress-bar-container" id="progressBarContainer">
                    <div id="xpProgressBarFill" class="progress-bar-fill" style="background-position: right;"></div>
                    <div id="progressPercentage" class="progress-percentage">0%</div>
                </div>
                    <!-- End NEW: Level Info Display -->

                </div>

                <div class="profile-stats">
                    <div class="stat-item">
                        <span id="statPosts" class="stat-value">0</span>
                        <span class="stat-label">Posts</span>
                    </div>
                    <div class="stat-item friends-button" id="friendsStatItem" data-stat="friends">
                        <span id="statFriends" class="stat-value">0</span>
                        <span class="stat-label">View Friends</span>
                        <i class="fas fa-users button-icon" id="friendsButtonIcon"></i>
                    </div>
                    <div class="stat-item">
                        <span id="statFollowers" class="stat-value">0</span>
                        <span class="stat-label">Followers</span>
                    </div>
                    <div class="stat-item">
                        <span id="statFollowing" class="stat-value">0</span>
                        <span class="stat-label">Following</span>
                    </div>
                    <!-- JCoins with Exchange Rate -->
                    <div class="stat-item" id="jcoinStatItem">
                        <span id="jCoins" class="stat-value">0</span>
                        <span class="stat-label">JCoins</span>
                        <p class="jcoin-exchange-rate" id="jcoinExchangeRate" style="display: none;">
                            <span id="jcoinUSDValue">$0.00</span> USD
                        </p>
                    </div>
                    <!-- NEW: Gas (XP) Stat Item -->
                    <div class="stat-item" id="gasStatItem">
                        <span id="gasValue" class="stat-value">0</span>
                        <span class="stat-label">Gas (XP)</span>
                    </div>
                </div>

                <div class="profile-actions" id="profileActions">
                    <!-- Buttons will be dynamically added/hidden based on owner/viewer -->
                    <!-- Removed Edit Profile Button -->

                    <!-- NEW: User Information Toggle Button -->
                    <button id="userInfoToggle" class="profile-action-button primary user-info-toggle">
                        <i class="fas fa-user-circle"></i>
                        <span class="toggle-text">Show User Info</span>
                    </button>

                    <!-- NEW: Wallet Link -->

                    


                    <!-- NEW: Report User Button (only visible for other users) -->
                    <button id="reportUserButton" class="profile-action-button danger" style="display: none;">
                        <i class="fas fa-flag"></i> Report User
                    </button>

                    <!-- Removed Add Friend and Message buttons as requested -->
                </div>

                <!-- NEW: User Information Section -->
                <div id="userInfoSection" class="user-info-section" style="display: none;">
                    <div class="user-info-header">
                        <h3 class="user-info-title">
                            <i class="fas fa-user-edit"></i>
                            User Information
                        </h3>
                        <p class="user-info-subtitle">Manage your profile details and preferences</p>
                    </div>

                    <!-- Profile Display Section -->
                    <div class="profile-display-section">
                        <div class="profile-display-grid">
                            <div class="profile-display-item">
                                <div class="display-label">
                                    <i class="fas fa-user"></i>
                                    Display Name
                                </div>
                                <div class="display-value" id="displayNameValue">Not set</div>
                            </div>
                            
                            <div class="profile-display-item">
                                <div class="display-label">
                                    <i class="fas fa-envelope"></i>
                                    Email
                                </div>
                                <div class="display-value" id="emailValue">Not set</div>
                            </div>
                            
                            <div class="profile-display-item">
                                <div class="display-label">
                                    <i class="fas fa-phone"></i>
                                    Phone
                                </div>
                                <div class="display-value" id="phoneValue">Not set</div>
                            </div>
                            
                            <div class="profile-display-item">
                                <div class="display-label">
                                    <i class="fas fa-map-marker-alt"></i>
                                    Location
                                </div>
                                <div class="display-value" id="locationValue">Not set</div>
                            </div>
                            
                            <div class="profile-display-item">
                                <div class="display-label">
                                    <i class="fas fa-graduation-cap"></i>
                                    School
                                </div>
                                <div class="display-value" id="schoolValue">Not set</div>
                            </div>
                            
                            <div class="profile-display-item">
                                <div class="display-label">
                                    <i class="fas fa-briefcase"></i>
                                    Work
                                </div>
                                <div class="display-value" id="workValue">Not set</div>
                            </div>
                        </div>
                        
                        <div class="profile-display-item full-width">
                            <div class="display-label">
                                <i class="fas fa-quote-left"></i>
                                Bio
                            </div>
                            <div class="display-value" id="bioValue">Not set</div>
                        </div>
                        
                        <div class="profile-display-item full-width">
                            <div class="display-label">
                                <i class="fas fa-heart"></i>
                                Interests
                            </div>
                            <div class="display-value" id="interestsValue">Not set</div>
                        </div>
                    </div>

                    <!-- Profile Edit Form -->
                    <div class="profile-edit-form" id="profileEditForm" style="display: none;">
                        <h4 class="edit-form-title">
                            <i class="fas fa-edit"></i>
                            Edit Profile
                        </h4>
                        
                        <div class="edit-form-grid">
                            <div class="form-group">
                                <label for="editDisplayName">Display Name</label>
                                <input type="text" id="editDisplayName" placeholder="Enter your display name">
                            </div>
                            
                            <div class="form-group">
                                <label for="editEmail">Email</label>
                                <input type="email" id="editEmail" placeholder="Enter your email address">
                            </div>
                            
                            <div class="form-group">
                                <label for="editPhone">Phone</label>
                                <input type="tel" id="editPhone" placeholder="Enter your phone number">
                            </div>
                            
                            <div class="form-group">
                                <label for="editLocation">Location</label>
                                <input type="text" id="editLocation" placeholder="Enter your location">
                            </div>
                            
                            <div class="form-group">
                                <label for="editSchool">School</label>
                                <input type="text" id="editSchool" placeholder="Enter your school">
                            </div>
                            
                            <div class="form-group">
                                <label for="editWork">Work</label>
                                <input type="text" id="editWork" placeholder="Enter your work">
                            </div>
                        </div>
                        
                        <div class="form-group full-width">
                            <label for="editBio">Bio</label>
                            <textarea id="editBio" rows="3" placeholder="Tell us about yourself..."></textarea>
                        </div>
                        
                        <div class="form-group full-width">
                            <label for="editInterests">Interests</label>
                            <textarea id="editInterests" rows="2" placeholder="What are your interests?"></textarea>
                        </div>
                        
                        <div class="edit-form-actions">
                            <button type="button" id="saveProfileChanges" class="save-btn">
                                <i class="fas fa-save"></i>
                                Save Changes
                            </button>
                            <button type="button" id="cancelProfileEdit" class="cancel-btn">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                        </div>
                    </div>

                    <!-- Privacy Settings Section -->
                    <div class="privacy-settings-section" id="privacySettingsSection" style="display: none;">
                        <h4 class="privacy-section-title">
                            <i class="fas fa-shield-alt"></i>
                            Privacy Settings
                        </h4>
                        <p class="privacy-section-subtitle">Control who can see your information</p>
                        
                        <!-- Profile Information Visibility -->
                        <div class="privacy-category">
                            <h5 class="privacy-category-title">
                                <i class="fas fa-user"></i>
                                Profile Information
                            </h5>
                            
                            <div class="privacy-toggle-group">
                                <label>Make Email Public</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="toggleEmailVisibility">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            
                            <div class="privacy-toggle-group">
                                <label>Show Phone Number</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="togglePhoneVisibility">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            
                            <div class="privacy-toggle-group">
                                <label>Show Location</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="toggleLocationVisibility">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            
                            <div class="privacy-toggle-group">
                                <label>Show User ID</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="toggleUserIdVisibility">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            
                            <div class="privacy-toggle-group">
                                <label>Show School</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="toggleSchoolVisibility">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            
                            <div class="privacy-toggle-group">
                                <label>Show Work</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="toggleWorkVisibility">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            
                            <div class="privacy-toggle-group">
                                <label>Show Interests</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="toggleInterestsVisibility">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            
                            <div class="privacy-toggle-group">
                                <label>Show Website</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="toggleWebsiteVisibility">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            
                            <div class="privacy-toggle-group">
                                <label>Show Social Links</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="toggleSocialLinksVisibility">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Activity & Interaction Settings -->
                        <div class="privacy-category">
                            <h5 class="privacy-category-title">
                                <i class="fas fa-comments"></i>
                                Who Can Contact You
                            </h5>
                            
                            <div class="privacy-toggle-group">
                                <label>Show Online Status</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="toggleOnlineStatusVisibility">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            
                            <div class="privacy-toggle-group">
                                <label>Allow Friend Requests</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="toggleFriendRequests">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            
                            <div class="privacy-toggle-group">
                                <label>Allow Direct Messages</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="toggleMessages">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="privacy-actions">
                            <button type="button" id="savePrivacySettingsButton" class="save-privacy-btn">
                                <i class="fas fa-shield-alt"></i>
                                Save Privacy Settings
                            </button>
                        </div>
                    </div>

                    <!-- Profile Actions -->
                    <div class="user-info-actions">
                        <button id="editProfileBtn" class="action-btn edit-btn">
                            <i class="fas fa-edit"></i>
                            Edit Profile
                        </button>
                        <button id="viewProfileBtn" class="action-btn view-btn" style="display: none;">
                            <i class="fas fa-eye"></i>
                            View Profile
                        </button>
                        <button id="privacySettingsBtn" class="action-btn privacy-btn" style="display: none;">
                            <i class="fas fa-shield-alt"></i>
                            Privacy Settings
                        </button>
                    </div>
                </div>



            </div>
        </div>
    </main>

    <!-- Custom Message Box (reused from Home.html) -->


    <!-- Floating Contact Icon - Bottom Left -->
    <div id="contactIcon" class="contact-icon" title="Need Help? Contact Us!">
        <i class="fas fa-headset"></i>
    </div>

    <!-- Contact Help Modal -->
    <div id="contactModal" class="contact-modal">
        <div class="contact-modal-content">
            <div class="contact-modal-header">
                <h3>Need Help? We're Here For You!</h3>
                <button id="closeContactModal" class="close-contact-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="contact-modal-body">
                <div class="help-grid">
                    <div class="help-card contact-card">
                        <div class="help-icon">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <h4>Email Support</h4>
                        <p>Get help via email</p>
                        <a href="mailto:jchatguide@gmail.com" class="help-link">
                            jchatguide@gmail.com
                        </a>
                    </div>

                    <div class="help-card whatsapp-card">
                        <div class="help-icon">
                            <i class="fab fa-whatsapp"></i>
                        </div>
                        <h4>WhatsApp Support</h4>
                        <p>Quick help via WhatsApp</p>
                        <a href="https://wa.me/2349013790707" class="help-link" target="_blank">
                            +234 901 379 0707
                        </a>
                    </div>

                    <div class="help-card phone-card">
                        <div class="help-icon">
                            <i class="fas fa-phone"></i>
                        </div>
                        <h4>Phone Support</h4>
                        <p>Call us directly</p>
                        <a href="tel:+2349013790707" class="help-link">
                            +234 901 379 0707
                        </a>
                    </div>
                </div>

                <div class="help-info">
                    <div class="help-tip">
                        <i class="fas fa-lightbulb"></i>
                        <span>Pro Tip: For fastest support, use WhatsApp during business hours!</span>
                    </div>
                </div>

                <!-- Premium Features Section -->
                <div class="premium-features-section">
                    <h3 class="premium-section-title">
                        <i class="fas fa-crown"></i>
                        Premium Features
                    </h3>
                    <div class="premium-features-grid">
                        <div class="premium-feature-card">
                            <div class="feature-icon">
                                <i class="fas fa-wallet"></i>
                            </div>
                            <h4>Digital Wallet Access</h4>
                            <p>Unlock your digital wallet to manage JCoins, make transactions, and access premium services.</p>
                            <div class="feature-price">
                                <span class="price-amount">₦5,000</span>
                                <span class="price-description">One-time unlock</span>
                            </div>
                            <div class="feature-benefits">
                                <div class="benefit-item">
                                    <i class="fas fa-check"></i>
                                    <span>Secure JCoin transactions</span>
                                </div>
                                <div class="benefit-item">
                                    <i class="fas fa-check"></i>
                                    <span>Premium chat features</span>
                                </div>
                                <div class="benefit-item">
                                    <i class="fas fa-check"></i>
                                    <span>Exclusive profile customization</span>
                                </div>
                            </div>
                            <div class="feature-actions">
                                <a href="mailto:jchatguide@gmail.com" class="premium-contact-btn">
                                    <i class="fas fa-envelope"></i>
                                    Contact Admin
                                </a>
                                <a href="https://wa.me/2349013790707" class="premium-whatsapp-btn" target="_blank">
                                    <i class="fab fa-whatsapp"></i>
                                    WhatsApp
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Scroll Toggle Button - Pink and Blue Theme -->
    <div id="scrollToggleButton" class="scroll-toggle-btn" title="Scroll to Bottom">
        <i class="fas fa-chevron-down" id="scrollToggleIcon"></i>
    </div>

    <!-- Select Friend Modal (exactly like Chat.html) -->
    <div id="selectFriendModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Select a Friend to Chat With</h3>
            <input type="text" id="friendSearchInput" placeholder="Search friends..." class="search-input">
            <div id="friendListContainer" class="friend-list-modal">
                <div class="loading-friends-modal" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading friends...</p>
                </div>
                <p class="no-friends-modal" style="display: none;">No friends found.</p>
            </div>
            <div class="modal-buttons">
                <button id="closeFriendModalBtn" class="cancel-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- NEW: JCoin Request Modal -->
    <div id="jcoinRequestModal" class="modal-overlay">
        <div class="modal-content">
            <h3><i class="fas fa-coins"></i> Request JCoins</h3>
            <p style="color: var(--text-light); font-size: 0.9rem; text-align: center;">
                Enter the Naira amount you wish to purchase. You will be credited with JCoins based on the current exchange rate.
                <br>
                Amounts of <span class="gradient-text">#1000</span> and above receive a <span class="gradient-text">10% bonus</span>.
            </p>
            <div class="input-group">
                <label for="nairaAmountInput">Naira Amount (NGN):</label>
                <input type="number" id="nairaAmountInput" placeholder="e.g., 500, 1000, 5000" min="100">
                <p class="calculated-jcoins">You will get: <span id="calculatedJCoins">0 JCoins</span></p>
            </div>
            <div class="input-group">
                <label class="file-input-label" for="receiptUploadInput">Upload Payment Receipt:</label>
                <div class="file-input-wrapper">
                    <input type="file" id="receiptUploadInput" accept="image/*" style="display: none;">
                    <i class="fas fa-upload"></i>
                    <span class="file-name" id="receiptFileName">No file chosen</span>
                </div>
                <img id="receiptPreview" class="receipt-preview" style="display: none;">
            </div>
            <div class="button-group">
                <button id="cancelJCoinRequest" class="modal-button cancel-button">Cancel</button>
                <button id="submitJCoinRequestButton" class="modal-button save-button">
                    <span class="button-text">Submit Request</span>
                    
                </button>
            </div>
        </div>
    </div>

    <!-- NEW: Report User Modal -->
    <div id="reportUserModal" class="modal-overlay">
        <div class="modal-content">
            <h3><i class="fas fa-flag"></i> Report User</h3>
            <p style="color: var(--text-light); font-size: 0.9rem; text-align: center;">
                You are reporting <strong id="reportedUsernameDisplay" class="gradient-text"></strong>.
                Please select a reason and provide details.
            </p>
            <div class="input-group">
                <label for="reportReasonSelect">Reason:</label>
                <select id="reportReasonSelect">
                    <option value="">Select a reason</option>
                    <option value="harassment">Harassment / Bullying</option>
                    <option value="spam">Spam / Advertising</option>
                    <option value="inappropriate_content">Inappropriate Content</option>
                    <option value="impersonation">Impersonation</option>
                    <option value="scam">Scam / Fraud</option>
                    <option value="other">Other (please specify)</option>
                </select>
            </div>
            <div class="input-group">
                <label for="reportDetailsTextarea">Details (optional):</label>
                <textarea id="reportDetailsTextarea" rows="4" placeholder="Provide more details about the report..."></textarea>
            </div>
            <div class="button-group">
                <button id="cancelReportButton" class="modal-button cancel-button">Cancel</button>
                <button id="submitReportButton" class="modal-button save-button">
                    <span class="button-text">Submit Report</span>
                    
                </button>
            </div>
        </div>
    </div>
    <script type="module">
        // Import Firebase modules (Updated to v11.8.0 - Latest Stable)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, updateProfile, updateEmail, reauthenticateWithCredential, EmailAuthProvider, updatePassword, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, setDoc, deleteDoc, collection, query, where, getDocs, runTransaction, writeBatch, serverTimestamp, orderBy, addDoc, arrayUnion, documentId, onSnapshot } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-storage.js";
        import { Timestamp } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore.js";

        // --- Firebase & Canvas Environment Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyDz-8N0totzvMCvonF9pKj9RsoH3J8xL0w",
            authDomain: "jchat-1.firebaseapp.com",
            databaseURL: "https://jchat-1-default-rtdb.firebaseio.com",
            projectId: "jchat-1",
            storageBucket: "jchat-1.firebasestorage.app",
            messagingSenderId: "328479683167",
            appId: "1:328479683167:web:276c0b7e8ea44dd2d6a1ea",
            measurementId: "G-S6Z9GG0R9P"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; // Corrected: Use initialAuthToken variable

        // Cloudinary Configuration
        const cloudinaryConfig = {
            cloudName: "dxld01rcp", // Your Cloudinary Cloud Name
            uploadPreset: "Storage_preset" // Your Cloudinary Upload Preset
        };

        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- JCHAT Loader Management ---
        const jchatLoader = document.getElementById('jchatLoader');
        let loaderTimeout;

        const profileLoaderMessages = [
            'Initializing JCHAT',
            'Connecting to servers',
            'Loading your profile',
            'Setting up features',
            'Almost ready'
        ];

        const progressTextEl = jchatLoader?.querySelector('.loader-progress-text');
        const progressBarEl = jchatLoader?.querySelector('.loader-progress');
        const meterEl = jchatLoader?.querySelector('.loader-meter');
        let displayedProgress = 0;
        let targetProgress = 0;
        let progressRaf;

        function showLoader(message = 'Loading your profile') {
            if (jchatLoader) {
                const subtext = jchatLoader.querySelector('.loader-subtext');
                if (subtext) {
                    const dotsHtml = `<span class=\"loader-dots\">
                        <span class=\"loader-dot\"></span>
                        <span class=\"loader-dot\"></span>
                        <span class=\"loader-dot\"></span>
                    </span>`;
                    subtext.innerHTML = message + dotsHtml;
                }
                jchatLoader.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }
        }

        function hideLoader() {
            if (jchatLoader) {
                jchatLoader.classList.add('hidden');
                document.body.style.overflow = 'auto';
                setTimeout(() => {
                    if (jchatLoader.classList.contains('hidden')) {
                        jchatLoader.style.display = 'none';
                    }
                }, 500);
            }
        }

        function animateProgress() {
            if (!meterEl || !progressBarEl || !progressTextEl) return;
            const step = Math.max(0.5, (targetProgress - displayedProgress) * 0.12);
            if (displayedProgress < targetProgress) {
                displayedProgress = Math.min(targetProgress, displayedProgress + step);
                const deg = Math.round(displayedProgress * 3.6);
                meterEl.style.setProperty('--progress', `${deg}deg`);
                progressTextEl.textContent = `${Math.round(displayedProgress)}%`;
                progressBarEl.setAttribute('aria-valuenow', String(Math.round(displayedProgress)));
                const idx = Math.min(profileLoaderMessages.length - 1, Math.floor(displayedProgress / (100 / profileLoaderMessages.length)));
                showLoader(profileLoaderMessages[idx]);
                progressRaf = requestAnimationFrame(animateProgress);
            } else if (displayedProgress >= 100) {
                setTimeout(hideLoader, 300);
            }
        }

        function setProgress(p) {
            targetProgress = Math.min(100, Math.max(targetProgress, p));
            cancelAnimationFrame(progressRaf);
            progressRaf = requestAnimationFrame(animateProgress);
        }

        function initSmartLoader() {
            showLoader();
            // Watch images and stylesheets
            const imgs = Array.from(document.images);
            const links = Array.from(document.querySelectorAll('link[rel=\"stylesheet\"]'));
            const watchers = [];
            imgs.forEach(img => {
                if (!img.complete) {
                    watchers.push(new Promise(res => {
                        img.addEventListener('load', res, { once: true });
                        img.addEventListener('error', res, { once: true });
                    }));
                }
            });
            links.forEach(link => {
                watchers.push(new Promise(res => {
                    link.addEventListener('load', res, { once: true });
                    link.addEventListener('error', res, { once: true });
                }));
            });
            const total = watchers.length;
            let done = 0;
            if (total) {
                watchers.forEach(p => p.then(() => {
                    done++;
                    setProgress(40 + Math.round((done / total) * 40));
                }));
            }
            document.addEventListener('DOMContentLoaded', () => setProgress(25), { once: true });
            window.addEventListener('load', () => setProgress(90), { once: true });
            // Gentle creep to avoid stalls
            const creep = setInterval(() => {
                if (targetProgress < 95) setProgress(Math.min(95, targetProgress + 1));
                else clearInterval(creep);
            }, 700);
            // Fallback: force completion
            clearTimeout(loaderTimeout);
            loaderTimeout = setTimeout(() => setProgress(100), 12000);
        }

        initSmartLoader();

        // --- DOM Elements ---
        const headerProfilePic = document.getElementById('headerProfilePic');
        const headerAvatarIcon = document.getElementById('headerAvatarIcon');
        const headerDisplayName = document.getElementById('headerDisplayName');
        const notificationCountElement = document.getElementById('notificationCount');

        // const headerNavLinkProfile = document.getElementById('profileLink'); // Removed - element doesn't exist
        const adminIconLink = document.getElementById('adminIconLink');
        


        const profilePicWrapper = document.getElementById('profilePicWrapper'); // New wrapper for owner check
        const profilePagePic = document.getElementById('profilePagePic');
        const profilePageAvatarIcon = document.getElementById('profilePageAvatarIcon');
        const profilePicUploadInput = document.getElementById('profilePicUploadInput');
        const editProfilePicOverlay = document.getElementById('editProfilePicOverlay');

        const profileUsername = document.getElementById('profileUsername'); // H2 element for username
        const profileBio = document.getElementById('profileBio');
        
        // NEW: User ID elements
        const profileUserId = document.getElementById('profileUserId'); // P element container
        const userIdText = document.getElementById('userIdText'); // Span for User ID text
        const copyUserIdBtn = document.getElementById('copyUserIdBtn'); // Copy button
        
        const profileLocation = document.getElementById('profileLocation'); // P element container
        const locationText = document.getElementById('locationText'); // Span inside profileLocation
        const profileEmail = document.getElementById('profileEmail'); // P element container
        const emailText = document.getElementById('emailText'); // Span inside profileEmail

        // New Profile Information Elements
        const profileFullName = document.getElementById('profileFullName');
        const fullNameText = document.getElementById('fullNameText');
        const profileDateOfBirth = document.getElementById('profileDateOfBirth');
        const dateOfBirthText = document.getElementById('dateOfBirthText');
        const profileGender = document.getElementById('profileGender');
        const genderText = document.getElementById('genderText');
        const profilePhone = document.getElementById('profilePhone');
        const phoneText = document.getElementById('phoneText');
        const profileCountry = document.getElementById('profileCountry');
        const countryText = document.getElementById('countryText');
        const profileCity = document.getElementById('profileCity');
        const cityText = document.getElementById('cityText');
        const profileLanguage = document.getElementById('profileLanguage');
        const languageText = document.getElementById('languageText');
        const profileTimezone = document.getElementById('profileTimezone');
        const timezoneText = document.getElementById('timezoneText');

        // --- Notification Badge Management ---
        function updateNotificationBadge(count) {
            const notificationWrapper = document.querySelector('.notification-icon-wrapper');
            const notificationBadge = document.getElementById('notificationCount');
            if (notificationBadge && notificationWrapper) {
                if (count > 0) {
                    notificationBadge.textContent = count > 99 ? '99+' : count.toString();
                    notificationBadge.style.display = 'flex';
                    notificationWrapper.classList.add('has-notifications');
                    console.log('🔔 Notification badge updated:', count, 'notifications');
                } else {
                    notificationBadge.style.display = 'none';
                    notificationWrapper.classList.remove('has-notifications');
                    console.log('🔕 No notifications, badge hidden');
                }
            }
        }

        // NEW: User Info Display Elements
        const profileSchool = document.getElementById('profileSchool');
        const schoolText = document.getElementById('schoolText');
        const profileWork = document.getElementById('profileWork');
        const workText = document.getElementById('workText');
        const profileWebsite = document.getElementById('profileWebsite');
        const websiteLink = document.getElementById('websiteLink');
        const profileSocialLinks = document.getElementById('profileSocialLinks');
        const socialLinksText = document.getElementById('socialLinksText');

        const statPosts = document.getElementById('statPosts');
        const statFriends = document.getElementById('statFriends');
        const statFollowers = document.getElementById('statFollowers');
        const statFollowing = document.getElementById('statFollowing');
        const jCoinsSpan = document.getElementById('jCoins'); // Added for jCoins
        const jcoinExchangeRate = document.getElementById('jcoinExchangeRate'); // Added for exchange rate
        const jcoinUSDValue = document.getElementById('jcoinUSDValue'); // Added for USD value

        // XP Level Elements
        const gasValue = document.getElementById('gasValue'); // Gas (XP) value
        const xpLevelIcon = document.getElementById('xpLevelIcon');
        const xpLevelName = document.getElementById('xpLevelName');
        const progressBarContainer = document.getElementById('progressBarContainer'); // NEW: Get the container
        const xpProgressBarFill = document.getElementById('xpProgressBarFill');

        const profileActions = document.getElementById('profileActions');


        const claimDailyBonusButton = document.getElementById('claimDailyBonusButton'); // NEW
        const dailyBonusCountdown = document.getElementById('dailyBonusCountdown'); // NEW
        const reportUserButton = document.getElementById('reportUserButton'); // NEW

        // Inline Edit Fields
        const displayNameInput = document.getElementById('displayName'); // Input for display name
        const bioTextarea = document.getElementById('bio');
        const locationInput = document.getElementById('locationInput'); // Input for location
        // NEW: Inputs for additional user info
        const schoolInput = document.getElementById('schoolInput');

        // Profile Edit Form Fields
        const editDisplayNameInput = document.getElementById('editDisplayName');
        const editEmailInput = document.getElementById('editEmail');
        const editPhoneInput = document.getElementById('editPhone');
        const editLocationInput = document.getElementById('editLocation');
        const editSchoolInput = document.getElementById('editSchool');
        const editWorkInput = document.getElementById('editWork');
        const editBioTextarea = document.getElementById('editBio');
        const editInterestsTextarea = document.getElementById('editInterests');
        const workInput = document.getElementById('workInput');
        const interestsInput = document.getElementById('interestsInput');
        const websiteInput = document.getElementById('websiteInput');
        const socialLinksInput = document.getElementById('socialLinksInput');

        const saveProfileChanges = document.getElementById('saveProfileChanges'); // Renamed from saveProfileChangesButton

                    // Cover image wiring
            const profileCoverWrapper = document.getElementById('profileCoverWrapper');
            const profileCoverImg = document.getElementById('profileCoverImg');
            const profileCoverUploadInput = document.getElementById('profileCoverUploadInput');
            const editCoverOverlay = document.getElementById('editCoverOverlay');



            // NEW: Privacy Settings Toggles
            const toggleEmailVisibility = document.getElementById('toggleEmailVisibility');
            const togglePhoneVisibility = document.getElementById('togglePhoneVisibility');
            const toggleLocationVisibility = document.getElementById('toggleLocationVisibility');
            const toggleUserIdVisibility = document.getElementById('toggleUserIdVisibility');
            const toggleOnlineStatusVisibility = document.getElementById('toggleOnlineStatusVisibility');
            const toggleFriendRequests = document.getElementById('toggleFriendRequests');
            const toggleMessages = document.getElementById('toggleMessages');
            const toggleSchoolVisibility = document.getElementById('toggleSchoolVisibility');
            const toggleWorkVisibility = document.getElementById('toggleWorkVisibility');
            const toggleInterestsVisibility = document.getElementById('toggleInterestsVisibility');
            const toggleWebsiteVisibility = document.getElementById('toggleWebsiteVisibility');
            const toggleSocialLinksVisibility = document.getElementById('toggleSocialLinksVisibility');


        // NEW: Customization Selects
        const profileFrameSelect = document.getElementById('profileFrameSelect');
        const chatBubbleStyleSelect = document.getElementById('chatBubbleStyleSelect');
        const profileThemeSelect = document.getElementById('profileThemeSelect');
        const saveCustomizationButton = document.getElementById('saveCustomizationButton');

        // Privacy Settings Elements
        const savePrivacySettingsButton = document.getElementById('savePrivacySettingsButton');
        const privacySettingsSection = document.getElementById('privacySettingsSection');
        const privacySettingsBtn = document.getElementById('privacySettingsBtn');

        // Account Settings Fields
        const profileEmailInput = document.getElementById('profileEmailInput'); // Disabled email display
        const newEmailInput = document.getElementById('newEmail');
        const currentPasswordForEmailInput = document.getElementById('currentPasswordForEmail');
        const updateEmailButton = document.getElementById('updateEmailButton');
        const oldPasswordInput = document.getElementById('oldPassword');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmNewPasswordInput = document.getElementById('confirmNewPassword');
        const changePasswordButton = document.getElementById('changePasswordButton');
        const logoutButtonAccount = document.getElementById('logoutButtonAccount'); // Logout button in account settings

        // NEW: Toggle for Account Settings Section
        const toggleAccountSettingsButton = document.getElementById('toggleAccountSettingsButton');
        const accountSettingsSection = document.getElementById('accountSettingsSection');

        const userPostsFeed = document.getElementById('userPostsFeed');
        const postsFeedUsername = document.getElementById('postsFeedUsername');
        const loadingUserPostsMessage = document.getElementById('loadingUserPostsMessage');

        // JCoin Request Modal Elements
        const jcoinRequestModal = document.getElementById('jcoinRequestModal');
        const nairaAmountInput = document.getElementById('nairaAmountInput');
        const calculatedJCoinsSpan = document.getElementById('calculatedJCoins');
        const receiptUploadInput = document.getElementById('receiptUploadInput');
        const receiptFileNameSpan = document.getElementById('receiptFileName');
        const receiptPreviewImg = document.getElementById('receiptPreview');
        const cancelJCoinRequestButton = document.getElementById('cancelJCoinRequest');
        const submitJCoinRequestButton = document.getElementById('submitJCoinRequestButton');
        // NEW: Report User Modal Elements
        const reportUserModal = document.getElementById('reportUserModal');
        const reportedUsernameDisplay = document.getElementById('reportedUsernameDisplay');
        const reportReasonSelect = document.getElementById('reportReasonSelect');
        const reportDetailsTextarea = document.getElementById('reportDetailsTextarea');
        const cancelReportButton = document.getElementById('cancelReportButton');
        const submitReportButton = document.getElementById('submitReportButton');
        // NEW: Unlocked Rewards Section
        const unlockedRewardsSection = document.getElementById('unlockedRewardsSection');
        const unlockedRewardsGrid = document.getElementById('unlockedRewardsGrid');
        const noRewardsMessage = document.getElementById('noRewardsMessage');
        // NEW: Friends Snippet Section
        const friendsSnippetSection = document.getElementById('friendsSnippetSection');
        const friendsSnippetGrid = document.getElementById('friendsSnippetGrid');
        const noFriendsMessage = document.getElementById('noFriendsMessage');

                    // NEW: Recent Activity Section
            



            async function ensureUserPostsLoaded() {
                if (!userPostsList) return;
                if (userPostsList.dataset.loaded === '1') return;
                userPostsList.innerHTML = '<div style="opacity:0.8;">Loading posts...</div>';
                try {
                    const postsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'posts');
                    const qy = query(postsCollectionRef, where('authorId', '==', displayedUserId), orderBy('createdAt', 'desc'));
                    const snap = await getDocs(qy);
                    userPostsList.innerHTML = '';
                    if (snap.empty) {
                        userPostsList.innerHTML = '<div style="opacity:0.8;">No posts yet.</div>';
                    } else {
                        snap.forEach(docSnap => {
                            const p = docSnap.data();
                            const row = document.createElement('div');
                            row.style.cssText = 'padding:10px;border:1px solid var(--border-light);border-radius:10px;background:rgba(255,255,255,0.03);';
                            row.textContent = p.content || '(no text)';
                            userPostsList.appendChild(row);
                        });
                    }
                    userPostsList.dataset.loaded = '1';
                } catch (e) {
                    userPostsList.innerHTML = '<div style="color:salmon;">Failed to load posts.</div>';
                }
            }





            async function ensureSavedLoaded() {
                if (!savedPostsList || !savedInspirationsList) return;
                if (savedPostsList.dataset.loaded === '1' && savedInspirationsList.dataset.loaded === '1') return;
                savedPostsList.innerHTML = '<div style="opacity:0.8;">Loading saved posts...</div>';
                savedInspirationsList.innerHTML = '<div style="opacity:0.8;">Loading saved inspirations...</div>';
                try {
                    const savedPostsRef = collection(db, 'artifacts', appId, 'users', displayedUserId, 'saved_posts');
                    const savedSnap = await getDocs(savedPostsRef);
                    savedPostsList.innerHTML = '';
                    if (savedSnap.empty) {
                        savedPostsList.innerHTML = '<div style="opacity:0.8;">No saved posts.</div>';
                    } else {
                        savedSnap.forEach(d => {
                            const pid = d.id;
                            const row = document.createElement('div');
                            row.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border:1px solid var(--border-light);border-radius:10px;background:rgba(255,255,255,0.03);';
                            row.innerHTML = `<span>Post: ${pid}</span>`;
                            savedPostsList.appendChild(row);
                        });
                    }
                    savedPostsList.dataset.loaded = '1';
                } catch (e) {
                    savedPostsList.innerHTML = '<div style="color:salmon;">Failed to load saved posts.</div>';
                }
                try {
                    const savedInspRef = collection(db, 'artifacts', appId, 'users', displayedUserId, 'saved_inspirations');
                    const inspSnap = await getDocs(savedInspRef);
                    savedInspirationsList.innerHTML = '';
                    if (inspSnap.empty) {
                        savedInspirationsList.innerHTML = '<div style="opacity:0.8;">No saved inspirations.</div>';
                    } else {
                        inspSnap.forEach(d => {
                            const data = d.data() || {};
                            const text = data.text || '(no text)';
                            const row = document.createElement('div');
                            row.style.cssText = 'padding:8px 10px;border:1px solid var(--border-light);border-radius:10px;background:rgba(255,255,255,0.03);';
                            row.textContent = text;
                            savedInspirationsList.appendChild(row);
                        });
                    }
                    savedInspirationsList.dataset.loaded = '1';
                } catch (e) {
                    savedInspirationsList.innerHTML = '<div style="color:salmon;">Failed to load saved inspirations.</div>';
                }
            }


            // Cover upload handling (owner only)
            if (profileCoverUploadInput) {
                let originalImage = null;
                let imageNaturalWidth = 0;
                let imageNaturalHeight = 0;
                let cropState = { x: 0, y: 0, w: 0, h: 0, zoom: 1 };

                // New: Auto-crop (center-crop) cover to 16:5 and upload immediately
                async function autoCropAndUploadCover(file) {
                    try {
                        const dataUrl = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = reject;
                            reader.readAsDataURL(file);
                        });
                        const img = new Image();
                        await new Promise((res, rej) => { img.onload = res; img.onerror = rej; img.src = dataUrl; });
                        const targetW = 1600, targetH = 500; // 16:5
                        const srcW = img.naturalWidth, srcH = img.naturalHeight;
                        const srcAspect = srcW / srcH, outAspect = targetW / targetH;
                        let drawW, drawH;
                        if (srcAspect > outAspect) { // too wide
                            drawH = targetH;
                            drawW = Math.round(drawH * srcAspect);
                        } else { // too tall
                            drawW = targetW;
                            drawH = Math.round(drawW / srcAspect);
                        }
                        const canvas = document.createElement('canvas');
                        canvas.width = targetW; canvas.height = targetH;
                        const ctx = canvas.getContext('2d');
                        const dx = Math.round((targetW - drawW) / 2);
                        const dy = Math.round((targetH - drawH) / 2);
                        ctx.drawImage(img, dx, dy, drawW, drawH);
                        const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.9));
                        if (!blob) throw new Error('Auto-crop failed');
                        const url = await uploadMediaToCloudinary(blob);
                        if (!url) throw new Error('Upload failed');
                        const coverUrl = getCloudinaryImageUrl(url, `w_${targetW},h_${targetH},c_fill,q_auto`);
                        const previewEl = document.getElementById('profileCoverImg');
                        if (previewEl) { previewEl.src = coverUrl; previewEl.style.display = 'block'; }
                        if (currentUser && displayedUserId === currentUser.uid) {
                            await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profiles', 'user_profile'), { coverPicId: url, updatedAt: serverTimestamp() });
                            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.uid), { coverPicId: url, updatedAt: serverTimestamp() });
                            
                            // Update profile completion after changing cover picture
                            if (currentUserProfileData) {
                                currentUserProfileData.coverPicId = url;
                                calculateAndUpdateProfileCompletion(currentUserProfileData);
                            }
                        }
                        showEnhancedSmartSuccess('Cover updated!', 'update');
                    } catch (e) {
                        console.error('Failed to update cover.');
                    }
                }

                if (profileCoverUploadInput) profileCoverUploadInput.addEventListener('change', async (ev) => {
                    const file = ev.target.files?.[0];
                    if (!file) return;
                    // Use auto-crop immediate upload instead of manual modal
                    await autoCropAndUploadCover(file);
                });
            }

        // --- Global State ---
        let currentUser = null; // The currently authenticated user (Firebase Auth object)
        let currentUserProfileData = null; // The current user's own private profile data (Firestore document)
        let displayedUserId = null; // The ID of the user whose profile is currently being displayed (from URL or current user)
        let displayedUserProfileData = null; // The profile data of the user currently being displayed (could be current user or another user)
        let isAuthReady = false; // Flag to indicate if auth state has been checked
        const ADMIN_UID = 'cc96gdhCRPO72NFZtleRCujHvIq2'; // Admin's User ID
        let currentSystemSettings = {}; // To store system settings (like exchange rates)

        // NEW: Online Status Tracking (exactly like Chat.html)
        let userOnlineStatus = new Map(); // Track online status of users
        let userAuthStatus = new Map(); // Track authentication status of users

        const JCOIN_BONUS_THRESHOLD_NAIRA = 1000; // Naira amount from which JCoin bonus applies
        const JCOIN_BONUS_PERCENTAGE = 0.10; // 10% bonus

        let dailyBonusInterval = null; // For daily bonus countdown timer

        // --- Utility Functions ---

        /**
         * Plays a short notification sound.
         * Uses ne.mp3 for audio feedback.
         */

        function playNotificationSound(type) {
            try {
                // Create audio element for the new notification sound
                const audio = new Audio('ne.mp3');
                audio.volume = 0.6; // Set volume to 60%
                
                // Play the notification sound
                audio.play().catch(error => {
                    console.log('JCHAT_DEBUG: Could not play notification sound:', error);
                });
            } catch (error) {
                console.log('JCHAT_DEBUG: Error playing notification sound:', error);
            }
        }
        /**
         * Displays a temporary message box with a given message and type.
         * @param {string} message - The message to display.
         * @param {string} type - The type of message ('success', 'error', 'info', 'loading', 'warning').
         * @param {boolean} [isPersistent=false] - If true, message stays until explicitly cleared or replaced.
         * @param {number} [durationMs=3000] - Duration in milliseconds for the message to display if not persistent.
         */


        /**
         * Professional message box hiding function
         */








        /**
         * 🚀 SMART SUCCESS MESSAGE PANEL SYSTEM
         * Shows success message panel that slides out from the edge
         */
        function showSmartSuccessPanel(message, title = 'Success!', duration = 4000) {
            const panel = document.getElementById('smartSuccessPanel');
            const titleEl = document.getElementById('smartSuccessTitle');
            const messageEl = document.getElementById('smartSuccessMessage');
            const timestampEl = document.getElementById('smartSuccessTimestamp');
            
            if (!panel || !titleEl || !messageEl || !timestampEl) {
                console.error('Smart success panel elements not found');
                return;
            }

            // Update content
            titleEl.textContent = title;
            messageEl.textContent = message;
            timestampEl.textContent = new Date().toLocaleTimeString();

            // Show panel with slide animation
            panel.classList.remove('hide');
            panel.classList.add('show');

            // Add close button functionality
            const closeBtn = panel.querySelector('.smart-success-close');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    hideSmartSuccessPanel();
                });
            }

            // Play success sound
            playSuccessSound();

            // Auto-hide after duration
            setTimeout(() => {
                hideSmartSuccessPanel();
            }, duration);
        }

        /**
         * Hide smart success panel with slide animation
         */
        function hideSmartSuccessPanel() {
            const panel = document.getElementById('smartSuccessPanel');
            
            if (!panel) return;

            // Add hide animation
            panel.classList.remove('show');
            panel.classList.add('hide');
        }

        /**
         * Enhanced smart success message with custom styling
         */
        function showEnhancedSmartSuccess(message, style = 'default', duration = 4000) {
            let title = 'Success!';
            
            // Customize based on style
            switch (style) {
                case 'achievement':
                    title = '🎉 Achievement Unlocked!';
                    break;
                case 'update':
                    title = '✅ Update Complete!';
                    break;
                case 'celebration':
                    title = '🎊 Celebration!';
                    break;
                default:
                    title = 'Success!';
            }
            
            // Show smart success panel
            showSmartSuccessPanel(message, title, duration);
        }







        /**
         * Plays a pleasant success sound effect using ne.mp3
         */
        function playSuccessSound() {
            try {
                const audio = new Audio('ne.mp3');
                audio.volume = 0.7; // Set volume to 70%
                audio.play().catch(error => {
                    console.log('Audio playback failed:', error);
                });
            } catch (error) {
                console.log('Audio creation failed:', error);
            }
        }



        /**
         * Displays a custom confirmation modal.
         * @param {string} message - The message to display in the modal.
         * @returns {Promise<boolean>} Resolves with true if 'Yes' is clicked, false if 'No'.
         */
        function showCustomConfirm(message) {
            return new Promise((resolve) => {
                const customConfirmModal = document.getElementById('customConfirmModal'); // Assuming this exists or is created
                const confirmModalMessage = document.getElementById('confirmModalMessage'); // Assuming this exists
                const confirmYesBtn = document.getElementById('confirmYesBtn');     // Assuming this exists
                const confirmNoBtn = document.getElementById('confirmNoBtn');       // Assuming this exists

                if (!customConfirmModal || !confirmModalMessage) {
                    console.error("JCHAT_ERROR: Custom confirmation modal base elements not found.");
                    resolve(false);
                    return;
                }

                confirmModalMessage.textContent = message;
                customConfirmModal.classList.add('active');

                const handleYes = () => {
                    customConfirmModal.classList.remove('active');
                    confirmYesBtn.removeEventListener('click', handleYes);
                    confirmNoBtn.removeEventListener('click', handleNo);
                    resolve(true);
                };

                const handleNo = () => {
                    customConfirmModal.classList.remove('active');
                    confirmYesBtn.removeEventListener('click', handleYes);
                    confirmNoBtn.removeEventListener('click', handleNo);
                    resolve(false);
                };

                if (confirmYesBtn) confirmYesBtn.addEventListener('click', handleYes);
                if (confirmNoBtn) confirmNoBtn.addEventListener('click', handleNo);
            });
        }

        /**
         * Constructs a Cloudinary URL for an image/video.
         * @param {string} urlOrPublicId - The full Cloudinary URL or the public ID of the image on Cloudinary.
         * @param {string} transformations - Optional Cloudinary transformations.
         * @returns {string|null} The full Cloudinary URL or null if urlOrPublicId is not provided.
         */
        function getCloudinaryImageUrl(urlOrPublicId, transformations = "w_auto,f_auto,q_auto") {
            if (!urlOrPublicId) return null;
            // Check if it's already a full URL (e.g., from Firebase Auth photoURL or existing Cloudinary URL)
            if (urlOrPublicId.startsWith('http://') || urlOrPublicId.startsWith('https://')) {
                // If it's a direct URL to a Cloudinary asset, we can insert transformations
                // This is a simplified approach; a more robust one would parse the URL
                if (urlOrPublicId.includes('res.cloudinary.com')) {
                    const parts = urlOrPublicId.split('/upload/');
                    if (parts.length === 2) {
                        return `${parts[0]}/upload/${transformations}/${parts[1]}`;
                    }
                }
                return urlOrPublicId; // Return as is if it's a general URL not from Cloudinary or already transformed
            }
            // Assume it's a public ID if not a full URL
            return `https://res.cloudinary.com/${cloudinaryConfig.cloudName}/image/upload/${transformations}/${urlOrPublicId}`;
        }

        /**
         * Calculates and updates profile completion percentage.
         * @param {Object} profileData - The user's profile data.
         */
        function calculateAndUpdateProfileCompletion(profileData) {
            if (!profileData) return;

            const completionFields = [
                { field: 'username', weight: 15, required: true },
                { field: 'profilePicId', weight: 10, required: false },
                { field: 'bio', weight: 10, required: false },
                { field: 'email', weight: 8, required: false },
                { field: 'location', weight: 8, required: false },
                { field: 'fullName', weight: 8, required: false },
                { field: 'dateOfBirth', weight: 6, required: false },
                { field: 'gender', weight: 5, required: false },
                { field: 'phone', weight: 5, required: false },
                { field: 'country', weight: 5, required: false },
                { field: 'city', weight: 5, required: false },
                { field: 'language', weight: 4, required: false },
                { field: 'timezone', weight: 4, required: false },
                { field: 'school', weight: 6, required: false },
                { field: 'work', weight: 6, required: false },
                { field: 'website', weight: 3, required: false },
                { field: 'socialLinks', weight: 3, required: false },
                { field: 'interests', weight: 4, required: false }
            ];

            let totalScore = 0;
            let maxPossibleScore = 0;
            let completedFields = [];

            completionFields.forEach(({ field, weight, required }) => {
                maxPossibleScore += weight;
                
                if (profileData[field]) {
                    const value = profileData[field];
                    let isValid = false;
                    
                    // Check if the field has meaningful content
                    if (typeof value === 'string') {
                        isValid = value.trim().length > 0;
                    } else if (typeof value === 'object') {
                        isValid = value !== null && Object.keys(value).length > 0;
                    } else {
                        isValid = value !== null && value !== undefined;
                    }
                    
                    if (isValid) {
                        totalScore += weight;
                        completedFields.push(field);
                    }
                }
            });

            const completionPercentage = Math.round((totalScore / maxPossibleScore) * 100);
            
            // Update the UI
            const completionPercentageEl = document.getElementById('completionPercentage');
            const completionProgressFill = document.getElementById('completionProgressFill');
            const completionTip = document.getElementById('completionTip');
            
            if (completionPercentageEl) {
                completionPercentageEl.textContent = `${completionPercentage}%`;
            }
            
            if (completionProgressFill) {
                completionProgressFill.style.width = `${completionPercentage}%`;
                
                // Update progress bar color based on completion
                if (completionPercentage < 30) {
                    completionProgressFill.style.background = 'linear-gradient(90deg, #ff6b6b, #ff8e8e)';
                } else if (completionPercentage < 70) {
                    completionProgressFill.style.background = 'linear-gradient(90deg, #ffd93d, #ffed4e)';
                } else {
                    completionProgressFill.style.background = 'linear-gradient(90deg, #6bcf7f, #8ed8a0)';
                }
            }
            
            if (completionTip) {
                if (completionPercentage === 100) {
                    completionTip.textContent = '🎉 Profile complete! You\'ve unlocked all features!';
                    completionTip.style.color = '#6bcf7f';
                } else if (completionPercentage >= 80) {
                    completionTip.textContent = 'Almost there! Just a few more details to complete your profile.';
                    completionTip.style.color = '#ffd93d';
                } else if (completionPercentage >= 50) {
                    completionTip.textContent = 'Good progress! Keep adding details to unlock more features.';
                    completionTip.style.color = '#ffd93d';
                } else {
                    completionTip.textContent = 'Complete your profile to unlock more features!';
                    completionTip.style.color = '#ff6b6b';
                }
            }

            // Log completion details for debugging
            console.log(`JCHAT_DEBUG: Profile completion: ${completionPercentage}% (${completedFields.length}/${completionFields.length} fields)`);
            console.log('JCHAT_DEBUG: Completed fields:', completedFields);
            
            return completionPercentage;
        }

        /**
         * Displays the profile picture or a default icon.
         * @param {HTMLElement} imgElement - The <img> element to update.
         * @param {HTMLElement} iconElement - The <i> element to display if no image.
         * @param {string|null} profilePicId - The Cloudinary public ID or URL, or null.
         * @param {string} usernameInitial - Initial for placeholder.
         * @param {string} transformations - Cloudinary transformations for the image.
         */
        function displayProfilePicture(imgElement, iconElement, profilePicId, usernameInitial, transformations) {
            if (!imgElement) return;
            const placeholder = '/assets/User.png';
            if (profilePicId) {
                const imageUrl = getCloudinaryImageUrl(profilePicId, transformations);
                imgElement.onerror = () => { imgElement.onerror = null; imgElement.src = placeholder; if (iconElement) iconElement.style.display = 'none'; };
                imgElement.src = imageUrl || placeholder;
                imgElement.style.display = 'block';
                if (iconElement) iconElement.style.display = 'none';
            } else {
                imgElement.onerror = null;
                imgElement.src = placeholder;
                imgElement.style.display = 'block';
                if (iconElement) iconElement.style.display = 'none';
            }
        }
        /**
         * Resizes and compresses an image file using a canvas.
         * @param {File} file - The image file to process.
         * @param {number} maxWidth - Maximum width for the resized image.
         * @param {number} maxHeight - Maximum height for the resized image.
         * @param {number} quality - JPEG compression quality (0.0 to 1.0).
         * @returns {Promise<Blob>} A promise that resolves with the processed image as a Blob.
         */
        function resizeImage(file, maxWidth = 800, maxHeight = 800, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // Calculate new dimensions while maintaining aspect ratio
                        if (width > maxWidth) {
                            height = height * (maxWidth / width);
                            width = maxWidth;
                        }
                        if (height > maxHeight) {
                            width = width * (maxHeight / height);
                            height = maxHeight;
                        }

                        canvas.width = width;
                        canvas.height = height;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob((blob) => {
                            if (blob) {
                                resolve(blob);
                            } else {
                                reject(new Error('Canvas to Blob conversion failed: Resulting blob was null.'));
                            }
                        }, 'image/jpeg', quality);
                    };
                    img.onerror = (error) => {
                        console.error("JCHAT_ERROR: Image element loading error during resize:", error);
                        reject(new Error(`Image loading failed: ${error.message || 'Unknown image loading error.'}`));
                    };
                    img.src = event.target.result;
                };
                reader.onerror = (error) => {
                    console.error("JCHAT_ERROR: FileReader error during readAsDataURL:", error);
                    reject(new Error(`FileReader error: ${error.target.error ? error.target.error.message : 'Unknown error reading file.'}`));
                }
                try {
                    reader.readAsDataURL(file);
                } catch (e) {
                    console.error("JCHAT_ERROR: Error calling readAsDataURL:", e);
                    reject(new Error(`Failed to read file data: ${e.message}`));
                }
            });
        }

        /**
         * Checks whether the MIME type is supported for in-browser image resizing.
         * @param {string} mimeType
         * @returns {boolean}
         */
        function isResizableImageType(mimeType) {
            const supported = ['image/jpeg','image/jpg','image/png','image/webp','image/gif','image/bmp'];
            return supported.includes((mimeType || '').toLowerCase());
        }

        /**
         * Uploads a file (image/video) to Cloudinary.
         * @param {File|Blob} file - The file object (or Blob) to upload.
         * @returns {Promise<string|null>} A promise that resolves with the full secure URL of the uploaded asset, or null on error.
         */
        async function uploadMediaToCloudinary(file) {
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', cloudinaryConfig.uploadPreset);

                const resourceType = file.type.startsWith('image/') ? 'image' : 'video'; // Determine resource type

                const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/${resourceType}/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("JCHAT_ERROR: Cloudinary upload error:", errorData);
                    throw new Error(`Cloudinary upload failed: ${errorData.error.message || response.statusText}`);
                }

                const data = await response.json();
                return data.secure_url; // Return the secure URL
            } catch (error) {
                console.error("JCHAT_ERROR: Error uploading to Cloudinary:", error);
                return null;
            }
        }
        /**
         * Updates the authorProfilePic in all posts by a given user.
         * This function is called when a user's main profile picture changes.
         * @param {string} userId - The UID of the user whose posts need updating.
         * @param {string|null} newProfilePicUrl - The new profile picture URL.
         */
        async function updatePostsWithNewProfilePic(userId, newProfilePicUrl) {
            try {
                const postsCollectionRef = collection(db, "artifacts", appId, "public", "data", "posts");
                const q = query(postsCollectionRef, where("authorId", "==", userId));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const batch = writeBatch(db);
                    querySnapshot.forEach(docSnap => {
                        const postRef = doc(db, "artifacts", appId, "public", "data", "posts", docSnap.id);
                        batch.update(postRef, { profilePhoto: newProfilePicUrl });
                    });
                    await batch.commit();
                    console.log(`JCHAT_DEBUG: Updated profile picture for ${querySnapshot.size} posts by user ${userId}.`);
                }
            } catch (error) {
                console.error("JCHAT_ERROR: Error updating posts with new profile picture:", error);
                // Not showing message box here as it's a background task after main profile update
            }
        }
        /**
         * Handles the change event for the profile picture upload input.
         * Resizes, uploads to Cloudinary, updates Firestore, and refreshes UI.
         */
        async function handleProfilePicChange(event) {
            if (!currentUser || !isAuthReady || displayedUserId !== currentUser.uid) {
                console.warn("You can only change your own profile picture.");
                return;
            }

            const file = event.target.files[0];
            if (!file) {
                return; // No file selected
            }

            if (!file.type.startsWith('image/')) {
                console.warn("Please select an image file.");
                return;
            }
            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                console.warn("Image size too large. Max 5MB.");
                return;
            }


            console.log("Uploading profile picture...");

            try {
                // 1. Resize and compress image when browser can decode; otherwise use original
                let imageToUpload = file;
                if (isResizableImageType((file.type || '').toLowerCase())) {
                    try {
                        imageToUpload = await resizeImage(file, 240, 240, 0.9); // Optimized for profile pics
                    } catch (e) {
                        console.warn('Profile image resize failed; uploading original file instead:', e);
                        imageToUpload = file;
                    }
                } else {
                    console.warn('Unsupported image type for in-browser resize; uploading original:', file.type);
                }

                // 2. Upload to Cloudinary
                const newProfilePicUrl = await uploadMediaToCloudinary(imageToUpload);

                if (!newProfilePicUrl) {
                    throw new Error("Cloudinary upload failed.");
                }

                // 3. Update Firebase Auth profile
                await updateProfile(currentUser, {
                    photoURL: newProfilePicUrl
                });
                console.log("JCHAT_DEBUG: Firebase Auth photoURL updated.");

                // 4. Update Firestore private profile
                const privateProfileDocRef = doc(db, "artifacts", appId, "users", currentUser.uid, "profiles", "user_profile");
                await updateDoc(privateProfileDocRef, {
                    profilePicId: newProfilePicUrl, // Store the full URL
                    updatedAt: serverTimestamp()
                });
                console.log("JCHAT_DEBUG: Firestore private profilePicId updated.");

                // 5. Update Firestore public profile
                const publicProfileDocRef = doc(db, "artifacts", appId, "public", "data", "users", currentUser.uid);
                await updateDoc(publicProfileDocRef, {
                    profilePicId: newProfilePicUrl, // Store the full URL
                    updatedAt: serverTimestamp()
                });
                console.log("JCHAT_DEBUG: Firestore public profilePicId updated.");

                // 6. Update profile pictures in user's posts (background task)
                updatePostsWithNewProfilePic(currentUser.uid, newProfilePicUrl);

                // 7. Update UI immediately
                displayProfilePicture(profilePagePic, profilePageAvatarIcon, newProfilePicUrl, (currentUserProfileData?.username || 'U').charAt(0).toUpperCase(), "w_240,h_240,c_fill,g_face,r_max");
                displayProfilePicture(headerProfilePic, headerAvatarIcon, newProfilePicUrl, (currentUserProfileData?.username || 'U').charAt(0).toUpperCase(), "w_70,h_70,c_fill,g_face,r_max");

                                    showEnhancedSmartSuccess("Profile picture updated successfully! 🎉", 'celebration');

                // Refresh currentUserProfileData
                const updatedProfileSnap = await getDoc(privateProfileDocRef);
                if (updatedProfileSnap.exists()) {
                    currentUserProfileData = updatedProfileSnap.data();
                    displayedUserProfileData = currentUserProfileData; // Ensure consistency
                    
                    // Update profile completion after changing profile picture
                    calculateAndUpdateProfileCompletion(displayedUserProfileData);
                }

            }
            catch (error) {
                console.error("JCHAT_ERROR: Error updating profile picture:", error);
                console.error(`Failed to update profile picture: ${error.message}`);
            }
            finally {

                // Clear file input to allow re-uploading the same file if needed
                event.target.value = '';
            }
        }

        /**
         * Handles user logout.
         */
        async function handleLogout() {
            if (!currentUser) return; // Only allow logout if a user is actually logged in
            try {
                await signOut(auth);
                showEnhancedSmartSuccess("Logged out successfully! 👋", 'celebration');
                setTimeout(() => {
                    window.location.href = '/login.html'; // Redirect to login page
                }, 1000);
            } catch (error) {
                console.error("JCHAT_ERROR: Error logging out:", error);
                console.error("Failed to log out. Please try again.");
            }
        }

        /**
         * Handles saving profile changes (display name, bio, location, school, work, interests, website, social links).
         */
        async function handleSaveProfileChanges() {
            if (!currentUser || !isAuthReady || displayedUserId !== currentUser.uid) {
                console.warn("You can only edit your own profile.");
                return;
            }

            console.log("Saving profile...");

            const newDisplayName = displayNameInput.value.trim();
            const newBio = bioTextarea.value.trim();
            const newLocation = locationInput.value.trim();
            const newSchool = schoolInput.value.trim(); // NEW
            const newWork = workInput.value.trim();     // NEW
            const newInterests = interestsInput.value.trim(); // NEW
            const newWebsite = websiteInput.value.trim();   // NEW
            const newSocialLinks = socialLinksInput.value.trim(); // NEW

            if (!newDisplayName) {
                console.error("Display name cannot be empty.");
                return;
            }

            try {
                // Update Firebase Auth display name
                if (currentUser.displayName !== newDisplayName) {
                    await updateProfile(currentUser, {
                        displayName: newDisplayName
                    });
                    console.log("JCHAT_DEBUG: Firebase Auth displayName updated.");
                }

                // Update Firestore private profile
                const privateProfileDocRef = doc(db, "artifacts", appId, "users", currentUser.uid, "profiles", "user_profile");
                await updateDoc(privateProfileDocRef, {
                    username: newDisplayName, // Update username field in Firestore
                    bio: newBio,
                    location: newLocation,
                    school: newSchool, // NEW
                    work: newWork,     // NEW
                    interests: newInterests, // NEW
                    website: newWebsite,   // NEW
                    socialLinks: newSocialLinks, // NEW
                    updatedAt: serverTimestamp()
                });
                console.log("JCHAT_DEBUG: Firestore private profile updated.");

                // Update Firestore public profile
                const publicProfileDocRef = doc(db, "artifacts", appId, "public", "data", "users", currentUser.uid);
                await updateDoc(publicProfileDocRef, {
                    username: newDisplayName,
                    bio: newBio,
                    location: newLocation,
                    school: newSchool, // NEW
                    work: newWork,     // NEW
                    interests: newInterests, // NEW
                    website: newWebsite,   // NEW
                    socialLinks: newSocialLinks, // NEW
                    updatedAt: serverTimestamp()
                });
                console.log("JCHAT_DEBUG: Firestore public profile updated.");

                // Update header UI immediately
                if (headerDisplayName) headerDisplayName.textContent = newDisplayName; // Null check
                if (profileUsername) profileUsername.textContent = newDisplayName; // Null check
                if (profileBio) profileBio.textContent = newBio || "No bio provided yet."; // Null check

                // Update display for new fields
                if (newLocation) { if (locationText) locationText.textContent = newLocation; if (profileLocation) profileLocation.style.display = 'block'; } else { if (profileLocation) profileLocation.style.display = 'none'; }
                if (newSchool) { if (schoolText) schoolText.textContent = newSchool; if (profileSchool) profileSchool.style.display = 'block'; } else { if (profileSchool) profileSchool.style.display = 'none'; }
                if (newWork) { if (workText) workText.textContent = newWork; if (profileWork) profileWork.style.display = 'block'; } else { if (profileWork) profileWork.style.display = 'none'; }
                if (newWebsite) { if (websiteLink) { websiteLink.href = newWebsite; websiteLink.textContent = newWebsite.replace(/^(https?:\/\/)?(www\.)?/, ''); } if (profileWebsite) profileWebsite.style.display = 'block'; } else { if (profileWebsite) profileWebsite.style.display = 'none'; }
                if (newSocialLinks) { if (socialLinksText) socialLinksText.textContent = newSocialLinks; if (profileSocialLinks) profileSocialLinks.style.display = 'block'; } else { if (profileSocialLinks) profileSocialLinks.style.display = 'none'; }

                showEnhancedSmartSuccess("Profile saved successfully! ✨", 'update');



                // Refresh currentUserProfileData
                const updatedProfileSnap = await getDoc(privateProfileDocRef);
                if (updatedProfileSnap.exists()) {
                    currentUserProfileData = updatedProfileSnap.data();
                    displayedUserProfileData = currentUserProfileData; // Ensure consistency
                    
                    // Update profile completion after saving changes
                    calculateAndUpdateProfileCompletion(displayedUserProfileData);
                }

            } catch (error) {
                console.error("JCHAT_ERROR: Error saving profile changes:", error);
                console.error(`Failed to save profile: ${error.message}`);
            } finally {
                // Profile save complete
            }
        }

        /**
         * Handles copying the User ID to clipboard.
         */
        async function handleCopyUserId() {
            if (!userIdText || !userIdText.textContent) {
                console.warn("No User ID to copy.");
                return;
            }

            try {
                await navigator.clipboard.writeText(userIdText.textContent);
                
                // Visual feedback
                copyUserIdBtn.classList.add('copied');
                const originalIcon = copyUserIdBtn.querySelector('i');
                originalIcon.className = 'fas fa-check';
                
                showEnhancedSmartSuccess("User ID copied to clipboard! 📋", 'achievement');
                
                // Reset button after 2 seconds
                setTimeout(() => {
                    copyUserIdBtn.classList.remove('copied');
                    originalIcon.className = 'fas fa-copy';
                }, 2000);
                
            } catch (error) {
                console.error("JCHAT_ERROR: Failed to copy User ID:", error);
                
                // Fallback for older browsers
                try {
                    const textArea = document.createElement('textarea');
                    textArea.value = userIdText.textContent;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    showEnhancedSmartSuccess("User ID copied to clipboard! 📋", 'achievement');
                } catch (fallbackError) {
                    console.error("JCHAT_ERROR: Fallback copy failed:", fallbackError);
                    console.error("Failed to copy User ID. Please select and copy manually.");
                }
            }
        }






































        /**
         * Handles quick action execution.
         */
        function handleQuickAction(action) {
            switch (action) {
                case 'edit-profile':
                    // Show profile edit section
                    const profileDetailsSection = document.querySelector('.profile-details-section');
                    if (profileDetailsSection) {
                        profileDetailsSection.style.display = 'flex';
                        profileDetailsSection.scrollIntoView({ behavior: 'smooth' });
                    }
                    break;
                case 'share-profile':
                    // Generate and copy profile share URL
                    const shareUrl = `${window.location.origin}/Profile.html?userId=${currentUser?.uid || displayedUserId}`;
                    navigator.clipboard.writeText(shareUrl).then(() => {
                        showEnhancedSmartSuccess('Profile URL copied to clipboard!', 'achievement');
                    }).catch(() => {
                        console.error('Failed to copy URL');
                    });
                    break;
                case 'download-qr':
                    // Trigger QR code download
                    const qrImg = document.getElementById('profileQrImg');
                    if (qrImg && qrImg.src) {
                        const link = document.createElement('a');
                        link.download = 'profile-qr.png';
                        link.href = qrImg.src;
                        link.click();
                    } else {
                        console.warn('QR code not available yet');
                    }
                    break;
                case 'profile-settings':
                    // Show profile settings (customization section)
                    const customizationSection = document.getElementById('customizationSection');
                    if (customizationSection) {
                        customizationSection.style.display = 'block';
                        customizationSection.scrollIntoView({ behavior: 'smooth' });
                    }
                    break;
                default:
                    console.log('Unknown action:', action);
            }
        }

















        // EMERGENCY FIX: Disable all touch gesture interference
        function initializeTouchGestures() {
            // Completely disabled to ensure natural scrolling
        }

        /**
         * Initializes theme preset functionality.
         */
        function initializeThemePresets() {
            const themePresets = document.querySelectorAll('.theme-preset');
            const profileThemeSelect = document.getElementById('profileThemeSelect');

            themePresets.forEach(preset => {
                preset.addEventListener('click', () => {
                    const theme = preset.dataset.theme;
                    
                    // Remove selected class from all presets
                    themePresets.forEach(p => p.classList.remove('selected'));
                    
                    // Add selected class to clicked preset
                    preset.classList.add('selected');
                    
                    // Update the theme select dropdown
                    if (profileThemeSelect) {
                        profileThemeSelect.value = theme;
                    }
                    
                    // Apply theme preview
                    applyThemePreview(theme);
                    
                    // Show success message
                    showEnhancedSmartSuccess(`Theme preset "${theme}" selected! 🎨`, 'celebration');
                });
            });

            // Set initial selected theme
            if (profileThemeSelect) {
                const currentTheme = profileThemeSelect.value;
                const currentPreset = document.querySelector(`[data-theme="${currentTheme}"]`);
                if (currentPreset) {
                    currentPreset.classList.add('selected');
                }
            }
        }

        /**
         * Applies theme preview to the profile.
         */
        function applyThemePreview(theme) {
            const profileSection = document.querySelector('.profile-section');
            if (!profileSection) return;

            // Remove existing theme classes
            profileSection.classList.remove('theme-professional', 'theme-creative', 'theme-minimal', 'theme-vibrant');

            // Add new theme class
            profileSection.classList.add(`theme-${theme}`);

            // Apply theme-specific styles
            switch (theme) {
                case 'professional':
                    profileSection.style.setProperty('--accent-color', '#667eea');
                    profileSection.style.setProperty('--accent-color-dark', '#764ba2');
                    break;
                case 'creative':
                    profileSection.style.setProperty('--accent-color', '#f093fb');
                    profileSection.style.setProperty('--accent-color-dark', '#f5576c');
                    break;
                case 'minimal':
                    profileSection.style.setProperty('--accent-color', '#4facfe');
                    profileSection.style.setProperty('--accent-color-dark', '#00f2fe');
                    break;
                case 'vibrant':
                    profileSection.style.setProperty('--accent-color', '#43e97b');
                    profileSection.style.setProperty('--accent-color-dark', '#38f9d7');
                    break;
                default:
                    // Reset to default theme
                    profileSection.style.removeProperty('--accent-color');
                    profileSection.style.removeProperty('--accent-color-dark');
            }
        }

        /**
         * Smart Profile Notifications System
         */
        class ProfileNotifications {
            constructor() {
                this.notifications = [];
                this.notificationsSection = document.getElementById('profileNotificationsSection');
                this.notificationsList = document.getElementById('notificationsList');
                this.clearBtn = document.getElementById('clearNotificationsBtn');
                this.initialize();
            }

            initialize() {
                if (this.clearBtn) {
                    this.clearBtn.addEventListener('click', () => this.clearAllNotifications());
                }
                
                // Check for existing notifications in localStorage
                this.loadNotifications();
                this.checkProfileStatus();
            }

            addNotification(type, title, message, persistent = false) {
                const notification = {
                    id: Date.now(),
                    type: type,
                    title: title,
                    message: message,
                    timestamp: new Date(),
                    persistent: persistent
                };

                this.notifications.unshift(notification);
                this.saveNotifications();
                this.displayNotifications();
                this.showNotificationSection();

                // Auto-remove non-persistent notifications after 5 seconds
                if (!persistent) {
                    setTimeout(() => {
                        this.removeNotification(notification.id);
                    }, 5000);
                }

                return notification.id;
            }

            removeNotification(id) {
                this.notifications = this.notifications.filter(n => n.id !== id);
                this.saveNotifications();
                this.displayNotifications();
                
                if (this.notifications.length === 0) {
                    this.hideNotificationSection();
                }
            }

            clearAllNotifications() {
                this.notifications = [];
                this.saveNotifications();
                this.displayNotifications();
                this.hideNotificationSection();
                showEnhancedSmartSuccess('All notifications cleared! ✨', 'update');
            }

            displayNotifications() {
                if (!this.notificationsList) return;

                this.notificationsList.innerHTML = '';
                
                this.notifications.forEach(notification => {
                    const notificationElement = this.createNotificationElement(notification);
                    this.notificationsList.appendChild(notificationElement);
                });
            }

            createNotificationElement(notification) {
                const div = document.createElement('div');
                div.className = `notification-item ${notification.type}`;
                div.innerHTML = `
                    <i class="fas ${this.getNotificationIcon(notification.type)} notification-icon"></i>
                    <div class="notification-content">
                        <div class="notification-title">${notification.title}</div>
                        <div class="notification-message">${notification.message}</div>
                        <div class="notification-time">${this.formatTime(notification.timestamp)}</div>
                    </div>
                    <button class="clear-notifications-btn" onclick="profileNotifications.removeNotification(${notification.id})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                return div;
            }

            getNotificationIcon(type) {
                const icons = {
                    'info': 'fa-info-circle',
                    'warning': 'fa-exclamation-triangle',
                    'success': 'fa-check-circle',
                    'error': 'fa-times-circle'
                };
                return icons[type] || 'fa-bell';
            }

            formatTime(timestamp) {
                const now = new Date();
                const diff = now - timestamp;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);

                if (minutes < 1) return 'Just now';
                if (minutes < 60) return `${minutes}m ago`;
                if (hours < 24) return `${hours}h ago`;
                return `${days}d ago`;
            }

            showNotificationSection() {
                if (this.notificationsSection) {
                    this.notificationsSection.style.display = 'block';
                }
            }

            hideNotificationSection() {
                if (this.notificationsSection) {
                    this.notificationsSection.style.display = 'none';
                }
            }

            saveNotifications() {
                localStorage.setItem('jchat-profile-notifications', JSON.stringify(this.notifications));
            }

            loadNotifications() {
                const saved = localStorage.getItem('jchat-profile-notifications');
                if (saved) {
                    try {
                        this.notifications = JSON.parse(saved);
                        this.displayNotifications();
                        if (this.notifications.length > 0) {
                            this.showNotificationSection();
                        }
                    } catch (e) {
                        console.error('Error loading notifications:', e);
                    }
                }
            }

            checkProfileStatus() {
                // Profile completion notifications are now handled differently
                // Check for profile views (if analytics are enabled)
                const analyticsEnabled = document.getElementById('analyticsOptInToggle')?.checked;
                if (analyticsEnabled) {
                    this.addNotification('info', 'Analytics Enabled', 'Profile view analytics are now active. Track your profile performance!');
                }
            }
        }

        // Global instance
        let profileNotifications;

        /**
         * Handles changing user's email address.
         */
        async function handleChangeEmail(event) {
            event.preventDefault(); // Prevent form submission
            if (!currentUser || !isAuthReady) {
                console.warn("You must be logged in to change your email.");
                return;
            }

            console.log("Updating email...");

            const newEmail = newEmailInput.value.trim();
            const currentPassword = currentPasswordForEmailInput.value.trim();

            if (!newEmail || !currentPassword) {
                console.error("Please fill in both new email and current password.");
                return;
            }

            if (newEmail === currentUser.email) {
                console.log("New email is the same as current email.");
                return;
            }

            try {
                // Reauthenticate user first
                const credential = EmailAuthProvider.credential(currentUser.email, currentPassword);
                await reauthenticateWithCredential(currentUser, credential);
                console.log("JCHAT_DEBUG: User reauthenticated successfully.");

                // Update email
                await updateEmail(currentUser, newEmail);
                console.log("JCHAT_DEBUG: Firebase Auth email updated.");

                // Update Firestore private profile
                const privateProfileDocRef = doc(db, "artifacts", appId, "users", currentUser.uid, "profiles", "user_profile");
                await updateDoc(privateProfileDocRef, {
                    email: newEmail,
                    updatedAt: serverTimestamp()
                });
                console.log("JCHAT_DEBUG: Firestore private email updated.");

                showEnhancedSmartSuccess("Email updated successfully! Please verify your new email.", 'update');
                if (profileEmailInput) profileEmailInput.value = newEmail; // Update displayed email, null check
                if (newEmailInput) newEmailInput.value = ''; // Null check
                if (currentPasswordForEmailInput) currentPasswordForEmailInput.value = ''; // Null check

                // Refresh currentUserProfileData
                const updatedProfileSnap = await getDoc(privateProfileDocRef);
                if (updatedProfileSnap.exists()) {
                    currentUserProfileData = updatedProfileSnap.data();
                }

            } catch (error) {
                console.error("JCHAT_ERROR: Error updating email:", error);
                let errorMessage = "Failed to update email. Please check your current password.";
                if (error.code === 'auth/wrong-password') {
                    errorMessage = "Incorrect current password.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Invalid email format.";
                } else if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "This email is already in use by another account.";
                } else if (error.code === 'auth/requires-recent-login') {
                    errorMessage = "Please log out and log back in to update your email.";
                }
                console.error(`${errorMessage} (${error.message})`);
            } finally {
                // Email update complete
            }
        }

        /**
         * Handles changing user's password.
         */
        async function handleChangePassword() {
            if (!currentUser || !isAuthReady) {
                console.warn("You must be logged in to change your password.");
                return;
            }

            console.log("Changing password...");

            const oldPassword = oldPasswordInput.value.trim();
            const newPassword = newPasswordInput.value.trim();
            const confirmNewPassword = confirmNewPasswordInput.value.trim();

            if (!oldPassword || !newPassword || !confirmNewPassword) {
                console.error("Please fill in all password fields.");
                return;
            }

            if (newPassword !== confirmNewPassword) {
                console.error("New password and confirmation do not match.");
                return;
            }

            if (newPassword.length < 6) {
                console.error("New password must be at least 6 characters long.");
                return;
            }

            try {
                // Reauthenticate user first
                const credential = EmailAuthProvider.credential(currentUser.email, oldPassword);
                await reauthenticateWithCredential(currentUser, credential);
                console.log("JCHAT_DEBUG: User reauthenticated successfully.");

                // Update password
                await updatePassword(currentUser, newPassword);
                console.log("JCHAT_DEBUG: Firebase Auth password updated.");

                showEnhancedSmartSuccess("Password updated successfully!", 'update');
                if (oldPasswordInput) oldPasswordInput.value = ''; // Null check
                if (newPasswordInput) newPasswordInput.value = ''; // Null check
                if (confirmNewPasswordInput) confirmNewPasswordInput.value = ''; // Null check

            } catch (error) {
                console.error("JCHAT_ERROR: Error updating password:", error);
                let errorMessage = "Failed to update password. Please check your old password.";
                if (error.code === 'auth/wrong-password') {
                    errorMessage = "Incorrect old password.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "New password is too weak. Please choose a stronger one.";
                } else if (error.code === 'auth/requires-recent-login') {
                    errorMessage = "Please log out and log back in to update your password.";
                }
                console.error(`${errorMessage} (${error.message})`);
            } finally {
                // Password change complete
            }
        }

        /**
         * Calculates the total cumulative Gas required to reach a specific level N.
         * Formula: Total_Gas_for_Level_N = 1500 * N * (N + 1) / 2
         * @param {number} level - The target level N.
         * @returns {number} The total cumulative Gas required to reach that level.
         */
        function getTotalGasRequiredToReachLevel(level) {
            if (level <= 0) return 0;
            return 1500 * level * (level + 1) / 2;
        }
        /**
         * Defines level names, icons, and rewards for various levels.
         * This is a client-side representation and should ideally match server-side logic.
         * @param {number} level - The current level.
         * @returns {{level: number, name: string, icon: string, jCoinReward: number, gasReward: number, otherRewards: string[]}} Level information.
         */
        function getLevelInfo(level) {
            let jCoinReward = 0;
            let gasReward = 0;
            let name = `Level ${level}`;
            let icon = "fas fa-question-circle";
            let otherRewards = []; // Array to hold other reward descriptions

            // Base JCoin and Gas rewards scale linearly
            // Starting values and increments are adjusted to provide a smoother curve up to 500
            if (level >= 1 && level <= 25) { // Tier 1: Early Explorer
                jCoinReward = 10 + (level - 1) * 5; // Start 10, +5/level
                gasReward = 5 + (level - 1) * 2;   // Start 5, +2/level
                const levelNames = [
                    "Novice", "Beginner", "Apprentice", "Explorer", "Pioneer",
                    "Communicator", "Socialite", "Networker", "Influencer", "Trendsetter",
                    "Innovator", "Creator", "Visionary", "Architect", "Maestro",
                    "Strategist", "Guardian", "Champion", "Hero", "Legend",
                    "Mythic", "Celestial", "Divine", "Transcendent", "Cosmic Being"
                ];
                const levelIcons = [
                    "fas fa-leaf", "fas fa-seedling", "fas fa-user-graduate", "fas fa-map-marker-alt", "fas fa-compass",
                    "fas fa-comments", "fas fa-users", "fas fa-share-alt", "fas fa-star", "fas fa-fire",
                    "fas fa-lightbulb", "fas fa-paint-brush", "fas fa-eye", "fas fa-building", "fas fa-music",
                    "fas fa-chess", "fas fa-shield-alt", "fas fa-trophy", "fas fa-mask", "fas fa-dragon",
                    "fas fa-meteor", "fas fa-galaxy", "fas fa-hand-sparkles", "fas fa-infinity", "fas fa-atom"
                ];
                name = levelNames[level - 1] || `Level ${level}`;
                icon = levelIcons[level - 1] || "fas fa-question-circle";

                // Specific other rewards for Tier 1
                if (level === 1) otherRewards.push("Badge: 'Newbie'");
                if (level === 3) otherRewards.push("Unlock: 1-Hour XP Boost");
                if (level === 5) otherRewards.push("Badge: 'Chat Starter'", "Unlock: Basic Profile Picture Frame");
                if (level === 8) otherRewards.push("Unlock: Common Emote Pack (Set 1)");
                if (level === 10) otherRewards.push("Title: 'Friendly Face'", "Increased Message Character Limit (+10)");
                if (level === 13) otherRewards.push("Unlock: 3-Hour XP Boost");
                if (level === 15) otherRewards.push("Badge: 'Community Contributor'", "Unlock: Basic Chat Bubble Style");
                if (level === 18) otherRewards.push("Unlock: Common Emote Pack (Set 2)");
                if (level === 20) otherRewards.push("Title: 'Early Explorer'", "Increased Message Character Limit (+15)");
                if (level === 25) otherRewards.push("Badge: 'Veteran Chatter'", "Unlock: Gradient Profile Picture Frame");

            } else if (level >= 26 && level <= 100) { // Tier 2: Active Member (Levels 26 - 100)
                jCoinReward = 120 + (level - 26) * 8; // Starts higher, increases more
                gasReward = 30 + (level - 26) * 3;
                const tierNames = ["Active Member", "Group Enthusiast", "Social Butterfly", "Community Builder"];
                const tierIcons = ["fas fa-user-check", "fas fa-users-cog", "fas fa-globe-europe", "fas fa-handshake"];
                const tierIndex = Math.floor((level - 26) / 19); // Cycle every ~19 levels for 4 names
                name = `${tierNames[tierIndex % tierNames.length]} Lv. ${level}`;
                icon = tierIcons[tierIndex % tierIcons.length];

                // Specific other rewards for Tier 2
                if (level === 30) otherRewards.push("Badge: 'Active Member'", "Unlock: Uncommon Emote Pack (Set 1)");
                if (level === 35) otherRewards.push("Increased Friend Limit (+10)");
                if (level === 40) otherRewards.push("Unlock: New Chat Bubble Style (Set 2)");
                if (level === 45) otherRewards.push("Unlock: 1-Day XP Boost");
                if (level === 50) otherRewards.push("Title: 'Centurion'", "Permanent: 1% JCoin Shop Discount", "Badge: '50-Level Achiever'");
                if (level === 55) otherRewards.push("Unlock: Uncommon Emote Pack (Set 3)");
                if (level === 60) otherRewards.push("Increased Message Character Limit (+20)");
                if (level === 65) otherRewards.push("Unlock: Basic Profile Theme (Solid Color)");
                if (level === 70) otherRewards.push("Increased Friend Limit (+15)");
                if (level === 75) otherRewards.push("Title: 'Dedicated User'", "Unlock: Rare Emote Pack (Set 1)");
                if (level === 80) otherRewards.push("Unlock: New Chat Bubble Style (Set 3)");
                if (level === 85) otherRewards.push("Unlock: 3-Day XP Boost");
                if (level === 90) otherRewards.push("Increased Group Creation Limit (+1)");
                if (level === 95) otherRewards.push("Unlock: Uncommon Profile Picture Frame");
                if (level === 100) otherRewards.push("Title: 'Master Conversationalist'", "Badge: 'Century Mark'", "Permanent: 2% JCoin Shop Discount", "Unlock: Exclusive 'Golden' Profile Picture Frame");

            } else if (level >= 101 && level <= 250) { // Tier 3: Dedicated User (Levels 101 - 250)
                jCoinReward = 750 + (level - 101) * 12;
                gasReward = 150 + (level - 101) * 5;
                const tierNames = ["Dedicated User", "JCHAT Elite", "Master Communicator", "Community Architect"];
                const tierIcons = ["fas fa-user-shield", "fas fa-gem", "fas fa-microphone-alt", "fas fa-sitemap"];
                const tierIndex = Math.floor((level - 101) / 37); // Cycle every ~37 levels for 4 names
                name = `${tierNames[tierIndex % tierNames.length]} Lv. ${level}`;
                icon = tierIcons[tierIndex % tierIcons.length];

                // Specific other rewards for Tier 3
                if (level === 110) otherRewards.push("Unlock: Animated Emote Pack (Set 1)");
                if (level === 120) otherRewards.push("Increased Media Upload Size (+5MB)");
                if (level === 125) otherRewards.push("Title: 'Rising Star'", "Unlock: Custom Chat Font (Style 1)");
                if (level === 130) otherRewards.push("Unlock: 7-Day XP Boost");
                if (level === 140) otherRewards.push("Permanent: 3% JCoin Shop Discount");
                if (level === 150) otherRewards.push("Badge: 'JCHAT Expert'", "Unlock: Premium Profile Theme (Animated 1)");
                if (level === 160) otherRewards.push("Increased Group Member Capacity (+5)");
                if (level === 170) otherRewards.push("Unlock: Animated Emote Pack (Set 2)");
                if (level === 175) otherRewards.push("Title: 'Elite Communicator'", "Unlock: Custom Chat Font (Style 2)");
                if (level === 180) otherRewards.push("Increased Message Character Limit (+25)");
                if (level === 190) otherRewards.push("Permanent: 4% JCoin Shop Discount");
                if (level === 200) otherRewards.push("Badge: 'Double Century'", "Title: 'JCHAT Champion'", "Unlock: Exclusive 'Diamond' Profile Picture Frame", "Voucher: 1-Day Free Group Promotion");
                if (level === 210) otherRewards.push("Increased Media Upload Size (+10MB)");
                if (level === 220) otherRewards.push("Unlock: Premium Profile Theme (Animated 2)");
                if (level === 230) otherRewards.push("Unlock: Rare Emote Pack (Set 2)");
                if (level === 240) otherRewards.push("Priority Support Access");
                if (level === 250) otherRewards.push("Badge: 'Quarter-Millennium'", "Title: 'The Architect'", "Early Access: Next Major Feature Beta");

            } else if (level >= 251 && level <= 400) { // Tier 4: JCHAT Legend (Levels 251 - 400)
                jCoinReward = 2500 + (level - 251) * 20;
                gasReward = 500 + (level - 251) * 10;
                const tierNames = ["JCHAT Legend", "Grandmaster", "Cosmic Converser", "Eternal Speaker"];
                const tierIcons = ["fas fa-star-half-alt", "fas fa-chess-king", "fas fa-galaxy", "fas fa-infinity"];
                const tierIndex = Math.floor((level - 251) / 37); // Cycle every ~37 levels for 4 names
                name = `${tierNames[tierIndex % tierNames.length]} Lv. ${level}`;
                icon = tierIcons[tierIndex % tierIcons.length];

                // Specific other rewards for Tier 4
                if (level === 260) otherRewards.push("Permanent: 5% JCoin Shop Discount");
                if (level === 275) otherRewards.push("Title: 'Grand Strategist'", "Unlock: Legendary Emote Pack (Set 1)");
                if (level === 290) otherRewards.push("Increased Group Creation Limit (+2)");
                if (level === 300) otherRewards.push("Badge: 'Triple Century'", "Title: 'JCHAT Grandmaster'", "Voucher: 3-Day Free Group Promotion", "Unlock: Exclusive VIP Chat Room Access");
                if (level === 310) otherRewards.push("Increased Media Upload Size (+15MB)");
                if (level === 325) otherRewards.push("Title: 'Cosmic Weaver'", "Unlock: Custom Chat Font (Style 3)");
                if (level === 340) otherRewards.push("Permanent: 7% JCoin Shop Discount");
                if (level === 350) otherRewards.push("Badge: 'JCHAT Luminary'", "Unlock: Personalized Emote Slot (1 custom upload)");
                if (level === 360) otherRewards.push("Increased Group Member Capacity (+10)");
                if (level === 375) otherRewards.push("Title: 'The Eternal Flame'", "Unlock: Legendary Emote Pack (Set 2)");
                if (level === 390) otherRewards.push("Ad-Free Experience (1 Month)");
                if (level === 400) otherRewards.push("Badge: 'Quad Century'", "Title: 'The Unrivaled'", "Permanent: 10% JCoin Shop Discount", "Unlock: Unique Profile Aura (Tier 1)");

            } else if (level >= 401 && level <= 500) { // Tier 5: The Unrivaled (Levels 401 - 500)
                jCoinReward = 5000 + (level - 401) * 30;
                gasReward = 1000 + (level - 401) * 15;
                const tierNames = ["The Unrivaled", "Cosmic Creator", "JCHAT Deity", "Apex Being"];
                const tierIcons = ["fas fa-infinity", "fas fa-solar-system", "fas fa-hand-holding-heart", "fas fa-star-and-crescent"];
                const tierIndex = Math.floor((level - 401) / 25); // Cycle every 25 levels for 4 names
                name = `${tierNames[tierIndex % tierNames.length]} Lv. ${level}`;
                icon = tierIcons[tierIndex % tierIcons.length];

                // Specific other rewards for Tier 5
                if (level === 410) otherRewards.push("Ad-Free Experience (3 Months)");
                if (level === 425) otherRewards.push("Title: 'Pinnacle Performer'", "Unlock: Unique Profile Aura (Tier 2)");
                if (level === 440) otherRewards.push("Increased Media Upload Size (+20MB)");
                if (level === 450) otherRewards.push("Badge: 'Near-God'", "Unlock: Mythic Emote Pack (Set 1)");
                if (level === 460) otherRewards.push("Permanent: 12% JCoin Shop Discount");
                if (level === 475) otherRewards.push("Title: 'Cosmic Architect'", "Voucher: 7-Day Free Group Promotion");
                if (level === 480) otherRewards.push("Ad-Free Experience (6 Months)");
                if (level === 490) otherRewards.push("Unlock: Exclusive 'Cosmic' Animated Avatar Frame");
                if (level === 500) {
                    otherRewards.push(
                        "Badge: 'JCHAT Deity'",
                        "Title: 'The Absolute'",
                        "Lifetime Premium Status (Ad-Free, All Cosmetics Unlocked)",
                        "Personalized Group Creation Perk (Custom starting benefits for new groups)",
                        "Acknowledgment on JCHAT Hall of Fame (Your name/ID listed on a special page)",
                        "Exclusive Discord Role (if applicable)",
                        "Voting Rights on Future Feature Development"
                    );
                }
            } else if (level > 500) {
                // Beyond level 500, continue scaling rewards and use a generic "Master" tier
                jCoinReward = 5000 + (500 - 401) * 30 + (level - 500) * 50;
                gasReward = 1000 + (500 - 401) * 8 + (level - 500) * 15;
                name = `Master Lv. ${level}`;
                icon = "fas fa-star";
                otherRewards.push("Continued JCoin & Gas Rewards", "Exclusive Recognition (Tier 6)");
                if (level % 100 === 0) otherRewards.push("Special Milestone Bonus");
            }

            return {
                level: level,
                name: name,
                icon: icon,
                jCoinReward: jCoinReward,
                gasReward: gasReward,
                otherRewards: otherRewards
            };
        }
        /**
         * Checks if the user has leveled up and applies rewards.
         * This function is called after any update to totalGasEarned.
         * @param {string} userId - The UID of the current user.
         * @param {number} oldLevel - The user's level before the current update.
         * @param {number} newTotalGasEarned - The user's total cumulative Gas after the update.
         */
        async function checkAndApplyLevelUps(userId, oldLevel, newTotalGasEarned) {
            let currentLevel = oldLevel;
            let updated = false;
            let levelsGainedMessages = [];

            while (true) {
                const nextLevel = currentLevel + 1;
                // If it's a new user with 0 totalGasEarned, and the initial level is 1
                // The condition totalGasEarned >= gasNeededForNextLevel should only trigger if they have enough for Level 1, then Level 2, etc.
                const gasNeededForNextLevel = getTotalGasRequiredToReachLevel(nextLevel);

                // If user has not yet earned enough XP for the next level, or has reached max defined level
                if (newTotalGasEarned < gasNeededForNextLevel) {
                    break;
                }

                // If here, user has enough XP for nextLevel
                const levelInfo = getLevelInfo(nextLevel);
                currentLevel = nextLevel;
                updated = true;

                try {
                    await runTransaction(db, async (transaction) => {
                        const userProfileDocRef = doc(db, "artifacts", appId, "users", userId, "profiles", "user_profile");
                        const userProfileSnap = await transaction.get(userProfileDocRef);

                        if (!userProfileSnap.exists()) {
                            throw new Error("User profile not found during level-up transaction.");
                        }

                        const currentProfileData = userProfileSnap.data();
                        const updatedJCoins = (currentProfileData.jCoins || 0) + levelInfo.jCoinReward;
                        const updatedGas = (currentProfileData.gas || 0) + levelInfo.gasReward;
                        const updatedUnlockedBenefits = [...(currentProfileData.unlockedBenefits || [])];

                        // Add new benefits, avoiding duplicates
                        if (levelInfo.otherRewards && levelInfo.otherRewards.length > 0) {
                            levelInfo.otherRewards.forEach(benefit => {
                                if (!updatedUnlockedBenefits.includes(benefit)) {
                                    updatedUnlockedBenefits.push(benefit);
                                }
                            });
                        }

                        transaction.update(userProfileDocRef, {
                            level: currentLevel,
                            jCoins: updatedJCoins,
                            gas: updatedGas,
                            unlockedBenefits: updatedUnlockedBenefits,
                            updatedAt: serverTimestamp()
                        });

                        // Also update public profile for level and totalGasEarned
                        const publicProfileDocRef = doc(db, "artifacts", appId, "public", "data", "users", userId);
                        transaction.update(publicProfileDocRef, {
                            level: currentLevel,
                            totalGasEarned: newTotalGasEarned, // Ensure public profile also reflects totalGasEarned
                            updatedAt: serverTimestamp()
                        });
                    });

                    levelsGainedMessages.push(`🎉 You reached Level ${currentLevel}: ${levelInfo.name}! You received ${levelInfo.jCoinReward} JCoins and ${levelInfo.gasReward} Gas.`);
                    if (levelInfo.otherRewards.length > 0) {
                        levelsGainedMessages[levelsGainedMessages.length - 1] += ` Unlocked: ${levelInfo.otherRewards.join(', ')}.`;
                    }
                    console.log(`JCHAT_DEBUG: User ${userId} leveled up to ${currentLevel}.`);

                } catch (transactionError) {
                    console.error("JCHAT_ERROR: Transaction failed during level-up:", transactionError);
                    console.error(`Failed to apply level-up rewards for Level ${currentLevel}: ${transactionError.message}`);
                    break; // Stop processing further levels if a transaction fails
                }
            }

            if (updated) {
                // Show all level-up messages
                levelsGainedMessages.forEach(msg => showEnhancedSmartSuccess(msg, 'achievement', 5000));
                // Re-fetch and display the profile to update UI with new level, JCoins, Gas
                await fetchAndDisplayUserProfile(userId);
            }
        }
        /**
         * Fetches and displays the current user's profile data for the header.
         * This function runs on every page to ensure header is consistent.
         * @param {firebase.User} user - The authenticated Firebase user object.
         */
        async function fetchAndDisplayHeaderProfile(user) {
            try {
                const privateProfileDocRef = doc(db, "artifacts", appId, "users", user.uid, "profiles", "user_profile");
                const publicProfileDocRef = doc(db, "artifacts", appId, "public", "data", "users", user.uid);
                
                const privateDocSnap = await getDoc(privateProfileDocRef);

                let profileData = null;
                if (privateDocSnap.exists()) {
                    profileData = privateDocSnap.data();
                    // Fix for createdAt if it's missing or malformed (not a Timestamp)
                    if (!profileData.createdAt || typeof profileData.createdAt.toDate !== 'function') {
                        console.warn("JCHAT_WARN: Private user_profile createdAt is missing or malformed. Attempting to fix.");
                        await updateDoc(privateProfileDocRef, { createdAt: serverTimestamp() });
                        // Re-fetch to get the correct Timestamp object
                        const updatedSnap = await getDoc(privateProfileDocRef);
                        profileData.createdAt = updatedSnap.data().createdAt;
                    }
                    // Ensure 'gas' field exists, initialize if not
                    if (profileData.gas === undefined) {
                        console.log("JCHAT_DEBUG: 'gas' field missing in profile, initializing to 0.");
                        await updateDoc(privateProfileDocRef, { gas: 0 });
                        profileData.gas = 0;
                    }
                    // Ensure 'totalGasEarned' field exists, initialize if not
                    if (profileData.totalGasEarned === undefined) {
                        console.log("JCHAT_DEBUG: 'totalGasEarned' field missing in profile, initializing to 0.");
                        await updateDoc(privateProfileDocRef, { totalGasEarned: 0 });
                        profileData.totalGasEarned = 0;
                    }
                    // Ensure 'level' field exists, initialize if not
                    if (profileData.level === undefined) {
                        console.log("JCHAT_DEBUG: 'level' field missing in profile, initializing to 1.");
                        await updateDoc(privateProfileDocRef, { level: 1 });
                        profileData.level = 1;
                    }
                    
                    if (profileData.unlockedBenefits === undefined) { // NEW: Initialize unlockedBenefits
                        console.log("JCHAT_DEBUG: 'unlockedBenefits' field missing in profile, initializing to [].");
                        await updateDoc(privateProfileDocRef, { unlockedBenefits: [] });
                        profileData.unlockedBenefits = [];
                    }
                    if (profileData.lastDailyBonusClaimDate === undefined) { // NEW: Initialize lastDailyBonusClaimDate
                        console.log("JCHAT_DEBUG: 'lastDailyBonusClaimDate' missing, initializing to null.");
                        await updateDoc(privateProfileDocRef, { lastDailyBonusClaimDate: null });
                        profileData.lastDailyBonusClaimDate = null;
                    }
                    // NEW: Initialize additional profile fields
                    if (profileData.school === undefined) { await updateDoc(privateProfileDocRef, { school: "" }); profileData.school = ""; }
                    if (profileData.work === undefined) { await updateDoc(privateProfileDocRef, { work: "" }); profileData.work = ""; }
                    if (profileData.interests === undefined) { await updateDoc(privateProfileDocRef, { interests: "" }); profileData.interests = ""; }
                    if (profileData.website === undefined) { await updateDoc(privateProfileDocRef, { website: "" }); profileData.website = ""; }
                    if (profileData.socialLinks === undefined) { await updateDoc(privateProfileDocRef, { socialLinks: "" }); profileData.socialLinks = ""; }
                    if (profileData.profileFrame === undefined) { await updateDoc(privateProfileDocRef, { profileFrame: "default" }); profileData.profileFrame = "default"; } // NEW
                    if (profileData.chatBubbleStyle === undefined) { await updateDoc(privateProfileDocRef, { chatBubbleStyle: "default" }); profileData.chatBubbleStyle = "default"; } // NEW
                    if (profileData.profileTheme === undefined) { await updateDoc(privateProfileDocRef, { profileTheme: "default" }); profileData.profileTheme = "default"; } // NEW

                    console.log("JCHAT_DEBUG: Fetched existing profile data for header:", profileData);
                } else {
                    // If private profile doesn't exist, create a basic one
                    profileData = {
                        username: user.displayName || `User_${user.uid.substring(0, 8)}`,
                        email: user.email || "",
                        profilePicId: user.photoURL || null,
                        bio: "",
                        location: "",
                        school: "", // NEW
                        work: "", // NEW
                        interests: "", // NEW
                        website: "", // NEW
                        socialLinks: "", // NEW
                        friendsCount: 0,
                        followersCount: 0,
                        followingCount: 0,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp(),
                        inspirationType: "motivational",
                        visibility: {
                            displayName: true, profilePic: true, bio: false, location: false,
                            emailPublic: false, lastOnline: false, allowFriendRequests: true, allowMessages: true,
                            school: false, work: false, interests: false, website: false, socialLinks: false // NEW visibility defaults
                        },
                        totalPosts: 0,
                        jCoins: 0, // Initialize jCoins
                        gas: 0, // Initialize GAS
                        totalGasEarned: 0, // Initialize totalGasEarned
                        level: 1, // Initialize level
        
                        unlockedBenefits: [], // NEW: Initialize unlockedBenefits
                        lastDailyBonusClaimDate: null, // NEW: Initialize daily bonus claim date
                        profileFrame: "default", // NEW
                        chatBubbleStyle: "default", // NEW
                        profileTheme: "default", // NEW
                    };
                    await setDoc(privateProfileDocRef, profileData);
                    console.log("JCHAT_DEBUG: Created new profile data for header:", profileData);

                    // Also create/update public profile
                    await setDoc(publicProfileDocRef, {
                        username: profileData.username,
                        profilePicId: profileData.profilePicId,
                        bio: profileData.bio,
                        location: profileData.location,
                        school: profileData.school, // NEW
                        work: profileData.work,     // NEW
                        interests: profileData.interests, // NEW
                        website: profileData.website,   // NEW
                        socialLinks: profileData.socialLinks, // NEW
                        createdAt: profileData.createdAt,
                        updatedAt: profileData.updatedAt,
                        visibility: profileData.visibility,
                        totalPosts: profileData.totalPosts,
                        level: profileData.level, // Include level in public profile
                        totalGasEarned: profileData.totalGasEarned, // Include totalGasEarned in public profile
                        profileFrame: profileData.profileFrame, // NEW: Public profile also needs customization info
                        chatBubbleStyle: profileData.chatBubbleStyle, // NEW
                        profileTheme: profileData.profileTheme, // NEW
                    }, { merge: true });
                }

                // Store current user's profile data globally
                currentUserProfileData = profileData;

                // Update header UI
                const usernameInitial = (profileData.username || "J").charAt(0).toUpperCase();
                displayProfilePicture(headerProfilePic, headerAvatarIcon, profileData?.profilePicId, usernameInitial, "w_70,h_70,c_fill,g_face,r_max");
                headerDisplayName.textContent = profileData.username || "JCHAT User";
                if (headerNavLinkProfile) headerNavLinkProfile.href = `/Profile.html?userId=${user.uid}`; // Ensure header nav link is correct, null check

                // Show Admin Icon if current user is admin
                if (adminIconLink) { // Null check
                    if (user.uid === ADMIN_UID) {
                        adminIconLink.style.display = 'block';
                    } else {
                        adminIconLink.style.display = 'none';
                    }
                }

            } catch (error) {
                console.error("JCHAT_ERROR: Error fetching or creating profile for header:", error);
                const usernameInitial = (user.displayName || "J").charAt(0).toUpperCase();
                displayProfilePicture(headerProfilePic, headerAvatarIcon, user.photoURL, usernameInitial, "w_70,h_70,c_fill,g_face,r_max");
                if (headerDisplayName) headerDisplayName.textContent = user.displayName || "JCHAT User"; // Null check
                console.error(`Error loading header profile: ${error.message}`);
            }
        }
        /**
         * Fetches and displays the notification count for the current user.
         * @param {string} userId - The UID of the current user.
         */
        async function fetchNotificationCount(userId) {
            try {
                const notificationsCollectionRef = collection(db, "artifacts", appId, "users", userId, "notifications");
                const q = query(notificationsCollectionRef, where("read", "==", false));
                const querySnapshot = await getDocs(q);
                const unreadCount = querySnapshot.size;

                if (unreadCount > 0) {
                    if (notificationCountElement) { // Null check
                        notificationCountElement.textContent = unreadCount;
                        notificationCountElement.style.display = 'flex';
                    }
                } else {
                    if (notificationCountElement) { // Null check
                        notificationCountElement.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error("JCHAT_ERROR: Error fetching notification count:", error);
                if (notificationCountElement) notificationCountElement.style.display = 'none'; // Null check
            }
        }

        // --- Profile Page Specific Functions ---

        /**
         * Fetches system settings to get exchange rates for JCoins.
         */
        async function fetchSystemSettings() {
            const systemSettingsDocRef = doc(db, "artifacts", appId, "public", "data", "settings", "system_settings");
            try {
                const docSnap = await getDoc(systemSettingsDocRef);
                if (docSnap.exists()) {
                    currentSystemSettings = docSnap.data();
                    console.log("JCHAT_DEBUG: System settings fetched:", currentSystemSettings);
                } else {
                    console.warn("JCHAT_WARNING: System settings document not found. Using default values.");
                    currentSystemSettings = {
                        jcoinNairaRate: 7.5, // Default if not found
                        dailyBonusAmount: 50 // Default if not found
                    };
                }
            } catch (error) {
                console.error("JCHAT_ERROR: Error fetching system settings:", error);
                console.error("Failed to load system settings.");
            }
        }

        /**
         * Shows the JCoin request modal.
         */
        function showJCoinRequestModal() {
            
            if (jcoinRequestModal) jcoinRequestModal.classList.add('active'); // Null check
            if (nairaAmountInput) nairaAmountInput.value = ''; // Null check
            if (calculatedJCoinsSpan) calculatedJCoinsSpan.textContent = '0 JCoins'; // Null check
            if (receiptUploadInput) receiptUploadInput.value = ''; // Clear file input, null check
            if (receiptFileNameSpan) receiptFileNameSpan.textContent = 'No file chosen'; // Null check
            if (receiptPreviewImg) { // Null check
                receiptPreviewImg.style.display = 'none';
                receiptPreviewImg.src = '';
            }
        }

        /**
         * Hides the JCoin request modal.
         */
        function hideJCoinRequestModal() {
            if (jcoinRequestModal) jcoinRequestModal.classList.remove('active'); // Null check
        }
        /**
         * Calculates the JCoins based on Naira amount and bonus.
         * @param {number} nairaAmount - The Naira amount entered by the user.
         * @returns {number} The calculated JCoins.
         */
        function calculateJCoins(nairaAmount) {
            const jcoinNairaRate = currentSystemSettings.jcoinNairaRate || 7.5; // Use fetched rate or default
            let baseJCoins = Math.floor(nairaAmount / jcoinNairaRate);
            let bonusJCoins = 0;
            if (nairaAmount >= JCOIN_BONUS_THRESHOLD_NAIRA) {
                bonusJCoins = Math.floor(baseJCoins * JCOIN_BONUS_PERCENTAGE);
            }
            return baseJCoins + bonusJCoins;
        }

        /**
         * Submits the JCoin purchase request to Firestore.
         */
        async function submitJCoinRequest() {
            if (!currentUser || !currentUserProfileData) {
                console.error("You must be logged in to submit a request.");
                return;
            }
            

            const nairaAmount = parseInt(nairaAmountInput.value);
            const receiptFile = receiptUploadInput.files[0];

            if (isNaN(nairaAmount) || nairaAmount <= 0) {
                console.error("Please enter a valid Naira amount.");
                return;
            }
            if (nairaAmount < 100) { // Minimum request amount
                console.warn("Minimum request amount is #100.");
                return;
            }
            if (!receiptFile) {
                console.error("Please upload a payment receipt.");
                return;
            }

            console.log("Submitting JCoin request...");

            try {
                const requestedJCoins = calculateJCoins(nairaAmount);
                const uploadedReceiptUrl = await uploadMediaToCloudinary(receiptFile); // Corrected function call

                if (!uploadedReceiptUrl) {
                    throw new Error("Failed to upload receipt image.");
                }

                const jcoinBuyRequestsCollectionRef = collection(db, "artifacts", appId, "public", "data", "jcoin_buy_requests");

                await addDoc(jcoinBuyRequestsCollectionRef, {
                    userId: currentUser.uid,
                    username: currentUserProfileData.username || `User_${currentUser.uid.substring(0, 8)}`,
                    profilePicId: currentUserProfileData.profilePicId || null,
                    requestedNairaPrice: nairaAmount,
                    requestedJCoins: requestedJCoins,
                    receiptImageUrl: uploadedReceiptUrl,
                    status: 'pending', // Always pending for admin review
                    timestamp: serverTimestamp()
                });

                showEnhancedSmartSuccess("JCoin request submitted successfully! An admin will review it shortly.", 'achievement');
                hideJCoinRequestModal(); // Close modal on success
            } catch (error) {
                console.error("JCHAT_ERROR: Error submitting JCoin request:", error);
                console.error(`Failed to submit request: ${error.message}`);
            } finally {
                // JCoin request complete
            }
        }

        // --- NEW: Pending Activity Reward Creation Function ---
        /**
         * Creates a pending activity reward document for admin review.
         * This system allows for manual approval of XP/JCoin rewards, preventing abuse.
         * @param {string} userId - The ID of the user who performed the activity.
         * @param {string} username - The username of the user.
         * @param {string} activityType - The type of activity (e.g., 'daily_login', 'profile_complete').
         * @param {number} suggestedXpReward - The suggested XP amount to award (can be negative for deductions).
         * @param {number} suggestedJCoinReward - The suggested JCoin amount to award (can be negative for deductions).
         * @param {string} [activityId=null] - Optional: ID of the specific activity.
         */
        async function createPendingActivityReward(
            userId,
            username,
            activityType,
            suggestedXpReward,
            suggestedJCoinReward,
            activityId = null
        ) {
            try {
                const pendingRewardsCollectionRef = collection(db, "artifacts", appId, "public", "data", "pending_activity_rewards");

                const newRewardDocRef = await addDoc(pendingRewardsCollectionRef, {
                    userId: userId,
                    username: username,
                    activityType: activityType,
                    suggestedXpReward: suggestedXpReward,
                    suggestedJCoinReward: suggestedJCoinReward,
                    status: 'pending', // Always pending for admin review
                    timestamp: serverTimestamp(),
                    activityId: activityId
                });

                console.log(`JCHAT_DEBUG: Pending activity reward created with ID: ${newRewardDocRef.id}`);
            } catch (error) {
                console.error("JCHAT_ERROR: Error creating pending activity reward:", error);
            }
        }
        /**
         * Handles claiming the daily JCoin bonus.
         * Now creates a pending reward for admin approval instead of directly awarding.
         */
        async function claimDailyBonus() {
            if (!currentUser || !currentUserProfileData) {
                console.warn("You must be logged in to claim the daily bonus.");
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize to start of day

            const lastClaimDate = currentUserProfileData.lastDailyBonusClaimDate ?
                new Date(currentUserProfileData.lastDailyBonusClaimDate.toDate()) : null;

            if (lastClaimDate && lastClaimDate.toDateString() === today.toDateString()) {
                console.log("You have already claimed your daily bonus today! Come back tomorrow.");
                return;
            }
            const dailyBonusAmount = currentSystemSettings.dailyBonusAmount || 50; // Use fetched amount or default

            // In a real application, consider adding a custom confirmation modal here instead of alert/confirm.
            // For now, assume a simple confirmation or proceed directly.
            const confirmed = true; // Replace with actual custom confirm if implemented

            // If a custom confirm dialog is available and used:
            // const confirmed = await showCustomConfirm(`Claim your daily bonus of ${dailyBonusAmount} JCoins?`);
            // if (!confirmed) {
            //     return;
            // }

            console.log("Claiming daily bonus...");

            try {
                const userProfileDocRef = doc(db, "artifacts", appId, "users", currentUser.uid, "profiles", "user_profile");

                await runTransaction(db, async (transaction) => {
                    const userProfileSnap = await transaction.get(userProfileDocRef);
                    if (!userProfileSnap.exists()) {
                        throw new Error("User profile not found for daily bonus.");
                    }
                    const currentProfileData = userProfileSnap.data();

                    const currentLastClaimDate = currentProfileData.lastDailyBonusClaimDate ?
                        new Date(currentProfileData.lastDailyBonusClaimDate.toDate()) : null;

                    // Double-check race condition: ensure it hasn't been claimed since this function started
                    if (currentLastClaimDate && currentLastClaimDate.toDateString() === today.toDateString()) {
                        throw new Error("Daily bonus already claimed.");
                    }

                    // Update only the lastDailyBonusClaimDate to prevent multiple claims
                    transaction.update(userProfileDocRef, {
                        lastDailyBonusClaimDate: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    });
                });

                // Create a pending reward for admin review instead of directly awarding
                await createPendingActivityReward(
                    currentUser.uid,
                    currentUserProfileData.username,
                    'daily_login',
                    10, // Suggested XP reward for daily login
                    dailyBonusAmount  // Suggested JCoin reward for daily login
                );

                showEnhancedSmartSuccess(`Daily bonus booked! +${dailyBonusAmount} JCoins and +10 XP are on the way. Keep the streak going!`, 'achievement');
                playNotificationSound('success');
                
                // Update local data for UI (without actually adding the coins yet)
                currentUserProfileData.lastDailyBonusClaimDate = Timestamp.fromDate(new Date());
                updateDailyBonusUI(); // Update button and countdown
            } catch (error) {
                console.error("JCHAT_ERROR: Error claiming daily bonus:", error);
                console.error(`Failed to claim bonus: ${error.message}`);
                playNotificationSound('error');
            } finally {
                // Daily bonus claim complete
            }
        }

        /**
         * Updates the daily bonus claim button and countdown timer.
         */
        function updateDailyBonusUI() {
            if (!currentUserProfileData || displayedUserId !== currentUser.uid) {
                if (claimDailyBonusButton) claimDailyBonusButton.style.display = 'none';
                if (dailyBonusCountdown) dailyBonusCountdown.style.display = 'none';
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const lastClaimDate = currentUserProfileData.lastDailyBonusClaimDate ?
                new Date(currentUserProfileData.lastDailyBonusClaimDate.toDate()) : null;

            if (lastClaimDate && lastClaimDate.toDateString() === today.toDateString()) {
                // Already claimed today
                if (claimDailyBonusButton) claimDailyBonusButton.style.display = 'none';
                if (dailyBonusCountdown) dailyBonusCountdown.style.display = 'block';

                // Calculate time until next midnight
                const nextMidnight = new Date(today);
                nextMidnight.setDate(today.getDate() + 1);
                const timeLeft = nextMidnight.getTime() - new Date().getTime();

                if (dailyBonusInterval) clearInterval(dailyBonusInterval);
                dailyBonusInterval = setInterval(() => {
                    const remainingTime = nextMidnight.getTime() - new Date().getTime();
                    if (remainingTime <= 0) {
                        clearInterval(dailyBonusInterval);
                        if (dailyBonusCountdown) dailyBonusCountdown.style.display = 'none';
                        if (claimDailyBonusButton) {
                            claimDailyBonusButton.style.display = 'inline-flex';
                        }
                        if (dailyBonusCountdown) dailyBonusCountdown.textContent = '';
                        return;
                    }
                    const hours = Math.floor((remainingTime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((remainingTime % (1000 * 60)) / 1000);

                    if (dailyBonusCountdown) dailyBonusCountdown.textContent = `Next bonus in: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);

            } else {
                // Can claim today
                if (claimDailyBonusButton) {
                    claimDailyBonusButton.style.display = 'inline-flex';
                }
                if (dailyBonusCountdown) dailyBonusCountdown.style.display = 'none';
                if (dailyBonusInterval) clearInterval(dailyBonusInterval);
            }
        }

        /**
         * Shows the report user modal for the displayed user.
         */
        function showReportUserModal() {
            if (!currentUser || displayedUserId === currentUser.uid) {
                console.warn("You cannot report yourself.");
                return;
            }
            if (!displayedUserProfileData) {
                console.error("Could not load user data to report.");
                return;
            }
            if (reportUserModal) reportUserModal.classList.add('active');
            if (reportedUsernameDisplay) reportedUsernameDisplay.textContent = displayedUserProfileData.username || 'Unknown User';
            if (reportReasonSelect) reportReasonSelect.value = ''; // Reset select
            if (reportDetailsTextarea) reportDetailsTextarea.value = ''; // Reset textarea
        }

        /**
         * Hides the report user modal.
         */
        function hideReportUserModal() {
            if (reportUserModal) reportUserModal.classList.remove('active');
        }
        /**
         * Submits a user report to Firestore.
         */
        async function submitReport() {
            if (!currentUser || !displayedUserProfileData) {
                console.error("Cannot submit report without user data.");
                return;
            }
            if (displayedUserId === currentUser.uid) {
                console.warn("You cannot report yourself.");
                return;
            }

            const reason = reportReasonSelect.value;
            const details = reportDetailsTextarea.value.trim();

            if (!reason) {
                console.error("Please select a reason for the report.");
                return;
            }

            console.log("Submitting report...");

            try {
                const reportsCollectionRef = collection(db, "artifacts", appId, "public", "data", "reports");
                await addDoc(reportsCollectionRef, {
                    reporterId: currentUser.uid,
                    reporterUsername: currentUserProfileData?.username || `User_${currentUser.uid.substring(0, 8)}`,
                    reportedId: displayedUserId,
                    reportedUsername: displayedUserProfileData.username || `User_${displayedUserId.substring(0, 8)}`,
                    contentType: "user", // Reporting the user themselves
                    contentId: displayedUserId, // The ID of the reported user
                    reason: reason,
                    details: details,
                    status: "pending", // Pending admin review
                    timestamp: serverTimestamp()
                });

                showEnhancedSmartSuccess("Report submitted successfully! Thank you for helping us maintain a safe community.", 'achievement');
                hideReportUserModal();
            } catch (error) {
                console.error("JCHAT_ERROR: Error submitting report:", error);
                console.error(`Failed to submit report: ${error.message}`);
            } finally {
                // Report submission complete
            }
        }

        /**
         * Fetches and displays unlocked rewards/benefits for the current user.
         */
        async function fetchAndDisplayUnlockedRewards() {
            if (!unlockedRewardsSection || !unlockedRewardsGrid || !noRewardsMessage) return;

            if (displayedUserId !== currentUser.uid) { // Only show for the owner of the profile
                unlockedRewardsSection.style.display = 'none';
                return;
            }
            unlockedRewardsSection.style.display = 'block';

            if (!currentUserProfileData || !currentUserProfileData.unlockedBenefits) {
                unlockedRewardsGrid.innerHTML = '';
                noRewardsMessage.style.display = 'block';
                return;
            }

            const unlockedBenefits = currentUserProfileData.unlockedBenefits;
            unlockedRewardsGrid.innerHTML = ''; // Clear previous
            if (unlockedBenefits.length === 0) {
                noRewardsMessage.style.display = 'block';
            } else {
                noRewardsMessage.style.display = 'none';
                unlockedBenefits.forEach(benefit => {
                    const rewardItem = document.createElement('div');
                    rewardItem.classList.add('reward-item');

                    let iconClass = 'fas fa-gem'; // Default icon
                    let name = benefit;

                    // Attempt to parse icon and name from benefit string
                    if (benefit.startsWith("Badge:")) {
                        iconClass = 'fas fa-certificate';
                        name = benefit.replace('Badge: \'', '').replace('\'', '');
                    } else if (benefit.startsWith("Unlock:")) {
                        if (benefit.includes("XP Boost")) iconClass = 'fas fa-rocket';
                        else if (benefit.includes("Profile Picture Frame")) iconClass = 'fas fa-image'; // Using a more general image icon
                        else if (benefit.includes("Emote Pack")) iconClass = 'fas fa-smile';
                        else if (benefit.includes("Chat Bubble Style")) iconClass = 'fas fa-comment-alt';
                        else if (benefit.includes("Profile Theme")) iconClass = 'fas fa-palette';
                        else if (benefit.includes("Custom Chat Font")) iconClass = 'fas fa-font';
                        else if (benefit.includes("Personalized Emote Slot")) iconClass = 'fas fa-paint-brush'; // Or fas fa-upload
                        else if (benefit.includes("Profile Aura")) iconClass = 'fas fa-crown';
                        else if (benefit.includes("Exclusive VIP Chat Room Access")) iconClass = 'fas fa-lock-open';
                        else if (benefit.includes("Lifetime Premium Status")) iconClass = 'fas fa-star';
                        else if (benefit.includes("Early Access")) iconClass = 'fas fa-flask';
                        else if (benefit.includes("Priority Support")) iconClass = 'fas fa-headset';
                        else if (benefit.includes("Ad-Free Experience")) iconClass = 'fas fa-ad'; // New Ad-Free icon

                        name = benefit.replace('Unlock: ', '');
                        if (name.includes('(') && name.includes(')')) { // Remove parenthesized info for cleaner display
                            name = name.substring(0, name.indexOf('(')).trim();
                        }
                    } else if (benefit.startsWith("Title:")) {
                        iconClass = 'fas fa-award';
                        name = benefit.replace('Title: \'', '').replace('\'', '');
                    } else if (benefit.includes("Discount")) {
                        iconClass = 'fas fa-tags';
                    } else if (benefit.includes("Voucher")) {
                        iconClass = 'fas fa-ticket-alt'; // Icon for vouchers
                    }

                    rewardItem.innerHTML = `
                        <i class="${iconClass} reward-icon"></i>
                        <span>${name}</span>
                    `;
                    unlockedRewardsGrid.appendChild(rewardItem);
                });
            }
        }






        /**
         * Fetches and displays friends in the modal (exactly like Chat.html)
         */
        async function fetchAndDisplayFriendsInModal() {
            const friendListContainer = document.getElementById('friendListContainer');
            const loadingElement = friendListContainer.querySelector('.loading-friends-modal');
            const noFriendsElement = friendListContainer.querySelector('.no-friends-modal');
            
            if (!friendListContainer || !loadingElement || !noFriendsElement) return;

            // Show loading state
            loadingElement.style.display = 'block';
            noFriendsElement.style.display = 'none';

            try {
                // Fetch ALL friends using the same logic as Find_Friends.html
                const publicFriendsRef = collection(db, "artifacts", appId, "public", "data", "friends");
                const publicUsersRef = collection(db, "artifacts", appId, "public", "data", "users");
                
                // Get the current user's friends list
                const friendsSnapshot = await getDocs(publicFriendsRef);
                const currentUserFriends = new Set();
                
                friendsSnapshot.forEach(docSnap => {
                    const friendData = docSnap.data();
                    if (friendData.user1Id === displayedUserId) {
                        currentUserFriends.add(friendData.user2Id);
                    } else if (friendData.user2Id === displayedUserId) {
                        currentUserFriends.add(friendData.user1Id);
                    }
                });

                if (currentUserFriends.size === 0) {
                    loadingElement.style.display = 'none';
                    noFriendsElement.style.display = 'block';
                    noFriendsElement.textContent = 'No friends yet. Start connecting with other users!';
                    return;
                }

                // Fetch all public users to get friend details
                const usersSnapshot = await getDocs(publicUsersRef);
                const friendsData = [];

                usersSnapshot.forEach(docSnap => {
                    const userData = docSnap.data();
                    if (currentUserFriends.has(docSnap.id)) {
                        friendsData.push({
                            id: docSnap.id,
                            username: userData.username || `User_${docSnap.id.substring(0, 8)}`,
                            profilePicId: userData.profilePicId,
                            bio: userData.bio || "",
                            location: userData.location || "",
                            visibility: userData.visibility || {}
                        });
                    }
                });

                // Hide loading and render friends
                loadingElement.style.display = 'none';
                renderFriendsInModal(friendsData);
                
                // Update the Friends button count
                updateFriendsButtonCount(friendsData.length);

            } catch (error) {
                console.error("JCHAT_ERROR: Error fetching friends for modal:", error);
                loadingElement.style.display = 'none';
                noFriendsElement.style.display = 'block';
                noFriendsElement.textContent = 'Failed to load friends. Please try again.';
            }
        }

        /**
         * Renders friends list in the modal (exactly like Chat.html)
         */
        function renderFriendsInModal(friends) {
            const friendListContainer = document.getElementById('friendListContainer');
            const noFriendsElement = friendListContainer.querySelector('.no-friends-modal');
            
            if (!friendListContainer || !noFriendsElement) return;

            // Clear existing friend items
            const existingItems = friendListContainer.querySelectorAll('.friend-item');
            existingItems.forEach(item => item.remove());

            if (friends.length === 0) {
                noFriendsElement.style.display = 'block';
                noFriendsElement.textContent = 'No friends found.';
                return;
            }

            noFriendsElement.style.display = 'none';

                                        // Create friend items
            friends.forEach(friend => {
                const friendItem = document.createElement('div');
                friendItem.className = 'friend-item';
                friendItem.setAttribute('data-friend-id', friend.id);

                // Create profile picture with fallback
                let profilePicHtml = '';
                if (friend.profilePicId && friend.visibility?.profilePic !== false) {
                    profilePicHtml = `
                        <div style="position: relative;">
                            <img src="${getCloudinaryImageUrl(friend.profilePicId, 'w_80,h_80,c_fill,g_face,r_max')}" 
                                 alt="${friend.username} Pic" 
                                 onerror="this.onerror=null; this.src='https://placehold.co/40x40/CCCCCC/000000?text=${friend.username.charAt(0).toUpperCase()}';">
                            <div class="status-dot offline" id="status-${friend.id}"></div>
                        </div>`;
                } else {
                    profilePicHtml = `
                        <div style="position: relative;">
                            <div class="default-avatar"><i class="fas fa-user-circle"></i></div>
                            <div class="status-dot offline" id="status-${friend.id}"></div>
                        </div>`;
                }

                friendItem.innerHTML = `
                    ${profilePicHtml}
                    <span>${friend.username}</span>
                `;

                // Add click handler to start chat
                friendItem.addEventListener('click', () => {
                    const friendId = friend.id;
                    const friendName = friend.username;
                    
                    console.log(`JCHAT_DEBUG: Starting chat with friend ${friendId} (${friendName})`);
                    
                    // Close modal
                    selectFriendModal.classList.remove('active');
                    
                    // Navigate to chat page
                    showEnhancedSmartSuccess(`💬 Opening chat with ${friendName}...`, 'celebration');
                    setTimeout(() => {
                        window.location.href = `/Chat.html?partner=${friendId}`;
                    }, 1000);
                });

                friendListContainer.appendChild(friendItem);
            });

            // Update modal title to show friend count
            const modalTitle = selectFriendModal.querySelector('h3');
            if (modalTitle) {
                modalTitle.textContent = `Select a Friend to Chat With (${friends.length})`;
            }
        }

        /**
         * Filters friends in the modal based on search query
         */
        function filterFriendsInModal(searchQuery) {
            const friendItems = document.querySelectorAll('#selectFriendModal .friend-item');
            const query = searchQuery.toLowerCase();

            friendItems.forEach(item => {
                const friendName = item.querySelector('span').textContent.toLowerCase();
                if (friendName.includes(query)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        /**
         * Updates online status for a specific user (exactly like Chat.html)
         */
        function updateUserOnlineStatus(userId, isOnline, lastActivity = null) {
            if (!userId) return;

            // Update the status map
            userOnlineStatus.set(userId, isOnline);

            // Update the status dot in the modal if it exists
            const statusDot = document.getElementById(`status-${userId}`);
            if (statusDot) {
                statusDot.className = 'status-dot';
                
                if (isOnline) {
                    statusDot.classList.add('online');
                } else if (lastActivity) {
                    const now = new Date();
                    const lastActivityDate = lastActivity.toDate ? lastActivity.toDate() : new Date(lastActivity);
                    const timeDiff = now - lastActivityDate;
                    
                    if (timeDiff < 30 * 60 * 1000) { // 30 minutes threshold for "recently"
                        statusDot.classList.add('recently');
                    } else {
                        statusDot.classList.add('offline');
                    }
                } else {
                    statusDot.classList.add('offline');
                }
            }
        }

        /**
         * Sets up real-time online status tracking (exactly like Chat.html)
         */
        function setupOnlineStatusTracking() {
            if (!isAuthReady || !currentUser) return;

            console.log("JCHAT_DEBUG: Setting up online status tracking...");

            // Listen to public users collection for real-time updates
            const publicUsersRef = collection(db, "artifacts", appId, "public", "data", "users");
            
            onSnapshot(publicUsersRef, (snapshot) => {
                snapshot.forEach(docSnap => {
                    const userData = docSnap.data();
                    const userId = docSnap.id;
                    
                    // Track authentication status
                    const isAuthenticated = userData.isOnline || false;
                    userAuthStatus.set(userId, isAuthenticated);
                    
                    // Update online status based on last activity (for authenticated users only)
                    if (isAuthenticated && userData.lastActivity) {
                        const lastActivity = userData.lastActivity.toDate ? userData.lastActivity.toDate() : new Date(userData.lastActivity);
                        const now = new Date();
                        const timeDiff = now - lastActivity;
                        const isOnline = timeDiff < 5 * 60 * 1000; // 5 minutes threshold
                        
                        updateUserOnlineStatus(userId, isOnline, userData.lastActivity);
                    } else {
                        updateUserOnlineStatus(userId, false);
                    }
                });
            }, (error) => {
                console.error("JCHAT_ERROR: Error setting up online status tracking:", error);
            });
        }

        /**
         * Updates the Friends button label with current friend count
         */
        function updateFriendsButtonCount(count) {
            const friendsStatItem = document.getElementById('friendsStatItem');
            if (friendsStatItem) {
                const statValue = friendsStatItem.querySelector('#statFriends');
                const statLabel = friendsStatItem.querySelector('.stat-label');
                
                if (statValue) {
                    statValue.textContent = count;
                }
                
                if (statLabel) {
                    statLabel.textContent = `View Friends (${count})`;
                }
            }
        }

        /**
         * Fetches the real friend count and updates the Friends stat
         */
        async function fetchAndUpdateFriendCount() {
            if (!isAuthReady || !currentUser) return;

            try {
                // Fetch ALL friends using the same logic as Find_Friends.html
                const publicFriendsRef = collection(db, "artifacts", appId, "public", "data", "friends");
                
                // Get the current user's friends list
                const friendsSnapshot = await getDocs(publicFriendsRef);
                const currentUserFriends = new Set();
                
                friendsSnapshot.forEach(docSnap => {
                    const friendData = docSnap.data();
                    if (friendData.user1Id === displayedUserId) {
                        currentUserFriends.add(friendData.user2Id);
                    } else if (friendData.user2Id === displayedUserId) {
                        currentUserFriends.add(friendData.user1Id);
                    }
                });

                // Update the Friends stat with real count
                updateFriendsButtonCount(currentUserFriends.size);
                
            } catch (error) {
                console.error("JCHAT_ERROR: Error fetching friend count:", error);
                // Keep count as 0 if there's an error
                updateFriendsButtonCount(0);
            }
        }


        /**
         * Fetches and displays a user's profile data.
         * Determines if it's the current user's profile or another user's.
         * @param {string} userIdToDisplay - The UID of the user whose profile should be displayed.
         */
        async function fetchAndDisplayUserProfile(userIdToDisplay) {
            
            console.log("Loading profile...");
            if (profileUsername) profileUsername.textContent = "Username";
            if (profileBio) profileBio.textContent = "No bio provided yet.";
            if (profileUserId) profileUserId.style.display = 'none'; // NEW: Hide User ID during loading
            if (profileLocation) profileLocation.style.display = 'none';
            if (profileEmail) profileEmail.style.display = 'none';
            if (profilePhone) profilePhone.style.display = 'none';
            if (profileSchool) profileSchool.style.display = 'none'; // NEW
            if (profileWork) profileWork.style.display = 'none';   // NEW
            if (profileWebsite) profileWebsite.style.display = 'none'; // NEW
            if (profileSocialLinks) profileSocialLinks.style.display = 'none'; // NEW

            if (statPosts) statPosts.textContent = "0";
            if (statFriends) statFriends.textContent = "0";
            if (statFollowers) statFollowers.textContent = "0";
            if (statFollowing) statFollowing.textContent = "0";
            if (jCoinsSpan) jCoinsSpan.textContent = "0"; // Reset jCoins
            if (jcoinExchangeRate) jcoinExchangeRate.style.display = 'none'; // Hide exchange rate by default
            if (gasValue) gasValue.textContent = "0"; // Reset Gas (XP)
            if (xpLevelIcon) xpLevelIcon.className = "fas fa-question-circle profile-level-icon"; // Reset icon
            if (xpLevelName) xpLevelName.textContent = "Loading Level..."; // Reset level name
                    if (xpProgressBarFill) xpProgressBarFill.style.width = "0%"; // Reset progress bar
        if (xpProgressBarFill) xpProgressBarFill.style.backgroundPosition = "right"; // Reset gradient position
        
        // Reset percentage display
        const progressPercentageElement = document.getElementById('progressPercentage');
        if (progressPercentageElement) {
            progressPercentageElement.textContent = "0%";
            progressPercentageElement.style.color = '#fff';
            progressPercentageElement.style.textShadow = '0 0 3px rgba(0, 0, 0, 0.8)';
        }
            if (profilePagePic) profilePagePic.style.display = 'none';
            if (profilePageAvatarIcon) profilePageAvatarIcon.style.display = 'block';
            
            // Hide all action buttons initially
            if (claimDailyBonusButton) claimDailyBonusButton.style.display = 'none'; // NEW: Hide claim daily bonus button
            if (dailyBonusCountdown) dailyBonusCountdown.style.display = 'none'; // NEW: Hide daily bonus countdown
            if (reportUserButton) reportUserButton.style.display = 'none'; // NEW: Hide report user button
            // Hide inline edit fields and account settings by default
            const localProfileDetailsSection = displayNameInput ? displayNameInput.closest('.profile-details-section') : null; // Null check for displayNameInput
            if (localProfileDetailsSection) {
                localProfileDetailsSection.style.display = 'none';
            }
            if (accountSettingsSection) accountSettingsSection.style.display = 'none'; // NEW: Hide account settings by default
            if (toggleAccountSettingsButton) toggleAccountSettingsButton.style.display = 'none'; // NEW: Hide toggle button by default

            // NEW: Hide new sections by default
            if (unlockedRewardsSection) unlockedRewardsSection.style.display = 'none';
            if (friendsSnippetSection) friendsSnippetSection.style.display = 'none';
            if (profileFrameSelect) profileFrameSelect.closest('.customization-option').style.display = 'none'; // Hide parent div
            if (chatBubbleStyleSelect) chatBubbleStyleSelect.closest('.customization-option').style.display = 'none';
            if (profileThemeSelect) profileThemeSelect.closest('.customization-option').style.display = 'none';
            if (saveCustomizationButton) saveCustomizationButton.style.display = 'none';
            if (toggleEmailVisibility) toggleEmailVisibility.closest('.privacy-toggle-group').style.display = 'none'; // Hide parent div
            if (togglePhoneVisibility) togglePhoneVisibility.closest('.privacy-toggle-group').style.display = 'none';
            if (toggleLocationVisibility) toggleLocationVisibility.closest('.privacy-toggle-group').style.display = 'none';
            if (toggleUserIdVisibility) toggleUserIdVisibility.closest('.privacy-toggle-group').style.display = 'none';
            if (toggleOnlineStatusVisibility) toggleOnlineStatusVisibility.closest('.privacy-toggle-group').style.display = 'none';
            if (toggleFriendRequests) toggleFriendRequests.closest('.privacy-toggle-group').style.display = 'none';
            if (toggleMessages) toggleMessages.closest('.privacy-toggle-group').style.display = 'none';
            if (toggleSchoolVisibility) toggleSchoolVisibility.closest('.privacy-toggle-group').style.display = 'none';
            if (toggleWorkVisibility) toggleWorkVisibility.closest('.privacy-toggle-group').style.display = 'none';
            if (toggleInterestsVisibility) toggleInterestsVisibility.closest('.privacy-toggle-group').style.display = 'none';
            if (toggleWebsiteVisibility) toggleWebsiteVisibility.closest('.privacy-toggle-group').style.display = 'none';
            if (toggleSocialLinksVisibility) toggleSocialLinksVisibility.closest('.privacy-toggle-group').style.display = 'none';

            let profileDocRef;
            let isCurrentUserProfile = false;

            if (currentUser && userIdToDisplay === currentUser.uid) {
                // Displaying current user's profile (private data)
                profileDocRef = doc(db, "artifacts", appId, "users", userIdToDisplay, "profiles", "user_profile");
                isCurrentUserProfile = true;
                if (profilePicWrapper) profilePicWrapper.classList.add('owner'); // Null check
            } else {
                // Displaying another user's profile (public data)
                profileDocRef = doc(db, "artifacts", appId, "public", "data", "users", userIdToDisplay);
                isCurrentUserProfile = false;
                if (profilePicWrapper) profilePicWrapper.classList.remove('owner'); // Null check
            }

            try {
                const docSnap = await getDoc(profileDocRef);

                if (docSnap.exists()) {
                    // Store the fetched profile data globally for the currently displayed user
                    // If it's the current user's profile, store it in currentUserProfileData
                    if (isCurrentUserProfile) {
                        currentUserProfileData = docSnap.data();
                        displayedUserProfileData = currentUserProfileData; // Both point to the same for owner
                    } else {
                        displayedUserProfileData = docSnap.data();
                    }
                    
                    // IMPORTANT: Ensure userId is always part of displayedUserProfileData
                    displayedUserProfileData.userId = userIdToDisplay;
                    
                    // Calculate and update profile completion immediately after loading data
                    calculateAndUpdateProfileCompletion(displayedUserProfileData);

                    console.log(`JCHAT_DEBUG: Fetched profile data for ${userIdToDisplay}:`, displayedUserProfileData);

                    // Apply visibility settings if it's another user's profile
                    const visibility = displayedUserProfileData.visibility || {};

                    // Cover image display (respect visibility if added later)
                    if (profileCoverImg && displayedUserProfileData.coverPicId) {
                        profileCoverImg.src = getCloudinaryImageUrl(displayedUserProfileData.coverPicId, 'w_1600,h_400,c_fill,q_auto');
                        profileCoverImg.style.display = 'block';
                    }
                    if (editCoverOverlay) {
                        editCoverOverlay.style.display = (currentUser && isCurrentUserProfile) ? 'block' : 'none';
                    }

                    if (profileUsername) profileUsername.textContent = displayedUserProfileData.username || "JCHAT User"; // Null check
                    const usernameInitial = (displayedUserProfileData.username || "J").charAt(0).toUpperCase();



                    // Profile Picture
                    if (profilePagePic && profilePageAvatarIcon) { // Null check
                        if (displayedUserProfileData.profilePicId && (isCurrentUserProfile || visibility.profilePic)) {
                            displayProfilePicture(profilePagePic, profilePageAvatarIcon, displayedUserProfileData.profilePicId, usernameInitial, "w_240,h_240,c_fill,g_face,r_max");
                        } else {
                            profilePagePic.style.display = 'none';
                            profilePageAvatarIcon.style.display = 'block';
                        }
                    }

                    // Bio
                    if (profileBio) { // Null check
                        if (displayedUserProfileData.bio && (isCurrentUserProfile || visibility.bio)) {
                            profileBio.textContent = displayedUserProfileData.bio;
                        } else {
                            profileBio.textContent = isCurrentUserProfile ? "No bio provided yet." : "Bio not publicly available.";
                        }
                    }

                    // NEW: User ID Display
                    if (profileUserId && userIdText) { // Null check
                        if (isCurrentUserProfile || visibility.userId) {
                            userIdText.textContent = userIdToDisplay;
                            profileUserId.style.display = 'block';
                        } else {
                            profileUserId.style.display = 'none';
                        }
                    }

                    // Location
                    if (profileLocation && locationText) { // Null check
                        if (displayedUserProfileData.location && (isCurrentUserProfile || visibility.location)) {
                            locationText.textContent = displayedUserProfileData.location;
                            profileLocation.style.display = 'block';
                        } else {
                            profileLocation.style.display = 'none';
                        }
                    }

                    // Email (only for owner or if public)
                    if (profileEmail && emailText) { // Null check
                        if (displayedUserProfileData.email && (isCurrentUserProfile || visibility.emailPublic)) {
                            emailText.textContent = displayedUserProfileData.email;
                            profileEmail.style.display = 'block';
                        } else {
                            profileEmail.style.display = 'none';
                        }
                    }

                    // NEW: Display additional user info based on visibility
                    
                    // Full Name
                    if (profileFullName && fullNameText) {
                        if (displayedUserProfileData.fullName && (isCurrentUserProfile || visibility.firstName)) {
                            fullNameText.textContent = displayedUserProfileData.fullName;
                            profileFullName.style.display = 'block';
                        } else {
                            profileFullName.style.display = 'none';
                        }
                    }

                    // Date of Birth
                    if (profileDateOfBirth && dateOfBirthText) {
                        if (displayedUserProfileData.dateOfBirth && (isCurrentUserProfile || visibility.dateOfBirth)) {
                            const dob = new Date(displayedUserProfileData.dateOfBirth);
                            const age = Math.floor((new Date() - dob) / (365.25 * 24 * 60 * 60 * 1000));
                            dateOfBirthText.textContent = `${dob.toLocaleDateString()} (${age} years old)`;
                            profileDateOfBirth.style.display = 'block';
                        } else {
                            profileDateOfBirth.style.display = 'none';
                        }
                    }

                    // Gender
                    if (profileGender && genderText) {
                        if (displayedUserProfileData.gender && (isCurrentUserProfile || visibility.gender)) {
                            const genderDisplay = displayedUserProfileData.gender.charAt(0).toUpperCase() + displayedUserProfileData.gender.slice(1);
                            genderText.textContent = genderDisplay;
                            profileGender.style.display = 'block';
                        } else {
                            profileGender.style.display = 'none';
                        }
                    }

                    // Phone
                    if (profilePhone && phoneText) {
                        if (displayedUserProfileData.phone && (isCurrentUserProfile || visibility.phone)) {
                            phoneText.textContent = displayedUserProfileData.phone;
                            profilePhone.style.display = 'block';
                        } else {
                            profilePhone.style.display = 'none';
                        }
                    }

                    // Country
                    if (profileCountry && countryText) {
                        if (displayedUserProfileData.country && (isCurrentUserProfile || visibility.country)) {
                            const countryDisplay = displayedUserProfileData.country.charAt(0).toUpperCase() + displayedUserProfileData.country.slice(1);
                            countryText.textContent = countryDisplay;
                            profileCountry.style.display = 'block';
                        } else {
                            profileCountry.style.display = 'none';
                        }
                    }

                    // City
                    if (profileCity && cityText) {
                        if (displayedUserProfileData.city && (isCurrentUserProfile || visibility.city)) {
                            cityText.textContent = displayedUserProfileData.city;
                            profileCity.style.display = 'block';
                        } else {
                            profileCity.style.display = 'none';
                        }
                    }

                    // Language
                    if (profileLanguage && languageText) {
                        if (displayedUserProfileData.language && (isCurrentUserProfile || visibility.language)) {
                            const languageDisplay = displayedUserProfileData.language.charAt(0).toUpperCase() + displayedUserProfileData.language.slice(1);
                            languageText.textContent = languageDisplay;
                            profileLanguage.style.display = 'block';
                        } else {
                            profileLanguage.style.display = 'none';
                        }
                    }

                    // Timezone
                    if (profileTimezone && timezoneText) {
                        if (displayedUserProfileData.timezone && (isCurrentUserProfile || visibility.timezone)) {
                            timezoneText.textContent = displayedUserProfileData.timezone;
                            profileTimezone.style.display = 'block';
                        } else {
                            profileTimezone.style.display = 'none';
                        }
                    }

                    if (profileSchool && schoolText) {
                        if (displayedUserProfileData.school && (isCurrentUserProfile || visibility.school)) {
                            schoolText.textContent = displayedUserProfileData.school;
                            profileSchool.style.display = 'block';
                        } else {
                            profileSchool.style.display = 'none';
                        }
                    }
                    if (profileWork && workText) {
                        if (displayedUserProfileData.work && (isCurrentUserProfile || visibility.work)) {
                            workText.textContent = displayedUserProfileData.work;
                            profileWork.style.display = 'block';
                        } else {
                            profileWork.style.display = 'none';
                        }
                    }
                    if (profileWebsite && websiteLink) {
                        if (displayedUserProfileData.website && (isCurrentUserProfile || visibility.website)) {
                            websiteLink.href = displayedUserProfileData.website;
                            websiteLink.textContent = displayedUserProfileData.website.replace(/^(https?:\/\/)?(www\.)?/, ''); // Display cleaner URL
                            profileWebsite.style.display = 'block';
                        } else {
                            profileWebsite.style.display = 'none';
                        }
                    }
                    if (profileSocialLinks && socialLinksText) {
                        if (displayedUserProfileData.socialLinks && (isCurrentUserProfile || visibility.socialLinks)) {
                            socialLinksText.textContent = displayedUserProfileData.socialLinks;
                            profileSocialLinks.style.display = 'block';
                        } else {
                            profileSocialLinks.style.display = 'none';
                        }
                    }

                    // Stats (always show for owner, for others based on public profile data)
                    if (statPosts) statPosts.textContent = displayedUserProfileData.totalPosts ?? 0; // Null check
                    // Friends count will be updated when modal is opened, set to 0 initially
                if (statFriends) statFriends.textContent = "0";
                    if (statFollowers) statFollowers.textContent = displayedUserProfileData.followersCount ?? 0; // Null check
                    if (statFollowing) statFollowing.textContent = displayedUserProfileData.followingCount ?? 0; // Null check
                    
                    // JCoins (only visible to owner)
                    const fallbackUserCurrency = (typeof userCurrency === 'object' && userCurrency) ? userCurrency : { code: 'USD', symbol: '$', label: 'USD' };
                    if (jCoinsSpan && jcoinExchangeRate && jcoinUSDValue) { // Null check
                        if (isCurrentUserProfile) {
                            jCoinsSpan.textContent = (displayedUserProfileData.jCoins ?? 0).toLocaleString();
                            if (typeof setUserCurrencyFromProfile === 'function') {
                                setUserCurrencyFromProfile(displayedUserProfileData);
                            }
                            const j = (displayedUserProfileData.jCoins ?? 0);
                            let fiatValue = 0;
                            const uc = (typeof userCurrency === 'object' && userCurrency) ? userCurrency : { code: 'USD', symbol: '$', label: 'USD' };
                            if (uc.code === 'NGN') {
                                const rate = currentSystemSettings.jcoinNairaRate || 7.5;
                                fiatValue = j * rate; // JCoins to NGN using configured rate
                            } else {
                                const nairaRate = currentSystemSettings.jcoinNairaRate || 7.5;
                                const usdPerNaira = 0.001; // existing assumption in app
                                fiatValue = j * nairaRate * usdPerNaira; // approximate USD
                            }
                            const fmt = (typeof formatLocalCurrency === 'function') ? formatLocalCurrency : (amt => `$${Number(amt).toFixed(2)}`);
                            jcoinUSDValue.textContent = fmt(fiatValue);
                            jcoinExchangeRate.style.display = 'flex'; // Use flex to align icon and text
                            if (jCoinsSpan.closest('.stat-item')) jCoinsSpan.closest('.stat-item').style.display = 'block'; // Ensure the entire stat item is visible
                        } else {
                            // Hide JCoins and exchange rate for other users
                            if (jCoinsSpan.closest('.stat-item')) jCoinsSpan.closest('.stat-item').style.display = 'none';
                        }
                    }
                    
                    // NEW: Display Gas (XP) and Level Progress
                    const currentGasBalance = displayedUserProfileData.gas ?? 0; // Current spendable Gas
                    const totalGasEarned = displayedUserProfileData.totalGasEarned ?? 0; // Cumulative Gas for leveling

                    // Determine current level based on totalGasEarned
                    let currentLevel = 1; // Start from Level 1
                    for (let i = 1; i <= 500; i++) { // Check up to max level 500 (or higher if you extend getLevelInfo)
                        const gasNeededToReachLevelI = getTotalGasRequiredToReachLevel(i);
                        if (totalGasEarned >= gasNeededToReachLevelI) {
                            currentLevel = i;
                        } else {
                            break; // Stop when totalGasEarned is less than what's needed for the current 'i' level
                        }
                    }
                    // Ensure level displayed is at least 1, even if totalGasEarned is 0
                    currentLevel = Math.max(1, currentLevel);

                    const levelInfo = getLevelInfo(currentLevel); // Get info for the calculated level

                    if (gasValue) gasValue.textContent = currentGasBalance.toLocaleString(); // Display current Gas balance, null check

                    // Update Level Name and Icon
                    if (xpLevelName) xpLevelName.textContent = levelInfo.name; // Null check
                    if (xpLevelIcon) xpLevelIcon.className = `${levelInfo.icon} profile-level-icon`; // Null check

                    let progressPercentage = 0;
                    const gasNeededForCurrentDisplayedLevel = getTotalGasRequiredToReachLevel(currentLevel);
                    const gasNeededForNextLevel = getTotalGasRequiredToReachLevel(currentLevel + 1);

                    if (currentLevel < 500) { // For levels up to 500, calculate progress
                        const gasEarnedInCurrentLevelSegment = totalGasEarned - gasNeededForCurrentDisplayedLevel;
                        const gasRequiredForCurrentLevelSegment = gasNeededForNextLevel - gasNeededForCurrentDisplayedLevel;
                        
                        if (gasRequiredForCurrentLevelSegment > 0) {
                            progressPercentage = Math.min(100, (gasEarnedInCurrentLevelSegment / gasRequiredForCurrentLevelSegment) * 100);
                        } else {
                            progressPercentage = 100; // Should not happen if formula is correct, but as a safeguard (e.g., if totalGasEarned is exactly at target)
                        }
                    } else {
                        progressPercentage = 100; // Maxed out for levels beyond 500
                        if (xpLevelName) xpLevelName.textContent = `MAX Level (${levelInfo.name})`;
                    }

                    // Set background-position for the gradient fill
                    // When progressPercentage is 0, background-position is right (0% of the gradient shown)
                    // When progressPercentage is 100, background-position is left (100% of the gradient shown)
                    const backgroundPosition = 100 - progressPercentage; // Invert for background-position: left to right fill
                    if (xpProgressBarFill) {
                        xpProgressBarFill.style.backgroundPosition = `${backgroundPosition}% 0`;
                        xpProgressBarFill.style.width = `${Math.floor(progressPercentage)}%`;
                    }

                    // Update percentage display
                    const progressPercentageElement = document.getElementById('progressPercentage');
                    if (progressPercentageElement) {
                        progressPercentageElement.textContent = `${Math.round(progressPercentage)}%`;
                        
                        // Update text color based on progress percentage for better visibility
                        if (progressPercentage < 30) {
                            progressPercentageElement.style.color = '#fff'; // White for low progress
                            progressPercentageElement.style.textShadow = '0 0 3px rgba(0, 0, 0, 0.8)';
                        } else if (progressPercentage < 70) {
                            progressPercentageElement.style.color = '#000'; // Black for medium progress
                            progressPercentageElement.style.textShadow = '0 0 2px rgba(255, 255, 255, 0.8)';
                        } else {
                            progressPercentageElement.style.color = '#000'; // Black for high progress
                            progressPercentageElement.style.textShadow = '0 0 2px rgba(255, 255, 255, 0.8)';
                        }
                    }

                    // Action Buttons and Inline Edit Fields
                    if (isCurrentUserProfile) {
            

                        if (claimDailyBonusButton) claimDailyBonusButton.style.display = 'inline-flex'; // NEW: Show daily bonus button
                        updateDailyBonusUI(); // NEW: Update daily bonus UI

                        

                        // Show inline edit fields and account settings for owner
                        const profileDetailsSection = displayNameInput ? displayNameInput.closest('.profile-details-section') : null; // Null check
                        if (profileDetailsSection) {
                            profileDetailsSection.style.display = 'flex';
                        }
                        // Populate inline edit fields
                        if (displayNameInput) displayNameInput.value = displayedUserProfileData.username || ""; // Null check
                        if (bioTextarea) bioTextarea.value = displayedUserProfileData.bio || ""; // Null check
                        if (locationInput) locationInput.value = displayedUserProfileData.location || ""; // Null check
                        if (schoolInput) schoolInput.value = displayedUserProfileData.school || ""; // NEW
                        if (workInput) workInput.value = displayedUserProfileData.work || ""; // NEW
                        if (interestsInput) interestsInput.value = displayedUserProfileData.interests || ""; // NEW
                        if (websiteInput) websiteInput.value = displayedUserProfileData.website || ""; // NEW
                        if (socialLinksInput) socialLinksInput.value = displayedUserProfileData.socialLinks || ""; // NEW

                        // Populate privacy toggles
                        if (toggleEmailVisibility) toggleEmailVisibility.checked = visibility.emailPublic ?? false;
                        if (togglePhoneVisibility) togglePhoneVisibility.checked = visibility.phoneVisible ?? false;
                        if (toggleLocationVisibility) toggleLocationVisibility.checked = visibility.location ?? false;
                        if (toggleUserIdVisibility) toggleUserIdVisibility.checked = visibility.userId ?? true; // Default to true for User ID
                        if (toggleOnlineStatusVisibility) toggleOnlineStatusVisibility.checked = visibility.lastOnline ?? false;
                        if (toggleFriendRequests) toggleFriendRequests.checked = visibility.allowFriendRequests ?? true;
                        if (toggleMessages) toggleMessages.checked = visibility.allowMessages ?? true;
                        if (toggleSchoolVisibility) toggleSchoolVisibility.checked = visibility.school ?? false;
                        if (toggleWorkVisibility) toggleWorkVisibility.checked = visibility.work ?? false;
                        if (toggleInterestsVisibility) toggleInterestsVisibility.checked = visibility.interests ?? false;
                        if (toggleWebsiteVisibility) toggleWebsiteVisibility.checked = visibility.website ?? false;
                        if (toggleSocialLinksVisibility) toggleSocialLinksVisibility.checked = visibility.socialLinks ?? false;
                        // Show privacy toggles and save button
                        if (toggleEmailVisibility) toggleEmailVisibility.closest('.privacy-toggle-group').style.display = 'flex';
                        if (togglePhoneVisibility) togglePhoneVisibility.closest('.privacy-toggle-group').style.display = 'flex';
                        if (toggleLocationVisibility) toggleLocationVisibility.closest('.privacy-toggle-group').style.display = 'flex';
                        if (toggleUserIdVisibility) toggleUserIdVisibility.closest('.privacy-toggle-group').style.display = 'flex';
                        if (toggleOnlineStatusVisibility) toggleOnlineStatusVisibility.closest('.privacy-toggle-group').style.display = 'flex';
                        if (toggleFriendRequests) toggleFriendRequests.closest('.privacy-toggle-group').style.display = 'flex';
                        if (toggleMessages) toggleMessages.closest('.privacy-toggle-group').style.display = 'flex';
                        if (toggleSchoolVisibility) toggleSchoolVisibility.closest('.privacy-toggle-group').style.display = 'flex';
                        if (toggleWorkVisibility) toggleWorkVisibility.closest('.privacy-toggle-group').style.display = 'flex';
                        if (toggleInterestsVisibility) toggleInterestsVisibility.closest('.privacy-toggle-group').style.display = 'flex';
                        if (toggleWebsiteVisibility) toggleWebsiteVisibility.closest('.privacy-toggle-group').style.display = 'flex';
                        if (toggleSocialLinksVisibility) toggleSocialLinksVisibility.closest('.privacy-toggle-group').style.display = 'flex';

                        // Populate customization selects
                        if (profileFrameSelect) profileFrameSelect.value = displayedUserProfileData.profileFrame || 'default';
                        if (chatBubbleStyleSelect) chatBubbleStyleSelect.value = displayedUserProfileData.chatBubbleStyle || 'default';
                        if (profileThemeSelect) profileThemeSelect.value = displayedUserProfileData.profileTheme || 'default';
                        // Show customization options and save button
                        if (profileFrameSelect) profileFrameSelect.closest('.customization-option').style.display = 'flex';
                        if (chatBubbleStyleSelect) chatBubbleStyleSelect.closest('.customization-option').style.display = 'flex';
                        if (profileThemeSelect) profileThemeSelect.closest('.customization-option').style.display = 'flex';
                        if (saveCustomizationButton) saveCustomizationButton.style.display = 'inline-flex';

                        // Show privacy settings button and load privacy settings
                        if (privacySettingsBtn) privacySettingsBtn.style.display = 'inline-flex';
                        if (savePrivacySettingsButton) savePrivacySettingsButton.style.display = 'inline-flex';
                        
                        // Load privacy settings
                        loadPrivacySettings(displayedUserProfileData);

                        if (profileEmailInput) profileEmailInput.value = displayedUserProfileData.email || ""; // Populate disabled email field, null check

                        // Show toggle button for account settings
                        if (toggleAccountSettingsButton) toggleAccountSettingsButton.style.display = 'inline-flex';
                        
                        // Calculate and update profile completion for current user
                        calculateAndUpdateProfileCompletion(displayedUserProfileData);

                        // NEW: Show unlocked rewards for owner
                        await fetchAndDisplayUnlockedRewards();
                        
                        // Calculate and update profile completion
                        calculateAndUpdateProfileCompletion(displayedUserProfileData);

                    } else if (currentUser) { // If logged in and viewing another user
                        // Hide all owner-specific buttons and editing sections
                        

                        if (claimDailyBonusButton) claimDailyBonusButton.style.display = 'none'; // Hide daily bonus button for others
                        if (dailyBonusCountdown) dailyBonusCountdown.style.display = 'none'; // Hide daily bonus countdown for others
                        
                        // Show Report User Button
                        if (reportUserButton) reportUserButton.style.display = 'inline-flex';

                        // Hide inline edit fields and account settings
                        const profileDetailsSection = displayNameInput ? displayNameInput.closest('.profile-details-section') : null; // Null check
                        if (profileDetailsSection) {
                            profileDetailsSection.style.display = 'none';
                        }
                        if (toggleAccountSettingsButton) toggleAccountSettingsButton.style.display = 'none'; // NEW: Hide toggle button for others
                        if (accountSettingsSection) accountSettingsSection.style.display = 'none'; // NEW: Hide account settings for others

                        // Hide owner-specific sections
                        if (unlockedRewardsSection) unlockedRewardsSection.style.display = 'none';
                        if (profileFrameSelect) profileFrameSelect.closest('.customization-option').style.display = 'none';
                        if (chatBubbleStyleSelect) chatBubbleStyleSelect.closest('.customization-option').style.display = 'none';
                        if (profileThemeSelect) profileThemeSelect.closest('.customization-option').style.display = 'none';
                        if (saveCustomizationButton) saveCustomizationButton.style.display = 'none';
                        if (savePrivacySettingsButton) savePrivacySettingsButton.style.display = 'none';
                        if (privacySettingsBtn) privacySettingsBtn.style.display = 'none';
                        if (toggleEmailVisibility) toggleEmailVisibility.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleLocationVisibility) toggleLocationVisibility.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleUserIdVisibility) toggleUserIdVisibility.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleOnlineStatusVisibility) toggleOnlineStatusVisibility.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleFriendRequests) toggleFriendRequests.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleMessages) toggleMessages.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleSchoolVisibility) toggleSchoolVisibility.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleWorkVisibility) toggleWorkVisibility.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleInterestsVisibility) toggleInterestsVisibility.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleWebsiteVisibility) toggleWebsiteVisibility.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleSocialLinksVisibility) toggleSocialLinksVisibility.closest('.privacy-toggle-group').style.display = 'none';
                        
                        // Calculate and update profile completion for other users
                        calculateAndUpdateProfileCompletion(displayedUserProfileData);
                    } else { // Not logged in, viewing any profile
                        

                        if (claimDailyBonusButton) claimDailyBonusButton.style.display = 'none'; // Hide daily bonus button
                        if (dailyBonusCountdown) dailyBonusCountdown.style.display = 'none'; // Hide daily bonus countdown
                        if (reportUserButton) reportUserButton.style.display = 'none'; // Hide report user button
                        // Hide inline edit fields and account settings
                        const profileDetailsSection = displayNameInput ? displayNameInput.closest('.profile-details-section') : null; // Null check
                        if (profileDetailsSection) {
                            profileDetailsSection.style.display = 'none';
                        }
                        if (toggleAccountSettingsButton) toggleAccountSettingsButton.style.display = 'none'; // NEW: Hide toggle button
                        if (accountSettingsSection) accountSettingsSection.style.display = 'none'; // NEW: Hide account settings
                        // Hide all new sections as well if profile not found
                        if (unlockedRewardsSection) unlockedRewardsSection.style.display = 'none';
                        if (friendsSnippetSection) friendsSnippetSection.style.display = 'none';
                        if (profileFrameSelect) profileFrameSelect.closest('.customization-option').style.display = 'none';
                        if (chatBubbleStyleSelect) chatBubbleStyleSelect.closest('.customization-option').style.display = 'none';
                        if (profileThemeSelect) profileThemeSelect.closest('.customization-option').style.display = 'none';
                        if (saveCustomizationButton) saveCustomizationButton.style.display = 'none';
                        if (savePrivacySettingsButton) savePrivacySettingsButton.style.display = 'none';
                        if (privacySettingsBtn) privacySettingsBtn.style.display = 'none';
                        if (toggleEmailVisibility) toggleEmailVisibility.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleLocationVisibility) toggleLocationVisibility.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleUserIdVisibility) toggleUserIdVisibility.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleOnlineStatusVisibility) toggleOnlineStatusVisibility.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleFriendRequests) toggleFriendRequests.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleMessages) toggleMessages.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleSchoolVisibility) toggleSchoolVisibility.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleWorkVisibility) toggleWorkVisibility.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleInterestsVisibility) toggleInterestsVisibility.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleWebsiteVisibility) toggleWebsiteVisibility.closest('.privacy-toggle-group').style.display = 'none';
                        if (toggleSocialLinksVisibility) toggleSocialLinksVisibility.closest('.privacy-toggle-group').style.display = 'none';
                        
                        // Calculate and update profile completion for non-logged in users
                        calculateAndUpdateProfileCompletion(displayedUserProfileData);
                    }

                    // Load user's posts (if desired on profile page)
                    // await fetchAndDisplayUserPosts(userIdToDisplay, displayedUserProfileData.username || "User");
                    if (userPostsFeed) userPostsFeed.style.display = 'none'; // Keep posts section hidden for now as it's not fully styled for this page., null check

                    // Friends are now displayed via modal, no need to pre-load here
                    
                    // Fetch and update the real friend count for the Friends stat
                    await fetchAndUpdateFriendCount();



                    showEnhancedSmartSuccess("Profile loaded!", 'update');
                    


                    // After displaying profile, check for level ups (only for owner)
                    if (isCurrentUserProfile && currentUserProfileData) {
                        await checkAndApplyLevelUps(currentUser.uid, currentUserProfileData.level, currentUserProfileData.totalGasEarned);
                    }

                } else {
                    if (profileUsername) profileUsername.textContent = "User Not Found"; // Null check
                    if (profileBio) profileBio.textContent = "This user profile does not exist or is unavailable."; // Null check
                    console.error("User profile not found.");
                    // Hide inline edit fields and account settings
                    const profileDetailsSection = displayNameInput ? displayNameInput.closest('.profile-details-section') : null; // Null check
                    if (profileDetailsSection) {
                        profileDetailsSection.style.display = 'none';
                    }
                    if (toggleAccountSettingsButton) toggleAccountSettingsButton.style.display = 'none'; // NEW: Hide toggle button
                    if (accountSettingsSection) accountSettingsSection.style.display = 'none'; // NEW: Hide account settings
                    // Hide all new sections as well if profile not found
                    if (unlockedRewardsSection) unlockedRewardsSection.style.display = 'none';
                    if (friendsSnippetSection) friendsSnippetSection.style.display = 'none';

                    if (profileFrameSelect) profileFrameSelect.closest('.customization-option').style.display = 'none';
                    if (chatBubbleStyleSelect) chatBubbleStyleSelect.closest('.customization-option').style.display = 'none';
                    if (profileThemeSelect) profileThemeSelect.closest('.customization-option').style.display = 'none';
                    if (saveCustomizationButton) saveCustomizationButton.style.display = 'none';
                    if (savePrivacySettingsButton) savePrivacySettingsButton.style.display = 'none';
                    if (privacySettingsBtn) privacySettingsBtn.style.display = 'none';
                    if (toggleEmailVisibility) toggleEmailVisibility.closest('.privacy-toggle-group').style.display = 'none';
                    if (toggleLocationVisibility) toggleLocationVisibility.closest('.privacy-toggle-group').style.display = 'none';
                    if (toggleUserIdVisibility) toggleUserIdVisibility.closest('.privacy-toggle-group').style.display = 'none';
                    if (toggleOnlineStatusVisibility) toggleOnlineStatusVisibility.closest('.privacy-toggle-group').style.display = 'none';
                    if (toggleFriendRequests) toggleFriendRequests.closest('.privacy-toggle-group').style.display = 'none';
                    if (toggleMessages) toggleMessages.closest('.privacy-toggle-group').style.display = 'none';
                    if (toggleSchoolVisibility) toggleSchoolVisibility.closest('.privacy-toggle-group').style.display = 'none';
                    if (toggleWorkVisibility) toggleWorkVisibility.closest('.privacy-toggle-group').style.display = 'none';
                    if (toggleInterestsVisibility) toggleInterestsVisibility.closest('.privacy-toggle-group').style.display = 'none';
                    if (toggleWebsiteVisibility) toggleWebsiteVisibility.closest('.privacy-toggle-group').style.display = 'none';
                    if (toggleSocialLinksVisibility) toggleSocialLinksVisibility.closest('.privacy-toggle-group').style.display = 'none';

                }
            } catch (error) {
                console.error("JCHAT_ERROR: Error fetching user profile:", error);
                if (profileUsername) profileUsername.textContent = "Error Loading Profile"; // Null check
                if (profileBio) profileBio.textContent = "An error occurred while loading this profile."; // Null check
                console.error(`Failed to load profile: ${error.message}`);
                

                // Hide inline edit fields and account settings
                const profileDetailsSection = displayNameInput ? displayNameInput.closest('.profile-details-section') : null; // Null check
                if (profileDetailsSection) {
                    profileDetailsSection.style.display = 'none';
                }
                if (toggleAccountSettingsButton) toggleAccountSettingsButton.style.display = 'none'; // NEW: Hide toggle button
                if (accountSettingsSection) accountSettingsSection.style.display = 'none'; // NEW: Hide account settings
                // Hide all new sections on error as well
                if (unlockedRewardsSection) unlockedRewardsSection.style.display = 'none';
                if (friendsSnippetSection) friendsSnippetSection.style.display = 'none';

                if (profileFrameSelect) profileFrameSelect.closest('.customization-option').style.display = 'none';
                if (chatBubbleStyleSelect) chatBubbleStyleSelect.closest('.customization-option').style.display = 'none';
                if (profileThemeSelect) profileThemeSelect.closest('.customization-option').style.display = 'none';
                if (saveCustomizationButton) saveCustomizationButton.style.display = 'none';
                if (savePrivacySettingsButton) savePrivacySettingsButton.style.display = 'none';
                if (privacySettingsBtn) privacySettingsBtn.style.display = 'none';
                if (toggleEmailVisibility) toggleEmailVisibility.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleLocationVisibility) toggleLocationVisibility.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleOnlineStatusVisibility) toggleOnlineStatusVisibility.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleFriendRequests) toggleFriendRequests.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleMessages) toggleMessages.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleSchoolVisibility) toggleSchoolVisibility.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleWorkVisibility) toggleWorkVisibility.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleInterestsVisibility) toggleInterestsVisibility.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleWebsiteVisibility) toggleWebsiteVisibility.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleSocialLinksVisibility) toggleSocialLinksVisibility.closest('.privacy-toggle-group').style.display = 'none';

            } finally {
                // Ensure the message box clears if it was persistent loading type
                

                

            }
        }
        // --- Authentication State Listener ---
        onAuthStateChanged(auth, async (user) => {
            try {
                if (user) {
                    currentUser = user;
                    isAuthReady = true; // Set auth ready flag
                    console.log("JCHAT_DEBUG: User authenticated in Profile Page:", user.uid);
                    
                    // Fetch system settings first as they are needed by profile display functions
                    await fetchSystemSettings();
                    // Fetch header profile next, as it sets currentUserProfileData
                    await fetchAndDisplayHeaderProfile(user); 

                    // Determine which user's profile to display
                    const urlParams = new URLSearchParams(window.location.search);
                    displayedUserId = urlParams.get('userId') || currentUser.uid; // Default to current user's ID

                    // Fetch and display user profile after header profile is ready
                    await fetchAndDisplayUserProfile(displayedUserId);
                    fetchNotificationCount(user.uid); // Fetch notification count
                    
                    // Presence heartbeat
                    try {
                        const userDocRef = doc(db, "artifacts", appId, "public", "data", "users", user.uid);
                        const post = async () => { try { await setDoc(userDocRef, { online: navigator.onLine, lastActive: serverTimestamp() }, { merge: true }); } catch {} };
                        post();
                        window.addEventListener('online', post);
                        window.addEventListener('offline', post);
                        window.addEventListener('beforeunload', () => { try { navigator.sendBeacon && navigator.sendBeacon('/'); } catch {} });
                    } catch {}

                    // Hide loader after profile is fully loaded
                    hideLoader();

                } else {
                console.log("JCHAT_DEBUG: No user signed in.");
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("JCHAT_DEBUG: Signed in with custom token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("JCHAT_DEBUG: Signed in anonymously.");
                    }
                    // onAuthStateChanged will be triggered again with the new user
                } catch (error) {
                    console.error("JCHAT_ERROR: Error during anonymous sign-in or custom token sign-in:", error);
                    if (!auth.currentUser) {
                        window.location.href = '/login.html';
                    }
                }
                isAuthReady = false;
                if (logoutButtonAccount) logoutButtonAccount.disabled = true; // Account settings logout button, null check
                if (headerDisplayName) headerDisplayName.textContent = "Guest"; // Null check
                if (headerProfilePic) headerProfilePic.style.display = 'none'; // Null check
                if (headerAvatarIcon) headerAvatarIcon.style.display = 'block'; // Null check
                if (adminIconLink) adminIconLink.style.display = 'none'; // Ensure admin icon is hidden, null check
                console.log("Please log in to view profiles.");
                // Display generic message if not logged in and no specific user ID is provided
                if (profileUsername) profileUsername.textContent = "Please Log In"; // Null check
                if (profileBio) profileBio.textContent = "Log in to view your profile or search for other users."; // Null check
                // Clear actions if they exist
                // if (profileActions) profileActions.innerHTML = ''; // Removed - element doesn't exist
                // Hide inline edit fields and account settings
                const profileDetailsSection = displayNameInput ? displayNameInput.closest('.profile-details-section') : null; // Null check
                if (profileDetailsSection) {
                    profileDetailsSection.style.display = 'none';
                }
                // Hide account settings if they exist
                // if (toggleAccountSettingsButton) toggleAccountSettingsButton.style.display = 'none'; // Removed - element doesn't exist
                // if (accountSettingsSection) accountSettingsSection.style.display = 'none'; // Removed - element doesn't exist
                // Hide all new sections as well
                // if (unlockedRewardsSection) unlockedRewardsSection.style.display = 'none'; // Removed - element doesn't exist
                // if (friendsSnippetSection) friendsSnippetSection.style.display = 'none'; // Removed - element doesn't exist
                // if (recentActivitySection) recentActivitySection.style.display = 'none'; // Removed - element doesn't exist
                // if (profileFrameSelect) profileFrameSelect.closest('.customization-option').style.display = 'none'; // Removed - element doesn't exist
                // if (chatBubbleStyleSelect) chatBubbleStyleSelect.closest('.customization-option').style.display = 'none'; // Removed - element doesn't exist
                // if (profileThemeSelect) profileThemeSelect.closest('.customization-option').style.display = 'none'; // Removed - element doesn't exist
                // if (saveCustomizationButton) saveCustomizationButton.style.display = 'none'; // Removed - element doesn't exist
                // if (savePrivacySettingsButton) savePrivacySettingsButton.style.display = 'none'; // Removed - element doesn't exist
                // if (privacySettingsBtn) privacySettingsBtn.style.display = 'none'; // Removed - element doesn't exist
                if (toggleEmailVisibility) toggleEmailVisibility.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleLocationVisibility) toggleLocationVisibility.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleOnlineStatusVisibility) toggleOnlineStatusVisibility.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleFriendRequests) toggleFriendRequests.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleMessages) toggleMessages.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleSchoolVisibility) toggleSchoolVisibility.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleWorkVisibility) toggleWorkVisibility.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleInterestsVisibility) toggleInterestsVisibility.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleWebsiteVisibility) toggleWebsiteVisibility.closest('.privacy-toggle-group').style.display = 'none';
                if (toggleSocialLinksVisibility) toggleSocialLinksVisibility.closest('.privacy-toggle-group').style.display = 'none';
                
                // Hide loader when no user is signed in
                hideLoader();
            }
        } catch (error) {
            console.error("JCHAT_ERROR: Error in authentication flow:", error);
            console.error(`Authentication error: ${error.message}`);
            // Hide loader on error
            hideLoader();
        } finally {
            // Always ensure loader is hidden after authentication flow
            console.log("JCHAT_DEBUG: Authentication flow complete");
        }
        });
        // --- Scroll Toggle Button Functionality ---
        function initializeScrollToggle() {
            const scrollToggleBtn = document.getElementById('scrollToggleButton');
            const scrollToggleIcon = document.getElementById('scrollToggleIcon');
            let isAtTop = true;

            if (!scrollToggleBtn || !scrollToggleIcon) return;

            // Function to scroll to bottom
            function scrollToBottom() {
                window.scrollTo({
                    top: document.documentElement.scrollHeight,
                    behavior: 'smooth'
                });
                isAtTop = false;
                updateScrollToggleState();
            }

            // Function to scroll to top
            function scrollToTop() {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
                isAtTop = true;
                updateScrollToggleState();
            }

            // Function to update button state and icon
            function updateScrollToggleState() {
                if (isAtTop) {
                    scrollToggleBtn.classList.remove('scroll-to-top');

                    scrollToggleIcon.className = 'fas fa-chevron-down';
                    scrollToggleBtn.title = 'Scroll to Bottom';
                } else {
                    scrollToggleBtn.classList.add('scroll-to-top');

                    scrollToggleIcon.className = 'fas fa-chevron-up';
                    scrollToggleBtn.title = 'Scroll to Top';
                }
            }

            // Add click event listener
            scrollToggleBtn.addEventListener('click', () => {
                if (isAtTop) {
                    scrollToBottom();
                } else {
                    scrollToTop();
                }
            });

            // Update state on scroll
            let scrollTimeout;
            window.addEventListener('scroll', () => {
                if (scrollTimeout) {
                    clearTimeout(scrollTimeout);
                }
                scrollTimeout = setTimeout(() => {
                    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    const windowHeight = window.innerHeight;
                    const documentHeight = document.documentElement.scrollHeight;
                    
                    // Check if we're at top or bottom
                    if (scrollTop < 100) {
                        if (!isAtTop) {
                            isAtTop = true;
                            updateScrollToggleState();
                        }
                    } else if (scrollTop + windowHeight >= documentHeight - 100) {
                        if (isAtTop) {
                            isAtTop = false;
                            updateScrollToggleState();
                        }
                    }
                }, 150); // Increased timeout for better performance
            }, { passive: true });

            // Initialize button state
            updateScrollToggleState();
        }
        // --- User Information Toggle Functionality ---
        function initializeUserInfoToggle() {
            const userInfoToggle = document.getElementById('userInfoToggle');
            const userInfoSection = document.getElementById('userInfoSection');
            const editProfileBtn = document.getElementById('editProfileBtn');
            const viewProfileBtn = document.getElementById('viewProfileBtn');
            const profileEditForm = document.getElementById('profileEditForm');
            const saveProfileChanges = document.getElementById('saveProfileChanges');
            const cancelProfileEdit = document.getElementById('cancelProfileEdit');

            if (!userInfoToggle || !userInfoSection) return;

            let isUserInfoVisible = false;
            let isEditMode = false;

            // Toggle User Information Section
            userInfoToggle.addEventListener('click', () => {
                isUserInfoVisible = !isUserInfoVisible;
                
                if (isUserInfoVisible) {
                    userInfoSection.style.display = 'flex';
                    userInfoToggle.querySelector('.toggle-text').textContent = 'Hide User Info';
                    userInfoToggle.innerHTML = '<i class="fas fa-eye-slash"></i><span class="toggle-text">Hide User Info</span>';
                    
                    // Load and display user data
                    loadUserInfoData();
                } else {
                    userInfoSection.style.display = 'none';
                    userInfoToggle.querySelector('.toggle-text').textContent = 'Show User Info';
                    userInfoToggle.innerHTML = '<i class="fas fa-user-circle"></i><span class="toggle-text">Show User Info</span>';
                    
                    // Reset to view mode
                    if (isEditMode) {
                        toggleEditMode(false);
                    }
                }
            });

            // Edit Profile Button
            if (editProfileBtn) {
                editProfileBtn.addEventListener('click', () => {
                    toggleEditMode(true);
                });
            }

            // View Profile Button
            if (viewProfileBtn) {
                viewProfileBtn.addEventListener('click', () => {
                    toggleEditMode(false);
                });
            }

            // Save Profile Changes
            if (saveProfileChanges) {
                saveProfileChanges.addEventListener('click', async () => {
                    await saveUserInfoData();
                });
            }

            // Cancel Profile Edit
            if (cancelProfileEdit) {
                cancelProfileEdit.addEventListener('click', () => {
                    toggleEditMode(false);
                    loadUserInfoData(); // Reload original data
                });
            }

            // Toggle between edit and view modes
            function toggleEditMode(editMode) {
                isEditMode = editMode;
                
                if (editMode) {
                    profileEditForm.style.display = 'block';
                    editProfileBtn.style.display = 'none';
                    viewProfileBtn.style.display = 'inline-flex';
                    
                    // Populate form with current data
                    populateEditForm();
                } else {
                    profileEditForm.style.display = 'none';
                    editProfileBtn.style.display = 'inline-flex';
                    viewProfileBtn.style.display = 'none';
                }
            }

            // Load user information data
            async function loadUserInfoData() {
                try {
                    const user = auth.currentUser;
                    if (!user) return;

                    // Use the same data source as profileUsername for consistency
                    const privateProfileDocRef = doc(db, "artifacts", appId, "users", user.uid, "profiles", "user_profile");
                    const userDoc = await getDoc(privateProfileDocRef);
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        
                        // Update display values using the same field names as profileUsername
                        document.getElementById('displayNameValue').textContent = userData.username || 'Not set';
                        document.getElementById('locationValue').textContent = userData.location || 'Not set';
                        document.getElementById('schoolValue').textContent = userData.school || 'Not set';
                        document.getElementById('workValue').textContent = userData.work || 'Not set';
                        document.getElementById('bioValue').textContent = userData.bio || 'Not set';
                        document.getElementById('interestsValue').textContent = userData.interests || 'Not set';
                    }
                } catch (error) {
                    console.error('Error loading user info:', error);
                }
            }

            // Populate edit form with current data
            function populateEditForm() {
                try {
                    const user = auth.currentUser;
                    if (!user) return;

                    // Get current display values
                    const displayName = document.getElementById('displayNameValue').textContent;
                    const location = document.getElementById('locationValue').textContent;
                    const school = document.getElementById('schoolValue').textContent;
                    const work = document.getElementById('workValue').textContent;
                    const bio = document.getElementById('bioValue').textContent;
                    const interests = document.getElementById('interestsValue').textContent;

                    // Populate form fields (only if not "Not set") with null checks
                    const editDisplayName = document.getElementById('editDisplayName');
                    const editEmail = document.getElementById('editEmail');
                    const editPhone = document.getElementById('editPhone');
                    const editLocation = document.getElementById('editLocation');
                    const editSchool = document.getElementById('editSchool');
                    const editWork = document.getElementById('editWork');
                    const editBio = document.getElementById('editBio');
                    const editInterests = document.getElementById('editInterests');
                    
                    if (editDisplayName) editDisplayName.value = displayName !== 'Not set' ? displayName : '';
                    if (editEmail) editEmail.value = email !== 'Not set' ? email : '';
                    if (editPhone) editPhone.value = phone !== 'Not set' ? phone : '';
                    if (editLocation) editLocation.value = location !== 'Not set' ? location : '';
                    if (editSchool) editSchool.value = school !== 'Not set' ? school : '';
                    if (editWork) editWork.value = work !== 'Not set' ? work : '';
                    if (editBio) editBio.value = bio !== 'Not set' ? bio : '';
                    if (editInterests) editInterests.value = interests !== 'Not set' ? interests : '';
                } catch (error) {
                    console.error('Error populating edit form:', error);
                }
            }

            // Save user information data
            async function saveUserInfoData() {
                try {
                    const user = auth.currentUser;
                    if (!user) return;

                    // Get form values with null checks
                    const editDisplayNameEl = document.getElementById('editDisplayName');
                    const editEmailEl = document.getElementById('editEmail');
                    const editPhoneEl = document.getElementById('editPhone');
                    const editLocationEl = document.getElementById('editLocation');
                    const editSchoolEl = document.getElementById('editSchool');
                    const editWorkEl = document.getElementById('editWork');
                    const editBioEl = document.getElementById('editBio');
                    const editInterestsEl = document.getElementById('editInterests');
                    
                    const displayName = editDisplayNameEl ? editDisplayNameEl.value.trim() : '';
                    const email = editEmailEl ? editEmailEl.value.trim() : '';
                    const phone = editPhoneEl ? editPhoneEl.value.trim() : '';
                    const location = editLocationEl ? editLocationEl.value.trim() : '';
                    const school = editSchoolEl ? editSchoolEl.value.trim() : '';
                    const work = editWorkEl ? editWorkEl.value.trim() : '';
                    const bio = editBioEl ? editBioEl.value.trim() : '';
                    const interests = editInterestsEl ? editInterestsEl.value.trim() : '';

                    // Update user document in the same location as profileUsername data
                    const privateProfileDocRef = doc(db, "artifacts", appId, "users", user.uid, "profiles", "user_profile");
                    await updateDoc(privateProfileDocRef, {
                        username: displayName || null,  // Use 'username' field to match profileUsername
                        email: email || null,
                        phone: phone || null,
                        location: location || null,
                        school: school || null,
                        work: work || null,
                        bio: bio || null,
                        interests: interests || null,
                        updatedAt: serverTimestamp()
                    });

                    // Update display values
                    document.getElementById('displayNameValue').textContent = displayName || 'Not set';
                    document.getElementById('emailValue').textContent = email || 'Not set';
                    document.getElementById('phoneValue').textContent = phone || 'Not set';
                    document.getElementById('locationValue').textContent = location || 'Not set';
                    document.getElementById('schoolValue').textContent = school || 'Not set';
                    document.getElementById('workValue').textContent = work || 'Not set';
                    document.getElementById('bioValue').textContent = bio || 'Not set';
                    document.getElementById('interestsValue').textContent = interests || 'Not set';

                    // Switch back to view mode
                    toggleEditMode(false);

                    // Show success message
                    showEnhancedSmartSuccess('Profile updated successfully!', 'update');

                } catch (error) {
                    console.error('Error saving user info:', error);
                    console.error('Error updating profile. Please try again.');
                }
            }
        }

        // Save Privacy Settings Function
        async function savePrivacySettings() {
            try {
                const user = auth.currentUser;
                if (!user) {
                    console.error('Please log in to save privacy settings.');
                    return;
                }

                // Show saving message
                console.log("Saving privacy settings...");

                // Collect privacy settings values
                const privacySettings = {
                    emailPublic: toggleEmailVisibility ? toggleEmailVisibility.checked : false,
                    phoneVisible: togglePhoneVisibility ? togglePhoneVisibility.checked : false,
                    locationVisible: toggleLocationVisibility ? toggleLocationVisibility.checked : false,
                    userIdVisible: toggleUserIdVisibility ? toggleUserIdVisibility.checked : false,
                    schoolVisible: toggleSchoolVisibility ? toggleSchoolVisibility.checked : false,
                    workVisible: toggleWorkVisibility ? toggleWorkVisibility.checked : false,
                    interestsVisible: toggleInterestsVisibility ? toggleInterestsVisibility.checked : false,
                    websiteVisible: toggleWebsiteVisibility ? toggleWebsiteVisibility.checked : false,
                    socialLinksVisible: toggleSocialLinksVisibility ? toggleSocialLinksVisibility.checked : false,
                    onlineStatusVisible: toggleOnlineStatusVisibility ? toggleOnlineStatusVisibility.checked : false,
                    allowFriendRequests: toggleFriendRequests ? toggleFriendRequests.checked : true,
                    allowDirectMessages: toggleMessages ? toggleMessages.checked : true,
                    updatedAt: serverTimestamp()
                };

                // Update privacy settings in the user's profile document
                const privateProfileDocRef = doc(db, "artifacts", appId, "users", user.uid, "profiles", "user_profile");
                await updateDoc(privateProfileDocRef, {
                    visibility: privacySettings
                });

                // Update profile completion after saving privacy settings
                if (currentUserProfileData) {
                    currentUserProfileData.visibility = privacySettings;
                    calculateAndUpdateProfileCompletion(currentUserProfileData);
                }

                // Hide loading message and show success
                showEnhancedSmartSuccess('Privacy settings saved successfully!', 'update');
                
                console.log('Privacy settings saved:', privacySettings);

            } catch (error) {
                console.error('Error saving privacy settings:', error);
                console.error('Error saving privacy settings. Please try again.');
            }
        }

        // Load Privacy Settings Function
        async function loadPrivacySettings(userData) {
            if (!userData || !userData.visibility) return;
            
            const visibility = userData.visibility;
            
            // Populate privacy toggles with saved values
            if (toggleEmailVisibility) toggleEmailVisibility.checked = visibility.emailPublic || false;
            if (togglePhoneVisibility) togglePhoneVisibility.checked = visibility.phoneVisible || false;
            if (toggleLocationVisibility) toggleLocationVisibility.checked = visibility.locationVisible || false;
            if (toggleUserIdVisibility) toggleUserIdVisibility.checked = visibility.userIdVisible || false;
            if (toggleSchoolVisibility) toggleSchoolVisibility.checked = visibility.schoolVisible || false;
            if (toggleWorkVisibility) toggleWorkVisibility.checked = visibility.workVisible || false;
            if (toggleInterestsVisibility) toggleInterestsVisibility.checked = visibility.interestsVisible || false;
            if (toggleWebsiteVisibility) toggleWebsiteVisibility.checked = visibility.websiteVisible || false;
            if (toggleSocialLinksVisibility) toggleSocialLinksVisibility.checked = visibility.socialLinksVisible || false;
            if (toggleOnlineStatusVisibility) toggleOnlineStatusVisibility.checked = visibility.onlineStatusVisible || false;
            if (toggleFriendRequests) toggleFriendRequests.checked = visibility.allowFriendRequests !== false; // Default true
            if (toggleMessages) toggleMessages.checked = visibility.allowDirectMessages !== false; // Default true
        }

        // --- Event Listeners (moved to DOMContentLoaded for safety) ---
        document.addEventListener('DOMContentLoaded', () => {
            // Apply theme on load
            const savedTheme = localStorage.getItem('jchat-theme');
            const themes = ['theme-light-mode', 'theme-dark-mode', 'theme-glass-mode', 'theme-sunset-mode'];
            if (savedTheme && themes.includes(savedTheme)) {
                document.body.classList.remove(...themes);
                document.body.classList.add(savedTheme);
            } else {
                document.body.classList.remove(...themes);
                document.body.classList.add('theme-dark-mode'); // Default
            }

            // Initialize Scroll Toggle Button
            initializeScrollToggle();

            // Profile Picture Upload
            if (profilePicUploadInput) profilePicUploadInput.addEventListener('change', handleProfilePicChange); // Null check

            // Profile Edit
            if (saveProfileChanges) saveProfileChanges.addEventListener('click', handleSaveProfileChanges); // Null check



            // NEW: User ID Copy Button
            if (copyUserIdBtn) copyUserIdBtn.addEventListener('click', handleCopyUserId); // Null check







            // Initialize Touch Gestures for Mobile
            initializeTouchGestures();

            // Initialize Theme Presets
            initializeThemePresets();

            // Initialize Profile Notifications
            profileNotifications = new ProfileNotifications();

            // NEW: User Information Toggle Functionality
            initializeUserInfoToggle();

            // Account Settings Toggle
            if (toggleAccountSettingsButton) {
                toggleAccountSettingsButton.addEventListener('click', () => {
                    if (accountSettingsSection) {
                        const isHidden = accountSettingsSection.style.display === 'none';
                        accountSettingsSection.style.display = isHidden ? 'flex' : 'none'; // Use flex for column layout
                        // Change button text/icon based on state
                        toggleAccountSettingsButton.innerHTML = isHidden ?
                            '<i class="fas fa-times-circle"></i> Close Settings' :
                            '<i class="fas fa-cog"></i> Manage Account Settings';
                    }
                });
            }

            // NEW: Friends Button and Modal Event Listeners (exactly like Chat.html)
            const friendsStatItem = document.getElementById('friendsStatItem');
            const friendsButtonIcon = document.getElementById('friendsButtonIcon');
            const selectFriendModal = document.getElementById('selectFriendModal');
            const closeFriendModalBtn = document.getElementById('closeFriendModalBtn');
            const friendSearchInput = document.getElementById('friendSearchInput');
            
            if (friendsStatItem && friendsButtonIcon && selectFriendModal) {
                friendsStatItem.addEventListener('click', () => {
                    // Add button press effect
                    friendsStatItem.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        friendsStatItem.style.transform = '';
                    }, 150);
                    
                    // Show modal
                    selectFriendModal.classList.add('active');
                    
                    // Set up online status tracking
                    setupOnlineStatusTracking();
                    
                    // Fetch and display friends in modal
                    fetchAndDisplayFriendsInModal();
                });
            }

            // Close modal with close button
            if (closeFriendModalBtn) {
                closeFriendModalBtn.addEventListener('click', () => {
                    selectFriendModal.classList.remove('active');
                    console.log('JCHAT_DEBUG: Modal closed via close button');
                });
            }

            // Close modal when clicking outside
            if (selectFriendModal) {
                selectFriendModal.addEventListener('click', (e) => {
                    if (e.target.id === 'selectFriendModal') {
                        e.target.classList.remove('active');
                        console.log('JCHAT_DEBUG: Modal closed via outside click');
                    }
                });
            }

            // Close modal with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (selectFriendModal && selectFriendModal.classList.contains('active')) {
                        selectFriendModal.classList.remove('active');
                        console.log('JCHAT_DEBUG: Modal closed via Escape key');
                    }
                }
            });

            // Search functionality
            if (friendSearchInput) {
                friendSearchInput.addEventListener('input', (e) => {
                    filterFriendsInModal(e.target.value);
                });
            }

            // Account Settings
            const changeEmailForm = document.getElementById('changeEmailForm'); // Get form element here
            if (changeEmailForm) changeEmailForm.addEventListener('submit', handleChangeEmail); // Null check
            if (updateEmailButton) updateEmailButton.addEventListener('click', handleChangeEmail); // Also listen to button click
            if (changePasswordButton) changePasswordButton.addEventListener('click', handleChangePassword); // Null check
            if (logoutButtonAccount) logoutButtonAccount.addEventListener('click', handleLogout); // Logout button in account settings, null check

            // JCoin Request Modal Event Listeners
            if (cancelJCoinRequestButton) cancelJCoinRequestButton.addEventListener('click', hideJCoinRequestModal); // Null check
            if (submitJCoinRequestButton) submitJCoinRequestButton.addEventListener('click', submitJCoinRequest); // Null check

            // Calculate JCoins dynamically as Naira amount changes
            if (nairaAmountInput && calculatedJCoinsSpan) { // Null check
                nairaAmountInput.addEventListener('input', () => {
                    const nairaAmount = parseInt(nairaAmountInput.value);
                    if (!isNaN(nairaAmount) && nairaAmount > 0) {
                        const calculatedJCoins = calculateJCoins(nairaAmount);
                        calculatedJCoinsSpan.textContent = `${calculatedJCoins.toLocaleString()} JCoins`;
                    } else {
                        calculatedJCoinsSpan.textContent = '0 JCoins';
                    }
                });
            }

            // Handle receipt file input change
            if (receiptUploadInput && receiptFileNameSpan && receiptPreviewImg) { // Null check
                receiptUploadInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        receiptFileNameSpan.textContent = file.name;
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            receiptPreviewImg.src = e.target.result;
                            receiptPreviewImg.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    } else {
                        receiptFileNameSpan.textContent = 'No file chosen';
                        receiptPreviewImg.style.display = 'none';
                        receiptPreviewImg.src = '';
                    }
                });
            }

            // Allow clicking the custom file input wrapper to trigger the hidden input
            const fileInputWrapper = document.querySelector('.file-input-wrapper');
            if (fileInputWrapper && receiptUploadInput) { // Null check
                fileInputWrapper.addEventListener('click', () => {
                    receiptUploadInput.click();
                });
            }

            // NEW: Explicit click listener for the progress bar container
            if (progressBarContainer) { // Null check
                progressBarContainer.style.cursor = 'pointer'; // Add pointer cursor to indicate clickability
                progressBarContainer.addEventListener('click', () => {
                    window.location.href = '/Levels.html'; // Navigate to levels.html
                });
            }

            // NEW: Daily Bonus button listener
            if (claimDailyBonusButton) claimDailyBonusButton.addEventListener('click', claimDailyBonus);

            // NEW: Report User button and modal listeners
            if (reportUserButton) reportUserButton.addEventListener('click', showReportUserModal);
            if (cancelReportButton) cancelReportButton.addEventListener('click', hideReportUserModal);
            if (submitReportButton) submitReportButton.addEventListener('click', submitReport);

            // Privacy Settings Event Listeners
            if (privacySettingsBtn) {
                privacySettingsBtn.addEventListener('click', () => {
                    if (privacySettingsSection) {
                        const isHidden = privacySettingsSection.style.display === 'none';
                        privacySettingsSection.style.display = isHidden ? 'block' : 'none';
                        
                        // Update button text based on state
                        if (isHidden) {
                            privacySettingsBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Privacy Settings';
                        } else {
                            privacySettingsBtn.innerHTML = '<i class="fas fa-shield-alt"></i> Privacy Settings';
                        }
                    }
                });
            }

            if (savePrivacySettingsButton) {
                savePrivacySettingsButton.addEventListener('click', savePrivacySettings);
            }

            // Contact Modal Event Listeners
            const contactIcon = document.getElementById('contactIcon');
            const contactModal = document.getElementById('contactModal');
            const closeContactModal = document.getElementById('closeContactModal');

            // Show contact modal
            if (contactIcon) {
                contactIcon.addEventListener('click', () => {
                    if (contactModal) {
                        contactModal.classList.add('active');
                        document.body.style.overflow = 'hidden'; // Prevent background scrolling
                    }
                });
            }

            // Hide contact modal
            function hideContactModal() {
                if (contactModal) {
                    contactModal.classList.remove('active');
                    document.body.style.overflow = ''; // Restore scrolling
                }
            }

            // Close modal when clicking close button
            if (closeContactModal) {
                closeContactModal.addEventListener('click', hideContactModal);
            }

            // Close modal when clicking outside the content
            if (contactModal) {
                contactModal.addEventListener('click', (e) => {
                    if (e.target === contactModal) {
                        hideContactModal();
                    }
                });
            }

            // Close modal with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && contactModal && contactModal.classList.contains('active')) {
                    hideContactModal();
                }
            });

        }); // Close DOMContentLoaded event listener

        window.addEventListener('storage', (event) => {
            if (event.key === 'jchat-theme') {
                const newTheme = event.newValue || 'theme-dark-mode';
                const themes = ['theme-light-mode', 'theme-dark-mode', 'theme-glass-mode', 'theme-sunset-mode'];
                if (themes.includes(newTheme)) {
                    document.body.classList.remove(...themes);
                    document.body.classList.add(newTheme);
                }
            }
        });

        window.addEventListener('beforeunload', () => {
            // Clear daily bonus interval on page unload
            if (dailyBonusInterval) {
                clearInterval(dailyBonusInterval);
                dailyBonusInterval = null;
            }
            // No specific Firestore listeners to unsubscribe from on this page currently
        });

    </script>
</body>
</html>
