<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JCHAT — Sign In</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;800&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#0f1724; --bg2:#0b1220; --pink:#ff2e92; --blue:#00d5ff; --card:#0f1116; --muted:rgba(255,255,255,.75);
      --radius:14px; --glass:rgba(255,255,255,.03); --accent-gradient:linear-gradient(90deg,var(--blue),var(--pink));
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{font-family:Inter, Poppins, system-ui, -apple-system, sans-serif;background:radial-gradient(circle at 10% 20%,var(--blue),transparent 120px),radial-gradient(circle at 90% 80%,var(--pink),transparent 160px),linear-gradient(180deg,var(--bg1),var(--bg2));color:#fff;display:flex;align-items:center;justify-content:center;padding:24px}

    .auth-card{width:100%;max-width:480px;border-radius:16px;background:linear-gradient(145deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.04);overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.6)}
    .auth-header{padding:36px 28px;background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.2));text-align:center}
    .brand{font-family:Poppins, Inter, sans-serif;font-weight:800;font-size:44px;background:var(--accent-gradient);-webkit-background-clip:text;background-clip:text;color:transparent}
    .headline{margin-top:8px;font-size:18px;color:var(--muted)}

    .auth-body{padding:28px}
    .form-row{margin-bottom:16px}
    label.field-label{display:block;font-size:12px;font-weight:600;margin-bottom:8px;color:var(--muted);text-transform:uppercase;letter-spacing:0.6px}
    input.field-input, button.btn, .link-button{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.04);background:var(--glass);color:#fff;font-size:15px}
    input.field-input:focus{outline:none;box-shadow:0 8px 30px rgba(0,0,0,.6);border-color:var(--pink)}

    .btn{background:var(--accent-gradient);border:none;font-weight:700;cursor:pointer;letter-spacing:0.6px}
    .muted{color:var(--muted);font-size:13px;text-align:center;margin-top:14px}
    .mode-toggle{background:none;border:none;color:var(--blue);cursor:pointer;font-weight:700}

    .helper{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;color:var(--muted);font-size:13px}
    .link-button{background:transparent;border:0;color:var(--muted);text-align:left;padding:0}

    .alert{padding:10px 12px;border-radius:10px;margin-bottom:12px;font-size:14px}
    .alert.error{background:linear-gradient(135deg, rgba(239,68,68,0.06), rgba(255,120,90,0.03));color:#ffb4b4;border:1px solid rgba(239,68,68,.14)}
    .alert.success{background:linear-gradient(135deg,#10b981,#06b6d4);color:#fff}

    @media (max-width:480px){.brand{font-size:36px}.auth-header{padding:26px}.auth-body{padding:20px}}
  </style>
</head>
<body>
  <main class="auth-card" role="main">
    <header class="auth-header">
      <div class="brand">JCHAT</div>
      <div class="headline" id="sub">Sign in to continue</div>
    </header>

    <section class="auth-body">
      <div id="alert" class="sr-only" aria-live="polite"></div>

      <form id="authForm" novalidate>
        <div id="signupGroup" class="hidden">
          <div class="form-row">
            <label class="field-label" for="displayName">Full name</label>
            <input id="displayName" class="field-input" name="displayName" type="text" autocomplete="name" />
          </div>
          <div class="form-row">
            <label class="field-label" for="username">Username</label>
            <input id="username" class="field-input" name="username" type="text" autocomplete="username" />
          </div>
        </div>

        <div class="form-row">
          <label class="field-label" for="email">Email</label>
          <input id="email" class="field-input" name="email" type="email" required autocomplete="email" />
        </div>

        <div class="form-row">
          <label class="field-label" for="password">Password</label>
          <input id="password" class="field-input" name="password" type="password" required autocomplete="current-password" />
        </div>

        <div id="confirmRow" class="form-row hidden">
          <label class="field-label" for="confirm">Confirm password</label>
          <input id="confirm" class="field-input" type="password" autocomplete="new-password" />
        </div>

        <div class="helper">
          <label style="display:flex;align-items:center;gap:8px;font-size:13px"><input id="remember" type="checkbox" /> Remember</label>
          <button type="button" id="forgotBtn" class="link-button">Forgot password?</button>
        </div>

        <div id="actionRow" class="form-row">
          <button id="submitBtn" class="btn" type="submit">Sign In</button>
        </div>

        <div class="muted">
          <span id="mutedText">Don't have an account?</span>
          &nbsp;
          <button type="button" id="toggleMode" class="mode-toggle">Create account</button>
        </div>
      </form>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, sendEmailVerification, updateProfile, setPersistence, browserLocalPersistence, browserSessionPersistence, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.8.0/firebase-auth.js';
    import { getFirestore, doc, setDoc, serverTimestamp, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBsBinyrD9WZZXRaCvA4gxfX7BIimydDvo",
      authDomain: "jchat-1.firebaseapp.com",
      projectId: "jchat-1",
      storageBucket: "jchat-1.firebasestorage.app",
      messagingSenderId: "328479683167",
      appId: "1:328479683167:web:276c0b7e8ea44dd2d6a1ea",
      measurementId: "G-S6Z9GG0R9P"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = id => document.getElementById(id);
    const alertEl = $('alert');
    const authForm = $('authForm');
    const submitBtn = $('submitBtn');
    const toggleMode = $('toggleMode');
    const signupGroup = $('signupGroup');
    const confirmRow = $('confirmRow');
    const mutedText = $('mutedText');
    const sub = $('sub');

    let isSignup = false;

    function showAlert(message, type='error'){
      alertEl.className = '';
      alertEl.textContent = message;
      alertEl.classList.add('alert');
      alertEl.classList.add(type==='error' ? 'error' : 'success');
      alertEl.classList.remove('sr-only');
      setTimeout(()=>{ alertEl.classList.add('sr-only'); }, 6000);
    }

    function clearAlert(){ alertEl.className='sr-only'; alertEl.textContent=''; }

    function setLoading(flag, text){ submitBtn.disabled = flag; submitBtn.textContent = flag ? (text||'Please wait...') : (isSignup ? 'Create account' : 'Sign In'); }

    toggleMode.addEventListener('click', ()=>{
      isSignup = !isSignup;
      signupGroup.classList.toggle('hidden', !isSignup);
      confirmRow.classList.toggle('hidden', !isSignup);
      mutedText.textContent = isSignup ? 'Already have an account?' : "Don't have an account?";
      toggleMode.textContent = isSignup ? 'Sign in' : 'Create account';
      sub.textContent = isSignup ? 'Create your JCHAT account' : 'Sign in to continue';
      submitBtn.textContent = isSignup ? 'Create account' : 'Sign In';
      clearAlert();
    });

    function validEmail(email){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); }

    authForm.addEventListener('submit', async (e)=>{
      e.preventDefault(); clearAlert();
      const email = $('email').value.trim();
      const password = $('password').value;
      if(!email || !password){ showAlert('Please complete all required fields.'); return; }
      if(!validEmail(email)){ showAlert('Please enter a valid email.'); return; }
      if(password.length < 6){ showAlert('Password must be at least 6 characters.'); return; }

      if(isSignup){
        const confirm = $('confirm').value;
        const displayName = $('displayName').value.trim();
        const username = $('username').value.trim().toLowerCase();
        if(!displayName){ showAlert('Please enter your full name.'); return; }
        if(!username || username.length < 3){ showAlert('Choose a username (3+ chars).'); return; }
        if(password !== confirm){ showAlert('Passwords do not match.'); return; }

        setLoading(true,'Creating account...');
        try{
          // prevent duplicate username
          const q = query(collection(db,'users'), where('username','==',username));
          const snap = await getDocs(q);
          if(!snap.empty){ setLoading(false); showAlert('Username already taken.'); return; }

          const cred = await createUserWithEmailAndPassword(auth,email,password);
          const user = cred.user;
          await updateProfile(user,{displayName});
          await setDoc(doc(db,'users',user.uid),{uid:user.uid,email:user.email,displayName,username,provider:'email',createdAt:serverTimestamp()});
          try{ await sendEmailVerification(user); }catch(e){}
          showAlert('Account created — redirecting...', 'success');
          setTimeout(()=>location.href='Home.html',900);
        }catch(err){ setLoading(false); handleError(err); }

      } else {
        setLoading(true,'Signing in...');
        try{
          await setPersistence(auth, $('remember').checked ? browserLocalPersistence : browserSessionPersistence);
          const cred = await signInWithEmailAndPassword(auth,email,password);
          const user = cred.user;
          await setDoc(doc(db,'users',user.uid),{lastLogin:serverTimestamp()}, {merge:true});
          showAlert('Signed in — redirecting...', 'success');
          setTimeout(()=>location.href='Home.html',700);
        }catch(err){ setLoading(false); handleError(err); }
      }
    });

    $('forgotBtn').addEventListener('click', async ()=>{
      clearAlert(); const email = $('email').value.trim();
      if(!email){ showAlert('Enter your email to receive a reset link.'); return; }
      if(!validEmail(email)){ showAlert('Please enter a valid email.'); return; }
      setLoading(true,'Sending...');
      try{ await sendPasswordResetEmail(auth,email); setLoading(false); showAlert('Reset link sent. Check your inbox.','success'); }catch(err){ setLoading(false); handleError(err); }
    });

    function handleError(err){ const code = err && err.code ? String(err.code) : ''; let msg='Operation failed. Please try again.'; switch(code){ case 'auth/user-not-found': msg='No account for that email.'; break; case 'auth/wrong-password': msg='Incorrect password.'; break; case 'auth/email-already-in-use': msg='Email already in use.'; break; case 'auth/weak-password': msg='Password too weak.'; break; case 'auth/invalid-email': msg='Invalid email address.'; break; case 'auth/network-request-failed': msg='Network error.'; break; } showAlert(msg); }

    onAuthStateChanged(auth,user=>{ if(user) setTimeout(()=>location.href='Home.html',350); });
  </script>
</body>
</html>
