<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JCHAT â€” Sign In</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root{
      --pink:#ff2e92;
      --blue:#00d5ff;
      --white:#fff;
      --text-light:rgba(255,255,255,.75);
      --border-light:rgba(255,255,255,.06);
      --card-background:linear-gradient(145deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      --header-background:linear-gradient(135deg, rgba(10,10,10,.85), rgba(10,10,10,.75));
      --radius:18px;
      --transition:.28s ease;
      --button-background:linear-gradient(90deg,var(--blue),var(--pink));
      --button-shadow:0 6px 20px rgba(0,213,255,.08),0 6px 20px rgba(255,46,146,.06);
      --input-background:rgba(255,255,255,.03);
    }

    html,body{height:100%}
    body{
      font-family:'Inter', 'Poppins', system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
      background:radial-gradient(circle at 10% 10%, var(--blue), transparent 140px), radial-gradient(circle at 90% 90%, var(--pink), transparent 160px), linear-gradient(135deg,#11121b,#0e0f1a);
      display:flex;align-items:center;justify-content:center;padding:24px;color:var(--white);
      min-height:100vh;overflow-x:hidden
    }

    .card{
      width:100%;max-width:460px;border-radius:var(--radius);background:var(--card-background);backdrop-filter:blur(14px);border:1px solid var(--border-light);box-shadow:var(--button-shadow);overflow:hidden
    }

    .card-header{
      padding:36px 28px;background:var(--header-background);text-align:center
    }

    .brand{
      font-family:'Poppins',sans-serif;font-weight:800;font-size:46px;line-height:1;color:transparent;background:linear-gradient(90deg,var(--pink),var(--blue));-webkit-background-clip:text;margin-bottom:8px;text-shadow:0 8px 18px rgba(0,0,0,.45)
    }

    .headline{font-size:20px;font-weight:600;color:var(--white);margin-bottom:6px}
    .subhead{font-size:13px;color:var(--text-light)}

    .card-body{padding:30px}

    .field{margin-bottom:18px}
    .field label{display:block;font-size:12px;font-weight:700;margin-bottom:8px;color:linear-gradient(90deg,var(--blue),var(--pink));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .input{width:100%;padding:14px 16px;border-radius:12px;border:1px solid var(--border-light);background:var(--input-background);color:var(--white);font-size:15px;transition:all var(--transition)}
    .input:focus{outline:none;box-shadow:0 8px 30px rgba(0,0,0,.5);transform:translateY(-2px);border-color:var(--pink)}

    .actions{margin-top:6px}

    .btn{display:inline-flex;align-items:center;justify-content:center;width:100%;padding:14px;border-radius:12px;border:none;background:var(--button-background);color:var(--white);font-weight:700;letter-spacing:0.6px;cursor:pointer;transition:all var(--transition);box-shadow:var(--button-shadow)}
    .btn:active{transform:translateY(1px)}

    .muted{color:var(--text-light);font-size:13px;text-align:center;margin-top:16px}

    .toggle-mode{background:none;border:none;color:var(--blue);cursor:pointer;font-weight:700}

    .row{display:flex;gap:12px}

    .small-link{color:var(--text-light);font-size:13px;text-decoration:none}

    .inline-help{font-size:13px;color:var(--text-light);display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}

    .hidden{display:none}

    .error{background:linear-gradient(135deg, rgba(239,68,68,0.08), rgba(255,150,100,0.04));border:1px solid rgba(239,68,68,.18);color:#ffb4b4;padding:10px 12px;border-radius:10px;font-size:13px;margin-bottom:12px}

    .success{background:linear-gradient(135deg,#10b981,#06b6d4);color:#fff;padding:10px 12px;border-radius:10px;font-size:13px;margin-bottom:12px}

    .link-btn{background:none;border:none;color:var(--text-light);text-decoration:underline;cursor:pointer}

    @media (max-width:480px){.brand{font-size:36px}.card{max-width:92vw}.card-header{padding:26px}.card-body{padding:20px}}
  </style>
</head>
<body>
  <main class="card" role="main">
    <header class="card-header">
      <div class="brand">JCHAT</div>
      <div class="headline" id="modeHeadline">Welcome Back</div>
      <div class="subhead" id="modeSub">Sign in to continue to your account</div>
    </header>

    <section class="card-body">
      <div id="alert" class="hidden" role="status"></div>

      <form id="authForm" novalidate>
        <div id="signupFields" class="hidden">
          <div class="field">
            <label for="displayName">Full name</label>
            <input id="displayName" name="displayName" class="input" type="text" autocomplete="name" placeholder="Jane Doe">
          </div>
          <div class="field">
            <label for="username">Username</label>
            <input id="username" name="username" class="input" type="text" placeholder="janedoe">
          </div>
        </div>

        <div class="field">
          <label for="emailField">Email address</label>
          <input id="emailField" name="email" class="input" type="email" required placeholder="you@example.com" autocomplete="email">
        </div>

        <div class="field">
          <label for="passwordField">Password</label>
          <input id="passwordField" name="password" class="input" type="password" required placeholder="Enter password" autocomplete="current-password">
        </div>

        <div id="confirmPassField" class="field hidden">
          <label for="confirmPassword">Confirm password</label>
          <input id="confirmPassword" class="input" type="password" placeholder="Confirm password" autocomplete="new-password">
        </div>

        <div class="inline-help">
          <label class="row" style="align-items:center">
            <input id="remember" type="checkbox" style="margin-right:8px" aria-label="Remember me"> Remember me
          </label>
          <button type="button" id="forgotBtn" class="link-btn">Forgot?</button>
        </div>

        <div class="field actions">
          <button id="submitBtn" class="btn" type="submit">Sign In</button>
        </div>

        <div class="muted">
          <span id="mutedText">Don't have an account?</span>
          &nbsp;
          <button type="button" id="toggleMode" class="toggle-mode">Create account</button>
        </div>
      </form>

    </section>
  </main>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, sendEmailVerification, updateProfile, setPersistence, browserLocalPersistence, browserSessionPersistence, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.8.0/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBsBinyrD9WZZXRaCvA4gxfX7BIimydDvo",
      authDomain: "jchat-1.firebaseapp.com",
      projectId: "jchat-1",
      storageBucket: "jchat-1.firebasestorage.app",
      messagingSenderId: "328479683167",
      appId: "1:328479683167:web:276c0b7e8ea44dd2d6a1ea",
      measurementId: "G-S6Z9GG0R9P"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const el = id => document.getElementById(id);
    const alertEl = el('alert');
    const form = el('authForm');
    const submitBtn = el('submitBtn');
    const toggleModeBtn = el('toggleMode');
    const signupFields = el('signupFields');
    const confirmPassField = el('confirmPassField');
    const modeHeadline = el('modeHeadline');
    const modeSub = el('modeSub');
    const mutedText = el('mutedText');
    const rememberCheckbox = el('remember');

    let signupMode = false;

    function showAlert(message, type='error'){
      alertEl.className = '';
      alertEl.classList.remove('hidden');
      alertEl.textContent = message;
      if(type==='error') alertEl.classList.add('error'); else alertEl.classList.add('success');
      setTimeout(()=>{ alertEl.classList.add('hidden'); }, 7000);
    }

    function setLoading(loading, text){
      submitBtn.disabled = loading;
      submitBtn.textContent = loading ? (text || 'Please wait...') : (signupMode ? 'Create account' : 'Sign In');
      submitBtn.style.opacity = loading? '0.8' : '1';
    }

    function isValidEmail(email){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); }

    toggleModeBtn.addEventListener('click', ()=>{
      signupMode = !signupMode;
      signupFields.classList.toggle('hidden', !signupMode);
      confirmPassField.classList.toggle('hidden', !signupMode);
      modeHeadline.textContent = signupMode ? 'Create your account' : 'Welcome Back';
      modeSub.textContent = signupMode ? 'Register to start using JCHAT' : 'Sign in to continue to your account';
      mutedText.textContent = signupMode ? 'Already have an account?' : "Don't have an account?";
      toggleModeBtn.textContent = signupMode ? 'Sign in' : 'Create account';
      submitBtn.textContent = signupMode ? 'Create account' : 'Sign In';
    });

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = el('emailField').value.trim();
      const password = el('passwordField').value;
      setAlertHidden();

      if(!email || !password){ showAlert('Please complete all required fields.'); return; }
      if(!isValidEmail(email)){ showAlert('Please enter a valid email address.'); return; }
      if(password.length < 6){ showAlert('Password must be at least 6 characters.'); return; }

      if(signupMode){
        const confirm = el('confirmPassword').value || '';
        const displayName = el('displayName').value.trim();
        const username = el('username').value.trim();
        if(!displayName){ showAlert('Please provide your full name.'); return; }
        if(!username || username.length < 3){ showAlert('Please choose a username (3+ chars).'); return; }
        if(password !== confirm){ showAlert('Passwords do not match.'); return; }
        setLoading(true, 'Creating account...');
        try{
          const userCred = await createUserWithEmailAndPassword(auth, email, password);
          const user = userCred.user;
          await updateProfile(user, { displayName });
          await setDoc(doc(db, 'users', user.uid), {
            uid: user.uid, email: user.email, displayName, username: username.toLowerCase(), provider: 'email', createdAt: serverTimestamp()
          });
          try{ await sendEmailVerification(user); }catch(e){}
          showAlert('Account created. Redirecting...', 'success');
          setTimeout(()=> location.href = 'Home.html', 1200);
        }catch(err){
          setLoading(false); handleFirebaseError(err);
        }
      } else {
        setLoading(true, 'Signing in...');
        try{
          await setPersistence(auth, rememberCheckbox.checked ? browserLocalPersistence : browserSessionPersistence);
          const userCred = await signInWithEmailAndPassword(auth, email, password);
          const user = userCred.user;
          await setDoc(doc(db, 'users', user.uid), { lastLogin: serverTimestamp() }, { merge: true });
          showAlert('Signed in. Redirecting...', 'success');
          setTimeout(()=> location.href = 'Home.html', 800);
        }catch(err){ setLoading(false); handleFirebaseError(err); }
      }
    });

    function setAlertHidden(){ alertEl.classList.add('hidden'); alertEl.className='hidden'; alertEl.textContent=''; }

    function handleFirebaseError(err){
      const code = err && err.code ? String(err.code) : '';
      let msg = 'Authentication failed. Please try again.';
      switch(code){
        case 'auth/user-not-found': msg = 'No account found with that email.'; break;
        case 'auth/wrong-password': msg = 'Incorrect password.'; break;
        case 'auth/email-already-in-use': msg = 'An account with that email already exists.'; break;
        case 'auth/weak-password': msg = 'Password too weak. Choose a stronger one.'; break;
        case 'auth/invalid-email': msg = 'Invalid email address.'; break;
        case 'auth/network-request-failed': msg = 'Network error. Check your connection.'; break;
      }
      showAlert(msg);
    }

    el('forgotBtn').addEventListener('click', async ()=>{
      const email = el('emailField').value.trim();
      if(!email){ showAlert('Enter your email to receive a reset link.'); return; }
      if(!isValidEmail(email)){ showAlert('Please enter a valid email address.'); return; }
      setLoading(true, 'Sending reset...');
      try{ await sendPasswordResetEmail(auth, email); setLoading(false); showAlert('Reset link sent to your email.', 'success'); }catch(err){ setLoading(false); handleFirebaseError(err); }
    });

    onAuthStateChanged(auth, (user)=>{ if(user){ /* auto-redirect if already signed in */ setTimeout(()=> location.href='Home.html', 300); } });

    // Username availability check (basic): prevents duplicate usernames during signup
    el('username').addEventListener('blur', async ()=>{
      const username = el('username').value.trim();
      if(!username) return;
      try{
        const q = query(collection(db,'users'), where('username','==',username.toLowerCase()));
        const snap = await getDocs(q);
        if(!snap.empty) showAlert('Username already taken. Choose another.');
      }catch(e){ /* ignore silently */ }
    });

    // Initialize button label
    submitBtn.textContent = 'Sign In';

  </script>
</body>
</html>
