<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JCHAT - Groups</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    :root {
      --pink: #ff7ac6;
      --blue: #6aa7ff;
      --bg: #0b1220;
      --panel: #0f172a;
      --panel-2: #111827;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --border: #1f2937;
      --border-light: #374151;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --grad: linear-gradient(135deg, var(--pink), var(--blue));
    }
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; background: #0b1220; color: var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; height: 100%; }
    body { display: flex; flex-direction: column; }

    /* Header */
    header { position: sticky; top: 0; z-index: 20; background: linear-gradient(135deg, rgba(10, 10, 20, .85), rgba(10, 10, 20, .75)); border-bottom: 1px solid var(--border); box-shadow: 0 4px 15px rgba(0,0,0,.25); }
    .header-inner { max-width: 1200px; margin: 0 auto; padding: 10px 16px; display: flex; align-items: center; justify-content: space-between; }
    .brand { display: flex; align-items: center; gap: 10px; font-weight: 800; letter-spacing: -0.02em; }
    .brand .title { background-image: var(--grad); -webkit-background-clip: text; background-clip: text; color: transparent; font-family: Poppins, Inter, sans-serif; font-size: 18px; }
    .header-actions { display: flex; align-items: center; gap: 12px; }
    .balance-pill { display: inline-flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.06); border: 1px solid var(--border); padding: 6px 10px; border-radius: 999px; font-size: 12px; }
    .balance-pill i { background-image: var(--grad); -webkit-background-clip: text; background-clip: text; color: transparent; }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--panel-2); color: var(--text); font-weight: 600; cursor: pointer; transition: all .2s ease; text-decoration: none; }
    .btn:hover { transform: translateY(-1px); border-color: var(--blue); box-shadow: 0 6px 18px rgba(0,0,0,.25); }
    .btn.primary { background-image: var(--grad); color: #0b1220; border: 0; }

    /* Layout */
    .layout { flex: 1; display: grid; grid-template-columns: 300px 1fr; gap: 16px; padding: 16px; max-width: 1200px; width: 100%; margin: 0 auto; }
    @media (max-width: 900px) { .layout { grid-template-columns: 1fr; } }

    .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; box-shadow: var(--shadow); overflow: hidden; }
    .panel-header { padding: 12px 14px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); }
    .panel-title { font-weight: 800; font-family: Poppins, Inter, sans-serif; background-image: var(--grad); -webkit-background-clip: text; background-clip: text; color: transparent; }

    /* Sidebar: rooms */
    .search { display: flex; gap: 8px; padding: 10px 12px; border-bottom: 1px solid var(--border); }
    .input { flex: 1; padding: 10px 12px; background: var(--panel-2); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-size: 14px; }
    .rooms { max-height: calc(100vh - 230px); overflow: auto; padding: 8px; display: flex; flex-direction: column; gap: 8px; }
    .room-item { display: grid; grid-template-columns: 36px 1fr auto; gap: 10px; align-items: center; padding: 10px; border: 1px solid var(--border); background: var(--panel-2); border-radius: 12px; cursor: pointer; transition: all .2s ease; }
    .room-item:hover { border-color: var(--blue); transform: translateY(-1px); }
    .room-avatar { width: 36px; height: 36px; border-radius: 10px; background: rgba(255,255,255,0.06); display: grid; place-items: center; font-weight: 800; color: #fff; }
    .room-meta { display: flex; flex-direction: column; gap: 2px; }
    .room-name { font-weight: 700; }
    .room-sub { font-size: 12px; color: var(--muted); }
    .pill { font-size: 12px; padding: 4px 8px; border-radius: 999px; border: 1px solid var(--border); background: rgba(255,255,255,0.06); }

    /* Chat */
    .chat { display: grid; grid-template-rows: auto 1fr auto; height: calc(100vh - 120px); }
    .chat-header { padding: 12px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); }
    .chat-title { display: flex; align-items: center; gap: 12px; }
    .vault { display: inline-flex; gap: 8px; align-items: center; background: rgba(255,255,255,0.06); border: 1px solid var(--border); padding: 6px 10px; border-radius: 999px; font-size: 12px; }
    .chat-actions { display: flex; gap: 8px; }
    .messages { padding: 12px; overflow: auto; display: flex; flex-direction: column; gap: 10px; background: radial-gradient(ellipse at top left, rgba(255,122,198,0.05), transparent 300px), radial-gradient(ellipse at bottom right, rgba(106,167,255,0.05), transparent 300px); }
    .msg { display: grid; grid-template-columns: 36px 1fr; gap: 10px; }
    .msg-avatar { width: 36px; height: 36px; border-radius: 10px; background: rgba(255,255,255,0.06); display: grid; place-items: center; font-weight: 800; }
    .msg-bubble { background: var(--panel-2); border: 1px solid var(--border); border-radius: 12px; padding: 10px; }
    .msg-head { display: flex; gap: 8px; align-items: center; margin-bottom: 4px; }
    .msg-name { font-weight: 700; }
    .msg-time { color: var(--muted); font-size: 12px; }
    .msg-text { white-space: pre-wrap; overflow-wrap: anywhere; }
    .composer { display: grid; grid-template-columns: 1fr auto; gap: 8px; padding: 12px; border-top: 1px solid var(--border); }

    /* Empty / overlay */
    .empty { color: var(--muted); text-align: center; padding: 30px 10px; }

    /* Modal */
    .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.55); backdrop-filter: blur(6px); z-index: 50; }
    .card { width: min(560px, 92vw); max-height: 90vh; overflow: auto; background: var(--panel); border: 1px solid var(--border-light); border-radius: 16px; box-shadow: var(--shadow); }
    .card-hd { padding: 14px 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .card-hd h3 { margin: 0; font-weight: 800; background-image: var(--grad); -webkit-background-clip: text; background-clip: text; color: transparent; }
    .card-bd { padding: 16px; display: grid; gap: 12px; }
    .card-ft { padding: 12px 16px; border-top: 1px solid var(--border); display: flex; gap: 10px; }
    .row { display: grid; gap: 8px; }
    .help { color: var(--muted); font-size: 12px; }

    /* Message box */
    .toast { position: fixed; top: 16px; right: 16px; background: var(--panel); border: 1px solid var(--border); padding: 12px 14px; border-radius: 10px; box-shadow: var(--shadow); transform: translateX(400px); transition: transform .3s ease; z-index: 60; }
    .toast.show { transform: translateX(0); }
    .toast.success { border-left: 4px solid var(--success); }
    .toast.error { border-left: 4px solid var(--danger); }
    .toast.info { border-left: 4px solid var(--blue); }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="brand">
        <img src="assets/security.png" alt="JCHAT" style="height:24px;width:auto" onerror="this.style.display='none'">
        <span class="title">JCHAT Groups</span>
      </div>
      <div class="header-actions">
        <div class="balance-pill" title="Your JCoins"><i class="fas fa-coins"></i><span id="headerJc">0</span></div>
        <div class="balance-pill" title="Your Gas"><i class="fas fa-bolt"></i><span id="headerGas">0</span></div>
        <a class="btn" href="/Developer.html"><i class="fas fa-store"></i><span>Buy JCoins</span></a>
        <a class="btn" href="/Wallet.html"><i class="fas fa-wallet"></i><span>Wallet</span></a>
        <button class="btn primary" id="openCreateRoom"><i class="fas fa-plus"></i><span>New Room</span></button>
      </div>
    </div>
  </header>

  <main class="layout">
    <!-- Sidebar: Rooms -->
    <section class="panel">
      <div class="panel-header">
        <div class="panel-title">Rooms</div>
        <div class="pill" id="myRoomsCount">0</div>
      </div>
      <div class="search">
        <input id="roomSearch" class="input" type="text" placeholder="Search rooms...">
        <button class="btn" id="refreshRooms" title="Refresh"><i class="fas fa-rotate"></i></button>
      </div>
      <div class="rooms" id="myRooms"></div>
      <div class="panel-header"><div class="panel-title">Discover</div></div>
      <div class="rooms" id="discoverRooms"></div>
    </section>

    <!-- Chat -->
    <section class="panel chat">
      <div class="chat-header">
        <div class="chat-title">
          <div class="room-avatar" id="activeAvatar">#</div>
          <div>
            <div class="room-name" id="activeRoomName">Select a room</div>
            <div class="room-sub" id="activeRoomMeta">â€”</div>
          </div>
        </div>
        <div class="chat-actions">
          <div class="vault" title="Group JCoin vault"><i class="fas fa-coins"></i><span id="vaultAmount">0</span></div>
          <button class="btn" id="donateBtn"><i class="fas fa-hand-holding-usd"></i><span>Donate</span></button>
          <button class="btn" id="inviteBtn"><i class="fas fa-user-plus"></i><span>Invite</span></button>
          <button class="btn" id="leaveBtn"><i class="fas fa-door-open"></i><span>Leave</span></button>
        </div>
      </div>
      <div class="messages" id="messages">
        <div class="empty">No room selected.</div>
      </div>
      <div class="composer">
        <input id="composerInput" class="input" type="text" placeholder="Type a message..." maxlength="1000">
        <button id="sendBtn" class="btn primary"><i class="fas fa-paper-plane"></i><span>Send</span></button>
      </div>
    </section>
  </main>

  <!-- Create Room Modal -->
  <div class="modal" id="createModal" role="dialog" aria-modal="true">
    <div class="card">
      <div class="card-hd"><h3>Create Room</h3><button class="btn" id="closeCreate">Close</button></div>
      <div class="card-bd">
        <div class="row">
          <label for="roomName">Name</label>
          <input id="roomName" class="input" type="text" placeholder="e.g., Lagos Tech" maxlength="60">
        </div>
        <div class="row">
          <label for="roomDesc">Description</label>
          <input id="roomDesc" class="input" type="text" placeholder="What is this room about?" maxlength="160">
        </div>
        <div class="help">Creating a room costs <b id="createCost">1000</b> JCoins. Anti-spam measure to keep quality high. Need JCoins? <a href="/Developer.html" class="btn" style="padding:4px 8px; border-radius:8px; font-size:12px; display:inline-flex; gap:6px; vertical-align:middle"><i class="fas fa-store"></i><span>Buy from Developer</span></a></div>
      </div>
      <div class="card-ft">
        <button class="btn" id="cancelCreate">Cancel</button>
        <button class="btn primary" id="confirmCreate">Create</button>
      </div>
    </div>
  </div>

  <!-- Donate Modal -->
  <div class="modal" id="donateModal" role="dialog" aria-modal="true">
    <div class="card">
      <div class="card-hd"><h3>Donate to Vault</h3><button class="btn" id="closeDonate">Close</button></div>
      <div class="card-bd">
        <div class="row">
          <label for="donateAmount">Amount (JCoins)</label>
          <input id="donateAmount" class="input" type="number" min="1" step="1" placeholder="0">
        </div>
        <div class="help">Your balance: <b id="donateBalance">0</b> JCoins</div>
      </div>
      <div class="card-ft">
        <button class="btn" id="cancelDonate">Cancel</button>
        <button class="btn primary" id="confirmDonate">Donate</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">Info</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, collection, query, where, onSnapshot, serverTimestamp, runTransaction, orderBy, limit, getDocs, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Preserve essential config (injected when available)
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
      apiKey: "AIzaSyDz-8N0totzvMCvonF9pKj9RsoH3J8xL0w",
      authDomain: "jchat-1.firebaseapp.com",
      databaseURL: "https://jchat-1-default-rtdb.firebaseio.com",
      projectId: "jchat-1",
      storageBucket: "jchat-1.firebasestorage.app",
      messagingSenderId: "328479683167",
      appId: "1:328479683167:web:276c0b7e8ea44dd2d6a1ea",
      measurementId: "G-S6Z9GG0R9P"
    };
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM
    const roomSearch = document.getElementById('roomSearch');
    const refreshRooms = document.getElementById('refreshRooms');
    const myRoomsEl = document.getElementById('myRooms');
    const discoverRoomsEl = document.getElementById('discoverRooms');
    const myRoomsCount = document.getElementById('myRoomsCount');
    const messagesEl = document.getElementById('messages');
    const activeAvatar = document.getElementById('activeAvatar');
    const activeRoomName = document.getElementById('activeRoomName');
    const activeRoomMeta = document.getElementById('activeRoomMeta');
    const vaultAmount = document.getElementById('vaultAmount');
    const headerJc = document.getElementById('headerJc');
    const headerGas = document.getElementById('headerGas');
    const sendBtn = document.getElementById('sendBtn');
    const composerInput = document.getElementById('composerInput');
    const openCreateRoom = document.getElementById('openCreateRoom');
    const createModal = document.getElementById('createModal');
    const closeCreate = document.getElementById('closeCreate');
    const cancelCreate = document.getElementById('cancelCreate');
    const confirmCreate = document.getElementById('confirmCreate');
    const roomName = document.getElementById('roomName');
    const roomDesc = document.getElementById('roomDesc');
    const createCost = document.getElementById('createCost');
    const donateBtn = document.getElementById('donateBtn');
    const donateModal = document.getElementById('donateModal');
    const closeDonate = document.getElementById('closeDonate');
    const cancelDonate = document.getElementById('cancelDonate');
    const confirmDonate = document.getElementById('confirmDonate');
    const donateAmount = document.getElementById('donateAmount');
    const donateBalance = document.getElementById('donateBalance');
    const inviteBtn = document.getElementById('inviteBtn');
    const leaveBtn = document.getElementById('leaveBtn');
    const toast = document.getElementById('toast');

    // Economy constants (tunable via server settings in future)
    const GROUP_CREATION_COST = 1000;
    const QUEST_MSGS_DAILY_TARGET = 50; // challenging target
    const QUEST_JCOIN_REWARD = 20; // small reward; admin-reviewed

    // State
    let currentUser = null;
    let currentProfile = null;
    let selectedRoom = null; // { id, data }
    let msgUnsub = null;
    let myRooms = [];
    let discoverRooms = [];

    function showToast(message, type='info'){
      toast.textContent = message;
      toast.className = `toast ${type}`;
      requestAnimationFrame(()=> toast.classList.add('show'));
      setTimeout(()=> toast.classList.remove('show'), 3000);
    }

    function initialAvatar(text){
      if (!text) return '#';
      return text.trim().slice(0,1).toUpperCase();
    }

    function fmtDate(ts){
      try { return new Date(ts).toLocaleString(); } catch { return '' }
    }

    async function ensureAuth(){
      if (auth.currentUser) return;
      try {
        if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
      } catch {}
      if (!auth.currentUser) {
        try { await signInAnonymously(auth); } catch {}
      }
    }

    async function loadProfile(){
      if (!currentUser) return;
      const profRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profiles', 'user_profile');
      const snap = await getDoc(profRef);
      if (snap.exists()) {
        currentProfile = snap.data();
      } else {
        currentProfile = { jCoins: 0, gas: 0, username: currentUser.email || 'User', createdAt: serverTimestamp(), updatedAt: serverTimestamp() };
        await setDoc(profRef, currentProfile, { merge: true });
      }
      headerJc.textContent = (currentProfile.jCoins || 0).toLocaleString();
      headerGas.textContent = (currentProfile.gas || 0).toLocaleString();
      donateBalance.textContent = (currentProfile.jCoins || 0).toLocaleString();
    }

    function renderRooms(){
      const q = (roomSearch.value || '').toLowerCase();
      const toNode = (g) => {
        const el = document.createElement('div');
        el.className = 'room-item';
        el.dataset.id = g.id;
        el.innerHTML = `
          <div class="room-avatar">${initialAvatar(g.data.name)}</div>
          <div class="room-meta">
            <div class="room-name">${g.data.name}</div>
            <div class="room-sub">${(g.data.description||'').slice(0,80)}</div>
          </div>
          <div class="pill">${(g.data.memberCount||0)} <i class="fas fa-user" style="margin-left:6px"></i></div>
        `;
        el.addEventListener('click', ()=> selectRoom(g.id, g.data));
        return el;
      };
      myRoomsEl.innerHTML='';
      discoverRoomsEl.innerHTML='';
      const mine = myRooms.filter(g => g.data.name.toLowerCase().includes(q));
      mine.forEach(g => myRoomsEl.appendChild(toNode(g)));
      const disc = discoverRooms.filter(g => g.data.name.toLowerCase().includes(q));
      disc.forEach(g => discoverRoomsEl.appendChild(toNode(g)));
      myRoomsCount.textContent = mine.length;
    }

    async function subscribeRooms(){
      if (!currentUser) return;
      const myQ = query(collection(db, 'artifacts', appId, 'public', 'data', 'groups'), where('members', 'array-contains', currentUser.uid));
      onSnapshot(myQ, (snap)=>{
        myRooms = snap.docs.map(d=>({ id: d.id, data: d.data() }));
        renderRooms();
      });
      const discQ = query(collection(db, 'artifacts', appId, 'public', 'data', 'groups'), orderBy('memberCount', 'desc'), limit(50));
      onSnapshot(discQ, (snap)=>{
        discoverRooms = snap.docs.map(d=>({ id: d.id, data: d.data() }));
        renderRooms();
      });
    }

    function renderEmptyChat(){
      messagesEl.innerHTML = '<div class="empty">No room selected.</div>';
      activeAvatar.textContent = '#';
      activeRoomName.textContent = 'Select a room';
      activeRoomMeta.textContent = 'â€”';
      vaultAmount.textContent = '0';
    }

    function selectRoom(id, data){
      selectedRoom = { id, data };
      activeAvatar.textContent = initialAvatar(data.name);
      activeRoomName.textContent = data.name;
      activeRoomMeta.textContent = `${data.memberCount || (data.members?.length||0)} members Â· Owner ${data.ownerId ? data.ownerId.slice(0,6) : 'â€”'}`;
      vaultAmount.textContent = (data.vaultJCoins || 0).toLocaleString();
      messagesEl.innerHTML = '';
      if (msgUnsub) { msgUnsub(); msgUnsub = null; }
      const msgsCol = collection(db, 'artifacts', appId, 'public', 'data', 'groups', id, 'messages');
      const q = query(msgsCol, orderBy('createdAt', 'asc'), limit(200));
      msgUnsub = onSnapshot(q, (snap)=>{
        messagesEl.innerHTML = '';
        if (snap.empty) { messagesEl.innerHTML = '<div class="empty">Be the first to send a message.</div>'; return; }
        snap.docs.forEach(d => {
          const m = d.data();
          const row = document.createElement('div');
          row.className = 'msg';
          row.innerHTML = `
            <div class="msg-avatar">${initialAvatar(m.senderName||m.senderId)}</div>
            <div class="msg-bubble">
              <div class="msg-head"><span class="msg-name">${m.senderName||'User'}</span><span class="msg-time">${m.createdAt?.toDate ? new Date(m.createdAt.toDate()).toLocaleString() : ''}</span></div>
              <div class="msg-text">${(m.text||'')}</div>
            </div>
          `;
          messagesEl.appendChild(row);
        });
        messagesEl.scrollTop = messagesEl.scrollHeight;
      });
    }

    async function createRoom(){
      const name = (roomName.value||'').trim();
      const description = (roomDesc.value||'').trim();
      if (!name) { showToast('Room name required','error'); return; }
      if ((currentProfile?.jCoins||0) < GROUP_CREATION_COST) {
        showToast('Insufficient JCoins. Please buy in Wallet.','error');
        return;
      }
      try {
        await runTransaction(db, async (tx) => {
          const profRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profiles', 'user_profile');
          const profSnap = await tx.get(profRef);
          if (!profSnap.exists()) throw new Error('Profile not found');
          const jc = Number(profSnap.data().jCoins||0);
          if (jc < GROUP_CREATION_COST) throw new Error('Insufficient JCoins');

          const groupsCol = collection(db, 'artifacts', appId, 'public', 'data', 'groups');
          const newRef = doc(groupsCol);
          tx.set(newRef, {
            name, description,
            ownerId: currentUser.uid,
            createdAt: serverTimestamp(),
            isPublic: true,
            members: [currentUser.uid],
            memberCount: 1,
            vaultJCoins: 0,
            lastMessageAt: serverTimestamp()
          });

          tx.update(profRef, { jCoins: jc - GROUP_CREATION_COST, updatedAt: serverTimestamp() });

          const txRef = doc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions'));
          tx.set(txRef, { type: 'group_create_fee', amount: GROUP_CREATION_COST, note: `Created room ${name}`, timestamp: serverTimestamp() });
        });
        showToast('Room created','success');
        hideCreate();
      } catch (e) { console.error(e); showToast(e.message||'Failed','error'); }
    }

    async function sendMessage(){
      if (!selectedRoom) { showToast('Select a room','error'); return; }
      const text = (composerInput.value||'').trim();
      if (!text) return;
      try {
        const msgsCol = collection(db, 'artifacts', appId, 'public', 'data', 'groups', selectedRoom.id, 'messages');
        await addDoc(msgsCol, {
          senderId: currentUser.uid,
          senderName: currentProfile?.username || currentUser.email || 'User',
          text,
          createdAt: serverTimestamp()
        });
        const gRef = doc(db, 'artifacts', appId, 'public', 'data', 'groups', selectedRoom.id);
        await updateDoc(gRef, { lastMessageAt: serverTimestamp() });
        composerInput.value = '';
        incrementDailyMessageCountAndMaybeReward();
      } catch (e) { console.error(e); showToast('Send failed','error'); }
    }

    async function donateToVault(){
      if (!selectedRoom) { showToast('Select a room','error'); return; }
      const amount = Math.floor(Number(donateAmount.value||0));
      if (!amount || amount < 1) { showToast('Enter a valid amount','error'); return; }
      try {
        await runTransaction(db, async (tx) => {
          const profRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profiles', 'user_profile');
          const gRef = doc(db, 'artifacts', appId, 'public', 'data', 'groups', selectedRoom.id);
          const [profSnap, gSnap] = await Promise.all([tx.get(profRef), tx.get(gRef)]);
          if (!profSnap.exists() || !gSnap.exists()) throw new Error('Missing data');
          const jc = Number(profSnap.data().jCoins||0);
          if (jc < amount) throw new Error('Insufficient JCoins');
          const vault = Number(gSnap.data().vaultJCoins||0);
          tx.update(profRef, { jCoins: jc - amount, updatedAt: serverTimestamp() });
          tx.update(gRef, { vaultJCoins: vault + amount, updatedAt: serverTimestamp() });
          const txRef = doc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions'));
          tx.set(txRef, { type: 'group_vault_donate', amount, groupId: selectedRoom.id, timestamp: serverTimestamp() });
        });
        showToast('Donation successful','success');
        donateAmount.value = '';
        await loadProfile();
        // refresh selectedRoom data
        const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'groups', selectedRoom.id));
        if (snap.exists()) { selectedRoom.data = snap.data(); vaultAmount.textContent = (selectedRoom.data.vaultJCoins||0).toLocaleString(); }
        hideDonate();
      } catch (e) { console.error(e); showToast(e.message||'Failed','error'); }
    }

    async function joinRoom(roomId){
      try {
        await runTransaction(db, async (tx) => {
          const gRef = doc(db, 'artifacts', appId, 'public', 'data', 'groups', roomId);
          const uRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profiles', 'user_profile');
          const gSnap = await tx.get(gRef);
          if (!gSnap.exists()) throw new Error('Room not found');
          const g = gSnap.data();
          const members = Array.isArray(g.members) ? g.members : [];
          if (!members.includes(currentUser.uid)) {
            tx.update(gRef, { members: arrayUnion(currentUser.uid), memberCount: (g.memberCount||members.length||0) + 1, updatedAt: serverTimestamp() });
          }
          const uSnap = await tx.get(uRef);
          if (!uSnap.exists()) tx.set(uRef, { memberOfGroups: [roomId] }, { merge: true });
          else tx.update(uRef, { memberOfGroups: arrayUnion(roomId) });
        });
        showToast('Joined room','success');
      } catch (e) { console.error(e); showToast('Join failed','error'); }
    }

    async function leaveRoom(){
      if (!selectedRoom) return;
      const roomId = selectedRoom.id;
      try {
        await runTransaction(db, async (tx) => {
          const gRef = doc(db, 'artifacts', appId, 'public', 'data', 'groups', roomId);
          const uRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profiles', 'user_profile');
          const gSnap = await tx.get(gRef);
          if (!gSnap.exists()) throw new Error('Room not found');
          const g = gSnap.data();
          tx.update(gRef, { members: arrayRemove(currentUser.uid), memberCount: Math.max(0, (g.memberCount||0) - 1), updatedAt: serverTimestamp() });
          tx.update(uRef, { memberOfGroups: arrayRemove(roomId) });
        });
        showToast('Left room','success');
        selectedRoom = null;
        renderEmptyChat();
      } catch (e) { console.error(e); showToast('Leave failed','error'); }
    }

    // Challenging earning: local daily counter + admin-reviewed reward
    function incrementDailyMessageCountAndMaybeReward(){
      try {
        const key = `jchat-daily-msgs-${currentUser.uid}`;
        const today = new Date().toISOString().slice(0,10);
        let data = JSON.parse(localStorage.getItem(key) || '{}');
        if (data.date !== today) data = { date: today, count: 0, rewarded: false };
        data.count += 1;
        if (data.count >= QUEST_MSGS_DAILY_TARGET && !data.rewarded) {
          data.rewarded = true;
          createPendingActivityReward(currentUser.uid, currentProfile?.username || 'User', 'daily_message_streak', QUEST_JCOIN_REWARD, 5, selectedRoom?.id || null);
          showToast('Quest reached! Pending review for JCoins.','info');
        }
        localStorage.setItem(key, JSON.stringify(data));
      } catch {}
    }

    async function createPendingActivityReward(userId, username, activityType, suggestedJCoinAmount, suggestedXpAmount, groupId = null){
      try {
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'pending_activity_rewards'), {
          userId, username, activityType,
          suggestedJCoinAmount: suggestedJCoinAmount,
          suggestedXpAmount: suggestedXpAmount,
          suggestedGasAmount: 0,
          status: 'pending',
          timestamp: serverTimestamp(),
          groupId,
          reviewerId: null, reviewTimestamp: null, notes: ''
        });
      } catch (e) { console.error('reward', e); }
    }

    // UI helpers
    function showCreate(){ createModal.style.display='flex'; roomName.focus(); createCost.textContent = GROUP_CREATION_COST; }
    function hideCreate(){ createModal.style.display='none'; roomName.value=''; roomDesc.value=''; }
    function showDonate(){ if (!selectedRoom) { showToast('Select a room','error'); return; } donateModal.style.display='flex'; donateAmount.focus(); donateBalance.textContent = (currentProfile?.jCoins||0).toLocaleString(); }
    function hideDonate(){ donateModal.style.display='none'; donateAmount.value=''; }

    // Events
    openCreateRoom.addEventListener('click', showCreate);
    closeCreate.addEventListener('click', hideCreate);
    cancelCreate.addEventListener('click', hideCreate);
    confirmCreate.addEventListener('click', createRoom);
    donateBtn.addEventListener('click', showDonate);
    closeDonate.addEventListener('click', hideDonate);
    cancelDonate.addEventListener('click', hideDonate);
    confirmDonate.addEventListener('click', donateToVault);
    sendBtn.addEventListener('click', sendMessage);
    composerInput.addEventListener('keydown', (e)=>{ if (e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
    refreshRooms.addEventListener('click', renderRooms);
    roomSearch.addEventListener('input', renderRooms);
    inviteBtn.addEventListener('click', async ()=>{
      if (!selectedRoom) return;
      try {
        const url = `${location.origin}/Groups.html?room=${encodeURIComponent(selectedRoom.id)}`;
        if (navigator.share) await navigator.share({ title: 'Join my room', text: `Join ${selectedRoom.data.name}`, url });
        else { await navigator.clipboard.writeText(url); showToast('Invite link copied','info'); }
      } catch { showToast('Copy failed','error'); }
    });
    leaveBtn.addEventListener('click', leaveRoom);

    // Deep link join or open
    async function handleDeepLink(){
      const u = new URL(location.href);
      const roomId = u.searchParams.get('room');
      if (!roomId) return;
      const gRef = doc(db, 'artifacts', appId, 'public', 'data', 'groups', roomId);
      const snap = await getDoc(gRef);
      if (!snap.exists()) { showToast('Room not found','error'); return; }
      const g = snap.data();
      const isMember = (Array.isArray(g.members) && currentUser && g.members.includes(currentUser.uid));
      if (!isMember) await joinRoom(roomId);
      selectRoom(roomId, (await getDoc(gRef)).data());
    }

    onAuthStateChanged(auth, async (user)=>{
      currentUser = user || null;
      if (!currentUser) { await ensureAuth(); return; }
      await loadProfile();
      await subscribeRooms();
      await handleDeepLink();
    });

    // Bootstrap
    (async ()=>{ await ensureAuth(); renderEmptyChat(); })();
  </script>
</body>
</html>
