<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Last updated: 2025-08-21T18:19:29Z -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JCHAT - Groups</title>

    <!-- Google Fonts: Poppins for headings, Inter for body text -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Preconnect to Firebase and Cloudinary domains for faster loading -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://*.firebaseio.com" crossorigin>
    <link rel="preconnect" href="https://res.cloudinary.com" crossorigin>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* Universal box-sizing for consistent layout */
        *, *::before, *::after {
            box-sizing: border-box;
        }
        
        /* Prevent horizontal overflow on all elements */
        * {
            max-width: 100%;
        }
        
        /* Ensure no element causes horizontal scroll */
        body, html, main, .content-wrapper, .section-card {
            overflow-x: hidden;
        }

        /* Global CSS Variables (reused from Admin.html for consistency) */
        :root {
            --pink: #ff2e92;
            --blue: #00d5ff;
            --radius: 20px;
            --transition: .3s ease;

            /* Default Dark Mode variables */
            --white: #fff;
            --text-light: rgba(255, 255, 255, .7);
            --background-main: rgba(10, 10, 10, .75);
            --background-gradient-1: #00d5ff;
            --background-gradient-2: #ff2e92;
            --card-background: linear-gradient(145deg, rgba(255, 255, 255, .03), rgba(255, 255, 255, .01));
            --header-background: linear-gradient(135deg, rgba(10, 10, 10, .85), rgba(10, 10, 10, .75));
            --border-light: rgba(255, 255, 255, .05);
            --input-background: rgba(255, 255, 255, 0.05);
            --button-background-gradient: linear-gradient(90deg, var(--blue), var(--pink));
            --button-shadow: 0 4px 15px var(--blue), 0 4px 15px var(--pink);

            /* Semantic Colors */
            --background-color-primary: #1a1a2e;
            --background-color-secondary: #0f0f1f;
            --header-background-color: #2a2a4a;
            --footer-background-color: #2a2a4a;
            --content-background-color: #20203a;
            --card-background-color: #2a2a4a;
            --text-color-primary: #e0e0e0;
            --text-color-secondary: #b0b0d0;
            --notification-badge-color: #ff2e92;
            --status-online: #4CAF50;
            --status-offline: #6c757d;
            --status-away: #FFC107;
            --delete-button-color: #dc3545;
            --warning-color: #ffc107;
            --accent-color: #00d5ff;
            --accent-color-dark: #00aaff;
            --border-color: #3a3a5a;
        }

        /* Theme Definitions (Light, Dark, Glass, Sunset) */
        body.theme-light-mode {
            --background-main: #f0f2f5;
            background-image: none !important;
            --white: #333;
            --text-light: #666;
            --card-background: rgba(255, 255, 255, 0.95);
            --header-background: rgba(255, 255, 255, 0.98);
            --border-light: rgba(0, 0, 0, 0.1);
            --input-background: rgba(0, 0, 0, 0.05);
            --button-background-gradient: linear-gradient(90deg, #6dd5ed, #2193b0);
            --button-shadow: 0 4px 15px rgba(109, 213, 237, 0.4), 0 4px 15px rgba(33, 147, 176, 0.4);

            --background-color-primary: #f0f2f5;
            --background-color-secondary: #e0e2e5;
            --header-background-color: #ffffff;
            --footer-background-color: #ffffff;
            --content-background-color: #f7f9fb;
            --card-background-color: #ffffff;
            --text-color-primary: #333333;
            --text-color-secondary: #666666;
            --accent-color: #007bff;
            --accent-color-dark: #0056b3;
            --border-color: #e0e0e0;
            --input-background-color: #f0f0f0;
            --button-background: #e9ecef;
            --button-hover-background: #dee2e6;
            --active-item-background: rgba(0, 123, 255, 0.1);
            --notification-badge-color: #dc3545;
            --status-online: #28a745;
            --status-offline: #6c757d;
            --status-away: #ffc107;
            --delete-button-color: #dc3545;
            --warning-color: #ffc107;
        }

        body.theme-dark-mode {
            --background-main: #1a1a2e;
            background-image: radial-gradient(circle at top left, #16213e, transparent 100px),
                              radial-gradient(circle at bottom right, #0f3460, transparent 150px) !important;
            --white: #e0e0e0;
            --text-light: #a0a0a0;
            --card-background: rgba(25, 25, 40, 0.7);
            --header-background: linear-gradient(135deg, rgba(10, 10, 20, .85), rgba(10, 10, 20, .75));
            --border-light: rgba(255, 255, 255, 0.08);
            --input-background: rgba(255, 255, 255, 0.08);
            --button-background-gradient: linear-gradient(90deg, #e94560, #ba2f49);
            --button-shadow: 0 4px 15px rgba(233, 69, 96, 0.4), 0 4px 15px rgba(186, 47, 73, 0.4);

            --background-color-primary: #121212;
            --background-color-secondary: #1e1e1e;
            --header-background-color: #2c2c2c;
            --footer-background-color: #2c2c2c;
            --content-background-color: #242424;
            --card-background-color: #2c2c2c;
            --text-color-primary: #ffffff;
            --text-color-secondary: #bbbbbb;
            --accent-color: #bb86fc;
            --accent-color-dark: #9a67ea;
            --border-color: #444444;
            --input-background-color: #383838;
            --button-background: #383838;
            --button-hover-background: #505050;
            --active-item-background: rgba(187, 134, 252, 0.2);
            --notification-badge-color: #cf6679;
            --delete-button-color: #f44336;
            --warning-color: #ffeb3b;
        }

        body.theme-glass-mode {
            --background-main: rgba(10, 10, 10, 0.75);
            background-image: url('https://source.unsplash.com/random/1920x1080?abstract,blur') !important;
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
            backdrop-filter: blur(10px);
            --card-background: rgba(25, 25, 40, 0.7);
            --white: #e0e0e0;
            --text-light: rgba(255, 255, 255, 0.7);
            --input-background: rgba(255, 255, 255, 0.05);
            --border-light: rgba(255, 255, 255, 0.1);
            --button-background-gradient: linear-gradient(90deg, var(--pink), var(--blue));
            --button-shadow: 0 4px 15px var(--blue), 0 4px 15px var(--pink);
            box-shadow: inset 0 0 100px rgba(0, 0, 0, 0.5);

            --background-color-primary: rgba(10, 10, 10, 0.75);
            --background-color-secondary: rgba(10, 10, 10, 0.6);
            --header-background-color: rgba(10, 10, 10, 0.85);
            --footer-background-color: rgba(10, 10, 10, 0.85);
            --content-background-color: rgba(10, 10, 10, 0.75);
            --card-background-color: rgba(25, 25, 40, 0.7);
            --text-color-primary: #e0e0e0;
            --text-color-secondary: #b0b0d0;
            --accent-color: #00d5ff;
            --accent-color-dark: #00aaff;
            --border-color: rgba(255, 255, 255, 0.1);
            --input-background-color: rgba(255, 255, 255, 0.05);
            --button-background: rgba(0, 213, 255, 0.15);
            --button-hover-background: rgba(0, 213, 255, 0.25);
            --active-item-background: rgba(0, 213, 255, 0.1);
        }

        body.theme-sunset-mode {
            background: linear-gradient(to top, #ff7e5f, #feb47b) !important;
            --background-main: linear-gradient(to top, #ff7e5f, #feb47b);
            --card-background: rgba(255, 255, 255, 0.15);
            --white: #fff;
            --text-light: rgba(255, 255, 255, 0.8);
            --input-background: rgba(255, 255, 255, 0.1);
            --border-light: rgba(255, 255, 255, 0.3);
            --button-background-gradient: linear-gradient(90deg, #fd746c, #ff9068);
            --button-shadow: 0 4px 15px rgba(253, 116, 108, 0.4), 0 4px 15px rgba(255, 144, 104, 0.4);

            --background-color-primary: #ff7e5f;
            --background-color-secondary: #feb47b;
            --header-background-color: rgba(255, 126, 95, 0.9);
            --footer-background-color: rgba(255, 126, 95, 0.9);
            --content-background-color: rgba(255, 126, 95, 0.85);
            --card-background-color: rgba(255, 255, 255, 0.15);
            --text-color-primary: #fff;
            --text-color-secondary: rgba(255, 255, 255, 0.8);
            --accent-color: #ffd700;
            --accent-color-dark: #ccaa00;
            --border-color: rgba(255, 255, 255, 0.3);
            --input-background-color: rgba(255, 255, 255, 0.2);
            --button-background: rgba(255, 255, 255, 0.2);
            --button-hover-background: rgba(255, 255, 255, 0.3);
            --active-item-background: rgba(255, 215, 0, 0.1);
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden; /* Prevent horizontal scroll */
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: stretch; /* Changed from center to stretch to prevent shifting */
            justify-content: flex-start;
            background-color: var(--background-main);
            background-image: radial-gradient(circle at top left, var(--background-gradient-1), transparent 100px),
                              radial-gradient(circle at bottom right, var(--background-gradient-2), transparent 150px);
            color: var(--white);
            transition: background-color 0.5s ease, color 0.5s ease;
            width: 100%;
            max-width: 100vw; /* Prevent horizontal overflow */
            position: relative;
        }

        /* Header Styling (reused from Admin.html) */
        header {
            background: var(--header-background);
            border-bottom: 1px solid var(--border-light);
            padding: 10px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 55px;
            z-index: 10;
            display: flex;
            justify-content: center;
        }

        header .header-content-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 1200px;
            padding: 0 30px;
        }

        /* NEW: Styling for the Groups link as the main title */
        .groups-main-title {
            font-family: 'Poppins', sans-serif;
            font-size: 1.8rem;
            font-weight: 800;
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            letter-spacing: -0.03em;
            text-decoration: none;
            margin-right: auto; /* Push other elements to the right */
        }


        header nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            gap: 25px;
        }

        header nav ul li a {
            color: var(--white);
            text-decoration: none;
            font-weight: 600;
            font-size: 1.1rem;
            padding: 5px 0;
            position: relative;
            transition: color var(--transition);
        }

        header nav ul li a::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            width: 0;
            height: 3px;
            background: var(--blue);
            border-radius: 2px;
            transition: width var(--transition);
        }

        header nav ul li a:hover {
            color: var(--blue);
        }

        header nav ul li a:hover::after {
            width: 100%;
        }

        .user-profile-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification-icon-wrapper {
            position: relative;
            margin-right: 15px;
        }

        .notification-icon-wrapper a {
            text-decoration: none;
            color: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-icon-wrapper i {
            font-size: 1.5rem;
            color: var(--text-light);
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .notification-icon-wrapper i:hover {
            color: var(--white);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--notification-badge-color);
            color: var(--white);
            border-radius: 50%;
            padding: 3px 7px;
            font-size: 0.7rem;
            font-weight: 700;
            min-width: 20px;
            text-align: center;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            display: none;
        }

        .user-profile-header #profileLink {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: var(--white);
            transition: opacity 0.3s ease, background-color 0.3s ease;
            padding: 5px 10px;
            border-radius: var(--radius);
        }

        .user-profile-header #profileLink:hover {
            opacity: 0.8;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .user-profile-header img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--accent-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: opacity 0.3s ease;
        }

        .user-profile-header i {
            font-size: 30px;
            color: var(--text-light);
        }

        .user-profile-header span {
            font-weight: 600;
            font-size: 1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }

        .jcoin-gas-display {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: 15px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-color-primary);
        }
        .jcoin-gas-display .jcoin-icon, .jcoin-gas-display .gas-icon {
            color: var(--pink); /* JCoin color */
            font-size: 1.1rem;
        }
        .jcoin-gas-display .gas-icon {
            color: var(--blue); /* Gas color */
        }


        #logoutButton { /* Keeping style in case it's used elsewhere, but button removed from HTML */
            background: var(--button-background-gradient);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.3s ease;
            opacity: 0.8;
            margin-left: 10px;
        }

        #logoutButton:hover {
            transform: scale(1.1);
            box-shadow: var(--button-shadow);
            opacity: 1;
        }

        #logoutButton i {
            color: var(--white);
            font-size: 0.9rem;
        }

        /* Main Content Area */
        main {
            flex-grow: 1;
            padding: 40px 20px; /* Add horizontal padding to prevent edge overflow */
            padding-top: 80px; /* Adjust for fixed header and some top margin */
            width: 100%;
            max-width: 100vw; /* Prevent horizontal overflow */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            text-align: center;
            overflow-y: auto; /* Allow main content to scroll */
            overflow-x: hidden; /* Prevent horizontal overflow */
            min-height: calc(100vh - 55px); /* Make main content take full height minus header */
            box-sizing: border-box;
        }

        .content-wrapper {
            width: 100%;
            max-width: 1000px;
            padding: 0 10px; /* Reduce padding to prevent overflow */
            display: flex;
            flex-direction: column;
            gap: 25px;
            align-items: center;
            box-sizing: border-box;
        }

        .section-card {
            background: var(--card-background);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px) saturate(180%);
            border-radius: var(--radius);
            box-shadow: 0 8px 25px rgba(0, 0, 0, .3);
            padding: 2rem; /* Reduce padding on mobile */
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            text-align: center;
            box-sizing: border-box;
        }

        .section-card h1, .section-card h2 {
            font-family: 'Poppins', sans-serif;
            font-weight: 800;
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            margin-bottom: 1.5rem;
        }
        .section-card h1 { font-size: 2.8rem; }
        .section-card h2 { font-size: 2rem; margin-bottom: 1.2rem; }

        .section-description {
            color: var(--text-color-secondary);
            font-size: 1rem;
            margin-top: -1rem;
            margin-bottom: 1.5rem;
        }

        .group-list-container {
            width: 100%;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            max-height: 500px; /* Make group lists scrollable */
            overflow-y: auto;
            padding-right: 10px;
        }

        .group-list-container::-webkit-scrollbar {
            width: 8px;
        }

        .group-list-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .group-list-container::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, var(--blue), var(--pink));
            border-radius: 10px;
        }

        .group-list-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(to bottom, var(--pink), var(--blue));
        }

        .group-card {
            background: var(--input-background);
            border: 1px solid var(--border-light);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-decoration: none;
            color: inherit;
            position: relative;
        }

        .group-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .group-card .group-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--accent-color);
            flex-shrink: 0;
            margin-bottom: 5px;
        }
        .group-card .group-avatar-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            /* Apply gradient to the icon */
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Ensure text color is transparent for gradient to show */
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            border: 3px solid var(--accent-color);
            flex-shrink: 0;
            margin-bottom: 5px;
        }

        .group-card h3 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-color-primary);
            margin: 0;
            text-align: center;
            word-break: break-word;
        }

        .group-card p {
            margin: 0;
            font-size: 0.9rem;
            color: var(--text-color-secondary);
            text-align: center;
            flex-grow: 1; /* Allows description to take space */
        }

        .group-card .member-count {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .group-card .member-count i {
            /* Apply gradient to the member count icon */
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Ensure text color is transparent for gradient to show */
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
        }

        /* Group Vault Display */
        .group-vault {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-color-primary);
            width: 100%;
            flex-wrap: wrap;
        }
        .group-vault span {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .group-vault .jcoin-icon, .group-vault .gas-icon {
            font-size: 1.1rem;
        }
        .group-vault .jcoin-icon { color: var(--pink); }
        .group-vault .gas-icon { color: var(--blue); }

        /* Promotion/Boost Status */
        .group-status-tags {
            display: flex;
            gap: 8px;
            margin-top: 5px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .group-status-tag {
            background-color: rgba(0, 213, 255, 0.15);
            color: var(--accent-color);
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .group-status-tag.promoted { background-color: rgba(255, 46, 146, 0.15); color: var(--pink); }
        .group-status-tag.xp-boost { background-color: rgba(76, 175, 80, 0.15); color: #4CAF50; }
        .group-status-tag.jcoin-boost { background-color: rgba(255, 193, 7, 0.15); color: #FFC107; }


        .group-card .action-button-container {
            display: flex;
            flex-wrap: wrap; /* Allow buttons to wrap */
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            width: 100%;
        }

        .group-card .action-button {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(90deg, var(--blue), var(--pink));
            color: var(--white);
            box-shadow: 0 4px 10px rgba(0, 213, 255, 0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex-grow: 1; /* Allow buttons to grow */
            min-width: 120px; /* Minimum width for buttons */
        }

        .group-card .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }

        .group-card .action-button.leave-button {
            background: var(--delete-button-color);
            box-shadow: 0 4px 10px rgba(220, 53, 69, 0.3);
        }
        .group-card .action-button.leave-button:hover {
            box-shadow: 0 6px 15px rgba(220, 53, 69, 0.4);
        }
        .group-card .action-button.donate-button {
            background: linear-gradient(90deg, #4CAF50, #8BC34A); /* Green gradient */
            box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3);
        }
        .group-card .action-button.donate-button:hover {
            box-shadow: 0 6px 15px rgba(76, 175, 80, 0.4);
        }
        .group-card .action-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
        }


        .no-groups-message {
            text-align: center;
            color: var(--text-light);
            padding: 20px;
            font-size: 1rem;
            width: 100%;
        }

        /* Enhanced Search Styles */
        .advanced-search-container {
            width: 100%;
            margin-bottom: 25px;
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 15px; /* Reduce padding to prevent overflow */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
            max-width: 100%;
            overflow: hidden; /* Prevent content overflow */
        }
        
        .search-row {
            display: flex;
            gap: 10px; /* Reduce gap to prevent overflow */
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            width: 100%;
            box-sizing: border-box;
        }
        
        .search-row input {
            flex: 1;
            min-width: 200px; /* Ensure minimum width */
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: var(--input-background);
            color: var(--text-color-primary);
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            box-sizing: border-box;
            max-width: 100%;
        }
        
        .search-row input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 213, 255, 0.2);
        }
        
        .filter-toggle-btn {
            padding: 12px 15px; /* Reduce horizontal padding */
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: var(--input-background);
            color: var(--text-color-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px; /* Reduce gap */
            white-space: nowrap;
            flex-shrink: 0; /* Prevent shrinking */
            box-sizing: border-box;
        }
        
        .filter-toggle-btn:hover {
            background: var(--accent-color);
            color: var(--white);
            transform: translateY(-2px);
        }
        
        .search-filters-panel {
            display: none;
            animation: slideDown 0.3s ease;
        }
        
        .search-filters-panel.active {
            display: block;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Reduce minimum width */
            gap: 10px; /* Reduce gap */
            margin-bottom: 15px;
            width: 100%;
            box-sizing: border-box;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-group label {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-color-secondary);
        }
        
        .filter-group select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--input-background);
            color: var(--text-color-primary);
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.3s ease;
            width: 100%;
            box-sizing: border-box;
            max-width: 100%;
        }
        
        .filter-group select:focus {
            border-color: var(--accent-color);
        }
        
        .filter-actions {
            display: flex;
            gap: 8px; /* Reduce gap */
            justify-content: flex-end;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            width: 100%;
            box-sizing: border-box;
        }
        
        .secondary-btn, .primary-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
        }
        
        .secondary-btn {
            background: var(--input-background);
            color: var(--text-color-secondary);
            border: 1px solid var(--border-color);
        }
        
        .secondary-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }
        
        .primary-btn {
            background: linear-gradient(90deg, var(--blue), var(--pink));
            color: var(--white);
        }
        
        .primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        /* Discovery Tabs */
        .discovery-tabs {
            display: flex;
            gap: 8px; /* Reduce gap */
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            overflow-x: auto; /* Enable horizontal scrolling */
            overflow-y: hidden;
            width: 100%;
            box-sizing: border-box;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on mobile */
        }
        
        .discovery-tab {
            padding: 8px 12px; /* Reduce padding */
            border: none;
            background: transparent;
            color: var(--text-color-secondary);
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px; /* Reduce gap */
            white-space: nowrap;
            font-weight: 600;
            position: relative;
            flex-shrink: 0; /* Prevent tabs from shrinking */
            font-size: 0.9rem; /* Reduce font size */
            box-sizing: border-box;
        }
        
        .discovery-tab:hover {
            background: var(--input-background);
            color: var(--text-color-primary);
        }
        
        .discovery-tab.active {
            background: linear-gradient(90deg, var(--blue), var(--pink));
            color: var(--white);
        }
        
        .discovery-tab.active::after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid var(--pink);
        }

        /* JCoin Feature Cards (reused from previous) */
        .jcoin-features-section {
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 30px;
        }
        .jcoin-feature-card {
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            padding: 25px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .jcoin-feature-card h3 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.6rem;
            font-weight: 700;
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            margin-bottom: 5px;
        }
        .jcoin-feature-card p {
            color: var(--text-color-secondary);
            font-size: 0.95rem;
            margin-bottom: 5px;
        }
        .jcoin-cost {
            font-weight: 600;
            color: var(--pink);
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }
        .jcoin-cost i {
            color: var(--pink);
        }
        .jcoin-feature-card .feature-button {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(90deg, var(--blue), var(--pink));
            color: var(--white);
            box-shadow: 0 4px 10px rgba(0, 213, 255, 0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
        }
        .jcoin-feature-card .feature-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }
        .jcoin-feature-card .feature-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Daily Check-in & Quests */
        .daily-checkin-section, .quests-section, .leaderboard-section, .referral-program-section {
            width: 100%;
            max-width: 900px;
            margin-top: 30px;
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            padding: 25px;
            text-align: center;
        }
        .daily-checkin-section h2, .quests-section h2, .leaderboard-section h2, .referral-program-section h2 {
            font-family: 'Poppins', sans-serif;
            font-size: 2rem;
            font-weight: 800;
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            margin-bottom: 1.5rem;
        }
        .daily-checkin-section p, .quests-section p, .referral-program-section p {
            color: var(--text-color-secondary);
            font-size: 0.95rem;
            margin-bottom: 15px;
        }
        #dailyCheckinBtn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(90deg, #4CAF50, #8BC34A); /* Green gradient */
            color: var(--white);
            box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        #dailyCheckinBtn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(76, 175, 80, 0.4);
        }
        #dailyCheckinBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
        }

        .quest-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        .quest-card {
            background: var(--input-background);
            border: 1px solid var(--border-light);
            border-radius: 10px;
            padding: 15px;
            text-align: left;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .quest-card h4 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-color-primary);
            margin: 0;
        }
        .quest-card p {
            margin: 0;
            font-size: 0.9rem;
            color: var(--text-color-secondary);
        }
        .quest-card .quest-progress {
            font-size: 0.85rem;
            color: var(--text-light);
        }
        .quest-card .quest-rewards {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--accent-color);
            display: flex;
            align-items: center;
            gap: 5px;
            flex-wrap: wrap;
        }
        .quest-card .quest-rewards i {
            color: var(--pink); /* JCoin icon */
        }
        .quest-card .quest-rewards .gas-icon {
            color: var(--blue); /* Gas icon */
        }
        .quest-card .claim-quest-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(90deg, var(--pink), var(--blue));
            color: var(--white);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin-top: 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            align-self: flex-end; /* Align button to the right */
        }
        .quest-card .claim-quest-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .quest-card .claim-quest-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
            background: var(--input-background);
            color: var(--text-light);
        }

        /* Leaderboard */
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .leaderboard-table th, .leaderboard-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-light);
            text-align: left;
            color: var(--text-color-primary);
        }
        .leaderboard-table th {
            background: rgba(255, 255, 255, 0.05);
            font-weight: 700;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .leaderboard-table td {
            font-size: 0.9rem;
        }
        .leaderboard-table tr:last-child td {
            border-bottom: none;
        }
        .leaderboard-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }
        .leaderboard-table .rank {
            font-weight: 700;
            color: var(--accent-color);
        }
        .leaderboard-table .username {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .leaderboard-table .username img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid var(--accent-color);
        }
        .leaderboard-table .username i {
            font-size: 1.5rem;
            color: var(--text-light);
        }
        .leaderboard-table .value-display {
            font-weight: 600;
            color: var(--text-color-primary);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .leaderboard-table .value-display .jcoin-icon { color: var(--pink); }
        .leaderboard-table .value-display .gas-icon { color: var(--blue); }

        /* Referral Program Specific Styles */
        .referral-code-display {
            background: var(--input-background);
            border: 1px solid var(--border-light);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .referral-code-display span {
            font-family: 'Poppins', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--pink), var(--blue));
            flex-grow: 1;
            text-align: left;
            word-break: break-all;
        }
        .referral-code-display button {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(90deg, var(--blue), var(--pink));
            color: var(--white);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            flex-shrink: 0;
        }
        .referral-code-display button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .referral-stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            font-size: 1rem;
            color: var(--text-color-primary);
        }
        .referral-stats span {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .referral-stats i {
            color: var(--accent-color);
        }


        /* Create Group FAB */
        #createGroupFab {
            position: fixed;
            bottom: 20px; /* Adjusted position */
            right: 20px;
            background: var(--button-background-gradient);
            color: var(--white);
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            z-index: 70;
        }
        #createGroupFab:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        /* Modals (Create Group, Promote, Customize, Gift, Donate, Boost) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: var(--card-background);
            padding: 30px;
            border-radius: var(--radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
            max-width: 500px;
            width: 90%;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .modal-overlay.active .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .modal-content h3 {
            color: var(--white);
            margin-top: 0;
            margin-bottom: 10px;
            font-family: 'Poppins', sans-serif;
            font-size: 1.8rem;
        }
        .modal-content .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            text-align: left;
        }
        .modal-content label {
            font-weight: 600;
            font-size: 0.95rem;
            /* Apply gradient to labels */
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Ensure text color is transparent for gradient to show */
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
        }
        .modal-content input[type="text"],
        .modal-content input[type="number"],
        .modal-content select,
        .modal-content textarea {
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: var(--input-background);
            color: var(--text-color-primary);
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            width: 100%;
        }
        .modal-content input:focus,
        .modal-content textarea:focus,
        .modal-content select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 213, 255, 0.2);
        }
        .modal-content textarea {
            min-height: 80px;
            resize: vertical;
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
        }
        .modal-buttons button {
            padding: 10px 25px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .modal-buttons button.primary-btn {
            background: linear-gradient(90deg, var(--blue), var(--pink));
            color: var(--white);
            box-shadow: 0 4px 10px rgba(0, 213, 255, 0.3);
        }
        .modal-buttons button.primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 213, 255, 0.4);
        }
        .modal-buttons button.cancel-btn {
            background: var(--input-background);
            color: var(--text-light);
            border: 1px solid var(--border-light);
        }
        .modal-buttons button.cancel-btn:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.1);
        }

        /* Loader styles for buttons (reused from previous) */
        .button-loader {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid var(--white);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: none;
        }
        .button-loader.active { display: block; }
        .button-text { display: block; }
        .loading .button-text { display: none; }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom Message Box Styles (reused from previous) */
        #messageBox {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--card-background-color);
            color: var(--text-color-primary);
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            min-width: 280px;
            max-width: 90%;
            text-align: center;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        #messageBox.show {
            opacity: 1;
            display: flex;
        }
        #messageBox.success {
            background-image: linear-gradient(45deg, var(--pink), var(--blue));
            color: var(--white);
            border: none;
            box-shadow: 0 8px 30px rgba(0, 213, 255, 0.5), 0 8px 30px rgba(255, 46, 146, 0.5);
        }
        #messageBox.error { border-left: 5px solid var(--delete-button-color); background-color: var(--card-background-color); color: var(--text-color-primary); }
        #messageBox.info { border-left: 5px solid var(--accent-color); background-color: var(--card-background-color); color: var(--text-color-primary); }
        #messageBox.warning { border-left: 5px solid var(--warning-color); background-color: var(--card-background-color); color: var(--text-color-primary); }

        #messageBox i {
            font-size: 2.5rem;
            margin-bottom: 5px;
            background-image: linear-gradient(90deg, var(--blue), var(--pink));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent;
        }
        #messageBox.success i { color: var(--white); }
        #messageBox.error i { color: var(--delete-button-color); }
        #messageBox.info i { color: var(--accent-color); }
        #messageBox.warning i { color: var(--warning-color); }

        #messageBox span {
            font-size: 1.1rem;
            font-weight: 600;
        }

        @keyframes pulse-bg {
            0% { background-color: var(--accent-color); }
            50% { background-color: rgba(0, 213, 255, 0.7); }
            100% { background-color: var(--accent-color); }
        }
        #messageBox.loading-pulse { animation: pulse-bg 1.5s infinite ease-in-out; }

        /* Custom Confirmation Modal */
        .confirm-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }
        .confirm-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .confirm-modal-content {
            background: var(--card-background);
            padding: 30px;
            border-radius: var(--radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
            max-width: 400px;
            width: 90%;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .confirm-modal-overlay.active .confirm-modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .confirm-modal-content h3 {
            color: var(--white);
            margin-top: 0;
            margin-bottom: 20px;
            font-family: 'Poppins', sans-serif;
        }
        .confirm-modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
        }
        .confirm-modal-buttons button {
            padding: 10px 25px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .confirm-modal-buttons button.confirm-btn {
            background: linear-gradient(90deg, var(--pink), var(--blue));
            color: var(--white);
            box-shadow: 0 4px 10px rgba(0, 213, 255, 0.3);
        }
        .confirm-modal-buttons button.confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 213, 255, 0.4);
        }
        .confirm-modal-buttons button.cancel-btn {
            background: var(--input-background);
            color: var(--text-light);
            border: 1px solid var(--border-light);
        }
        .confirm-modal-buttons button.cancel-btn:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.1);
        }
        /* Customization options grid */
        .customization-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            width: 100%;
            margin-top: 15px;
            justify-items: center;
        }
        .customization-option {
            background: var(--input-background);
            border: 1px solid var(--border-light);
            border-radius: 10px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .customization-option.selected {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 213, 255, 0.3);
            transform: translateY(-3px);
        }
        .customization-option:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .customization-option img {
            max-width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 5px;
        }
        .customization-option h4 {
            font-size: 1rem;
            margin: 5px 0 0;
            color: var(--text-color-primary);
        }
        .customization-option .jcoin-cost {
            font-size: 0.85rem;
            margin-top: 5px;
        }


        /* Responsive Adjustments */
        @media (max-width: 600px) {
            /* Fix for mobile overflow issues */
            main {
                padding: 40px 10px; /* Reduce horizontal padding on mobile */
                padding-top: 75px; /* Adjust for smaller header on mobile */
            }
            
            .content-wrapper {
                padding: 0 5px; /* Further reduce padding on mobile */
            }
            
            .section-card {
                padding: 1.5rem; /* Reduce padding on mobile */
                width: 100%;
                margin: 0;
            }
            
            .advanced-search-container {
                padding: 10px; /* Reduce padding significantly on mobile */
            }
            
            .search-row {
                flex-direction: column; /* Stack elements vertically on mobile */
                gap: 8px;
                align-items: stretch;
            }
            
            .search-row input {
                min-width: unset; /* Remove minimum width constraint */
                width: 100%;
            }
            
            .filter-toggle-btn {
                width: 100%; /* Full width button on mobile */
                justify-content: center;
            }
            
            .filter-row {
                grid-template-columns: 1fr; /* Single column on mobile */
                gap: 8px;
            }
            
            .filter-actions {
                justify-content: center; /* Center buttons on mobile */
                gap: 6px;
            }
            
            .discovery-tabs {
                gap: 4px;
                padding-left: 5px;
                padding-right: 5px;
            }
            
            .discovery-tab {
                padding: 6px 10px;
                font-size: 0.8rem;
                gap: 4px;
            }
            
            header .header-content-wrapper {
                padding: 0 15px; /* Reduce header padding */
            }
            
            .groups-main-title {
                font-size: 1.4rem; /* Further reduce title size */
            }
            header nav ul {
                gap: 15px;
            }
            header nav ul li a {
                font-size: 1.1rem;
            }
            .user-profile-header #profileLink {
                padding: 5px;
            }
            .user-profile-header span {
                max-width: 90px;
            }
            .user-profile-header img {
                width: 30px;
                height: 30px;
            }
            .user-profile-header i {
                font-size: 25px;
            }
            #logoutButton {
                width: 25px;
                height: 25px;
                font-size: 0.8rem;
                margin-left: 8px;
            }
            #logoutButton i {
                font-size: 0.8rem;
            }
            .jcoin-gas-display {
                font-size: 0.8rem;
                gap: 5px;
                margin-left: 10px;
            }
            .jcoin-gas-display .jcoin-icon, .jcoin-gas-display .gas-icon {
                font-size: 1rem;
            }
            .section-card {
                padding: 1.5rem;
            }
            .section-card h1 {
                font-size: 2.2rem;
            }
            .section-card h2 {
                font-size: 1.7rem;
            }
            .group-list-container {
                grid-template-columns: 1fr;
                padding-right: 0;
            }
            .group-card {
                padding: 15px;
            }
            .group-card .group-avatar, .group-card .group-avatar-icon {
                width: 60px;
                height: 60px;
                font-size: 2.5rem;
            }
            .group-card h3 {
                font-size: 1.2rem;
            }
            .group-card p {
                font-size: 0.8rem;
            }
            .group-card .action-button {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
            .search-container input {
                font-size: 0.9rem;
                padding: 10px 12px;
            }
            #createGroupFab {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
                bottom: 10px; /* Adjusted for smaller screens */
            }
            .modal-content {
                padding: 20px;
            }
            .modal-content h3 {
                font-size: 1.5rem;
            }
            .modal-content input, .modal-content textarea {
                font-size: 0.9rem;
                padding: 10px 12px;
            }
            .modal-buttons button {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
            .jcoin-features-section {
                padding: 1.5rem;
            }
            .jcoin-feature-card h3 {
                font-size: 1.3rem;
            }
            .jcoin-feature-card .feature-button {
                font-size: 0.85rem;
                padding: 8px 15px;
            }
            .customization-option {
                width: 150px;
                padding: 10px;
            }
            .customization-option img {
                height: 60px;
            }
            .customization-option h4 {
                font-size: 0.9rem;
            }
            .customization-option .jcoin-cost {
                font-size: 0.8rem;
            }
            .daily-checkin-section, .quests-section, .leaderboard-section, .referral-program-section {
                padding: 1.5rem;
            }
            .daily-checkin-section h2, .quests-section h2, .leaderboard-section h2, .referral-program-section h2 {
                font-size: 1.7rem;
            }
            #dailyCheckinBtn {
                padding: 10px 20px;
                font-size: 0.9rem;
            }
            .quest-card h4 {
                font-size: 1.1rem;
            }
            .quest-card p, .quest-card .quest-progress, .quest-card .quest-rewards {
                font-size: 0.8rem;
            }
            .quest-card .claim-quest-btn {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            .leaderboard-table th, .leaderboard-table td {
                padding: 10px;
                font-size: 0.8rem;
            }
            .leaderboard-table th {
                font-size: 0.85rem;
            }
            .leaderboard-table .username img {
                width: 25px;
                height: 25px;
            }
            .leaderboard-table .username i {
                font-size: 1.3rem;
            }
            .leaderboard-table .value-display {
                font-size: 0.8rem;
            }
        }

        /* Tag chips */
        .tag-chip{display:inline-block;padding:4px 8px;border-radius:8px;background:rgba(255,255,255,0.08);font-size:.75rem;margin:2px;color:var(--text-light)}
        .tags-container{margin-top:6px;}
    </style>
<style id="header-overflow-fix">/*header-overflow-fix*/header .header-content-wrapper{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:nowrap}header .user-profile-header{display:flex;align-items:center;gap:10px;flex:1 1 auto;min-width:0;justify-content:flex-end}#profileLink{display:inline-flex;align-items:center;column-gap:8px;row-gap:2px;flex-wrap:wrap;max-width:100%;min-width:0}#profileLink #headerDisplayName{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:200px;flex:0 1 auto}#headerProfilePic,#headerAvatarIcon{flex:0 0 auto}@media (max-width:600px){header .header-content-wrapper{gap:8px}#profileLink{column-gap:6px}}</style></head>
<body class="theme-dark-mode">

    <header>
        <div class="header-content-wrapper">
            <!-- Groups link now acts as the main title -->
            <a href="/groups.html" class="groups-main-title">GROUPS</a>

            <div class="user-profile-header">
                <!-- Notification Icon with Badge -->
                <div class="notification-icon-wrapper">
                    <a href="/notifications.html" aria-label="Notifications">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notificationCount" style="display: none;">0</span>
                    </a>
                </div>
                <!-- JCoin and Gas Display -->
                <div class="jcoin-gas-display">
                    <span id="jCoinsDisplay"><i class="fas fa-coins jcoin-icon"></i> 0</span>
                    <span id="gasDisplay"><i class="fas fa-gas-pump gas-icon"></i> 0</span>
                </div>
                <!-- Logout Button Removed -->
                <a href="Profile.html" id="profileLink">
                    <img id="headerProfilePic" src="" alt="Profile Picture" style="display: none;">
                    <i id="headerAvatarIcon" class="fas fa-user-circle"></i>
                    <span id="headerDisplayName">Loading...</span>
                </a>
            </div>
        </div>
    </header>

    <main>
        <div class="content-wrapper">
            <div class="section-card">
                <h1>JCHAT Groups</h1>
                <p class="section-description">
                    Connect with communities, share interests, and chat with multiple friends.
                </p>

                <h2>My Groups</h2>
                <p class="no-groups-message" id="loadingMyGroupsMessage">Loading your groups...</p>
                <div id="myGroupsList" class="group-list-container">
                    <!-- My groups will be loaded here -->
                </div>

                <h2>Discover Groups</h2>
                
                <!-- Enhanced Search with Filters -->
                <div class="advanced-search-container">
                    <div class="search-row">
                        <input type="text" id="searchGroupInput" placeholder="Search groups by name, description, or tags...">
                        <button id="searchFiltersToggle" class="filter-toggle-btn">
                            <i class="fas fa-filter"></i> Filters
                        </button>
                    </div>
                    
                    <div id="searchFiltersPanel" class="search-filters-panel">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="categoryFilter">Category:</label>
                                <select id="categoryFilter">
                                    <option value="">All Categories</option>
                                    <option value="gaming">Gaming</option>
                                    <option value="tech">Technology</option>
                                    <option value="study">Study & Education</option>
                                    <option value="music">Music</option>
                                    <option value="art">Art & Design</option>
                                    <option value="sports">Sports</option>
                                    <option value="food">Food & Cooking</option>
                                    <option value="travel">Travel</option>
                                    <option value="books">Books & Literature</option>
                                    <option value="movies">Movies & TV</option>
                                    <option value="fitness">Fitness & Health</option>
                                    <option value="business">Business</option>
                                    <option value="social">Social</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label for="memberCountFilter">Member Count:</label>
                                <select id="memberCountFilter">
                                    <option value="">Any Size</option>
                                    <option value="small">Small (1-10)</option>
                                    <option value="medium">Medium (11-50)</option>
                                    <option value="large">Large (51-200)</option>
                                    <option value="huge">Huge (200+)</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label for="sortByFilter">Sort By:</label>
                                <select id="sortByFilter">
                                    <option value="members">Most Members</option>
                                    <option value="recent">Recently Created</option>
                                    <option value="activity">Most Active</option>
                                    <option value="promoted">Promoted First</option>
                                    <option value="alphabetical">Alphabetical</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="filter-actions">
                            <button id="clearFiltersBtn" class="secondary-btn">
                                <i class="fas fa-times"></i> Clear Filters
                            </button>
                            <button id="applyFiltersBtn" class="primary-btn">
                                <i class="fas fa-search"></i> Apply Filters
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Discovery Tabs -->
                <div class="discovery-tabs">
                    <button class="discovery-tab active" data-tab="all">
                        <i class="fas fa-globe"></i> All Groups
                    </button>
                    <button class="discovery-tab" data-tab="trending">
                        <i class="fas fa-fire"></i> Trending
                    </button>
                    <button class="discovery-tab" data-tab="recommended">
                        <i class="fas fa-star"></i> Recommended
                    </button>
                    <button class="discovery-tab" data-tab="new">
                        <i class="fas fa-sparkles"></i> New Groups
                    </button>
                </div>
                <p class="no-groups-message" id="loadingDiscoverGroupsMessage">Loading public groups...</p>
                <div id="discoverGroupsList" class="group-list-container">
                    <!-- Discoverable groups will be loaded here -->
                </div>
            </div>

            <!-- Daily Check-in Section -->
            <div class="daily-checkin-section">
                <h2>Daily Check-in Bonus</h2>
                <p>Claim your daily JCoins and XP for visiting the groups page!</p>
                <button id="dailyCheckinBtn" disabled>
                    <span class="button-text"><i class="fas fa-calendar-check"></i> Claim Daily Bonus</span>
                    <div class="button-loader"></div>
                </button>
            </div>

            <!-- Active Quests Section -->
            <div class="quests-section">
                <h2>Active Quests</h2>
                <p>Complete challenges to earn more JCoins and Gas! Also, earn JCoins for every message you send!</p>
                <div id="activeQuestsList" class="quest-list">
                    <p class="no-quests-message" style="text-align: center; color: var(--text-light);">Loading quests...</p>
                    <!-- Quests will be loaded here -->
                </div>
            </div>

            <!-- NEW: Referral Program Section -->
            <div class="referral-program-section">
                <h2>Referral Program</h2>
                <p>Invite your friends to JCHAT and earn JCoins and XP when they join!</p>
                <div class="referral-code-display">
                    <span>Your Referral Code: <strong id="referralCodeDisplay">Loading...</strong></span>
                    <button id="copyReferralCodeBtn">
                        <span class="button-text"><i class="fas fa-copy"></i> Copy</span>
                        <div class="button-loader"></div>
                    </button>
                </div>
                <div class="referral-stats">
                    <span><i class="fas fa-user-plus"></i> Referrals: <strong id="successfulReferralsCount">0</strong></span>
                    <span><i class="fas fa-coins"></i> Reward: <strong class="gradient-text">10 JCoins</strong> + <strong class="gradient-text">5 XP</strong> per referral</span>
                </div>
                <p class="section-description" style="margin-top: 15px;">
                    Your friend also gets <strong class="gradient-text">5 JCoins</strong> and <strong class="gradient-text">5 XP</strong> when they sign up with your code!
                </p>
            </div>


            <!-- Leaderboard Section -->
            <div class="leaderboard-section">
                <h2>Global Leaderboard</h2>
                <p>See who's leading in messages sent and JCoins earned!</p>
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>User</th>
                            <th>Messages Sent</th>
                            <th>JCoins Earned</th>
                        </tr>
                    </thead>
                    <tbody id="globalLeaderboardBody">
                        <tr id="loadingLeaderboardRow">
                            <td colspan="4" style="text-align: center; color: var(--text-light);">Loading leaderboard...</td>
                        </tr>
                        <!-- Leaderboard data will be loaded here -->
                    </tbody>
                </table>
            </div>


            <!-- JCoin Feature Cards Section -->
            <div class="jcoin-features-section">
                <h2>JCoin Group Features</h2>
                <p class="section-description">
                    Spend your JCoins to enhance your group's experience!
                </p>

                <!-- Group Promotion/Visibility Boosts -->
                <div class="jcoin-feature-card">
                    <h3>Group Promotion</h3>
                    <p>Boost your group's visibility in the "Discover Groups" section.</p>
                    <p class="jcoin-cost"><i class="fas fa-coins"></i> 100 - 500 JCoins</p>
                    <button id="promoteGroupBtn" class="feature-button" disabled>
                        <span class="button-text"><i class="fas fa-bullhorn"></i> Promote Group</span>
                        <div class="button-loader"></div>
                    </button>
                </div>

                <!-- Exclusive Group Customization -->
                <div class="jcoin-feature-card">
                    <h3>Exclusive Customization</h3>
                    <p>Unlock unique themes and visual elements for your group.</p>
                    <p class="jcoin-cost"><i class="fas fa-coins"></i> 50 - 300 JCoins</p>
                    <button id="customizeGroupBtn" class="feature-button" disabled>
                        <span class="button-text"><i class="fas fa-palette"></i> Customize Group</span>
                        <div class="button-loader"></div>
                    </button>
                </div>

                <!-- Temporary XP/JCoin Boosts for Group Members -->
                <div class="jcoin-feature-card">
                    <h3>Temporary Group Boosts</h3>
                    <p>Activate XP or JCoin boosts for all members in your group.</p>
                    <p class="jcoin-cost"><i class="fas fa-coins"></i> 200 - 1000 JCoins</p>
                    <button id="activateGroupBoostBtn" class="feature-button" disabled>
                        <span class="button-text"><i class="fas fa-rocket"></i> Activate Boost</span>
                        <div class="button-loader"></div>
                    </button>
                </div>

                <!-- Special Group Events/Activities -->
                <div class="jcoin-feature-card">
                    <h3>Special Group Events</h3>
                    <p>Host XP boosts, JCoin payouts, or exclusive activities for your members.</p>
                    <p class="jcoin-cost"><i class="fas fa-coins"></i> 500 - 2000 JCoins</p>
                    <button id="createEventBtn" class="feature-button" disabled>
                        <span class="button-text"><i class="fas fa-calendar-alt"></i> Create Event</span>
                        <div class="button-loader"></div>
                    </button>
                </div>

                <!-- Gifting JCoins to Group Members -->
                <div class="jcoin-feature-card">
                    <h3>Gift JCoins</h3>
                    <p>Send JCoins to a specific member within your group as a reward or thank you.</p>
                    <p class="jcoin-cost"><i class="fas fa-coins"></i> Variable Cost</p>
                    <button id="giftJCoinsBtn" class="feature-button" disabled>
                        <span class="button-text"><i class="fas fa-gift"></i> Gift JCoins</span>
                        <div class="button-loader"></div>
                    </button>
                </div>

                <!-- Unlock Private Group Channels -->
                <div class="jcoin-feature-card">
                    <h3>Unlock Private Channels</h3>
                    <p>Create exclusive, private sub-channels within your group for specific discussions.</p>
                    <p class="jcoin-cost"><i class="fas fa-coins"></i> 250 - 1000 JCoins</p>
                    <button id="unlockPrivateChannelBtn" class="feature-button" disabled>
                        <span class="button-text"><i class="fas fa-lock"></i> Unlock Channel</span>
                        <div class="button-loader"></div>
                    </button>
                </div>

            </div>
        </div>
    </main>

    <!-- Create Group Floating Action Button -->
    <button id="createGroupFab" aria-label="Create New Group">
        <i class="fas fa-plus"></i>
    </button>

    <!-- Create Group Modal -->
    <div id="createGroupModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Create New Group</h3>
            <p class="jcoin-cost" style="font-size: 1rem; margin-bottom: 15px;">Cost: <span id="createGroupCostDisplay">1000</span> <i class="fas fa-coins"></i></p>
            <div class="form-group">
                <label for="groupNameInput">Group Name:</label>
                <input type="text" id="groupNameInput" placeholder="Enter group name" maxlength="50" required>
            </div>
            <div class="form-group">
                <label for="groupDescriptionInput">Description:</label>
                <textarea id="groupDescriptionInput" placeholder="Tell us about your group (optional)" maxlength="1000"></textarea>
            </div>
            <div class="form-group">
                <label for="groupPicInput">Group Picture URL (Optional):</label>
                <input type="text" id="groupPicInput" placeholder="Enter image URL or leave blank">
            </div>
            <div class="form-group">
                <label for="createGroupTagsInput">Tags (comma separated):</label>
                <input type="text" id="createGroupTagsInput" placeholder="e.g., tech,gaming,study" maxlength="60">
            </div>
            <div class="modal-buttons">
                <button id="submitCreateGroupBtn" class="primary-btn">
                    <span class="button-text"><i class="fas fa-plus-circle"></i> Create Group</span>
                    <div class="button-loader"></div>
                </button>
                <button id="cancelCreateGroupBtn" class="cancel-btn">
                    <span class="button-text"><i class="fas fa-times"></i> Cancel</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Promote Group Modal -->
    <div id="promoteGroupModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Promote Group</h3>
            <p>Select a group to promote and choose the duration.</p>
            <div class="form-group">
                <label for="promoteGroupSelect">Select Group:</label>
                <select id="promoteGroupSelect">
                    <!-- Options will be dynamically populated with groups where user is admin -->
                </select>
            </div>
            <div class="form-group">
                <label for="promotionDuration">Promotion Duration:</label>
                <select id="promotionDuration">
                    <option value="1" data-cost="100">1 Day (100 JCoins)</option>
                    <option value="3" data-cost="250">3 Days (250 JCoins)</option>
                    <option value="7" data-cost="500">7 Days (500 JCoins)</option>
                </select>
            </div>
            <p class="jcoin-cost">Cost: <span id="promotionCostDisplay">100</span> <i class="fas fa-coins"></i></p>
            <div class="modal-buttons">
                <button id="submitPromoteGroupBtn" class="primary-btn">
                    <span class="button-text"><i class="fas fa-bullhorn"></i> Promote</span>
                    <div class="button-loader"></div>
                </button>
                <button id="cancelPromoteGroupBtn" class="cancel-btn">
                    <span class="button-text"><i class="fas fa-times"></i> Cancel</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Customize Group Modal -->
    <div id="customizeGroupModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Customize Group Visuals</h3>
            <p>Select a customization option for your group.</p>
            <div class="form-group">
                <label for="customizeGroupSelect">Select Group:</label>
                <select id="customizeGroupSelect">
                    <!-- Options will be dynamically populated with groups where user is admin -->
                </select>
            </div>
            <div class="customization-options" id="customizationOptionsContainer">
                <!-- Customization options will be dynamically loaded -->
                <div class="customization-option" data-type="banner" data-value="banner_galaxy" data-cost="150" data-name="Galaxy Banner">
                    <img src="https://placehold.co/180x80/000000/FFFFFF?text=Galaxy+Banner" alt="Galaxy Banner">
                    <h4>Galaxy Banner</h4>
                    <p class="jcoin-cost"><i class="fas fa-coins"></i> 150</p>
                </div>
                <div class="customization-option" data-type="banner" data-value="banner_forest" data-cost="150" data-name="Forest Banner">
                    <img src="https://placehold.co/180x80/000000/FFFFFF?text=Forest+Banner" alt="Forest Banner">
                    <h4>Forest Banner</h4>
                    <p class="jcoin-cost"><i class="fas fa-coins"></i> 150</p>
                </div>
                <div class="customization-option" data-type="emoji_pack" data-value="emoji_pack_1" data-cost="50" data-name="Emoji Pack 1">
                    <img src="https://placehold.co/180x80/000000/FFFFFF?text=Emoji+Pack+1" alt="Emoji Pack 1">
                    <h4>Emoji Pack 1</h4>
                    <p class="jcoin-cost"><i class="fas fa-coins"></i> 50</p>
                </div>
            </div>
            <div class="modal-buttons">
                <button id="submitCustomizeGroupBtn" class="primary-btn" disabled>
                    <span class="button-text"><i class="fas fa-check-circle"></i> Purchase & Apply</span>
                    <div class="button-loader"></div>
                </button>
                <button id="cancelCustomizeGroupBtn" class="cancel-btn">
                    <span class="button-text"><i class="fas fa-times"></i> Cancel</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Activate Group Boost Modal -->
    <div id="activateGroupBoostModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Activate Group Boost</h3>
            <p>Select a group and the type of boost.</p>
            <div class="form-group">
                <label for="boostGroupSelect">Select Group:</label>
                <select id="boostGroupSelect">
                    <!-- Options will be dynamically populated with groups where user is admin -->
                </select>
            </div>
            <div class="form-group">
                <label for="boostType">Boost Type:</label>
                <select id="boostType">
                    <option value="xp" data-cost="200">XP Boost (200 JCoins)</option>
                    <option value="jcoin" data-cost="500">JCoin Boost (500 JCoins)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="boostDuration">Duration (Hours):</label>
                <input type="number" id="boostDuration" value="24" min="1" max="72">
            </div>
            <p class="jcoin-cost">Cost: <span id="boostCostDisplay">200</span> <i class="fas fa-coins"></i></p>
            <div class="modal-buttons">
                <button id="submitActivateBoostBtn" class="primary-btn">
                    <span class="button-text"><i class="fas fa-rocket"></i> Activate</span>
                    <div class="button-loader"></div>
                </button>
                <button id="cancelActivateBoostBtn" class="cancel-btn">
                    <span class="button-text"><i class="fas fa-times"></i> Cancel</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Donate JCoins Modal -->
    <div id="donateJCoinsModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Donate JCoins to Group Vault</h3>
            <p>Support your group by donating JCoins to its shared vault.</p>
            <div class="form-group">
                <label for="donateGroupSelect">Select Group:</label>
                <select id="donateGroupSelect">
                    <!-- Options will be dynamically populated with groups user is a member of -->
                </select>
            </div>
            <div class="form-group">
                <label for="donateAmountInput">Amount to Donate:</label>
                <input type="number" id="donateAmountInput" min="1" placeholder="Enter amount">
            </div>
            <p class="jcoin-cost">Your JCoins: <span id="currentUserJCoinsDonateDisplay">0</span> <i class="fas fa-coins"></i></p>
            <div class="modal-buttons">
                <button id="submitDonateJCoinsBtn" class="primary-btn" disabled>
                    <span class="button-text"><i class="fas fa-hand-holding-usd"></i> Donate</span>
                    <div class="button-loader"></div>
                </button>
                <button id="cancelDonateJCoinsBtn" class="cancel-btn">
                    <span class="button-text"><i class="fas fa-times"></i> Cancel</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Gift JCoins Modal -->
    <div id="giftJCoinsModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Gift JCoins to Member</h3>
            <p>Select a group and a member to send JCoins to.</p>
            <div class="form-group">
                <label for="giftGroupSelect">Select Group:</label>
                <select id="giftGroupSelect">
                    <!-- Options will be dynamically populated with groups user is a member of -->
                </select>
            </div>
            <div class="form-group">
                <label for="giftMemberSelect">Select Member:</label>
                <select id="giftMemberSelect" disabled>
                    <option value="">Select a group first</option>
                </select>
            </div>
            <div class="form-group">
                <label for="giftAmountInput">Amount to Gift:</label>
                <input type="number" id="giftAmountInput" min="1" placeholder="Enter amount" disabled>
            </div>
            <p class="jcoin-cost">Your JCoins: <span id="currentUserJCoinsGiftDisplay">0</span> <i class="fas fa-coins"></i></p>
            <div class="modal-buttons">
                <button id="submitGiftJCoinsBtn" class="primary-btn" disabled>
                    <span class="button-text"><i class="fas fa-gift"></i> Send Gift</span>
                    <div class="button-loader"></div>
                </button>
                <button id="cancelGiftJCoinsBtn" class="cancel-btn">
                    <span class="button-text"><i class="fas fa-times"></i> Cancel</span>
                </button>
            </div>
        </div>
    </div>


    <!-- Custom Message Box (from Admin.html or local) -->
    <div id="messageBox"></div>

    <!-- Custom Confirmation Modal -->
    <div id="customConfirmModal" class="confirm-modal-overlay">
        <div class="confirm-modal-content">
            <h3 id="confirmModalMessage"></h3>
            <div class="confirm-modal-buttons">
                <button id="confirmYesBtn" class="confirm-btn">Yes</button>
                <button id="confirmNoBtn" class="cancel-btn">No</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, onSnapshot, addDoc, updateDoc, arrayUnion, arrayRemove, serverTimestamp, runTransaction, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"; // orderBy added here!

        // --- Firebase & Canvas Environment Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyBsBinyrD9WZZXRaCvA4gxfX7BIimydDvo",
            authDomain: "jchat-1.firebaseapp.com",
            projectId: "jchat-1",
            storageBucket: "jchat-1.firebasestorage.app",
            messagingSenderId: "328479683167",
            appId: "1:328479683167:web:276c0b7e8ea44dd2d6a1ea",
            measurementId: "G-S6Z9GG0R9P"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Cloudinary Configuration (needed for profile pictures)
        const cloudinaryConfig = {
            cloudName: "dxld01rcp", // Your Cloudinary Cloud Name
            uploadPreset: "Storage_preset" // Your Cloudinary Upload Preset
        };

        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const headerProfilePic = document.getElementById('headerProfilePic');
        const headerAvatarIcon = document.getElementById('headerAvatarIcon');
        const headerDisplayName = document.getElementById('headerDisplayName');
        // const logoutButton = document.getElementById('logoutButton'); // Removed from HTML
        const notificationCountElement = document.getElementById('notificationCount');
        const messageBox = document.getElementById('messageBox');
        const headerNavLinkProfile = document.getElementById('profileLink');
        const jCoinsDisplay = document.getElementById('jCoinsDisplay');
        const gasDisplay = document.getElementById('gasDisplay');

        const myGroupsList = document.getElementById('myGroupsList');
        const loadingMyGroupsMessage = document.getElementById('loadingMyGroupsMessage');
        const discoverGroupsList = document.getElementById('discoverGroupsList');
        const loadingDiscoverGroupsMessage = document.getElementById('loadingDiscoverGroupsMessage');
        const searchGroupInput = document.getElementById('searchGroupInput');
        const createGroupFab = document.getElementById('createGroupFab');

        const createGroupModal = document.getElementById('createGroupModal');
        const groupNameInput = document.getElementById('groupNameInput');
        const groupDescriptionInput = document.getElementById('groupDescriptionInput');
        const groupPicInput = document.getElementById('groupPicInput');
        const submitCreateGroupBtn = document.getElementById('submitCreateGroupBtn');
        const cancelCreateGroupBtn = document.getElementById('cancelCreateGroupBtn');
        const createGroupCostDisplay = document.getElementById('createGroupCostDisplay'); // NEW: Cost display for create group modal

        // New Daily Check-in & Quests Elements
        const dailyCheckinBtn = document.getElementById('dailyCheckinBtn');
        const activeQuestsList = document.getElementById('activeQuestsList');
        const globalLeaderboardBody = document.getElementById('globalLeaderboardBody');
        const loadingLeaderboardRow = document.getElementById('loadingLeaderboardRow');

        // NEW: Referral Program Elements
        const referralCodeDisplay = document.getElementById('referralCodeDisplay');
        const copyReferralCodeBtn = document.getElementById('copyReferralCodeBtn');
        const successfulReferralsCount = document.getElementById('successfulReferralsCount');


        // JCoin Feature Buttons
        const promoteGroupBtn = document.getElementById('promoteGroupBtn');
        const customizeGroupBtn = document.getElementById('customizeGroupBtn');
        const activateGroupBoostBtn = document.getElementById('activateGroupBoostBtn');
        const createEventBtn = document.getElementById('createEventBtn');
        const giftJCoinsBtn = document.getElementById('giftJCoinsBtn');
        const unlockPrivateChannelBtn = document.getElementById('unlockPrivateChannelBtn');

        // Promote Group Modal Elements
        const promoteGroupModal = document.getElementById('promoteGroupModal');
        const promoteGroupSelect = document.getElementById('promoteGroupSelect');
        const promotionDuration = document.getElementById('promotionDuration');
        const promotionCostDisplay = document.getElementById('promotionCostDisplay');
        const submitPromoteGroupBtn = document.getElementById('submitPromoteGroupBtn');
        const cancelPromoteGroupBtn = document.getElementById('cancelPromoteGroupBtn');

        // Customize Group Modal Elements
        const customizeGroupModal = document.getElementById('customizeGroupModal');
        const customizeGroupSelect = document.getElementById('customizeGroupSelect');
        const customizationOptionsContainer = document.getElementById('customizationOptionsContainer');
        const submitCustomizeGroupBtn = document.getElementById('submitCustomizeGroupBtn');
        const cancelCustomizeGroupBtn = document.getElementById('cancelCustomizeGroupBtn');

        // Activate Group Boost Modal Elements
        const activateGroupBoostModal = document.getElementById('activateGroupBoostModal');
        const boostGroupSelect = document.getElementById('boostGroupSelect');
        const boostType = document.getElementById('boostType');
        const boostDuration = document.getElementById('boostDuration');
        const boostCostDisplay = document.getElementById('boostCostDisplay');
        const submitActivateBoostBtn = document.getElementById('submitActivateBoostBtn');
        const cancelActivateBoostBtn = document.getElementById('cancelActivateBoostBtn');

        // Donate JCoins Modal Elements
        const donateJCoinsModal = document.getElementById('donateJCoinsModal');
        const donateGroupSelect = document.getElementById('donateGroupSelect');
        const donateAmountInput = document.getElementById('donateAmountInput');
        const currentUserJCoinsDonateDisplay = document.getElementById('currentUserJCoinsDonateDisplay');
        const submitDonateJCoinsBtn = document.getElementById('submitDonateJCoinsBtn');
        const cancelDonateJCoinsBtn = document.getElementById('cancelDonateJCoinsBtn');

        // Gift JCoins Modal Elements
        const giftJCoinsModal = document.getElementById('giftJCoinsModal');
        const giftGroupSelect = document.getElementById('giftGroupSelect');
        const giftMemberSelect = document.getElementById('giftMemberSelect');
        const giftAmountInput = document.getElementById('giftAmountInput');
        const currentUserJCoinsGiftDisplay = document.getElementById('currentUserJCoinsGiftDisplay');
        const submitGiftJCoinsBtn = document.getElementById('submitGiftJCoinsBtn');
        const cancelGiftJCoinsBtn = document.getElementById('cancelGiftJCoinsBtn');


        // Custom Message Box (from Admin.html or local)
        const customMessageBox = document.getElementById('messageBox'); // Renamed to avoid conflict with `messageBox` in `showMessageBox`

        // Custom Confirmation Modal elements
        const customConfirmModal = document.getElementById('customConfirmModal');
        const confirmModalMessage = document.getElementById('confirmModalMessage');
        const confirmYesBtn = document.getElementById('confirmYesBtn');
        const confirmNoBtn = document.getElementById('confirmNoBtn');

        // --- Global State ---
        let isAuthReady = false; // Flag to indicate if auth state has been checked
        let currentUser = null; // The currently authenticated user (Firebase Auth object)
        let currentUserProfileData = null; // Stores the authenticated user's own profile data
        let myGroupsData = []; // Stores groups the current user is a member of
        let allPublicGroupsData = []; // Stores all publicly discoverable groups
        let activeQuests = []; // Stores active quests
        let selectedCustomizationOption = null; // For customization modal

        // --- Economy Constants ---
        const DAILY_CHECKIN_JCOINS = 5;
        const DAILY_CHECKIN_XP = 10;
        const QUEST_SEND_MESSAGES_TARGET = 50; // Example quest: send 50 messages
        const QUEST_SEND_MESSAGES_JCOIN_REWARD = 20;
        const QUEST_SEND_MESSAGES_GAS_REWARD = 5;
        const GROUP_CREATION_COST = 1000; // NEW: Cost to create a new group

        // NEW: Referral Program Constants
        const REFERRAL_JCOIN_REWARD_REFERRER = 10;
        const REFERRAL_XP_REWARD_REFERRER = 5;
        const REFERRAL_JCOIN_REWARD_NEW_USER = 5;
        const REFERRAL_XP_REWARD_NEW_USER = 5;


        // --- Utility Functions (reused from other pages) ---

        /**
         * Plays a short notification sound.
         */
        function playNotificationSound() {
            const audio = new Audio('/assets/sounds/success_notification.mp3'); // Ensure this path is correct
            audio.play().catch(e => console.error("Error playing sound:", e));
        }

        /**
         * Displays a temporary message box with a given message and type.
         * @param {string} message - The message to display.
         * @param {string} type - The type of message ('success', 'error', 'info', 'loading', 'warning').
         * @param {number} [durationMs=3000] - Duration in milliseconds for the message to display.
         * @param {boolean} [isPersistent=false] - If true, message stays until explicitly cleared or replaced.
         */
        function showMessageBox(message, type, durationMs = 3000, isPersistent = false) {
            if (customMessageBox.timeoutId) {
                clearTimeout(customMessageBox.timeoutId);
                customMessageBox.timeoutId = null;
            }

            customMessageBox.innerHTML = `<i id="messageBoxIcon"></i><span id="messageBoxText"></span>`;
            const messageBoxIcon = customMessageBox.querySelector('#messageBoxIcon');
            const messageBoxText = customMessageBox.querySelector('#messageBoxText');

            messageBoxText.textContent = message;
            customMessageBox.className = 'message-box show ' + type;

            if (messageBoxIcon) {
                if (type === 'success') {
                    messageBoxIcon.classList.add('fas', 'fa-check-circle');
                    playNotificationSound();
                } else if (type === 'error') {
                    messageBoxIcon.classList.add('fas', 'fa-times-circle');
                } else if (type === 'info') {
                    messageBoxIcon.classList.add('fas', 'fa-info-circle');
                } else if (type === 'warning') {
                    messageBoxIcon.classList.add('fas', 'fa-exclamation-triangle');
                } else if (type === 'loading') {
                    messageBoxIcon.classList.add('fas', 'fa-spinner', 'fa-spin');
                }
            }

            if (type === 'loading') {
                customMessageBox.classList.add('loading-pulse');
            } else {
                customMessageBox.classList.remove('loading-pulse');
            }

            customMessageBox.style.display = 'flex';
            customMessageBox.style.opacity = '1';

            if (!isPersistent) {
                customMessageBox.timeoutId = setTimeout(() => {
                    customMessageBox.style.opacity = '0';
                    customMessageBox.addEventListener('transitionend', function handler() {
                        customMessageBox.style.display = 'none';
                        customMessageBox.removeEventListener('transitionend', handler);
                        customMessageBox.classList.remove('loading-pulse');
                    }, { once: true });
                }, durationMs);
            }
        }

        /**
         * Displays a custom confirmation modal.
         * @param {string} message - The message to display in the modal.
         * @returns {Promise<boolean>} Resolves with true if 'Yes' is clicked, false if 'No'.
         */
        function showCustomConfirm(message) {
            return new Promise((resolve) => {
                confirmModalMessage.textContent = message;
                customConfirmModal.classList.add('active');

                const handleYes = () => {
                    customConfirmModal.classList.remove('active');
                    confirmYesBtn.removeEventListener('click', handleYes);
                    confirmNoBtn.removeEventListener('click', handleNo);
                    resolve(true);
                };

                const handleNo = () => {
                    customConfirmModal.classList.remove('active');
                    confirmYesBtn.removeEventListener('click', handleYes);
                    confirmNoBtn.removeEventListener('click', handleNo);
                    resolve(false);
                };

                confirmYesBtn.addEventListener('click', handleYes);
                confirmNoBtn.addEventListener('click', handleNo);
            });
        }

        /**
         * Toggles loading state for a button.
         * @param {HTMLElement} buttonElement - The button to toggle.
         * @param {boolean} isLoading - True to show loading, false to hide.
         */
        function toggleButtonLoading(buttonElement, isLoading) {
            if (!buttonElement) return;
            const loader = buttonElement.querySelector('.button-loader');
            const text = buttonElement.querySelector('.button-text');

            if (isLoading) {
                buttonElement.disabled = true;
                buttonElement.classList.add('loading');
                if (loader) loader.classList.add('active');
                if (text) text.style.display = 'none';
            } else {
                buttonElement.disabled = false;
                buttonElement.classList.remove('loading');
                if (loader) loader.classList.remove('active');
                if (text) text.style.display = 'block';
            }
        }

        /**
         * Constructs a Cloudinary URL for an image/video.
         * @param {string} urlOrPublicId - The full Cloudinary URL or the public ID of the image on Cloudinary.
         * @param {string} transformations - Optional Cloudinary transformations.
         * @returns {string|null} The full Cloudinary URL or null if urlOrPublicId is not provided.
         */
        function getCloudinaryImageUrl(urlOrPublicId, transformations = "w_auto,f_auto,q_auto") {
            if (!urlOrPublicId) return null;
            if (urlOrPublicId.startsWith('http://') || urlOrPublicId.startsWith('https://')) {
                return urlOrPublicId;
            }
            return `https://res.cloudinary.com/${cloudinaryConfig.cloudName}/image/upload/${transformations}/${urlOrPublicId}`;
        }

        /**
         * Displays the profile picture or a default icon for a user/group.
         * @param {HTMLElement} imgElement - The <img> element to update.
         * @param {HTMLElement} iconElement - The <i> element to display if no image.
         * @param {string|null} picId - The Cloudinary public ID or URL, or null.
         * @param {string} initial - Initial for placeholder (e.g., username initial or group name initial).
         * @param {string} transformations - Cloudinary transformations.
         */
        function displayPicture(imgElement, iconElement, picId, initial, transformations) {
            if (imgElement) {
                if (picId) {
                    const imageUrl = getCloudinaryImageUrl(picId, transformations);
                    imgElement.src = imageUrl;
                    imgElement.style.display = 'block';
                    if (iconElement) iconElement.style.display = 'none';
                    imgElement.onerror = () => {
                        console.error(`Failed to load picture: ${picId}. Using placeholder.`);
                        imgElement.src = `https://placehold.co/80x80/CCCCCC/000000?text=${initial}`;
                        imgElement.style.display = 'block';
                        if (iconElement) iconElement.style.display = 'none';
                    };
                } else {
                    imgElement.src = '';
                    imgElement.style.display = 'none';
                    if (iconElement) iconElement.style.display = 'block';
                }
            }
        }

        /**
         * Generates a random alphanumeric referral code.
         * @param {number} length - The desired length of the referral code.
         * @returns {string} The generated referral code.
         */
        function generateReferralCode(length = 8) {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }

        /**
         * Copies the referral code to the clipboard.
         */
        function copyReferralCode() {
            const code = referralCodeDisplay.textContent;
            if (code && code !== "Loading..." && code !== "N/A") {
                // Use a temporary textarea to copy text to clipboard
                const tempInput = document.createElement('textarea');
                tempInput.value = code;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                showMessageBox("Referral code copied!", "success", 2000);
            } else {
                showMessageBox("No referral code to copy.", "warning", 2000);
            }
        }


        /**
         * Fetches and displays the current user's profile data for the header.
         * @param {firebase.User} user - The authenticated Firebase user object.
         */
        async function fetchAndDisplayHeaderProfile(user) {
            try {
                const privateProfileDocRef = doc(db, "artifacts", appId, "users", user.uid, "profiles", "user_profile");
                const publicProfileDocRef = doc(db, "artifacts", appId, "public", "data", "users", user.uid);

                const privateDocSnap = await getDoc(privateProfileDocRef);
                let profileData = null;

                if (privateDocSnap.exists()) {
                    profileData = privateDocSnap.data();
                } else {
                    profileData = {
                        username: user.displayName || `User_${user.uid.substring(0, 8)}`,
                        email: user.email || "",
                        profilePicId: user.photoURL || null,
                        bio: "", location: "", friendsCount: 0, followersCount: 0, followingCount: 0,
                        createdAt: Date.now(), updatedAt: Date.now(), inspirationType: "motivational",
                        visibility: {
                            displayName: true, profilePic: true, bio: false, location: false,
                            emailPublic: false, lastOnline: false, allowFriendRequests: true, allowMessages: true,
                        },
                        totalPosts: 0, jCoins: 0, level: 1, currentXp: 0, xpToNextLevel: 100,
                        gas: 0, // Initialize gas
                        messagesSentCount: 0, // Initialize messagesSentCount
                        lastGroupCheckIn: null, // Initialize lastGroupCheckIn
                        completedQuests: [], // Initialize completedQuests
                        questProgress: {}, // Initialize questProgress
                        referralCode: generateReferralCode(), // NEW: Generate referral code
                        successfulReferrals: 0 // NEW: Initialize successful referrals
                    };
                    await setDoc(privateProfileDocRef, profileData);
                }
                currentUserProfileData = profileData; // Store profile data globally

                // Ensure referral code exists and is displayed
                if (!currentUserProfileData.referralCode) {
                    currentUserProfileData.referralCode = generateReferralCode();
                    await updateDoc(privateProfileDocRef, { referralCode: currentUserProfileData.referralCode });
                }
                referralCodeDisplay.textContent = currentUserProfileData.referralCode;
                successfulReferralsCount.textContent = currentUserProfileData.successfulReferrals || 0;


                const publicProfileSummary = {
                    username: profileData.username,
                    profilePicId: profileData.profilePicId,
                    jCoins: profileData.jCoins,
                    level: profileData.level,
                    userId: user.uid,
                    email: profileData.email,
                    messagesSentCount: profileData.messagesSentCount || 0 // Ensure this is synced
                };
                await setDoc(publicProfileDocRef, publicProfileSummary, { merge: true });

                const usernameInitial = (profileData.username || "J").charAt(0).toUpperCase();
                displayPicture(headerProfilePic, headerAvatarIcon, profileData?.profilePicId, usernameInitial, "w_70,h_70,c_fill,g_face,r_max");
                headerDisplayName.textContent = profileData.username || "JCHAT User";
                headerNavLinkProfile.href = `Profile.html?userId=${user.uid}`;

                // Update JCoin and Gas display in header
                jCoinsDisplay.innerHTML = `<i class="fas fa-coins jcoin-icon"></i> ${currentUserProfileData.jCoins || 0}`;
                gasDisplay.innerHTML = `<i class="fas fa-gas-pump gas-icon"></i> ${currentUserProfileData.gas || 0}`;

                // logoutButton.disabled = false; // Removed logout button
            } catch (error) {
                console.error("Error fetching or creating profile for header:", error);
                const usernameInitial = (user.displayName || "J").charAt(0).toUpperCase();
                displayPicture(headerProfilePic, headerAvatarIcon, user.photoURL, usernameInitial, "w_70,h_70,c_fill,g_face,r_max");
                headerDisplayName.textContent = user.displayName || "JCHAT User";
                showMessageBox(`Error loading header profile: ${error.message}`, 'error');
                // logoutButton.disabled = false; // Removed logout button
            }
        }

        /**
         * Fetches and displays the notification count for the current user.
         * (Placeholder for future functionality)
         * @param {string} userId - The UID of the current user.
         */
        async function fetchNotificationCount(userId) {
            notificationCountElement.style.display = 'none';
        }

        /**
         * Handles user logout.
         */
        async function handleLogout() {
            if (!isAuthReady) return;
            try {
                await signOut(auth);
                showMessageBox("Logged out successfully! ", 'success');
                playNotificationSound();
                setTimeout(() => {
                    window.location.href = '/login.html';
                }, 1000);
            } catch (error) {
                console.error("Error logging out:", error);
                showMessageBox("Failed to log out. Please try again.", 'error');
            }
        }

        /**
         * Renders a single group card.
         * @param {object} groupData - The group data.
         * @param {boolean} isMember - True if the current user is a member of this group.
         */
        function renderGroupCard(groupData, isMember) {
            const groupCard = document.createElement('div');
            groupCard.classList.add('group-card');
            groupCard.dataset.groupId = groupData.id;

            const groupInitial = (groupData.name || "G").charAt(0).toUpperCase();
            const actionText = isMember ? 'Enter Chat' : 'Join Group';
            const actionIcon = isMember ? 'fas fa-comments' : 'fas fa-user-plus';
            const actionLink = isMember ? `/group_chat.html?groupId=${groupData.id}` : '#'; // Link to chat if member

            const isGroupAdmin = currentUser && groupData.admin === currentUser.uid;

            // Group Vault Display
            const groupJCoins = groupData.groupJCoinBalance || 0;
            const groupGas = groupData.groupGasBalance || 0;
            const vaultHtml = `
                <div class="group-vault">
                    <span><i class="fas fa-coins jcoin-icon"></i> ${groupJCoins.toFixed(1)}</span>
                    <span><i class="fas fa-gas-pump gas-icon"></i> ${groupGas.toFixed(1)}</span>
                </div>
            `;

            // Promotion/Boost Status Tags
            let statusTagsHtml = '';
            if (groupData.isPromoted && groupData.promotionEndDate && new Date(groupData.promotionEndDate.toDate()) > new Date()) {
                statusTagsHtml += `<span class="group-status-tag promoted"><i class="fas fa-bullhorn"></i> Promoted</span>`;
            }
            if (groupData.xpBoostEndTime && new Date(groupData.xpBoostEndTime.toDate()) > new Date()) {
                statusTagsHtml += `<span class="group-status-tag xp-boost"><i class="fas fa-star"></i> XP Boost</span>`;
            }
            if (groupData.jcoinBoostEndTime && new Date(groupData.jcoinBoostEndTime.toDate()) > new Date()) {
                statusTagsHtml += `<span class="group-status-tag jcoin-boost"><i class="fas fa-sack-dollar"></i> JCoin Boost</span>`;
            }
            if (statusTagsHtml) {
                statusTagsHtml = `<div class="group-status-tags">${statusTagsHtml}</div>`;
            }

            const tagsHtml = (groupData.tags||[]).slice(0,5).map(t=>`<span class="tag-chip">${t}</span>`).join(' ');

            groupCard.innerHTML = `
                <img src="" alt="Group Avatar" class="group-avatar" id="group-avatar-${groupData.id}" style="display: none;">
                <i class="fas fa-users group-avatar-icon" id="group-avatar-icon-${groupData.id}"></i>
                <h3>${groupData.name || 'Unnamed Group'}</h3>
                <p>${groupData.description || 'No description provided.'}</p>
                <div class="tags-container">${tagsHtml}</div>
                <span class="member-count"><i class="fas fa-users"></i> ${groupData.members?.length || 0} Members</span>
                ${vaultHtml}
                ${statusTagsHtml}
                <div class="action-button-container">
                    <a href="${actionLink}" class="action-button enter-chat-button" data-group-id="${groupData.id}" data-is-member="${isMember}">
                        <span class="button-text"><i class="${actionIcon}"></i> ${actionText}</span>
                        <div class="button-loader"></div>
                    </a>
                    ${isMember ? `<button class="action-button donate-button" data-group-id="${groupData.id}">
                        <span class="button-text"><i class="fas fa-hand-holding-usd"></i> Donate</span>
                        <div class="button-loader"></div>
                    </button>` : ''}
                    ${isMember && !isGroupAdmin ? `<button class="action-button leave-button" data-group-id="${groupData.id}">
                        <span class="button-text"><i class="fas fa-sign-out-alt"></i> Leave Group</span>
                        <div class="button-loader"></div>
                    </button>` : ''}
                    ${isGroupAdmin ? `<a href="/group_settings.html?groupId=${groupData.id}" class="action-button manage-button" data-group-id="${groupData.id}">
                        <span class="button-text"><i class="fas fa-cog"></i> Manage Group</span>
                    </a>` : ''}
                </div>
            `;

            const avatarImg = groupCard.querySelector(`#group-avatar-${groupData.id}`);
            const avatarIcon = groupCard.querySelector(`#group-avatar-icon-${groupData.id}`);
            displayPicture(avatarImg, avatarIcon, groupData.groupPicId, groupInitial, "w_160,h_160,c_fill,g_face,r_max");

            // Add event listener for the action button (Join/Enter Chat)
            const enterChatButton = groupCard.querySelector('.enter-chat-button');
            if (!isMember) {
                enterChatButton.addEventListener('click', (e) => {
                    e.preventDefault(); // Prevent default link behavior for non-members
                    handleJoinGroup(groupData.id, groupData.name, enterChatButton);
                });
            }

            // Add event listener for Leave Group button
            const leaveButton = groupCard.querySelector('.leave-button');
            if (leaveButton) {
                leaveButton.addEventListener('click', () => handleLeaveGroup(groupData.id, groupData.name, leaveButton));
            }

            // Add event listener for Donate button
            const donateButton = groupCard.querySelector('.donate-button');
            if (donateButton) {
                donateButton.addEventListener('click', () => {
                    donateGroupSelect.value = groupData.id; // Pre-select group
                    currentUserJCoinsDonateDisplay.textContent = currentUserProfileData.jCoins || 0;
                    donateAmountInput.value = '';
                    submitDonateJCoinsBtn.disabled = true;
                    donateJCoinsModal.classList.add('active');
                });
            }

            return groupCard;
        }

        /**
         * Fetches and displays groups the current user is a member of.
         */
        function fetchMyGroups() {
            if (!currentUser) {
                loadingMyGroupsMessage.textContent = "Please log in to see your groups.";
                return;
            }

            loadingMyGroupsMessage.style.display = 'block';
            myGroupsList.innerHTML = ''; // Clear previous list

            // Listen to groups where the current user is a member
            const q = query(collection(db, "artifacts", appId, "public", "data", "groups"), where("members", "array-contains", currentUser.uid));

            onSnapshot(q, (querySnapshot) => {
                if (querySnapshot.empty) {
                    loadingMyGroupsMessage.textContent = "You are not a member of any groups yet. Discover new groups below!";
                    myGroupsData = [];
                    return;
                }

                loadingMyGroupsMessage.style.display = 'none';
                myGroupsList.innerHTML = '';
                myGroupsData = [];

                querySnapshot.docs.forEach(docSnapshot => {
                    const groupData = docSnapshot.data();
                    const group = { id: docSnapshot.id, ...groupData };
                    myGroupsData.push(group);
                    myGroupsList.appendChild(renderGroupCard(group, true)); // True for isMember
                });
                showMessageBox("Your groups updated.", "info", 1500);
                // Re-filter discover groups as myGroupsData might have changed
                filterAndDisplayDiscoverGroups();
                populateGroupSelects(); // Update group selects in modals
            }, (error) => {
                console.error("JCHAT_ERROR: Error fetching my groups:", error);
                loadingMyGroupsMessage.textContent = `Error loading your groups: ${error.message}`;
                showMessageBox(`Error fetching your groups: ${error.message}`, 'error');
            });
        }

        /**
         * Fetches and displays all public groups (for discovery).
         */
        function fetchDiscoverGroups() {
            loadingDiscoverGroupsMessage.style.display = 'block';
            discoverGroupsList.innerHTML = ''; // Clear previous list

            const q = query(collection(db, "artifacts", appId, "public", "data", "groups"));

            onSnapshot(q, (querySnapshot) => {
                if (querySnapshot.empty) {
                    loadingDiscoverGroupsMessage.textContent = "No public groups available to discover.";
                    allPublicGroupsData = [];
                    return;
                }

                loadingDiscoverGroupsMessage.style.display = 'none';
                allPublicGroupsData = [];

                querySnapshot.docs.forEach(docSnapshot => {
                    const groupData = docSnapshot.data();
                    const group = { id: docSnapshot.id, ...groupData };
                    allPublicGroupsData.push(group);
                });

                filterAndDisplayDiscoverGroups(); // Apply initial filter (empty search)
                showMessageBox("Discover groups updated.", "info", 1500);
            }, (error) => {
                console.error("JCHAT_ERROR: Error fetching discover groups:", error);
                loadingDiscoverGroupsMessage.textContent = `Error loading discover groups: ${error.message}`;
                showMessageBox(`Error fetching discover groups: ${error.message}`, 'error');
            });
        }

        /**
         * Filters and displays discoverable groups based on search input.
         */
        function filterAndDisplayDiscoverGroups() {
            const searchTerm = searchGroupInput.value.toLowerCase().trim();
            discoverGroupsList.innerHTML = ''; // Clear current list

            const filteredGroups = allPublicGroupsData.filter(group =>
                group.name.toLowerCase().includes(searchTerm) ||
                (group.description && group.description.toLowerCase().includes(searchTerm)) ||
                (group.tags && group.tags.some(tag => tag.toLowerCase().includes(searchTerm)))
            );

            if (filteredGroups.length === 0) {
                discoverGroupsList.innerHTML = '<p class="no-groups-message">No groups found matching your search.</p>';
                return;
            }

            filteredGroups.forEach(group => {
                // Check if the current user is already a member of this group
                const isMember = myGroupsData.some(myGroup => myGroup.id === group.id);
                discoverGroupsList.appendChild(renderGroupCard(group, isMember));
            });
        }

        /**
         * Handles the creation of a new group.
         */
        async function handleCreateGroup() {
            if (!currentUser || !currentUserProfileData) {
                showMessageBox("You must be logged in to create a group.", "error");
                return;
            }

            const groupName = groupNameInput.value.trim();
            const groupDescription = groupDescriptionInput.value.trim();
            const groupPicUrl = groupPicInput.value.trim();
            const tagsRaw = createGroupTagsInput.value.trim();
            const tagsArr = tagsRaw ? tagsRaw.split(',').map(t=>t.trim()).filter(Boolean).slice(0,5) : [];

            if (!groupName) {
                showMessageBox("Group Name is required.", "warning");
                return;
            }

            if (currentUserProfileData.jCoins < GROUP_CREATION_COST) {
                showMessageBox(`You need ${GROUP_CREATION_COST} JCoins to create a group. You have ${currentUserProfileData.jCoins}.`, "error");
                return;
            }

            const confirmed = await showCustomConfirm(`Creating a group costs ${GROUP_CREATION_COST} JCoins. Do you want to proceed?`);
            if (!confirmed) return;

            toggleButtonLoading(submitCreateGroupBtn, true);
            showMessageBox("Creating group and deducting JCoins...", "loading", true);

            try {
                const userProfileRef = doc(db, "artifacts", appId, "users", currentUser.uid, "profiles", "user_profile");
                const userTransactionsCollectionRef = collection(db, "artifacts", appId, "users", currentUser.uid, "transactions");

                let newGroupRefId = null; // To store the ID of the new group

                await runTransaction(db, async (transaction) => {
                    const userDoc = await transaction.get(userProfileRef);
                    if (!userDoc.exists()) {
                        throw new Error("User profile not found!");
                    }

                    const currentJCoins = userDoc.data().jCoins || 0;
                    if (currentJCoins < GROUP_CREATION_COST) {
                        throw new Error("Insufficient JCoins for group creation.");
                    }

                    const newJCoins = currentJCoins - GROUP_CREATION_COST;

                    // 1. Deduct JCoins from user
                    transaction.update(userProfileRef, { jCoins: newJCoins, updatedAt: serverTimestamp() });

                    // 2. Add transaction record for deduction
                    transaction.set(doc(userTransactionsCollectionRef), {
                        type: 'group_creation_cost',
                        amount: -GROUP_CREATION_COST, // Negative for deduction
                        description: `Cost for creating group: "${groupName}"`,
                        timestamp: serverTimestamp(),
                        groupId: null, // Not associated with an existing group yet
                        relatedEntityId: null // No specific related entity
                    });

                    // 3. Create the new group document
                    const newGroupDocRef = doc(collection(db, "artifacts", appId, "public", "data", "groups")); // Get a new doc ref with auto ID
                    newGroupRefId = newGroupDocRef.id; // Store the ID
                    transaction.set(newGroupDocRef, {
                        name: groupName,
                        description: groupDescription,
                        groupPicId: groupPicUrl || null,
                        members: [currentUser.uid], // Creator is the first member
                        admin: currentUser.uid, // Creator is the initial admin
                        createdAt: serverTimestamp(),
                        lastActivity: serverTimestamp(),
                        isPublic: true, // All created groups are public for now
                        groupJCoinBalance: 0, // Initialize group JCoin balance
                        groupGasBalance: 0, // Initialize group Gas balance
                        tags: tagsArr
                    });

                    // 4. Add group ID to user's memberOfGroups array
                    transaction.update(userProfileRef, {
                        memberOfGroups: arrayUnion(newGroupRefId)
                    });
                });

                // After successful transaction, update local profile data and UI
                currentUserProfileData.jCoins -= GROUP_CREATION_COST;
                jCoinsDisplay.innerHTML = `<i class="fas fa-coins jcoin-icon"></i> ${currentUserProfileData.jCoins || 0}`;

                // Create pending activity reward for admin review (negative JCoin amount)
                await createPendingActivityReward(
                    currentUser.uid,
                    currentUserProfileData.username,
                    'group_creation_cost',
                    -GROUP_CREATION_COST, // Negative amount for deduction
                    0, 0,
                    newGroupRefId, // Associate with the newly created group
                    null
                );

                showMessageBox(`Group "${groupName}" created successfully for ${GROUP_CREATION_COST} JCoins!`, "success");
                createGroupModal.classList.remove('active'); // Close modal
                groupNameInput.value = ''; // Clear form
                groupDescriptionInput.value = '';
                groupPicInput.value = '';
                createGroupTagsInput.value = '';

                // onSnapshot listeners will handle UI updates for groups
            } catch (error) {
                console.error("JCHAT_ERROR: Error creating group:", error);
                showMessageBox(`Failed to create group: ${error.message}`, "error");
            } finally {
                toggleButtonLoading(submitCreateGroupBtn, false);
            }
        }

        /**
         * Handles joining an existing group.
         * @param {string} groupId - The ID of the group to join.
         * @param {string} groupName - The name of the group.
         * @param {HTMLElement} buttonElement - The button element that triggered the action.
         */
        async function handleJoinGroup(groupId, groupName, buttonElement) {
            if (!currentUser) {
                showMessageBox("You must be logged in to join a group.", "error");
                return;
            }

            const confirmed = await showCustomConfirm(`Do you want to join "${groupName}"?`);
            if (!confirmed) return;

            toggleButtonLoading(buttonElement, true);
            showMessageBox(`Joining "${groupName}"...`, "loading", true);

            try {
                const groupRef = doc(db, "artifacts", appId, "public", "data", "groups", groupId);
                await updateDoc(groupRef, {
                    members: arrayUnion(currentUser.uid) // Add current user to members array
                });

                // Add group ID to user's memberOfGroups array
                const userProfileRef = doc(db, "artifacts", appId, "users", currentUser.uid, "profiles", "user_profile");
                await updateDoc(userProfileRef, {
                    memberOfGroups: arrayUnion(groupId)
                });

                showMessageBox(`Successfully joined "${groupName}"!`, "success");
                // The onSnapshot listeners will automatically update the UI
            } catch (error) {
                console.error("JCHAT_ERROR: Error joining group:", error);
                showMessageBox(`Failed to join group: ${error.message}`, "error");
            } finally {
                toggleButtonLoading(buttonElement, false);
            }
        }

        /**
         * Handles leaving a group.
         * @param {string} groupId - The ID of the group to leave.
         * @param {string} groupName - The name of the group.
         * @param {HTMLElement} buttonElement - The button element that triggered the action.
         */
        async function handleLeaveGroup(groupId, groupName, buttonElement) {
            if (!currentUser) {
                showMessageBox("You must be logged in to leave a group.", "error");
                return;
            }

            const confirmed = await showCustomConfirm(`Are you sure you want to leave "${groupName}"?`);
            if (!confirmed) return;

            toggleButtonLoading(buttonElement, true);
            showMessageBox(`Leaving "${groupName}"...`, "loading", true);

            try {
                const groupRef = doc(db, "artifacts", appId, "public", "data", "groups", groupId);
                const groupDoc = await getDoc(groupRef);

                if (!groupDoc.exists()) {
                    throw new Error("Group not found.");
                }

                const groupData = groupDoc.data();
                const currentMembers = groupData.members || [];

                if (!currentMembers.includes(currentUser.uid)) {
                    throw new Error("You are not a member of this group.");
                }

                if (groupData.admin === currentUser.uid && currentMembers.length > 1) {
                    // If current user is the admin and there are other members, prompt for admin transfer
                    const transferConfirmed = await showCustomConfirm(`You are the admin of "${groupName}". If you leave, the group will need a new admin. Do you still want to leave? (Admin transfer not yet implemented, group might become unmanaged)`);
                    if (!transferConfirmed) {
                        showMessageBox("Leaving group cancelled.", "info");
                        return;
                    }
                    // In a full implementation, you'd prompt to select a new admin here.
                    // For now, the group will just lose its admin if the last one leaves.
                }

                // Remove user from group's members array
                await updateDoc(groupRef, {
                    members: arrayRemove(currentUser.uid)
                });

                // Remove group ID from user's memberOfGroups array
                const userProfileRef = doc(db, "artifacts", appId, "users", currentUser.uid, "profiles", "user_profile");
                await updateDoc(userProfileRef, {
                    memberOfGroups: arrayRemove(groupId)
                });

                showMessageBox(`Successfully left "${groupName}".`, "success");
                // onSnapshot listeners will handle UI updates
            } catch (error) {
                console.error("JCHAT_ERROR: Error leaving group:", error);
                showMessageBox(`Failed to leave group: ${error.message}`, "error");
            } finally {
                toggleButtonLoading(buttonElement, false);
            }
        }

        /**
         * Creates a pending activity reward for admin review.
         * @param {string} userId - The ID of the user whose JCoins/XP/Gas are affected.
         * @param {string} username - The username of the user.
         * @param {string} activityType - Type of activity (e.g., 'group_promotion').
         * @param {number} suggestedJCoinAmount - The suggested JCoin amount (positive for add, negative for deduct).
         * @param {number} suggestedXpAmount - The suggested XP amount (positive for add, negative for deduct).
         * @param {number} suggestedGasAmount - The suggested Gas amount (positive for add, negative for deduct).
         * @param {string|null} groupId - The ID of the group involved, if any.
         * @param {string|null} relatedEntityId - ID of related entity (e.g., promotion ID, customization ID, gifted user ID, quest ID).
         */
        async function createPendingActivityReward(userId, username, activityType, suggestedJCoinAmount, suggestedXpAmount, suggestedGasAmount, groupId = null, relatedEntityId = null) {
            try {
                const pendingRewardsCollectionRef = collection(db, "artifacts", appId, "public", "data", "pending_activity_rewards");
                await addDoc(pendingRewardsCollectionRef, {
                    userId: userId,
                    username: username,
                    activityType: activityType,
                    suggestedJCoinAmount: suggestedJCoinAmount,
                    suggestedXpAmount: suggestedXpAmount,
                    suggestedGasAmount: suggestedGasAmount, // Added Gas amount
                    status: 'pending', // Always pending for admin review
                    timestamp: serverTimestamp(),
                    groupId: groupId,
                    relatedEntityId: relatedEntityId,
                    reviewerId: null, // Admin who reviews it
                    reviewTimestamp: null,
                    notes: ''
                });
                console.log(`JCHAT_DEBUG: Pending activity reward created for ${activityType}.`);
            } catch (error) {
                console.error("JCHAT_ERROR: Error creating pending activity reward:", error);
            }
        }

        /**
         * Deducts JCoins from the current user's profile.
         * @param {number} amount - The amount of JCoins to deduct.
         * @param {string} activityType - The type of activity for the deduction (e.g., 'group_promotion').
         * @param {string|null} groupId - The ID of the group involved.
         * @param {string|null} relatedEntityId - ID of related entity (e.g., promotion ID).
         * @returns {Promise<boolean>} True if deduction initiated successfully, false otherwise.
         */
        async function deductJCoins(amount, activityType, groupId = null, relatedEntityId = null) {
            if (!currentUser || !currentUserProfileData) {
                showMessageBox("User not logged in or profile not loaded.", "error");
                return false;
            }
            if (currentUserProfileData.jCoins < amount) {
                showMessageBox("Insufficient JCoins.", "warning");
                return false;
            }

            const userProfileRef = doc(db, "artifacts", appId, "users", currentUser.uid, "profiles", "user_profile");
            const userTransactionsCollectionRef = collection(db, "artifacts", appId, "users", currentUser.uid, "transactions");


            try {
                await runTransaction(db, async (transaction) => {
                    const docSnap = await transaction.get(userProfileRef);
                    if (!docSnap.exists()) {
                        throw new Error("User profile not found!");
                    }
                    const currentJCoins = docSnap.data().jCoins || 0;
                    const newJCoins = currentJCoins - amount;
                    if (newJCoins < 0) {
                        throw new Error("Insufficient JCoins for this transaction.");
                    }
                    transaction.update(userProfileRef, { jCoins: newJCoins, updatedAt: serverTimestamp() });

                    // Add transaction record for deduction
                    transaction.set(doc(userTransactionsCollectionRef), {
                        type: activityType,
                        amount: -amount, // Negative for deduction
                        description: `Cost for ${activityType.replace(/_/g, ' ')}`,
                        timestamp: serverTimestamp(),
                        groupId: groupId,
                        relatedEntityId: relatedEntityId
                    });
                });

                // Create pending reward for the deduction (negative JCoin amount)
                await createPendingActivityReward(
                    currentUser.uid,
                    currentUserProfileData.username,
                    activityType,
                    -amount, // Negative amount for deduction
                    0, // No XP change for spending
                    0, // No Gas change for spending
                    groupId,
                    relatedEntityId
                );
                // After transaction, re-fetch profile to update local state and UI
                await fetchAndDisplayHeaderProfile(currentUser);
                return true;
            } catch (error) {
                console.error("JCHAT_ERROR: Error deducting JCoins:", error);
                showMessageBox(`Failed to deduct JCoins: ${error.message}`, "error");
                return false;
            }
        }

        /**
         * Adds JCoins to a user's profile.
         * @param {string} userId - The ID of the user to add JCoins to.
         * @param {string} username - The username of the user.
         * @param {number} amount - The amount of JCoins to add.
         * @param {string} activityType - The type of activity for the addition (e.g., 'jcoin_gift_received').
         * @param {string|null} groupId - The ID of the group involved.
         * @param {string|null} relatedEntityId - ID of related entity (e.g., sender user ID).
         * @returns {Promise<boolean>} True if addition initiated successfully, false otherwise.
         */
        async function addJCoins(userId, username, amount, activityType, groupId = null, relatedEntityId = null) {
            const userProfileRef = doc(db, "artifacts", appId, "users", userId, "profiles", "user_profile");
            const userTransactionsCollectionRef = collection(db, "artifacts", appId, "users", userId, "transactions");

            try {
                await runTransaction(db, async (transaction) => {
                    const docSnap = await transaction.get(userProfileRef);
                    if (!docSnap.exists()) {
                        throw new Error("Recipient user profile not found!");
                    }
                    const currentJCoins = docSnap.data().jCoins || 0;
                    const newJCoins = currentJCoins + amount;
                    transaction.update(userProfileRef, { jCoins: newJCoins, updatedAt: serverTimestamp() });

                    // Add transaction record for addition
                    transaction.set(doc(userTransactionsCollectionRef), {
                        type: activityType,
                        amount: amount, // Positive for addition
                        description: `Received JCoins for ${activityType.replace(/_/g, ' ')}`,
                        timestamp: serverTimestamp(),
                        groupId: groupId,
                        relatedEntityId: relatedEntityId
                    });
                });

                // Create pending reward for the addition (positive JCoin amount)
                await createPendingActivityReward(
                    userId,
                    username,
                    activityType,
                    amount, // Positive amount for addition
                    0, // No XP change for receiving JCoins
                    0, // No Gas change
                    groupId,
                    relatedEntityId
                );
                // If the current user is the recipient, update local state
                if (userId === currentUser.uid) {
                    await fetchAndDisplayHeaderProfile(currentUser);
                }
                return true;
            } catch (error) {
                console.error("JCHAT_ERROR: Error adding JCoins:", error);
                showMessageBox(`Failed to add JCoins to recipient: ${error.message}`, "error");
                return false;
            }
        }

        /**
         * Populates the group selection dropdowns in modals.
         */
        function populateGroupSelects() {
            // Clear existing options
            promoteGroupSelect.innerHTML = '<option value="">Select a group</option>';
            customizeGroupSelect.innerHTML = '<option value="">Select a group</option>';
            boostGroupSelect.innerHTML = '<option value="">Select a group</option>';
            donateGroupSelect.innerHTML = '<option value="">Select a group</option>';
            giftGroupSelect.innerHTML = '<option value="">Select a group</option>';

            // Populate Promote, Customize, Boost modals with groups where user is admin
            const adminGroups = myGroupsData.filter(group => currentUser && group.admin === currentUser.uid);
            adminGroups.forEach(group => {
                const optionPromote = document.createElement('option');
                optionPromote.value = group.id;
                optionPromote.textContent = group.name;
                promoteGroupSelect.appendChild(optionPromote);

                const optionCustomize = document.createElement('option');
                optionCustomize.value = group.id;
                optionCustomize.textContent = group.name;
                customizeGroupSelect.appendChild(optionCustomize);

                const optionBoost = document.createElement('option');
                optionBoost.value = group.id;
                optionBoost.textContent = group.name;
                boostGroupSelect.appendChild(optionBoost);
            });

            // Populate Donate and Gift JCoins modal with all groups the user is a member of
            myGroupsData.forEach(group => {
                const optionDonate = document.createElement('option');
                optionDonate.value = group.id;
                optionDonate.textContent = group.name;
                donateGroupSelect.appendChild(optionDonate);

                const optionGift = document.createElement('option');
                optionGift.value = group.id;
                optionGift.textContent = group.name;
                giftGroupSelect.appendChild(option);
            });

            // Enable/disable buttons based on admin status
            promoteGroupBtn.disabled = adminGroups.length === 0 || !isAuthReady;
            customizeGroupBtn.disabled = adminGroups.length === 0 || !isAuthReady;
            activateGroupBoostBtn.disabled = adminGroups.length === 0 || !isAuthReady;
            createEventBtn.disabled = adminGroups.length === 0 || !isAuthReady;
            unlockPrivateChannelBtn.disabled = adminGroups.length === 0 || !isAuthReady;

            // Donate JCoins can be used by any member
            // The donate button on each group card is enabled/disabled by renderGroupCard
            // This is for the modal trigger button
            // donateJCoinsBtn.disabled = myGroupsData.length === 0 || !isAuthReady;
            giftJCoinsBtn.disabled = myGroupsData.length === 0 || !isAuthReady;
        }

        /**
         * Handles Group Promotion.
         */
        async function handlePromoteGroup() {
            const groupId = promoteGroupSelect.value;
            const durationDays = parseInt(promotionDuration.value);
            const cost = parseInt(promotionDuration.selectedOptions[0].dataset.cost);

            if (!groupId) {
                showMessageBox("Please select a group to promote.", "warning");
                return;
            }
            if (!currentUserProfileData || currentUserProfileData.jCoins < cost) {
                showMessageBox("Insufficient JCoins to promote this group.", "error");
                return;
            }

            const confirmed = await showCustomConfirm(`Promote this group for ${durationDays} days for ${cost} JCoins?`);
            if (!confirmed) return;

            toggleButtonLoading(submitPromoteGroupBtn, true);
            showMessageBox(`Promoting group for ${cost} JCoins...`, "loading", true);

            try {
                const userProfileRef = doc(db, "artifacts", appId, "users", currentUser.uid, "profiles", "user_profile");
                const groupRef = doc(db, "artifacts", appId, "public", "data", "groups", groupId);

                await runTransaction(db, async (transaction) => {
                    const userDoc = await transaction.get(userProfileRef);
                    const groupDoc = await transaction.get(groupRef);

                    if (!userDoc.exists()) throw new Error("User profile not found!");
                    if (!groupDoc.exists()) throw new Error("Group not found!");

                    const currentJCoins = userDoc.data().jCoins || 0;
                    if (currentJCoins < cost) {
                        throw new Error("Insufficient JCoins for this transaction.");
                    }

                    const newJCoins = currentJCoins - cost;
                    const promotionEndDate = new Date();
                    promotionEndDate.setDate(promotionEndDate.getDate() + durationDays);

                    transaction.update(userProfileRef, { jCoins: newJCoins, updatedAt: serverTimestamp() });
                    transaction.update(groupRef, {
                        isPromoted: true,
                        promotionEndDate: promotionEndDate,
                        updatedAt: serverTimestamp()
                    });
                });

                // After transaction, re-fetch profile to update local state and UI
                await fetchAndDisplayHeaderProfile(currentUser);

                // Create pending reward for the deduction (for admin review/logging)
                await createPendingActivityReward(
                    currentUser.uid,
                    currentUserProfileData.username,
                    'group_promotion_purchase',
                    -cost,
                    0, 0,
                    groupId,
                    `duration_${durationDays}d`
                );

                showMessageBox(`Group promoted successfully for ${durationDays} days!`, "success");
                promoteGroupModal.classList.remove('active');
            } catch (error) {
                console.error("JCHAT_ERROR: Error promoting group:", error);
                showMessageBox(`Failed to promote group: ${error.message}`, "error");
            } finally {
                toggleButtonLoading(submitPromoteGroupBtn, false);
            }
        }

        /**
         * Handles Group Customization Purchase.
         */
        async function handleCustomizeGroup() {
            const groupId = customizeGroupSelect.value;
            if (!groupId) {
                showMessageBox("Please select a group to customize.", "warning");
                return;
            }
            if (!selectedCustomizationOption) {
                showMessageBox("Please select a customization option.", "warning");
                return;
            }

            const cost = parseInt(selectedCustomizationOption.dataset.cost);
            const type = selectedCustomizationOption.dataset.type;
            const value = selectedCustomizationOption.dataset.value;
            const optionName = selectedCustomizationOption.dataset.name;

            if (!currentUserProfileData || currentUserProfileData.jCoins < cost) {
                showMessageBox("Insufficient JCoins to purchase this customization.", "error");
                return;
            }

            const confirmed = await showCustomConfirm(`Purchase "${optionName}" for ${cost} JCoins?`);
            if (!confirmed) return;

            toggleButtonLoading(submitCustomizeGroupBtn, true);
            showMessageBox(`Purchasing customization for ${cost} JCoins...`, "loading", true);

            try {
                const userProfileRef = doc(db, "artifacts", appId, "users", currentUser.uid, "profiles", "user_profile");
                const groupRef = doc(db, "artifacts", appId, "public", "data", "groups", groupId);

                await runTransaction(db, async (transaction) => {
                    const userDoc = await transaction.get(userProfileRef);
                    if (!userDoc.exists()) throw new Error("User profile not found!");

                    const currentJCoins = userDoc.data().jCoins || 0;
                    if (currentJCoins < cost) {
                        throw new Error("Insufficient JCoins for this transaction.");
                    }

                    const newJCoins = currentJCoins - cost;
                    transaction.update(userProfileRef, { jCoins: newJCoins, updatedAt: serverTimestamp() });

                    const updateData = {};
                    if (type === 'banner') {
                        updateData.customBanner = value; // Store banner ID/URL
                    } else if (type === 'emoji_pack') {
                        updateData.customEmojiPack = value; // Store emoji pack ID
                    }
                    updateData.updatedAt = serverTimestamp();
                    transaction.update(groupRef, updateData);
                });

                // After transaction, re-fetch profile to update local state and UI
                await fetchAndDisplayHeaderProfile(currentUser);

                // Create pending reward for the deduction
                await createPendingActivityReward(
                    currentUser.uid,
                    currentUserProfileData.username,
                    'group_customization_purchase',
                    -cost,
                    0, 0,
                    groupId,
                    `${type}_${value}`
                );

                showMessageBox(`Customization "${optionName}" applied!`, "success");
                customizeGroupModal.classList.remove('active');
            } catch (error) {
                console.error("JCHAT_ERROR: Error customizing group:", error);
                showMessageBox(`Failed to apply customization: ${error.message}`, "error");
            } finally {
                toggleButtonLoading(submitCustomizeGroupBtn, false);
            }
        }

        /**
         * Handles Activating Group Boost.
         */
        async function handleActivateGroupBoost() {
            const groupId = boostGroupSelect.value;
            const type = boostType.value;
            const durationHours = parseInt(boostDuration.value);
            const cost = parseInt(boostType.selectedOptions[0].dataset.cost);

            if (!groupId) {
                showMessageBox("Please select a group to boost.", "warning");
                return;
            }
            if (!currentUserProfileData || currentUserProfileData.jCoins < cost) {
                showMessageBox("Insufficient JCoins to activate this boost.", "error");
                return;
            }

            const confirmed = await showCustomConfirm(`Activate ${type.toUpperCase()} Boost for ${durationHours} hours for ${cost} JCoins?`);
            if (!confirmed) return;

            toggleButtonLoading(submitActivateBoostBtn, true);
            showMessageBox(`Activating ${type.toUpperCase()} Boost for ${cost} JCoins...`, "loading", true);

            try {
                const userProfileRef = doc(db, "artifacts", appId, "users", currentUser.uid, "profiles", "user_profile");
                const groupRef = doc(db, "artifacts", appId, "public", "data", "groups", groupId);

                await runTransaction(db, async (transaction) => {
                    const userDoc = await transaction.get(userProfileRef);
                    if (!userDoc.exists()) throw new Error("User profile not found!");

                    const currentJCoins = userDoc.data().jCoins || 0;
                    if (currentJCoins < cost) {
                        throw new Error("Insufficient JCoins for this transaction.");
                    }

                    const newJCoins = currentJCoins - cost;
                    const boostEndTime = new Date(Date.now() + durationHours * 60 * 60 * 1000); // Current time + duration in ms

                    transaction.update(userProfileRef, { jCoins: newJCoins, updatedAt: serverTimestamp() });

                    const updateData = { updatedAt: serverTimestamp() };
                    if (type === 'xp') {
                        updateData.xpBoostEndTime = boostEndTime;
                    } else if (type === 'jcoin') {
                        updateData.jcoinBoostEndTime = boostEndTime;
                    }
                    transaction.update(groupRef, updateData);
                });

                // After transaction, re-fetch profile to update local state and UI
                await fetchAndDisplayHeaderProfile(currentUser);

                // Create pending reward for the deduction
                await createPendingActivityReward(
                    currentUser.uid,
                    currentUserProfileData.username,
                    `group_${type}_boost_purchase`,
                    -cost,
                    0, 0,
                    groupId,
                    `duration_${durationHours}h`
                );

                showMessageBox(`${type.toUpperCase()} Boost activated for ${durationHours} hours!`, "success");
                activateGroupBoostModal.classList.remove('active');
            } catch (error) {
                console.error("JCHAT_ERROR: Error activating boost:", error);
                showMessageBox(`Failed to activate boost: ${error.message}`, "error");
            } finally {
                toggleButtonLoading(submitActivateBoostBtn, false);
            }
        }

        /**
         * Handles donating JCoins to a group's vault.
         */
        async function handleDonateJCoins() {
            const groupId = donateGroupSelect.value;
            const donateAmount = parseInt(donateAmountInput.value);

            if (!groupId || !donateAmount || donateAmount <= 0) {
                showMessageBox("Please select a group and enter a valid amount.", "warning");
                return;
            }
            if (donateAmount > currentUserProfileData.jCoins) {
                showMessageBox("You do not have enough JCoins to donate this amount.", "error");
                return;
            }

            const confirmed = await showCustomConfirm(`Donate ${donateAmount} JCoins to this group's vault?`);
            if (!confirmed) return;

            toggleButtonLoading(submitDonateJCoinsBtn, true);
            showMessageBox(`Donating ${donateAmount} JCoins...`, "loading", true);

            try {
                const userProfileRef = doc(db, "artifacts", appId, "users", currentUser.uid, "profiles", "user_profile");
                const groupRef = doc(db, "artifacts", appId, "public", "data", "groups", groupId);

                await runTransaction(db, async (transaction) => {
                    const userDoc = await transaction.get(userProfileRef);
                    const groupDoc = await transaction.get(groupRef);

                    if (!userDoc.exists()) throw new Error("User profile not found!");
                    if (!groupDoc.exists()) throw new Error("Group not found!");

                    const currentUserJCoins = userDoc.data().jCoins || 0;
                    const currentGroupJCoins = groupDoc.data().groupJCoinBalance || 0;

                    if (currentUserJCoins < donateAmount) {
                        throw new Error("Insufficient JCoins for donation.");
                    }

                    transaction.update(userProfileRef, { jCoins: currentUserJCoins - donateAmount, updatedAt: serverTimestamp() });
                    transaction.update(groupRef, { groupJCoinBalance: currentGroupJCoins + donateAmount, updatedAt: serverTimestamp() });
                });

                // After transaction, re-fetch profile to update local state and UI
                await fetchAndDisplayHeaderProfile(currentUser);

                // Create pending reward for the deduction (for admin review/logging)
                await createPendingActivityReward(
                    currentUser.uid,
                    currentUserProfileData.username,
                    'jcoin_donation_to_group',
                    -donateAmount,
                    0, 0,
                    groupId,
                    null
                );

                showMessageBox(`Successfully donated ${donateAmount} JCoins to the group vault!`, "success");
                donateJCoinsModal.classList.remove('active');
            } catch (error) {
                console.error("JCHAT_ERROR: Error donating JCoins:", error);
                showMessageBox(`Failed to donate JCoins: ${error.message}`, "error");
            } finally {
                toggleButtonLoading(submitDonateJCoinsBtn, false);
            }
        }


        /**
         * Handles Gifting JCoins to a group member.
         */
        async function handleGiftJCoins() {
            const groupId = giftGroupSelect.value;
            const recipientId = giftMemberSelect.value;
            const giftAmount = parseInt(giftAmountInput.value);

            if (!groupId || !recipientId || !giftAmount || giftAmount <= 0) {
                showMessageBox("Please select a group, a member, and a valid amount.", "warning");
                return;
            }
            if (giftAmount > currentUserProfileData.jCoins) {
                showMessageBox("You do not have enough JCoins to send this gift.", "error");
                return;
            }
            if (recipientId === currentUser.uid) {
                showMessageBox("You cannot gift JCoins to yourself.", "warning");
                return;
            }

            const recipientUsername = giftMemberSelect.selectedOptions[0].textContent;

            const confirmed = await showCustomConfirm(`Gift ${giftAmount} JCoins to ${recipientUsername}?`);
            if (!confirmed) return;

            toggleButtonLoading(submitGiftJCoinsBtn, true);
            showMessageBox(`Sending ${giftAmount} JCoins to ${recipientUsername}...`, "loading", true);

            try {
                const senderProfileRef = doc(db, "artifacts", appId, "users", currentUser.uid, "profiles", "user_profile");
                const recipientProfileRef = doc(db, "artifacts", appId, "users", recipientId, "profiles", "user_profile");

                await runTransaction(db, async (transaction) => {
                    const senderDoc = await transaction.get(senderProfileRef);
                    const recipientDoc = await transaction.get(recipientProfileRef);

                    if (!senderDoc.exists()) throw new Error("Sender profile not found!");
                    if (!recipientDoc.exists()) throw new Error("Recipient profile not found!");

                    const currentSenderJCoins = senderDoc.data().jCoins || 0;
                    const currentRecipientJCoins = recipientDoc.data().jCoins || 0;

                    if (currentSenderJCoins < giftAmount) {
                        throw new Error("Insufficient JCoins for gifting.");
                    }

                    transaction.update(senderProfileRef, { jCoins: currentSenderJCoins - giftAmount, updatedAt: serverTimestamp() });
                    // Recipient's JCoins are updated directly in this transaction for immediate effect
                    transaction.update(recipientProfileRef, { jCoins: currentRecipientJCoins + giftAmount, updatedAt: serverTimestamp() });
                });

                // After transaction, re-fetch profile to update local state and UI for sender
                await fetchAndDisplayHeaderProfile(currentUser);

                // Create pending reward for the gift (for admin review/logging)
                // This will track the gift, but the JCoins are already transferred in the transaction
                await createPendingActivityReward(
                    currentUser.uid,
                    currentUserProfileData.username,
                    'jcoin_gift_sent',
                    -giftAmount, 0, 0,
                    groupId,
                    recipientId
                );
                await createPendingActivityReward(
                    recipientId,
                    recipientUsername,
                    'jcoin_gift_received',
                    giftAmount, 0, 0,
                    groupId,
                    currentUser.uid
                );

                showMessageBox(`Successfully gifted ${giftAmount} JCoins to ${recipientUsername}!`, "success");
                giftJCoinsModal.classList.remove('active');
                giftAmountInput.value = '';
                giftMemberSelect.innerHTML = '<option value="">Select a group first</option>';
                giftMemberSelect.disabled = true;
                submitGiftJCoinsBtn.disabled = true;
            } catch (error) {
                console.error("JCHAT_ERROR: Error gifting JCoins:", error);
                showMessageBox(`Failed to gift JCoins: ${error.message}`, "error");
            } finally {
                toggleButtonLoading(submitGiftJCoinsBtn, false);
            }
        }

        /**
         * Populates the member selection dropdown in the Gift JCoins modal.
         * @param {string} groupId - The ID of the selected group.
         */
        async function populateGiftMemberSelect(groupId) {
            giftMemberSelect.innerHTML = '<option value="">Select a member</option>';
            giftMemberSelect.disabled = true;
            submitGiftJCoinsBtn.disabled = true;

            if (!groupId) return;

            const selectedGroup = myGroupsData.find(g => g.id === groupId);
            if (!selectedGroup || !selectedGroup.members || selectedGroup.members.length === 0) {
                showMessageBox("No members found in this group.", "info");
                return;
            }

            const memberPromises = selectedGroup.members.map(async (memberId) => {
                const userPublicProfileRef = doc(db, "artifacts", appId, "public", "data", "users", memberId);
                const docSnap = await getDoc(userPublicProfileRef);
                if (docSnap.exists()) {
                    return { id: docSnap.id, username: docSnap.data().username || `User_${docSnap.id.substring(0, 8)}` };
                }
                return null;
            });

            const members = (await Promise.all(memberPromises)).filter(m => m !== null);

            members.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = member.username;
                giftMemberSelect.appendChild(option);
            });
            giftMemberSelect.disabled = false;
            // Enable submit button only if a member is selected and amount is valid
            if (giftMemberSelect.value && giftAmountInput.value > 0) {
                submitGiftJCoinsBtn.disabled = false;
            }
        }

        /**
         * Handles the daily check-in bonus claim.
         */
        async function handleDailyCheckin() {
            if (!currentUser || !currentUserProfileData) {
                showMessageBox("Please log in to claim your bonus.", "error");
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize to start of day

            const lastCheckInTimestamp = currentUserProfileData.lastGroupCheckIn;
            let lastCheckInDate = null;
            if (lastCheckInTimestamp) {
                lastCheckInDate = new Date(lastCheckInTimestamp.toDate());
                lastCheckInDate.setHours(0, 0, 0, 0);
            }

            if (lastCheckInDate && lastCheckInDate.getTime() === today.getTime()) {
                showMessageBox("You've already claimed your daily bonus today!", "info");
                return;
            }

            toggleButtonLoading(dailyCheckinBtn, true);
            showMessageBox("Claiming daily bonus...", "loading", true);

            try {
                const userProfileRef = doc(db, "artifacts", appId, "users", currentUser.uid, "profiles", "user_profile");
                const userTransactionsCollectionRef = collection(db, "artifacts", appId, "users", currentUser.uid, "transactions");

                await runTransaction(db, async (transaction) => {
                    const userDoc = await transaction.get(userProfileRef);
                    if (!userDoc.exists()) throw new Error("User profile not found!");

                    const currentJCoins = userDoc.data().jCoins || 0;
                    const currentXp = userDoc.data().currentXp || 0;
                    const currentLevel = userDoc.data().level || 1;
                    const xpToNextLevel = userDoc.data().xpToNextLevel || 100;

                    let newJCoins = currentJCoins + DAILY_CHECKIN_JCOINS;
                    let newXp = currentXp + DAILY_CHECKIN_XP;
                    let newLevel = currentLevel;
                    let newXpToNextLevel = xpToNextLevel;

                    // Handle level up
                    while (newXp >= newXpToNextLevel) {
                        newXp -= newXpToNextLevel;
                        newLevel++;
                        newXpToNextLevel = Math.floor(newXpToNextLevel * 1.5); // Increase XP needed for next level
                    }

                    transaction.update(userProfileRef, {
                        jCoins: newJCoins,
                        currentXp: newXp,
                        level: newLevel,
                        xpToNextLevel: newXpToNextLevel,
                        lastGroupCheckIn: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    });

                    // Add transaction record
                    transaction.set(doc(userTransactionsCollectionRef), {
                        type: 'daily_checkin_reward',
                        amount: DAILY_CHECKIN_JCOINS,
                        xpAmount: DAILY_CHECKIN_XP,
                        description: `Daily Check-in Bonus: +${DAILY_CHECKIN_JCOINS} JCoins, +${DAILY_CHECKIN_XP} XP`,
                        timestamp: serverTimestamp()
                    });
                });

                // Update local state and UI
                // Re-fetch profile to ensure level/XP updates are accurate
                await fetchAndDisplayHeaderProfile(currentUser);

                showMessageBox(`Claimed ${DAILY_CHECKIN_JCOINS} JCoins and ${DAILY_CHECKIN_XP} XP!`, "success");
            } catch (error) {
                console.error("JCHAT_ERROR: Error claiming daily bonus:", error);
                showMessageBox(`Failed to claim daily bonus: ${error.message}`, "error");
            } finally {
                toggleButtonLoading(dailyCheckinBtn, false);
                checkDailyCheckinStatus(); // Re-check status to disable button
            }
        }

        /**
         * Checks and updates the daily check-in button status.
         */
        function checkDailyCheckinStatus() {
            if (!currentUserProfileData) {
                dailyCheckinBtn.disabled = true;
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const lastCheckInTimestamp = currentUserProfileData.lastGroupCheckIn;
            let lastCheckInDate = null;
            if (lastCheckInTimestamp) {
                lastCheckInDate = new Date(lastCheckInTimestamp.toDate());
                lastCheckInDate.setHours(0, 0, 0, 0);
            }

            if (lastCheckInDate && lastCheckInDate.getTime() === today.getTime()) {
                dailyCheckinBtn.disabled = true;
                dailyCheckinBtn.querySelector('.button-text').textContent = "Claimed Today!";
            } else {
                dailyCheckinBtn.disabled = false;
                dailyCheckinBtn.querySelector('.button-text').innerHTML = '<i class="fas fa-calendar-check"></i> Claim Daily Bonus';
            }
        }

        /**
         * Fetches and displays active quests.
         */
        async function fetchActiveQuests() {
            activeQuestsList.innerHTML = '<p class="no-quests-message" style="text-align: center; color: var(--text-light);">Loading quests...</p>';
            activeQuests = [];

            try {
                const questsCollectionRef = collection(db, "artifacts", appId, "public", "data", "quests");
                const q = query(questsCollectionRef, where("isActive", "==", true));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    activeQuestsList.innerHTML = '<p class="no-quests-message">No active quests at the moment.</p>';
                    return;
                }

                activeQuestsList.innerHTML = ''; // Clear loading message
                querySnapshot.docs.forEach(docSnapshot => {
                    const quest = { id: docSnapshot.id, ...docSnapshot.data() };
                    activeQuests.push(quest);
                    renderQuestCard(quest);
                });
            } catch (error) {
                console.error("JCHAT_ERROR: Error fetching active quests:", error);
                activeQuestsList.innerHTML = `<p class="no-quests-message">Error loading quests: ${error.message}</p>`;
                showMessageBox(`Error loading quests: ${error.message}`, 'error');
            }
        }

        /**
         * Renders a single quest card.
         * @param {object} quest - The quest data.
         */
        function renderQuestCard(quest) {
            const questCard = document.createElement('div');
            questCard.classList.add('quest-card');
            questCard.dataset.questId = quest.id;

            const userProgress = currentUserProfileData.questProgress?.[quest.id] || 0;
            const isCompleted = userProgress >= quest.targetValue;
            const isClaimed = currentUserProfileData.completedQuests?.includes(quest.id);

            let progressText = '';
            if (quest.type === 'messages_sent') {
                progressText = `Progress: ${Math.min(userProgress, quest.targetValue)} / ${quest.targetValue} messages sent`;
            } else {
                progressText = `Progress: ${userProgress} / ${quest.targetValue}`; // Generic for other types
            }

            let rewardText = [];
            if (quest.rewardJCoins) rewardText.push(`<i class="fas fa-coins jcoin-icon"></i> ${quest.rewardJCoins} JCoins`);
            if (quest.rewardGas) rewardText.push(`<i class="fas fa-gas-pump gas-icon"></i> ${quest.rewardGas} Gas`);

            questCard.innerHTML = `
                <h4>${quest.name}</h4>
                <p>${quest.description}</p>
                <p class="quest-progress">${progressText}</p>
                <p class="quest-rewards">Rewards: ${rewardText.join(', ')}</p>
                <button class="claim-quest-btn" data-quest-id="${quest.id}" ${!isCompleted || isClaimed ? 'disabled' : ''}>
                    <span class="button-text"><i class="fas fa-gift"></i> ${isClaimed ? 'Claimed!' : 'Claim Reward'}</span>
                    <div class="button-loader"></div>
                </button>
            `;
            activeQuestsList.appendChild(questCard);

            const claimButton = questCard.querySelector('.claim-quest-btn');
            if (claimButton) {
                claimButton.addEventListener('click', () => handleClaimQuest(quest.id, quest.name, quest.rewardJCoins, quest.rewardGas));
            }
        }

        /**
         * Handles claiming a quest reward.
         * @param {string} questId - The ID of the quest.
         * @param {string} questName - The name of the quest.
         * @param {number} rewardJCoins - JCoins to reward.
         * @param {number} rewardGas - Gas to reward.
         */
        async function handleClaimQuest(questId, questName, rewardJCoins, rewardGas) {
            if (!currentUser || !currentUserProfileData) {
                showMessageBox("Please log in to claim quest rewards.", "error");
                return;
            }

            const confirmed = await showCustomConfirm(`Claim rewards for "${questName}"?`);
            if (!confirmed) return;

            const claimButton = document.querySelector(`.claim-quest-btn[data-quest-id="${questId}"]`);
            toggleButtonLoading(claimButton, true);
            showMessageBox("Claiming quest reward...", "loading", true);

            try {
                const userProfileRef = doc(db, "artifacts", appId, "users", currentUser.uid, "profiles", "user_profile");
                const userTransactionsCollectionRef = collection(db, "artifacts", appId, "users", currentUser.uid, "transactions");

                await runTransaction(db, async (transaction) => {
                    const userDoc = await transaction.get(userProfileRef);
                    if (!userDoc.exists()) throw new Error("User profile not found!");

                    const currentCompletedQuests = userDoc.data().completedQuests || [];
                    if (currentCompletedQuests.includes(questId)) {
                        throw new Error("Quest already claimed.");
                    }

                    // Add reward to user's balance
                    let newJCoins = (userDoc.data().jCoins || 0) + (rewardJCoins || 0);
                    let newGas = (userDoc.data().gas || 0) + (rewardGas || 0);

                    transaction.update(userProfileRef, {
                        jCoins: newJCoins,
                        gas: newGas,
                        completedQuests: arrayUnion(questId), // Mark quest as completed
                        updatedAt: serverTimestamp()
                    });

                    // Add transaction record
                    transaction.set(doc(userTransactionsCollectionRef), {
                        type: 'quest_reward',
                        amount: rewardJCoins, // JCoins rewarded
                        xpAmount: rewardGas, // XP rewarded
                        description: `Quest Completion: "${questName}"`,
                        timestamp: serverTimestamp(),
                        questId: questId
                    });
                });

                // Update local state and UI
                // Re-fetch profile to ensure level/XP updates are accurate
                await fetchAndDisplayHeaderProfile(currentUser);

                // Create pending activity reward for admin review/logging
                await createPendingActivityReward(
                    currentUser.uid,
                    currentUserProfileData.username,
                    'quest_completion',
                    rewardJCoins || 0,
                    0, // No XP for quests for now
                    rewardGas || 0,
                    null, // Not group specific
                    questId
                );

                showMessageBox(`Successfully claimed rewards for "${questName}"!`, "success");
                // Re-render quest card to show "Claimed!" and disable button
                renderQuestCard(activeQuests.find(q => q.id === questId));
            } catch (error) {
                console.error("JCHAT_ERROR: Error claiming quest:", error);
                showMessageBox(`Failed to claim quest: ${error.message}`, "error");
            } finally {
                toggleButtonLoading(claimButton, false);
            }
        }

        /**
         * Fetches and displays the global leaderboard.
         */
        async function fetchGlobalLeaderboard() {
            loadingLeaderboardRow.style.display = 'table-row';
            globalLeaderboardBody.innerHTML = ''; // Clear previous data

            try {
                const usersCollectionRef = collection(db, "artifacts", appId, "public", "data", "users");
                // Fetch users ordered by messagesSentCount (top 10 for example)
                const qMessages = query(usersCollectionRef, orderBy("messagesSentCount", "desc")); // No limit for now, can add limit(10)
                const messagesSnapshot = await getDocs(qMessages);

                // Fetch users ordered by jCoins (top 10 for example)
                const qJCoins = query(usersCollectionRef, orderBy("jCoins", "desc")); // No limit for now, can add limit(10)
                const jCoinsSnapshot = await getDocs(qJCoins);

                const usersData = {};
                messagesSnapshot.forEach(doc => {
                    usersData[doc.id] = { ...usersData[doc.id], ...doc.data(), id: doc.id };
                });
                jCoinsSnapshot.forEach(doc => {
                    usersData[doc.id] = { ...usersData[doc.id], ...doc.data(), id: doc.id };
                });

                const sortedByMessages = Object.values(usersData).sort((a, b) => (b.messagesSentCount || 0) - (a.messagesSentCount || 0));
                const sortedByJCoins = Object.values(usersData).sort((a, b) => (b.jCoins || 0) - (a.jCoins || 0));

                loadingLeaderboardRow.style.display = 'none';
                if (Object.keys(usersData).length === 0) {
                    globalLeaderboardBody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: var(--text-light);">No leaderboard data yet. Start chatting!</td></tr>`;
                    return;
                }

                // Render top 10 for now, can be adjusted
                for (let i = 0; i < Math.min(10, sortedByMessages.length); i++) {
                    const user = sortedByMessages[i];
                    const row = document.createElement('tr');
                    const usernameInitial = (user.username || "U").charAt(0).toUpperCase();
                    const avatarHtml = user.profilePicId ?
                        `<img src="${getCloudinaryImageUrl(user.profilePicId, 'w_60,h_60,c_fill,g_face,r_max')}" alt="Avatar">` :
                        `<i class="fas fa-user-circle"></i>`;

                    row.innerHTML = `
                        <td class="rank">${i + 1}</td>
                        <td class="username">${avatarHtml}<span>${user.username || 'Anonymous'}</span></td>
                        <td class="value-display">${user.messagesSentCount || 0}</td>
                        <td class="value-display"><i class="fas fa-coins jcoin-icon"></i> ${user.jCoins || 0}</td>
                    `;
                    globalLeaderboardBody.appendChild(row);
                }

            } catch (error) {
                console.error("JCHAT_ERROR: Error fetching leaderboard:", error);
                globalLeaderboardBody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: var(--text-light);">Error loading leaderboard: ${error.message}</td></tr>`;
                showMessageBox(`Error loading leaderboard: ${error.message}`, 'error');
            }
        }


        // --- Authentication State Listener ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                isAuthReady = true;
                await fetchAndDisplayHeaderProfile(user);
                fetchNotificationCount(user.uid);
                fetchMyGroups(); // Start fetching user's groups
                fetchDiscoverGroups(); // Start fetching discoverable groups
                checkDailyCheckinStatus(); // Check daily check-in status
                fetchActiveQuests(); // Fetch active quests
                fetchGlobalLeaderboard(); // Fetch leaderboard
                ensureSampleQuestExists(); // Ensure sample quest exists for new users
            } else {
                isAuthReady = false;
                currentUser = null;
                // logoutButton.disabled = true; // Removed logout button
                headerDisplayName.textContent = "Guest";
                headerProfilePic.style.display = 'none';
                headerAvatarIcon.style.display = 'block';
                jCoinsDisplay.innerHTML = `<i class="fas fa-coins jcoin-icon"></i> 0`;
                gasDisplay.innerHTML = `<i class="fas fa-gas-pump gas-icon"></i> 0`;
                myGroupsList.innerHTML = '<p class="no-groups-message">Please log in to see your groups.</p>';
                discoverGroupsList.innerHTML = '<p class="no-groups-message">Please log in to discover groups.</p>';
                dailyCheckinBtn.disabled = true;
                dailyCheckinBtn.querySelector('.button-text').textContent = "Log in to claim";
                activeQuestsList.innerHTML = '<p class="no-quests-message">Please log in to see quests.</p>';
                globalLeaderboardBody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: var(--text-light);">Please log in to view the leaderboard.</td></tr>`;
                referralCodeDisplay.textContent = "N/A";
                successfulReferralsCount.textContent = "0";

                showMessageBox("You must be logged in to access groups.", 'error', 2000, true);
                setTimeout(() => {
                    window.location.href = '/login.html';
                }, 2000);
            }
        });

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            // Apply saved theme
            const savedTheme = localStorage.getItem('jchat-theme');
            const themes = ['theme-light-mode', 'theme-dark-mode', 'theme-glass-mode', 'theme-sunset-mode'];
            if (savedTheme && themes.includes(savedTheme)) {
                document.body.classList.remove(...themes);
                document.body.classList.add(savedTheme);
            } else {
                document.body.classList.add('theme-dark-mode'); // Default to dark mode
            }

            // NEW: Display group creation cost
            if (createGroupCostDisplay) {
                createGroupCostDisplay.textContent = GROUP_CREATION_COST.toLocaleString();
            }

            searchGroupInput.addEventListener('input', filterAndDisplayDiscoverGroups);
            createGroupFab.addEventListener('click', () => {
                if (!currentUser || !currentUserProfileData) {
                    showMessageBox("Please log in to create a group.", "error");
                    return;
                }
                if (currentUserProfileData.jCoins < GROUP_CREATION_COST) {
                    showMessageBox(`You need ${GROUP_CREATION_COST} JCoins to create a group. You have ${currentUserProfileData.jCoins}.`, "error");
                    return;
                }
                createGroupModal.classList.add('active');
            });
            cancelCreateGroupBtn.addEventListener('click', () => {
                createGroupModal.classList.remove('active');
            });
            submitCreateGroupBtn.addEventListener('click', handleCreateGroup);

            // Close modal if clicking outside content
            createGroupModal.addEventListener('click', (e) => {
                if (e.target === createGroupModal) {
                    createGroupModal.classList.remove('active');
                }
            });

            // Daily Check-in Button
            dailyCheckinBtn.addEventListener('click', handleDailyCheckin);

            // NEW: Referral Program Button
            copyReferralCodeBtn.addEventListener('click', copyReferralCode);


            // JCoin Feature Buttons Event Listeners
            promoteGroupBtn.addEventListener('click', () => {
                if (!isAuthReady) { showMessageBox("Please log in.", "error"); return; }
                if (!currentUser || myGroupsData.filter(g => g.admin === currentUser.uid).length === 0) {
                    showMessageBox("You must be an admin of a group to use this feature.", "warning");
                    return;
                }
                promoteGroupSelect.value = ""; // Reset selection
                promotionCostDisplay.textContent = promotionDuration.selectedOptions[0].dataset.cost; // Reset cost
                promoteGroupModal.classList.add('active');
            });
            customizeGroupBtn.addEventListener('click', () => {
                if (!isAuthReady) { showMessageBox("Please log in.", "error"); return; }
                if (!currentUser || myGroupsData.filter(g => g.admin === currentUser.uid).length === 0) {
                    showMessageBox("You must be an admin of a group to use this feature.", "warning");
                    return;
                }
                customizeGroupSelect.value = ""; // Reset selection
                selectedCustomizationOption = null;
                document.querySelectorAll('.customization-option').forEach(opt => opt.classList.remove('selected'));
                submitCustomizeGroupBtn.disabled = true;
                customizeGroupModal.classList.add('active');
            });
            activateGroupBoostBtn.addEventListener('click', () => {
                if (!isAuthReady) { showMessageBox("Please log in.", "error"); return; }
                if (!currentUser || myGroupsData.filter(g => g.admin === currentUser.uid).length === 0) {
                    showMessageBox("You must be an admin of a group to use this feature.", "warning");
                    return;
                }
                boostGroupSelect.value = ""; // Reset selection
                boostType.value = "xp"; // Default to XP
                boostDuration.value = "24"; // Default duration
                boostCostDisplay.textContent = boostType.selectedOptions[0].dataset.cost; // Reset cost
                activateGroupBoostModal.classList.add('active');
            });
            createEventBtn.addEventListener('click', () => {
                if (!isAuthReady) { showMessageBox("Please log in.", "error"); return; }
                if (!currentUser || myGroupsData.filter(g => g.admin === currentUser.uid).length === 0) {
                    showMessageBox("You must be an admin of a group to use this feature.", "warning");
                    return;
                }
                showMessageBox("Feature coming soon: Create Special Group Events!", "info");
            });
            giftJCoinsBtn.addEventListener('click', () => {
                if (!isAuthReady) { showMessageBox("Please log in.", "error"); return; }
                if (!currentUser || myGroupsData.length === 0) {
                    showMessageBox("You must be a member of at least one group to gift JCoins.", "warning");
                    return;
                }
                giftGroupSelect.value = ""; // Reset group selection
                giftMemberSelect.innerHTML = '<option value="">Select a group first</option>'; // Clear members
                giftMemberSelect.disabled = true;
                giftAmountInput.value = "";
                giftAmountInput.disabled = true;
                submitGiftJCoinsBtn.disabled = true;
                if (currentUserJCoinsGiftDisplay && currentUserProfileData) {
                    currentUserJCoinsGiftDisplay.textContent = currentUserProfileData.jCoins || 0;
                }
                giftJCoinsModal.classList.add('active');
            });
            unlockPrivateChannelBtn.addEventListener('click', () => {
                if (!isAuthReady) { showMessageBox("Please log in.", "error"); return; }
                if (!currentUser || myGroupsData.filter(g => g.admin === currentUser.uid).length === 0) {
                    showMessageBox("You must be an admin of a group to use this feature.", "warning");
                    return;
                }
                showMessageBox("Feature coming soon: Unlock Private Group Channels!", "info");
            });

            // Promote Group Modal Listeners
            cancelPromoteGroupBtn.addEventListener('click', () => promoteGroupModal.classList.remove('active'));
            submitPromoteGroupBtn.addEventListener('click', handlePromoteGroup);
            promotionDuration.addEventListener('change', () => {
                promotionCostDisplay.textContent = promotionDuration.selectedOptions[0].dataset.cost;
            });
            promoteGroupModal.addEventListener('click', (e) => { if (e.target === promoteGroupModal) promoteGroupModal.classList.remove('active'); });

            // Customize Group Modal Listeners
            cancelCustomizeGroupBtn.addEventListener('click', () => customizeGroupModal.classList.remove('active'));
            submitCustomizeGroupBtn.addEventListener('click', handleCustomizeGroup);
            customizationOptionsContainer.addEventListener('click', (e) => {
                const option = e.target.closest('.customization-option');
                if (option) {
                    document.querySelectorAll('.customization-option').forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    selectedCustomizationOption = option;
                    submitCustomizeGroupBtn.disabled = false;
                }
            });
            customizeGroupModal.addEventListener('click', (e) => { if (e.target === customizeGroupModal) customizeGroupModal.classList.remove('active'); });

            // Activate Group Boost Modal Listeners
            cancelActivateBoostBtn.addEventListener('click', () => activateGroupBoostModal.classList.remove('active'));
            submitActivateBoostBtn.addEventListener('click', handleActivateGroupBoost);
            boostType.addEventListener('change', () => {
                boostCostDisplay.textContent = boostType.selectedOptions[0].dataset.cost;
            });
            activateGroupBoostModal.addEventListener('click', (e) => { if (e.target === activateGroupBoostModal) activateGroupBoostModal.classList.remove('active'); });

            // Donate JCoins Modal Listeners
            cancelDonateJCoinsBtn.addEventListener('click', () => donateJCoinsModal.classList.remove('active'));
            submitDonateJCoinsBtn.addEventListener('click', handleDonateJCoins);
            donateGroupSelect.addEventListener('change', () => {
                donateAmountInput.value = ''; // Clear amount
                submitDonateJCoinsBtn.disabled = true; // Disable until valid amount
                if (currentUserJCoinsDonateDisplay && currentUserProfileData) {
                    currentUserJCoinsDonateDisplay.textContent = currentUserProfileData.jCoins || 0;
                }
            });
            donateAmountInput.addEventListener('input', () => {
                const amount = parseInt(donateAmountInput.value);
                submitDonateJCoinsBtn.disabled = !(donateGroupSelect.value && amount > 0 && currentUserProfileData && amount <= currentUserProfileData.jCoins);
            });
            donateJCoinsModal.addEventListener('click', (e) => { if (e.target === donateJCoinsModal) donateJCoinsModal.classList.remove('active'); });


            // Gift JCoins Modal Listeners
            cancelGiftJCoinsBtn.addEventListener('click', () => giftJCoinsModal.classList.remove('active'));
            submitGiftJCoinsBtn.addEventListener('click', handleGiftJCoins);
            giftGroupSelect.addEventListener('change', (e) => populateGiftMemberSelect(e.target.value));
            giftAmountInput.addEventListener('input', () => {
                const amount = parseInt(giftAmountInput.value);
                submitGiftJCoinsBtn.disabled = !(giftMemberSelect.value && amount > 0 && currentUserProfileData && amount <= currentUserProfileData.jCoins);
            });
            giftMemberSelect.addEventListener('change', () => {
                const amount = parseInt(giftAmountInput.value);
                submitGiftJCoinsBtn.disabled = !(giftMemberSelect.value && amount > 0 && currentUserProfileData && amount <= currentUserProfileData.jCoins);
            });
            giftJCoinsModal.addEventListener('click', (e) => { if (e.target === giftJCoinsModal) giftJCoinsModal.classList.remove('active'); });
        });

        window.addEventListener('storage', (event) => {
            if (event.key === 'jchat-theme') {
                const newTheme = event.newValue || 'theme-dark-mode';
                const themes = ['theme-light-mode', 'theme-dark-mode', 'theme-glass-mode', 'theme-sunset-mode'];
                if (themes.includes(newTheme)) {
                    document.body.classList.remove(...themes);
                    document.body.classList.add(newTheme);
                }
            }
        });

        // The logout button event listener is no longer needed here since the button was removed from HTML.
        // If you re-add a logout mechanism, ensure it's handled appropriately.
        /*
        logoutButton.addEventListener('click', async () => {
            if (!isAuthReady) return;
            toggleButtonLoading(logoutButton, true);
            try {
                await signOut(auth);
                showMessageBox("Logged out successfully! ", 'success');
                setTimeout(() => {
                    window.location.href = '/login.html';
                }, 1500);
            } catch (error) {
                console.error("Error logging out:", error);
                showMessageBox("Failed to log out. Please try again.", 'error');
                toggleButtonLoading(logoutButton, false);
            }
        });
        */

        // --- Placeholder for Quests Collection (for testing) ---
        // You would typically manage this from an admin panel or backend.
        // This ensures a sample quest exists for the client to fetch.
        async function ensureSampleQuestExists() {
            const questRef = doc(db, "artifacts", appId, "public", "data", "quests", "send_50_messages_quest");
            const questDoc = await getDoc(questRef);
            if (!questDoc.exists()) {
                await setDoc(questRef, {
                    name: "Chatty Cathy/Carl",
                    description: `Send ${QUEST_SEND_MESSAGES_TARGET} messages across all groups to earn a reward!`,
                    type: "messages_sent",
                    targetValue: QUEST_SEND_MESSAGES_TARGET,
                    rewardJCoins: QUEST_SEND_MESSAGES_JCOIN_REWARD,
                    rewardGas: QUEST_SEND_MESSAGES_GAS_REWARD,
                    isActive: true,
                    adminOnly: false,
                    createdAt: serverTimestamp()
                });
                console.log("JCHAT_DEBUG: Sample quest 'send_50_messages_quest' created.");
            }
        }
        // Call this once on app start or when authenticated
        // ensureSampleQuestExists(); // Will be called after auth state is ready
    </script>
	
</body>
</html>
